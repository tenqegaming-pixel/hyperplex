<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEONPLEX ARCADE ‚Äî 90 GAMES</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
:root{
  --pink:#ff006e;--cyan:#00f5ff;--yellow:#ffbe0b;--green:#06d6a0;
  --purple:#8338ec;--orange:#ff6b35;--dark:#05050f;--card:#0a0a18;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dark);color:#fff;font-family:'Share Tech Mono',monospace;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 40px,rgba(0,245,255,0.03) 40px,rgba(0,245,255,0.03) 41px),
             repeating-linear-gradient(90deg,transparent,transparent 40px,rgba(0,245,255,0.03) 40px,rgba(0,245,255,0.03) 41px);
  pointer-events:none;z-index:0;}
header{text-align:center;padding:48px 20px 24px;position:relative;z-index:1;}
header h1{font-family:'Press Start 2P',monospace;font-size:clamp(1.2rem,4vw,2.8rem);
  color:var(--cyan);text-shadow:0 0 20px var(--cyan),0 0 60px var(--cyan);
  letter-spacing:6px;animation:flicker 5s infinite;}
header p{color:var(--pink);margin-top:12px;font-size:0.8rem;letter-spacing:4px;text-shadow:0 0 8px var(--pink);}
.badge{display:inline-block;margin-top:10px;padding:4px 14px;border:1px solid var(--yellow);color:var(--yellow);font-size:0.65rem;letter-spacing:3px;}
@keyframes flicker{0%,19%,21%,23%,25%,54%,56%,100%{opacity:1}20%,24%,55%{opacity:.5}}

.section-label{
  font-family:'Press Start 2P',monospace;font-size:0.55rem;letter-spacing:4px;
  color:rgba(255,255,255,0.25);text-align:center;margin:30px 0 0;
  padding:8px;border-top:1px solid rgba(255,255,255,0.06);
}

.arcade-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:18px;padding:20px 36px 60px;max-width:1500px;margin:0 auto;
  position:relative;z-index:1;
}
.game-card{
  background:var(--card);border:1px solid rgba(0,245,255,0.15);
  border-radius:3px;overflow:hidden;cursor:pointer;
  transition:transform .2s,box-shadow .2s,border-color .2s;
}
.game-card:hover{transform:translateY(-5px) scale(1.015);
  border-color:var(--cyan);box-shadow:0 0 24px rgba(0,245,255,0.25);}
.game-card.is3d{border-color:rgba(255,107,53,0.4);}
.game-card.is3d:hover{border-color:var(--orange);box-shadow:0 0 24px rgba(255,107,53,0.35);}
.game-preview{width:100%;height:140px;display:flex;align-items:center;
  justify-content:center;font-size:3.2rem;position:relative;overflow:hidden;}
.badge3d{position:absolute;top:8px;right:8px;background:var(--orange);
  color:#000;font-size:0.5rem;font-family:'Press Start 2P',monospace;
  padding:3px 7px;letter-spacing:2px;}
.game-info{padding:11px 14px;}
.game-genre{font-size:0.58rem;letter-spacing:.2em;color:var(--yellow);
  text-shadow:0 0 6px var(--yellow);margin-bottom:3px;}
.game-title{font-family:'Orbitron',sans-serif;font-size:0.82rem;
  font-weight:700;color:#fff;margin-bottom:4px;}
.game-desc{font-size:0.67rem;color:rgba(255,255,255,.45);line-height:1.5;}
.play-btn{display:block;width:calc(100% - 28px);margin:8px 14px 12px;
  padding:8px;text-align:center;background:transparent;
  font-family:'Share Tech Mono',monospace;font-size:0.74rem;
  letter-spacing:.15em;cursor:pointer;transition:background .2s,color .2s;}
.play-btn:hover{filter:brightness(1.3);}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.93);
  z-index:1000;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.active{display:flex;}
.modal{background:#0a0a1c;border:1px solid var(--cyan);
  box-shadow:0 0 50px rgba(0,245,255,.25);border-radius:3px;
  width:100%;max-width:700px;max-height:92vh;display:flex;
  flex-direction:column;overflow:hidden;}
.modal-header{display:flex;justify-content:space-between;align-items:center;
  padding:11px 16px;border-bottom:1px solid rgba(0,245,255,.15);
  background:rgba(0,245,255,.04);}
.modal-header h2{font-family:'Orbitron',sans-serif;font-size:.82rem;color:var(--cyan);}
.modal-close{background:none;border:none;color:var(--pink);font-size:1.3rem;cursor:pointer;}
.modal-score{color:var(--yellow);font-size:.74rem;}
.game-container{flex:1;display:flex;align-items:center;justify-content:center;
  padding:14px;flex-direction:column;gap:9px;overflow-y:auto;min-height:360px;}
canvas{display:block;max-width:100%;}
.game-msg{color:var(--green);font-size:.74rem;letter-spacing:.1em;text-align:center;
  min-height:16px;text-shadow:0 0 8px var(--green);}
.restart-btn{padding:6px 20px;background:transparent;border:1px solid var(--pink);
  color:var(--pink);font-family:'Share Tech Mono',monospace;
  cursor:pointer;font-size:.72rem;letter-spacing:.1em;}
.restart-btn:hover{background:var(--pink);color:#000;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-18px)}}
@keyframes glow3d{0%,100%{text-shadow:0 0 20px var(--orange)}50%{text-shadow:0 0 40px var(--orange),0 0 80px #ff4500}}
.af{animation:float 2s ease-in-out infinite;display:inline-block;}
.as{animation:spin 3s linear infinite;display:inline-block;}
.ap{animation:pulse 1.5s ease-in-out infinite;display:inline-block;}
.ab{animation:bounce 1s ease-in-out infinite;display:inline-block;}
.a3{animation:glow3d 2s ease-in-out infinite;display:inline-block;}
</style>
</head>
<body>
<header>
  <h1>‚ö° NEONPLEX ARCADE ‚ö°</h1>
  <p>INSERT COIN ¬∑ SELECT GAME ¬∑ PLAY</p>
  <div class="badge">90 GAMES ¬∑ 33 WebGL 3D ¬∑ ALL FREE</div>
</header>

<div class="section-label">‚îÄ‚îÄ CLASSIC GAMES (1‚Äì15) ‚îÄ‚îÄ</div>
<div class="arcade-grid" id="arcadeGrid1"></div>
<div class="section-label">‚îÄ‚îÄ NEW GAMES (16‚Äì30) ¬∑ 3 ARE 3D ‚îÄ‚îÄ</div>
<div class="arcade-grid" id="arcadeGrid2"></div>
<div class="section-label">‚îÄ‚îÄ 3D WebGL GAMES (31‚Äì45) ¬∑ ALL THREE.JS POWERED ‚îÄ‚îÄ</div>
<div class="arcade-grid" id="arcadeGrid3"></div>
<div class="section-label">‚îÄ‚îÄ BONUS GAMES (46‚Äì60) ¬∑ FRESH PICKS ‚îÄ‚îÄ</div>
<div class="arcade-grid" id="arcadeGrid4"></div>
<div class="section-label">‚îÄ‚îÄ MEGA PACK (61‚Äì75) ¬∑ NEW ARRIVALS ‚îÄ‚îÄ</div>
<div class="arcade-grid" id="arcadeGrid5"></div>
<div class="section-label">‚îÄ‚îÄ 3D ARENA (76‚Äì90) ¬∑ MORE WebGL POWERED ‚îÄ‚îÄ</div>
<div class="arcade-grid" id="arcadeGrid6"></div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitle">GAME</h2>
      <div style="display:flex;gap:16px;align-items:center">
        <span class="modal-score" id="modalScore"></span>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
    </div>
    <div class="game-container" id="gameContainer"></div>
  </div>
</div>

<script>
// ============================================================
// GAME DATA REGISTRY
// ============================================================
const GAMES1 = [
  {id:'snake',title:'SERPENT PRIME',genre:'ARCADE / CLASSIC',desc:'Guide the neon serpent. Eat orbs to grow. Avoid walls.',emoji:'üêç',bg:'#001a00',ac:'af',clr:'#06d6a0'},
  {id:'pong',title:'DUAL REBOUND',genre:'SPORTS / RETRO',desc:'Classic paddle battle. W/S left, arrows right. First to 7.',emoji:'üèì',bg:'#0a0014',ac:'ab',clr:'#8338ec'},
  {id:'breakout',title:'BLOCK OBLITERATOR',genre:'ACTION / BREAKOUT',desc:'Smash all bricks with your ball. Mouse or arrow keys. 3 lives.',emoji:'üß±',bg:'#1a0a00',ac:'ap',clr:'#ffbe0b'},
  {id:'invaders',title:'PIXEL INVADERS',genre:'SHOOTER / CLASSIC',desc:'Defend Earth. Arrow keys move, Space to shoot.',emoji:'üëæ',bg:'#00001a',ac:'af',clr:'#00f5ff'},
  {id:'memory',title:'SYNAPTIC GRID',genre:'PUZZLE / MEMORY',desc:'Flip cards and match all pairs. Train your memory.',emoji:'üß†',bg:'#0a001a',ac:'ap',clr:'#ff006e'},
  {id:'reaction',title:'REFLEX MATRIX',genre:'SKILL / REACTION',desc:'Click the moment the circle turns green. Test reflexes.',emoji:'‚ö°',bg:'#1a1000',ac:'ap',clr:'#ffbe0b'},
  {id:'typing',title:'KEYBOARD ASSAULT',genre:'SKILL / TYPING',desc:'Type falling words before they hit the ground.',emoji:'‚å®Ô∏è',bg:'#001a10',ac:'af',clr:'#06d6a0'},
  {id:'flappy',title:'NEON WINGS',genre:'ENDLESS / RUNNER',desc:'Tap space to flap through neon pipes. How far?',emoji:'üê¶',bg:'#000d1a',ac:'af',clr:'#00f5ff'},
  {id:'minesweeper',title:'MINEFIELD PROTOCOL',genre:'PUZZLE / STRATEGY',desc:'Reveal grid without mines. Right-click to flag.',emoji:'üí£',bg:'#1a0000',ac:'ap',clr:'#ff006e'},
  {id:'tictactoe',title:'GRID DOMINANCE',genre:'STRATEGY / CLASSIC',desc:'Tic-Tac-Toe vs CPU. Get 3 in a row to win.',emoji:'‚ùå',bg:'#0a0a0a',ac:'af',clr:'#8338ec'},
  {id:'dodge',title:'METEOR STORM',genre:'SURVIVAL / DODGE',desc:'Dodge the asteroid barrage. Survive as long as possible.',emoji:'üöÄ',bg:'#00001a',ac:'af',clr:'#00f5ff'},
  {id:'numberguess',title:'CIPHER HUNT',genre:'PUZZLE / GUESSING',desc:'Guess the secret number 1-100 in 7 tries.',emoji:'üî¢',bg:'#001010',ac:'ab',clr:'#06d6a0'},
  {id:'clicker',title:'QUANTUM CLICKER',genre:'IDLE / CLICKER',desc:'Click to harvest energy. Buy upgrades to automate.',emoji:'‚öõÔ∏è',bg:'#10001a',ac:'as',clr:'#8338ec'},
  {id:'simon',title:'CHROMATIC ECHO',genre:'MEMORY / PATTERN',desc:'Repeat the color sequence. Each round adds one step.',emoji:'üé®',bg:'#001a05',ac:'ap',clr:'#ffbe0b'},
  {id:'wordscramble',title:'LEXICON CHAOS',genre:'WORD / PUZZLE',desc:'Unscramble the jumbled word before 20 seconds runs out.',emoji:'üìù',bg:'#1a0a05',ac:'ab',clr:'#ff006e'},
];

const GAMES2 = [
  {id:'tetris',title:'BLOCKFALL ULTRA',genre:'PUZZLE / FALLING',desc:'Classic tetromino blocks. Clear lines to score. A/D move, W rotate, S drop fast.',emoji:'üü¶',bg:'#000a18',ac:'af',clr:'#00f5ff'},
  {id:'asteroids',title:'VOIDRIFT',genre:'ACTION / SPACE',desc:'Pilot your ship through asteroid fields. A/D rotate, W thrust, Space fire.',emoji:'‚òÑÔ∏è',bg:'#050015',ac:'as',clr:'#8338ec'},
  {id:'platformer',title:'NEONHOP',genre:'PLATFORMER / JUMP',desc:'Jump across glowing platforms to collect coins. A/D move, Space jump.',emoji:'üü¢',bg:'#000a00',ac:'ab',clr:'#06d6a0'},
  {id:'racing',title:'NEONRACE',genre:'RACING / DODGE',desc:'Dodge oncoming traffic on the neon highway. A/D to steer.',emoji:'üèéÔ∏è',bg:'#05050a',ac:'af',clr:'#ffbe0b'},
  {id:'paint',title:'PIXEL CANVAS',genre:'CREATIVE / DRAW',desc:'Draw anything with neon colors. Click and drag to paint. Color palette included.',emoji:'üé®',bg:'#0a0005',ac:'af',clr:'#ff006e'},
  {id:'quiz',title:'TECHNO QUIZ',genre:'TRIVIA / KNOWLEDGE',desc:'20 tech & gaming questions. Answer before the timer runs out each round.',emoji:'üß™',bg:'#001a10',ac:'ap',clr:'#06d6a0'},
  {id:'maze',title:'LABYRINTH X',genre:'PUZZLE / MAZE',desc:'Navigate the procedurally generated maze to reach the exit. Arrow keys to move.',emoji:'üó∫Ô∏è',bg:'#0a0000',ac:'ab',clr:'#ff006e'},
  {id:'connect4',title:'GRAVITY DROP',genre:'STRATEGY / CONNECT4',desc:'Drop tokens to connect 4 in a row before the CPU does.',emoji:'üî¥',bg:'#00051a',ac:'af',clr:'#00f5ff'},
  {id:'whack',title:'WHACK-A-BOT',genre:'ARCADE / REACTION',desc:'Smash the bots as they pop up. Miss 3 and it\'s over. Speed increases each round.',emoji:'ü§ñ',bg:'#0a0500',ac:'ap',clr:'#ffbe0b'},
  {id:'rhythm',title:'BEAT STRIKER',genre:'RHYTHM / MUSIC',desc:'Hit the notes as they reach the strike zone. Press A/S/D/F to match lanes.',emoji:'üéµ',bg:'#1a0010',ac:'as',clr:'#ff006e'},
  {id:'wordle',title:'CRYPTOWORD',genre:'WORD / STRATEGY',desc:'Guess the 5-letter tech word in 6 tries. Colors reveal correctness.',emoji:'üìü',bg:'#001008',ac:'af',clr:'#06d6a0'},
  {id:'chess',title:'NANO CHESS',genre:'STRATEGY / CHESS',desc:'Full chess vs a simple AI. Click a piece, then click where to move.',emoji:'‚ôüÔ∏è',bg:'#080808',ac:'af',clr:'#ffbe0b'},
  // 3 WebGL 3D GAMES
  {id:'cube3d',title:'CUBE BLAST 3D',genre:'3D / ACTION',desc:'Shoot colored cubes in a 3D arena. Mouse to aim, click to fire. WebGL powered.',emoji:'üßä',bg:'#0a0510',ac:'a3',clr:'#ff6b35',is3d:true},
  {id:'race3d',title:'TURBO DRIFT 3D',genre:'3D / RACING',desc:'Drive a neon car down an infinite 3D road. A/D to steer, avoid obstacles. WebGL.',emoji:'üèÅ',bg:'#050010',ac:'a3',clr:'#ff6b35',is3d:true},
  {id:'fps3d',title:'NEON DUNGEON 3D',genre:'3D / FPS',desc:'First-person dungeon crawler. WASD to move, mouse to look, click to shoot. WebGL.',emoji:'üî´',bg:'#050a00',ac:'a3',clr:'#ff6b35',is3d:true},
];

// ============================================================
// RENDER CARDS
// ============================================================
function renderGrid(games, containerId) {
  const grid = document.getElementById(containerId);
  games.forEach(g => {
    grid.innerHTML += `<div class="game-card${g.is3d?' is3d':''}" onclick="openGame('${g.id}')">
      <div class="game-preview" style="background:${g.bg}">
        <span class="${g.ac}" style="filter:drop-shadow(0 0 14px ${g.clr})">${g.emoji}</span>
        ${g.is3d?'<div class="badge3d">3D WebGL</div>':''}
      </div>
      <div class="game-info">
        <div class="game-genre" style="color:${g.is3d?'var(--orange)':'var(--yellow)'}${g.is3d?';text-shadow:0 0 6px var(--orange)':''}">${g.genre}</div>
        <div class="game-title">${g.title}</div>
        <div class="game-desc">${g.desc}</div>
      </div>
      <button class="play-btn" style="border:1px solid ${g.clr};color:${g.clr}">‚ñ∂ PLAY</button>
    </div>`;
  });
}
const GAMES3 = [
  {id:'g3_spaceshooter', title:'VOID ARMADA',        genre:'3D SPACE SHOOTER',   desc:'3D space combat ‚Äî fly your fighter and blast incoming enemy fleets. Mouse steer, click fire.', emoji:'üöÄ', is3d:true},
  {id:'g3_tank',         title:'IRON TANK ARENA',    genre:'3D TANK BATTLE',     desc:'Drive a 3D tank around a battle arena. WASD move, mouse aim turret, click to blast enemies.', emoji:'ü™ñ', is3d:true},
  {id:'g3_wormhole',     title:'WORMHOLE DASH',      genre:'3D TUNNEL RUNNER',   desc:'Fly through a twisting 3D wormhole at warp speed. Mouse to steer, dodge glowing walls.', emoji:'üåÄ', is3d:true},
  {id:'g3_marble',       title:'MARBLE MADNESS 3D',  genre:'3D MARBLE PHYSICS',  desc:'Guide a glowing marble through a tilting 3D obstacle course. Arrow keys to tilt the board.', emoji:'üîÆ', is3d:true},
  {id:'g3_tower',        title:'NEXUS DEFENSE',      genre:'3D TOWER DEFENSE',   desc:'Place laser towers on a 3D grid to stop waves of enemies marching to your base.', emoji:'üóº', is3d:true},
  {id:'g3_brawler',      title:'NEON BRAWLER',       genre:'3D ARENA COMBAT',    desc:'Fight enemy orbs in a 3D neon arena. WASD move, SPACE to dash-attack through enemies.', emoji:'‚öîÔ∏è', is3d:true},
  {id:'g3_pinball',      title:'CYBERBALL PINBALL',  genre:'3D PINBALL',         desc:'3D pinball with ramps, bumpers and multiball madness. Z = left flipper, / = right flipper.', emoji:'üé∞', is3d:true},
  {id:'g3_skysurf',      title:'CLOUD SURFER',       genre:'3D ENDLESS RUNNER',  desc:'Surf floating cloud platforms in the sky at high speed. A/D move, SPACE to jump.', emoji:'‚òÅÔ∏è', is3d:true},
  {id:'g3_sniper',       title:'QUANTUM SNIPER',     genre:'3D SNIPER',          desc:'Long-range 3D sniper ‚Äî click canvas to lock mouse, move to aim, click to fire at targets.', emoji:'üéØ', is3d:true},
  {id:'g3_rhythm',       title:'BEAT SPHERE',        genre:'3D RHYTHM',          desc:'3D rhythm game ‚Äî orbs fly at you in lanes. Press A S D F to smash them on the beat.', emoji:'ü•Å', is3d:true},
  {id:'g3_galaxy',       title:'STELLAR FORGE',      genre:'3D SANDBOX',         desc:'Build your own 3D galaxy ‚Äî click to place stars and watch gravity pull them into orbits.', emoji:'üå†', is3d:true},
  {id:'g3_bowling',      title:'NEON BOWLING',       genre:'3D BOWLING',         desc:'Holographic 3D bowling lane. Click and drag to aim, release to bowl for the strike.', emoji:'üé≥', is3d:true},
  {id:'g3_zombie',       title:'NEON UNDEAD',        genre:'3D WAVE SURVIVAL',   desc:'Survive endless zombie-cube waves from all sides. Auto-shoot, WASD to dodge and survive.', emoji:'üßü', is3d:true},
  {id:'g3_minigolf',     title:'ZERO-G GOLF',        genre:'3D MINI GOLF',       desc:'Mini golf in zero-gravity 3D space. Click and drag to aim and power your shot into the hole.', emoji:'‚õ≥', is3d:true},
  {id:'g3_particles',    title:'QUANTUM CANVAS',     genre:'3D PARTICLE ART',    desc:'Paint with 3D neon particles ‚Äî click and drag to sculpt explosive particle sculptures.', emoji:'‚ú®', is3d:true},
];

renderGrid(GAMES1, 'arcadeGrid1');
renderGrid(GAMES2, 'arcadeGrid2');
(function(){
  const grid=document.getElementById('arcadeGrid3');
  GAMES3.forEach(g=>{
    grid.innerHTML+=`<div class="game-card is3d" onclick="openGame('${g.id}')">
      <div class="game-preview" style="background:linear-gradient(135deg,#0a0510,#05001a)">
        <span style="font-size:3rem;filter:drop-shadow(0 0 18px #ff6b35);animation:pulse3d 2s ease-in-out infinite">${g.emoji}</span>
        <div class="badge3d">3D WebGL</div>
      </div>
      <div class="game-info">
        <div class="game-genre" style="color:var(--orange);text-shadow:0 0 6px var(--orange)">${g.genre}</div>
        <div class="game-title">${g.title}</div>
        <div class="game-desc">${g.desc}</div>
      </div>
      <button class="play-btn" style="border:1px solid var(--orange);color:var(--orange)">‚ñ∂ PLAY 3D</button>
    </div>`;
  });
  if(!document.querySelector('#kf3d')){const s=document.createElement('style');s.id='kf3d';s.textContent='@keyframes pulse3d{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}';document.head.appendChild(s);}
})();

const GAMES4 = [
  {id:'g4_life',      title:'CONWAY LIFE',      genre:'SIMULATION / CELLULAR', desc:'Conway\'s Game of Life. Click cells to toggle, hit Run to watch colonies evolve and compete.',   emoji:'üî¨', clr:'#06d6a0'},
  {id:'g4_snake2',    title:'SNAKE DUEL',        genre:'ARCADE / VERSUS',       desc:'Two snakes, one grid. WASD vs ARROWS ‚Äî first to crash loses. Challenge a friend locally.',     emoji:'üêç', clr:'#ff006e'},
  {id:'g4_sokoban',   title:'CRATE PUSHER',      genre:'PUZZLE / SOKOBAN',      desc:'Push crates onto targets. Classic Sokoban. Arrow keys move, R resets. 5 hand-crafted levels.',  emoji:'üì¶', clr:'#ffbe0b'},
  {id:'g4_blackjack', title:'NEON BLACKJACK',    genre:'CARD / CASINO',         desc:'Hit or stand against the dealer. Try to reach 21 without busting. Bet your chip stack.',        emoji:'üÉè', clr:'#00f5ff'},
  {id:'g4_hanoi',     title:'TOWER OF HANOI',    genre:'PUZZLE / LOGIC',        desc:'Move all discs to the right peg. Click to pick up and place. Classic logic puzzle.',           emoji:'üèõÔ∏è', clr:'#8338ec'},
  {id:'g4_life2',     title:'PIXEL AQUARIUM',    genre:'SIMULATION / LIFE',     desc:'Watch fish school, hunt prey, and flee predators. Click to add food. Emergent behavior.',       emoji:'üê†', clr:'#00f5ff'},
  {id:'g4_breakout2', title:'BRICK BLITZ',       genre:'ACTION / BREAKOUT',     desc:'Breakout with power-ups ‚Äî multiball, wide paddle, laser. Chain breaks for a score multiplier.', emoji:'üí•', clr:'#ff6b35'},
  {id:'g4_gravity',   title:'GRAVITY WARS',      genre:'STRATEGY / PHYSICS',    desc:'Aim and fire missiles with gravity bending your shots. Two-player local hot-seat artillery.',   emoji:'üåç', clr:'#06d6a0'},
  {id:'g4_pipes',     title:'PIPE DREAM',        genre:'PUZZLE / FLOW',         desc:'Rotate pipe tiles to connect source to drain before water flows. Race the clock each level.',    emoji:'üîß', clr:'#ffbe0b'},
  {id:'g4_dungeon',   title:'ROGUE DEPTHS',      genre:'ROGUELIKE / DUNGEON',   desc:'Explore a procedural dungeon. Arrow keys move, fight monsters, collect gold, find the exit.',   emoji:'üó°Ô∏è', clr:'#ff006e'},
  {id:'g4_typing2',   title:'CODE RAIN',         genre:'SKILL / TYPING',        desc:'Matrix-style falling code. Type the highlighted character streams to clear them. Speed ramps.',  emoji:'üíª', clr:'#06d6a0'},
  {id:'g4_pong2',     title:'RICOCHET ROYALE',   genre:'SPORTS / MULTI-BALL',   desc:'Pong with 3 balls at once and shrinking paddles. First player to 10 losses is eliminated.',     emoji:'‚ö°', clr:'#8338ec'},
  {id:'g4_slots',     title:'CYBER SLOTS',       genre:'CASINO / LUCK',         desc:'Neon slot machine with 5 symbols. Hit spin, match 3 to win. Special combo jackpots pay big.',   emoji:'üé∞', clr:'#ffbe0b'},
  {id:'g4_defense',   title:'PIXEL FORTRESS',    genre:'STRATEGY / DEFENSE',    desc:'2D tower defense ‚Äî place cannon, laser and slow towers. Survive 10 waves of escalating foes.',  emoji:'üè∞', clr:'#ff006e'},
  {id:'g4_sand',      title:'SAND SIMULATOR',    genre:'SIMULATION / SANDBOX',  desc:'Pour sand, water and fire. Watch them interact with gravity and physics. Pure creative chaos.',  emoji:'‚è≥', clr:'#ffbe0b'},
];

renderGrid(GAMES4, 'arcadeGrid4');

const GAMES5 = [
  {id:'g5_chess2',   title:'BLITZ CHESS',      genre:'STRATEGY / CHESS',      desc:'3-minute blitz chess vs AI. Full rules, promotion, check/checkmate detection. Think fast!',       emoji:'‚è±Ô∏è', clr:'#ffbe0b'},
  {id:'g5_frogger',  title:'ROAD HOPPER',      genre:'ARCADE / DODGE',        desc:'Cross lanes of traffic and river logs without getting squashed or sinking. Frogger classic.',      emoji:'üê∏', clr:'#06d6a0'},
  {id:'g5_2048',     title:'HEX 2048',         genre:'PUZZLE / MERGE',        desc:'Slide tiles and merge matching numbers to reach 2048. How high can you go past that?',           emoji:'üî¢', clr:'#ff6b35'},
  {id:'g5_paint2',   title:'PIXEL ARTIST',     genre:'CREATIVE / PIXEL ART',  desc:'16√ó16 pixel art canvas with palette, fill tool and export. Draw tiny masterpieces.',             emoji:'üñºÔ∏è', clr:'#ff006e'},
  {id:'g5_codebreak',title:'MASTERMIND',       genre:'PUZZLE / DEDUCTION',    desc:'Crack the hidden 4-color code in 10 guesses. Black peg = right color & place, white = right color.',emoji:'üîê', clr:'#8338ec'},
  {id:'g5_orbit',    title:'ORBIT DEFENDER',   genre:'ARCADE / DEFENSE',      desc:'Your planet orbits the center. Shoot asteroids before they hit it. Rotate with A/D, fire SPACE.',  emoji:'ü™ê', clr:'#00f5ff'},
  {id:'g5_dice',     title:'YAHTZEE BLITZ',    genre:'DICE / STRATEGY',       desc:'Roll 5 dice up to 3 times per turn. Score categories like Full House, Straights, and Yahtzee!',   emoji:'üé≤', clr:'#ffbe0b'},
  {id:'g5_morse',    title:'MORSE DECODER',    genre:'SKILL / EDUCATIONAL',   desc:'Hear a letter in Morse code, type it correctly. Speed increases every 5 correct. Test your ear!', emoji:'üì°', clr:'#06d6a0'},
  {id:'g5_lander',   title:'LUNAR LANDER',     genre:'SIM / PHYSICS',         desc:'Guide your lander to the pad. Thrust with UP, steer with LEFT/RIGHT. Land softly or explode.',   emoji:'üöÄ', clr:'#00f5ff'},
  {id:'g5_tron',     title:'TRON LIGHTCYCLE',  genre:'ARCADE / VERSUS',       desc:'Leave light trails ‚Äî crash into a wall or trail to lose. WASD vs ARROWS, 2-player local duel.',   emoji:'üèçÔ∏è', clr:'#00f5ff'},
  {id:'g5_formula',  title:'PIT STRATEGY',     genre:'STRATEGY / RACING',     desc:'Manage tyres, fuel and pit stops across a 10-lap race. Number puzzle racing management sim.',     emoji:'üèéÔ∏è', clr:'#ff6b35'},
  {id:'g5_reversi',  title:'NEON REVERSI',     genre:'STRATEGY / OTHELLO',    desc:'Flip your opponent\'s discs to claim the board. Play vs a smart AI. Classic Othello rules.',      emoji:'‚ö´', clr:'#8338ec'},
  {id:'g5_virus',    title:'ANTIVIRUS',        genre:'PUZZLE / STRATEGY',     desc:'Spread your color across the board one adjacent tile at a time. Take over before the AI does.',   emoji:'ü¶†', clr:'#06d6a0'},
  {id:'g5_kanji',    title:'SPEED MATH',       genre:'SKILL / MATH',          desc:'Rapid-fire arithmetic ‚Äî answer before the timer hits zero. Wrong answer or timeout = game over.',  emoji:'üßÆ', clr:'#ffbe0b'},
  {id:'g5_rps',      title:'RPS ARENA',        genre:'ARCADE / REACTION',     desc:'Rock Paper Scissors against an AI that learns your patterns. Win 10 rounds before it adapts.',    emoji:'‚úä', clr:'#ff006e'},
];

renderGrid(GAMES5, 'arcadeGrid5');

const GAMES6 = [
  {id:'g6_mech',      title:'MECH WARRIOR',      genre:'3D MECH COMBAT',      desc:'Pilot a 3D bipedal mech. WASD walk, mouse aim, click fire missiles. Destroy enemy mechs.',      emoji:'ü§ñ', is3d:true},
  {id:'g6_submarine', title:'DEPTH CHARGE',       genre:'3D SUBMARINE',        desc:'Pilot a submarine through ocean trenches. Torpedo enemy ships above, dodge depth charges.',      emoji:'üåä', is3d:true},
  {id:'g6_crystals',  title:'CRYSTAL HARVESTER',  genre:'3D MINING',           desc:'Fly a mining ship, blast crystal asteroids, collect shards. Upgrade hull with earnings.',         emoji:'üíé', is3d:true},
  {id:'g6_portal',    title:'PORTAL RUNNER',       genre:'3D PUZZLE RUNNER',   desc:'Run through portals that teleport you across a 3D maze. Reach the exit before time runs out.',   emoji:'üîµ', is3d:true},
  {id:'g6_swarm',     title:'BEE SWARM',           genre:'3D SWARM SIM',       desc:'Control a swarm of drones. Absorb smaller swarms, flee bigger ones. Grow to dominate the arena.', emoji:'üêù', is3d:true},
  {id:'g6_fortress',  title:'SKY FORTRESS',        genre:'3D TOWER ASSAULT',   desc:'Attack a floating fortress. Dodge turret fire while flying up to plant bombs on each cannon.',    emoji:'üè∞', is3d:true},
  {id:'g6_lava',      title:'LAVA SURFER',         genre:'3D ENDLESS SURF',    desc:'Surf a procedural lava wave on a hoverboard. Lean left/right with A/D, jump over lava jets.',    emoji:'üåã', is3d:true},
  {id:'g6_chess3d',   title:'BATTLE CHESS 3D',     genre:'3D CHESS',           desc:'Chess on a 3D board where pieces explode when captured. Full rules vs AI. Click to play.',        emoji:'‚ôüÔ∏è', is3d:true},
  {id:'g6_fishing',   title:'DEEP SEA FISHING',    genre:'3D FISHING SIM',     desc:'Cast your line into a 3D ocean. Reel in fish with timing, avoid snapping the line.',             emoji:'üé£', is3d:true},
  {id:'g6_magnet',    title:'MAGNET MAZE',          genre:'3D PUZZLE PHYSICS',  desc:'Control a magnetic ball. Attract or repel metal blocks to solve 3D gravity puzzles.',            emoji:'üß≤', is3d:true},
  {id:'g6_dragon',    title:'DRAGON FLIGHT',        genre:'3D FLIGHT',          desc:'Ride a dragon through mountain passes. Breathe fire on targets, collect gold hoards.',            emoji:'üêâ', is3d:true},
  {id:'g6_tennis',    title:'CYBER TENNIS',         genre:'3D SPORTS',          desc:'3D tennis with neon ball physics. Time your swing with SPACE, aim with mouse. Rally for points.',  emoji:'üéæ', is3d:true},
  {id:'g6_escape',    title:'ZERO-G ESCAPE',        genre:'3D PUZZLE',          desc:'Float through a zero-g space station. Push crates, activate switches, escape before O2 runs out.', emoji:'üõ∏', is3d:true},
  {id:'g6_volcano',   title:'VOLCANO DEFENSE',      genre:'3D DEFENSE',         desc:'Defend a village from volcanic boulders. Shoot boulders before they hit the houses below.',       emoji:'üåã', is3d:true},
  {id:'g6_speedway',  title:'NEON SPEEDWAY',        genre:'3D KART RACING',     desc:'Kart race on a neon circuit. Drift corners with A/D, hit boost pads, lap 3 AI opponents.',        emoji:'üèÅ', is3d:true},
];

(function(){
  var grid6=document.getElementById('arcadeGrid6');
  GAMES6.forEach(function(g){
    var card=document.createElement('div');
    card.className='game-card is3d';
    card.onclick=function(){openGame(g.id);};
    card.innerHTML='<div class="game-preview" style="background:linear-gradient(135deg,#0a0510,#05001a)"><span style="font-size:3rem;filter:drop-shadow(0 0 18px #ff6b35);animation:pulse3d 2s ease-in-out infinite">'+g.emoji+'</span><div class="badge3d">3D WebGL</div></div><div class="game-info"><div class="game-genre" style="color:var(--orange);text-shadow:0 0 6px var(--orange)">'+g.genre+'</div><div class="game-title">'+g.title+'</div><div class="game-desc">'+g.desc+'</div></div><button class="play-btn" style="border:1px solid var(--orange);color:var(--orange)">&#9654; PLAY 3D</button>';
    grid6.appendChild(card);
  });
})();

// ============================================================
// MODAL MANAGEMENT
// ============================================================
let currentGame = null, gameInterval = null, auxTimer = null, gameCleanup = null;

function openGame(id) {
  const allGames = [...GAMES1, ...GAMES2, ...GAMES3, ...GAMES4, ...GAMES5, ...GAMES6];
  const g = allGames.find(x => x.id === id);
  currentGame = id;
  document.getElementById('modalTitle').textContent = g.title;
  document.getElementById('modalScore').textContent = '';
  document.getElementById('modalOverlay').classList.add('active');
  document.getElementById('gameContainer').innerHTML = '';
  clearInterval(gameInterval); clearInterval(auxTimer);
  if (gameCleanup) { gameCleanup(); gameCleanup = null; }
  setTimeout(() => initGame(id), 50);
}
function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
  clearInterval(gameInterval); clearInterval(auxTimer);
  if (gameCleanup) { gameCleanup(); gameCleanup = null; }
  currentGame = null;
}
document.getElementById('modalOverlay').addEventListener('click', function(e) { if(e.target===this) closeModal(); });
function setScore(s) { document.getElementById('modalScore').textContent = s; }
function getCont() { return document.getElementById('gameContainer'); }
function addMsg(txt) { let el=document.getElementById('gamemsg'); if(!el){el=document.createElement('div');el.id='gamemsg';el.className='game-msg';getCont().appendChild(el);} el.textContent=txt; }
function addRestartBtn(fn) { const btn=document.createElement('button');btn.className='restart-btn';btn.textContent='‚Ü∫ RESTART';btn.onclick=fn;getCont().appendChild(btn); }
function makeCanvas(w,h) { const c=document.createElement('canvas');c.width=w;c.height=h;c.style.cssText='border:1px solid rgba(0,245,255,0.2);max-width:100%;';getCont().appendChild(c);return c; }

function initGame(id) {
  const map = {
    snake:gameSnake, pong:gamePong, breakout:gameBreakout, invaders:gameInvaders,
    memory:gameMemory, reaction:gameReaction, typing:gameTyping, flappy:gameFlappy,
    minesweeper:gameMinesweeper, tictactoe:gameTicTacToe, dodge:gameDodge,
    numberguess:gameNumberGuess, clicker:gameClicker, simon:gameSimon,
    wordscramble:gameWordScramble,
    // NEW
    tetris:gameTetris, asteroids:gameAsteroids, platformer:gamePlatformer,
    racing:gameRacing, paint:gamePaint, quiz:gameQuiz, maze:gameMaze,
    connect4:gameConnect4, whack:gameWhack, rhythm:gameRhythm,
    wordle:gameWordle, chess:gameChess,
    cube3d:gameCube3D, race3d:gameRace3D, fps3d:gameFPS3D,
    // GAMES3 ‚Äî 15 new WebGL 3D games
    g3_spaceshooter:g3SpaceShooter, g3_tank:g3Tank, g3_wormhole:g3Wormhole,
    g3_marble:g3Marble, g3_tower:g3Tower, g3_brawler:g3Brawler,
    g3_pinball:g3Pinball, g3_skysurf:g3SkySurf, g3_sniper:g3Sniper,
    g3_rhythm:g3Rhythm, g3_galaxy:g3Galaxy, g3_bowling:g3Bowling,
    g3_zombie:g3Zombie, g3_minigolf:g3Minigolf, g3_particles:g3Particles,
    // GAMES4 ‚Äî 15 bonus games
    g4_life:g4Life, g4_snake2:g4Snake2, g4_sokoban:g4Sokoban,
    g4_blackjack:g4Blackjack, g4_hanoi:g4Hanoi, g4_life2:g4Aquarium,
    g4_breakout2:g4Breakout2, g4_gravity:g4Gravity, g4_pipes:g4Pipes,
    g4_dungeon:g4Dungeon, g4_typing2:g4CodeRain, g4_pong2:g4Pong2,
    g4_slots:g4Slots, g4_defense:g4Defense, g4_sand:g4Sand,
    // GAMES5 ‚Äî 15 mega pack games
    g5_chess2:g5Chess2, g5_frogger:g5Frogger, g5_2048:g52048,
    g5_paint2:g5PixelArtist, g5_codebreak:g5Mastermind, g5_orbit:g5Orbit,
    g5_dice:g5Yahtzee, g5_morse:g5Morse, g5_lander:g5Lander,
    g5_tron:g5Tron, g5_formula:g5PitStrategy, g5_reversi:g5Reversi,
    g5_virus:g5Antivirus, g5_kanji:g5SpeedMath, g5_rps:g5RPS,
    // GAMES6 ‚Äî 15 new 3D WebGL games
    g6_mech:g6Mech, g6_submarine:g6Submarine, g6_crystals:g6Crystals,
    g6_portal:g6Portal, g6_swarm:g6Swarm, g6_fortress:g6Fortress,
    g6_lava:g6Lava, g6_chess3d:g6Chess3D, g6_fishing:g6Fishing,
    g6_magnet:g6Magnet, g6_dragon:g6Dragon, g6_tennis:g6Tennis,
    g6_escape:g6Escape, g6_volcano:g6Volcano, g6_speedway:g6Speedway
  };
  if (map[id]) map[id]();
}

// ============================================================
// ============================================================
// ORIGINAL 15 GAMES
// ============================================================
// ============================================================

function gameSnake(){
  const C=makeCanvas(520,370);const ctx=C.getContext('2d');
  const SZ=20,COLS=26,ROWS=18;
  let snake,dir,food,score,alive;
  function reset(){snake=[{x:13,y:9}];dir={x:1,y:0};score=0;alive=true;placeFood();setScore(0);addMsg('ARROW KEYS / WASD TO MOVE');}
  function placeFood(){food={x:Math.floor(Math.random()*COLS),y:Math.floor(Math.random()*ROWS)};}
  function draw(){
    ctx.fillStyle='#000';ctx.fillRect(0,0,C.width,C.height);
    ctx.strokeStyle='rgba(0,245,255,0.04)';
    for(let x=0;x<COLS;x++){ctx.beginPath();ctx.moveTo(x*SZ,0);ctx.lineTo(x*SZ,C.height);ctx.stroke();}
    for(let y=0;y<ROWS;y++){ctx.beginPath();ctx.moveTo(0,y*SZ);ctx.lineTo(C.width,y*SZ);ctx.stroke();}
    ctx.fillStyle='#ff006e';ctx.shadowColor='#ff006e';ctx.shadowBlur=12;ctx.fillRect(food.x*SZ+2,food.y*SZ+2,SZ-4,SZ-4);
    snake.forEach((s,i)=>{ctx.shadowColor='#06d6a0';ctx.shadowBlur=i===0?14:4;ctx.fillStyle=i===0?'#06d6a0':'#04a07a';ctx.fillRect(s.x*SZ+1,s.y*SZ+1,SZ-2,SZ-2);});
    ctx.shadowBlur=0;
    if(!alive){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#ff006e';ctx.font='bold 24px Orbitron';ctx.textAlign='center';ctx.shadowColor='#ff006e';ctx.shadowBlur=18;ctx.fillText('GAME OVER',C.width/2,C.height/2-8);ctx.fillStyle='#fff';ctx.font='12px Share Tech Mono';ctx.fillText('SCORE: '+score,C.width/2,C.height/2+18);ctx.shadowBlur=0;}
  }
  function tick(){
    if(!alive){draw();return;}
    const head={x:snake[0].x+dir.x,y:snake[0].y+dir.y};
    if(head.x<0||head.x>=COLS||head.y<0||head.y>=ROWS||snake.some(s=>s.x===head.x&&s.y===head.y)){alive=false;draw();return;}
    snake.unshift(head);
    if(head.x===food.x&&head.y===food.y){score+=10;setScore(score);placeFood();}else snake.pop();
    draw();
  }
  document.addEventListener('keydown',function snakeK(e){
    if(!currentGame||currentGame!=='snake')return document.removeEventListener('keydown',snakeK);
    const k=e.key;
    if((k==='ArrowUp'||k==='w')&&dir.y===0){dir={x:0,y:-1};e.preventDefault();}
    if((k==='ArrowDown'||k==='s')&&dir.y===0){dir={x:0,y:1};e.preventDefault();}
    if((k==='ArrowLeft'||k==='a')&&dir.x===0){dir={x:-1,y:0};e.preventDefault();}
    if((k==='ArrowRight'||k==='d')&&dir.x===0){dir={x:1,y:0};e.preventDefault();}
  });
  reset();gameInterval=setInterval(tick,120);
  addRestartBtn(()=>{clearInterval(gameInterval);reset();gameInterval=setInterval(tick,120);});
}

function gamePong(){
  const C=makeCanvas(520,360);const ctx=C.getContext('2d');
  let ball,p1y,p2y,s1,s2,running;const PH=68,SP=4;
  function reset(){ball={x:260,y:180,vx:(Math.random()>.5?1:-1)*SP,vy:(Math.random()-.5)*3.5};p1y=144;p2y=144;s1=0;s2=0;running=true;setScore('P1: 0  vs  P2: 0');addMsg('W/S = LEFT PADDLE   ARROWS = RIGHT');}
  const keys={};
  document.addEventListener('keydown',function pK(e){if(!currentGame||currentGame!=='pong')return document.removeEventListener('keydown',pK);keys[e.key]=true;if(['ArrowUp','ArrowDown'].includes(e.key))e.preventDefault();});
  document.addEventListener('keyup',e=>keys[e.key]=false);
  function draw(){
    ctx.fillStyle='#05050f';ctx.fillRect(0,0,C.width,C.height);
    ctx.setLineDash([8,8]);ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(260,0);ctx.lineTo(260,C.height);ctx.stroke();ctx.setLineDash([]);
    ctx.shadowColor='#00f5ff';ctx.shadowBlur=12;ctx.fillStyle='#00f5ff';ctx.fillRect(12,p1y,10,PH);ctx.fillRect(C.width-22,p2y,10,PH);
    ctx.shadowColor='#ff006e';ctx.shadowBlur=16;ctx.fillStyle='#ff006e';ctx.beginPath();ctx.arc(ball.x,ball.y,7,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle='rgba(255,255,255,.7)';ctx.font='22px Orbitron';ctx.textAlign='center';ctx.fillText(s1,130,36);ctx.fillText(s2,390,36);
    if(!running){ctx.fillStyle='rgba(0,0,0,.65)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#ffbe0b';ctx.font='22px Orbitron';ctx.shadowColor='#ffbe0b';ctx.shadowBlur=18;ctx.fillText((s1>=7?'P1':'P2')+' WINS!',260,180);ctx.shadowBlur=0;}
  }
  function tick(){
    if(!running){draw();return;}
    if(keys['w']&&p1y>0)p1y-=5;if(keys['s']&&p1y<C.height-PH)p1y+=5;
    if(keys['ArrowUp']&&p2y>0)p2y-=5;if(keys['ArrowDown']&&p2y<C.height-PH)p2y+=5;
    if(ball.vx>0)p2y+=(ball.y-p2y-PH/2)*.055;
    ball.x+=ball.vx;ball.y+=ball.vy;
    if(ball.y<7||ball.y>C.height-7)ball.vy*=-1;
    if(ball.x<28&&ball.y>p1y&&ball.y<p1y+PH){ball.vx=Math.abs(ball.vx);ball.vy+=(ball.y-p1y-PH/2)*.1;}
    if(ball.x>C.width-28&&ball.y>p2y&&ball.y<p2y+PH)ball.vx=-Math.abs(ball.vx);
    if(ball.x<0){s2++;setScore('P1:'+s1+'  vs  P2:'+s2);if(s2>=7)running=false;else{ball.x=260;ball.y=180;ball.vx=SP;}}
    if(ball.x>C.width){s1++;setScore('P1:'+s1+'  vs  P2:'+s2);if(s1>=7)running=false;else{ball.x=260;ball.y=180;ball.vx=-SP;}}
    draw();
  }
  reset();gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);reset();gameInterval=setInterval(tick,16);});
}

function gameBreakout(){
  const C=makeCanvas(520,370);const ctx=C.getContext('2d');
  const COLS=10,ROWS=5,BW=46,BH=15,GAP=4;
  const BC=['#ff006e','#ff4500','#ffbe0b','#06d6a0','#00f5ff'];
  let paddle,ball,bricks,score,lives,running;
  function reset(){
    paddle={x:210,y:348,w:100};ball={x:260,y:320,vx:3,vy:-4,r:7};bricks=[];
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)bricks.push({x:8+c*(BW+GAP),y:32+r*(BH+GAP),alive:true,color:BC[r]});
    score=0;lives=3;running=true;setScore('SCORE:0 LIVES:3');addMsg('MOUSE or ARROW KEYS to move paddle');
  }
  C.addEventListener('mousemove',e=>{const r=C.getBoundingClientRect();paddle.x=e.clientX-r.left-paddle.w/2;paddle.x=Math.max(0,Math.min(C.width-paddle.w,paddle.x));});
  const keys={};
  document.addEventListener('keydown',function bkK(e){if(!currentGame||currentGame!=='breakout')return document.removeEventListener('keydown',bkK);keys[e.key]=true;e.preventDefault();});
  document.addEventListener('keyup',e=>keys[e.key]=false);
  function draw(){
    ctx.fillStyle='#0a0300';ctx.fillRect(0,0,C.width,C.height);
    bricks.forEach(b=>{if(!b.alive)return;ctx.fillStyle=b.color;ctx.shadowColor=b.color;ctx.shadowBlur=8;ctx.fillRect(b.x,b.y,BW,BH);});
    ctx.shadowBlur=0;ctx.fillStyle='#8338ec';ctx.shadowColor='#8338ec';ctx.shadowBlur=10;ctx.fillRect(paddle.x,paddle.y,paddle.w,10);
    ctx.shadowColor='#fff';ctx.shadowBlur=14;ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='12px Share Tech Mono';ctx.textAlign='left';ctx.fillText('SCORE:'+score+'  LIVES:'+lives,8,20);
    if(!running){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#ffbe0b';ctx.font='20px Orbitron';ctx.textAlign='center';ctx.shadowColor='#ffbe0b';ctx.shadowBlur=18;ctx.fillText(bricks.every(b=>!b.alive)?'YOU WIN!':'GAME OVER',C.width/2,C.height/2);ctx.shadowBlur=0;}
  }
  function tick(){
    if(!running){draw();return;}
    if(keys['ArrowLeft'])paddle.x=Math.max(0,paddle.x-6);
    if(keys['ArrowRight'])paddle.x=Math.min(C.width-paddle.w,paddle.x+6);
    ball.x+=ball.vx;ball.y+=ball.vy;
    if(ball.x<ball.r||ball.x>C.width-ball.r)ball.vx*=-1;
    if(ball.y<ball.r)ball.vy*=-1;
    if(ball.y>paddle.y-ball.r&&ball.x>paddle.x&&ball.x<paddle.x+paddle.w){ball.vy=-Math.abs(ball.vy);ball.vx+=(ball.x-paddle.x-paddle.w/2)*.07;}
    if(ball.y>C.height){lives--;setScore('SCORE:'+score+' LIVES:'+lives);if(lives<=0)running=false;else{ball.x=paddle.x+paddle.w/2;ball.y=paddle.y-20;ball.vx=3;ball.vy=-4;}}
    bricks.forEach(b=>{if(!b.alive)return;if(ball.x>b.x-ball.r&&ball.x<b.x+BW+ball.r&&ball.y>b.y-ball.r&&ball.y<b.y+BH+ball.r){b.alive=false;ball.vy*=-1;score+=10;setScore('SCORE:'+score+' LIVES:'+lives);}});
    if(bricks.every(b=>!b.alive))running=false;
    draw();
  }
  reset();gameInterval=setInterval(tick,14);
  addRestartBtn(()=>{clearInterval(gameInterval);reset();gameInterval=setInterval(tick,14);});
}

function gameInvaders(){
  const C=makeCanvas(520,400);const ctx=C.getContext('2d');
  let player,bullets,enemies,eBullets,score,lives,phase,cooldown;
  function reset(){
    player={x:250,y:365,w:28,h:18};bullets=[];eBullets=[];score=0;lives=3;cooldown=0;phase=1;
    enemies=[];for(let r=0;r<4;r++)for(let c=0;c<9;c++)enemies.push({x:40+c*48,y:28+r*36,alive:true});
    setScore('SCORE:0  LIVES:3');addMsg('ARROWS MOVE ¬∑ SPACE SHOOT');
  }
  const keys={};
  document.addEventListener('keydown',function iK(e){if(!currentGame||currentGame!=='invaders')return document.removeEventListener('keydown',iK);keys[e.key]=true;if(e.key===' ')e.preventDefault();});
  document.addEventListener('keyup',e=>keys[e.key]=false);
  let edir=1,ef=0;
  function draw(){
    ctx.fillStyle='#00001a';ctx.fillRect(0,0,C.width,C.height);
    for(let i=0;i<30;i++){const x=(i*73)%C.width,y=(i*47+ef)%C.height;ctx.fillStyle='rgba(255,255,255,.2)';ctx.fillRect(x,y,1,1);}
    enemies.filter(e=>e.alive).forEach(e=>{ctx.fillStyle='#8338ec';ctx.shadowColor='#8338ec';ctx.shadowBlur=8;ctx.fillRect(e.x,e.y,22,16);ctx.fillStyle='#fff';ctx.fillRect(e.x+3,e.y+4,4,6);ctx.fillRect(e.x+15,e.y+4,4,6);ctx.shadowBlur=0;});
    bullets.forEach(b=>{ctx.fillStyle='#ffbe0b';ctx.fillRect(b.x-2,b.y-6,4,12);});
    eBullets.forEach(b=>{ctx.fillStyle='#ff006e';ctx.fillRect(b.x-2,b.y,4,10);});
    ctx.fillStyle='#00f5ff';ctx.shadowColor='#00f5ff';ctx.shadowBlur=12;
    ctx.beginPath();ctx.moveTo(player.x+14,player.y);ctx.lineTo(player.x,player.y+player.h);ctx.lineTo(player.x+28,player.y+player.h);ctx.closePath();ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='11px Share Tech Mono';ctx.textAlign='left';ctx.fillText('SCORE:'+score+'  LIVES:'+lives,8,18);
    const alive2=enemies.filter(e=>e.alive);
    if(alive2.length===0){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#06d6a0';ctx.font='20px Orbitron';ctx.textAlign='center';ctx.shadowColor='#06d6a0';ctx.shadowBlur=18;ctx.fillText('YOU WIN! SCORE:'+score,C.width/2,C.height/2);ctx.shadowBlur=0;}
    if(lives<=0){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#ff006e';ctx.font='22px Orbitron';ctx.textAlign='center';ctx.shadowColor='#ff006e';ctx.shadowBlur=18;ctx.fillText('GAME OVER',C.width/2,C.height/2);ctx.shadowBlur=0;}
  }
  function tick(){
    if(lives<=0||enemies.filter(e=>e.alive).length===0){draw();return;}
    ef++;cooldown--;
    if(keys['ArrowLeft'])player.x=Math.max(0,player.x-5);
    if(keys['ArrowRight'])player.x=Math.min(C.width-28,player.x+5);
    if(keys[' ']&&cooldown<=0){bullets.push({x:player.x+14,y:player.y});cooldown=22;}
    bullets.forEach(b=>b.y-=7);bullets=bullets.filter(b=>b.y>0);
    eBullets.forEach(b=>b.y+=4);eBullets=eBullets.filter(b=>b.y<C.height);
    if(ef%28===0){let hit=false;enemies.filter(e=>e.alive).forEach(e=>{e.x+=edir*14;if(e.x<10||e.x>C.width-32)hit=true;});if(hit){edir*=-1;enemies.filter(e=>e.alive).forEach(e=>e.y+=14);}}
    if(ef%35===0){const a=enemies.filter(e=>e.alive);if(a.length)eBullets.push({x:a[Math.floor(Math.random()*a.length)].x+11,y:a[0].y+16});}
    bullets.forEach((b,bi)=>enemies.forEach(e=>{if(e.alive&&b.x>e.x&&b.x<e.x+22&&b.y<e.y+16&&b.y>e.y){e.alive=false;bullets.splice(bi,1);score+=10;setScore('SCORE:'+score+'  LIVES:'+lives);}}));
    eBullets.forEach(b=>{if(Math.abs(b.x-(player.x+14))<14&&b.y>player.y&&b.y<player.y+player.h){lives--;setScore('SCORE:'+score+'  LIVES:'+lives);}});
    draw();
  }
  reset();gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);ef=0;edir=1;reset();gameInterval=setInterval(tick,16);});
}

function gameMemory(){
  const symbols=['üî•','üíé','üåô','‚≠ê','üéØ','üíú','üîÆ','üé≤'];
  let cards=[...symbols,...symbols].sort(()=>Math.random()-.5).map((s,i)=>({id:i,sym:s,flipped:false,matched:false}));
  let selected=[],moves=0,lock=false;
  const cont=getCont();
  function render(){
    let ex=document.getElementById('memUI');if(ex)ex.remove();
    const grid=document.createElement('div');grid.id='memUI';
    grid.style.cssText='display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-width:360px;';
    cards.forEach(card=>{
      const el=document.createElement('div');
      el.style.cssText='width:80px;height:80px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;cursor:pointer;border-radius:4px;border:2px solid '+(card.matched?'#06d6a0':card.flipped?'#8338ec':'rgba(255,255,255,0.15)')+';background:'+(card.flipped||card.matched?'#1a0a30':'#0d0d1a')+';transition:all .2s;';
      el.textContent=card.flipped||card.matched?card.sym:'?';
      el.onclick=()=>{
        if(lock||card.flipped||card.matched)return;
        card.flipped=true;selected.push(card);render();
        if(selected.length===2){moves++;setScore('MOVES: '+moves);lock=true;
          setTimeout(()=>{if(selected[0].sym===selected[1].sym){selected.forEach(c=>c.matched=true);}else{selected.forEach(c=>c.flipped=false);}selected=[];lock=false;render();
            if(cards.every(c=>c.matched))addMsg('üéâ COMPLETE IN '+moves+' MOVES!');},900);}
      };
      grid.appendChild(el);
    });
    cont.insertBefore(grid,cont.querySelector('#gamemsg'));
  }
  setScore('MOVES: 0');addMsg('FLIP CARDS TO FIND MATCHING PAIRS');render();
  addRestartBtn(()=>{cards=[...symbols,...symbols].sort(()=>Math.random()-.5).map((s,i)=>({id:i,sym:s,flipped:false,matched:false}));selected=[];moves=0;lock=false;setScore('MOVES: 0');addMsg('FLIP CARDS TO FIND MATCHING PAIRS');render();});
}

function gameReaction(){
  let state='waiting',startTime,score=0,round=0,times=[];
  const cont=getCont();
  function render(msg,sub){
    let ex=document.getElementById('rxUI');if(ex)ex.remove();
    const wrap=document.createElement('div');wrap.id='rxUI';wrap.style.cssText='display:flex;flex-direction:column;align-items:center;gap:16px;';
    const circle=document.createElement('div');circle.style.cssText='width:180px;height:180px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;user-select:none;border:3px solid '+(state==='GO'?'#06d6a0':state==='wait'?'#ff006e':'#333')+';background:'+(state==='GO'?'rgba(6,214,160,0.15)':state==='wait'?'rgba(255,0,110,0.1)':'#0d0d1a')+';transition:all .2s;';
    circle.innerHTML='<div style="font-size:1.1rem;font-family:Orbitron,sans-serif;color:'+(state==='GO'?'#06d6a0':state==='wait'?'#ff006e':'#aaa')+'">'+msg+'</div>'+(sub?'<div style="font-size:.7rem;color:rgba(255,255,255,.4);margin-top:8px">'+sub+'</div>':'');
    circle.onclick=()=>{
      if(state==='waiting'){state='wait';render('WAIT...','Don\'t click yet!');const delay=1500+Math.random()*3000;setTimeout(()=>{state='GO';startTime=Date.now();render('CLICK NOW!','Go go go!');},delay);}
      else if(state==='wait'){state='waiting';render('TOO EARLY!','Click to try again');}
      else if(state==='GO'){const rt=Date.now()-startTime;times.push(rt);round++;score=Math.round(1000/((times.reduce((a,b)=>a+b,0)/times.length)||1)*100);setScore('Avg: '+(times.reduce((a,b)=>a+b,0)/times.length).toFixed(0)+'ms | Score: '+score);state='waiting';render(rt+'ms','Round '+round+' ‚Äî Click to continue');}
    };
    const hist=document.createElement('div');hist.style.cssText='font-size:.68rem;color:rgba(255,255,255,.4);text-align:center;';hist.textContent=times.length?'Rounds: '+times.map(t=>t+'ms').join(' ¬∑ '):'';
    wrap.appendChild(circle);wrap.appendChild(hist);
    cont.insertBefore(wrap,cont.querySelector('#gamemsg'));
  }
  addMsg('CLICK THE CIRCLE WHEN IT TURNS GREEN');render('CLICK TO START');
  addRestartBtn(()=>{state='waiting';score=0;round=0;times=[];setScore('');addMsg('CLICK THE CIRCLE WHEN IT TURNS GREEN');render('CLICK TO START');});
}

function gameTyping(){
  const WORDS=['NEON','LASER','PIXEL','CYBER','VOID','GRID','ECHO','FLUX','WAVE','STORM','GLITCH','NOVA','PULSE','DRIFT','PRISM','WARP','PHASE'];
  const C=makeCanvas(520,360);const ctx=C.getContext('2d');
  let words=[],input='',score=0,lives=3,frame=0;
  function spawn(){words.push({word:WORDS[Math.floor(Math.random()*WORDS.length)],x:20+Math.random()*(C.width-120),y:-16,speed:.9+Math.random()*.8});}
  spawn();
  function draw(){
    ctx.fillStyle='#001a10';ctx.fillRect(0,0,C.width,C.height);
    ctx.strokeStyle='rgba(6,214,160,.18)';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(0,C.height-36);ctx.lineTo(C.width,C.height-36);ctx.stroke();ctx.setLineDash([]);
    words.forEach(w=>{const match=w.word.startsWith(input.toUpperCase());ctx.font='bold 17px Orbitron';ctx.textAlign='left';if(match&&input.length>0){ctx.fillStyle='#ffbe0b';ctx.fillText(input.toUpperCase(),w.x,w.y);ctx.fillStyle='rgba(255,255,255,.5)';ctx.fillText(w.word.slice(input.length),w.x+ctx.measureText(input.toUpperCase()).width,w.y);}else{ctx.fillStyle='#06d6a0';ctx.fillText(w.word,w.x,w.y);}});
    ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(0,C.height-35,C.width,35);
    ctx.fillStyle='#06d6a0';ctx.font='15px Share Tech Mono';ctx.textAlign='left';ctx.fillText('> '+input.toUpperCase()+'_',10,C.height-12);
    ctx.fillStyle='#ff006e';ctx.textAlign='right';ctx.fillText('‚ù§'.repeat(lives),C.width-8,C.height-12);
    ctx.fillStyle='#ffbe0b';ctx.textAlign='left';ctx.fillText('SCORE: '+score,8,18);
    if(lives<=0){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#ff006e';ctx.font='22px Orbitron';ctx.textAlign='center';ctx.shadowColor='#ff006e';ctx.shadowBlur=18;ctx.fillText('GAME OVER',C.width/2,C.height/2-10);ctx.fillStyle='#fff';ctx.font='12px Share Tech Mono';ctx.fillText('SCORE: '+score,C.width/2,C.height/2+18);ctx.shadowBlur=0;}
  }
  function tick(){
    if(lives<=0){draw();return;}
    frame++;words.forEach(w=>w.y+=w.speed);
    words=words.filter(w=>{if(w.y>C.height-36){lives--;setScore('SCORE:'+score+' LIVES:'+lives);return false;}return true;});
    if(frame%110===0)spawn();draw();
  }
  document.addEventListener('keydown',function tyK(e){
    if(!currentGame||currentGame!=='typing')return document.removeEventListener('keydown',tyK);
    if(lives<=0)return;
    if(e.key==='Backspace'){input=input.slice(0,-1);e.preventDefault();}
    else if(e.key.length===1&&/[a-zA-Z]/.test(e.key)){input+=e.key;e.preventDefault();}
    const idx=words.findIndex(w=>w.word===input.toUpperCase());
    if(idx>=0){words.splice(idx,1);score+=10;setScore('SCORE:'+score+' LIVES:'+lives);input='';spawn();}
  });
  setScore('SCORE:0 LIVES:3');addMsg('TYPE THE FALLING WORDS!');
  gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);words=[];input='';score=0;lives=3;frame=0;spawn();setScore('SCORE:0 LIVES:3');addMsg('TYPE THE FALLING WORDS!');gameInterval=setInterval(tick,16);});
}

function gameFlappy(){
  const C=makeCanvas(420,440);const ctx=C.getContext('2d');
  let bird,pipes,score,alive,started,frame;
  function reset(){bird={x:80,y:C.height/2,vy:0};pipes=[];score=0;alive=true;started=false;frame=0;addPipe();setScore(0);addMsg('SPACE or CLICK to flap');}
  function addPipe(){const th=70+Math.random()*(C.height-200);pipes.push({x:C.width,th});}
  const GAP=130,PW=46;
  function draw(){
    ctx.fillStyle='#000d1a';ctx.fillRect(0,0,C.width,C.height);
    for(let i=0;i<18;i++){ctx.fillStyle='rgba(255,255,255,.12)';ctx.fillRect((i*59)%C.width,(i*41)%C.height,1,1);}
    pipes.forEach(p=>{ctx.fillStyle='#06d6a0';ctx.shadowColor='#06d6a0';ctx.shadowBlur=12;ctx.fillRect(p.x,0,PW,p.th);ctx.fillRect(p.x,p.th+GAP,PW,C.height-p.th-GAP);ctx.shadowBlur=0;});
    ctx.fillStyle='#ffbe0b';ctx.shadowColor='#ffbe0b';ctx.shadowBlur=14;ctx.beginPath();ctx.arc(bird.x,bird.y,13,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle='#000';ctx.beginPath();ctx.arc(bird.x+4,bird.y-3,3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ffbe0b';ctx.font='14px Orbitron';ctx.textAlign='left';ctx.fillText('SCORE: '+score,8,22);
    if(!started&&alive){ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#00f5ff';ctx.font='13px Orbitron';ctx.textAlign='center';ctx.fillText('PRESS SPACE OR CLICK',C.width/2,C.height/2);}
    if(!alive){ctx.fillStyle='rgba(0,0,0,.7)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#ff006e';ctx.font='20px Orbitron';ctx.textAlign='center';ctx.fillText('GAME OVER',C.width/2,C.height/2-12);ctx.fillStyle='#fff';ctx.font='12px Share Tech Mono';ctx.fillText('SCORE: '+score,C.width/2,C.height/2+16);ctx.fillText('SPACE/CLICK TO RESTART',C.width/2,C.height/2+38);}
  }
  function tick(){
    frame++;
    if(!started||!alive){draw();return;}
    bird.vy+=.45;bird.y+=bird.vy;
    if(bird.y<13)bird.y=13;
    if(bird.y>C.height-13)alive=false;
    pipes.forEach(p=>{p.x-=2.8;if(bird.x+10>p.x&&bird.x-10<p.x+PW&&(bird.y-13<p.th||bird.y+13>p.th+GAP))alive=false;if(p.x+PW<0&&!p.scored){p.scored=true;score++;setScore(score);}});
    pipes=pipes.filter(p=>p.x>-PW-10);
    if(frame%90===0)addPipe();draw();
  }
  function flap(){if(!alive){reset();return;}if(!started)started=true;bird.vy=-9;}
  document.addEventListener('keydown',function fK(e){if(!currentGame||currentGame!=='flappy')return document.removeEventListener('keydown',fK);if(e.key===' '){flap();e.preventDefault();}});
  C.addEventListener('click',flap);
  reset();gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);reset();gameInterval=setInterval(tick,16);});
}

function gameMinesweeper(){
  const COLS=10,ROWS=9,MINES=14;
  let board,rev,flagged,over,won,first;
  const cont=getCont();
  function init(){
    board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
    rev=Array.from({length:ROWS},()=>Array(COLS).fill(false));
    flagged=Array.from({length:ROWS},()=>Array(COLS).fill(false));
    over=false;won=false;first=true;setScore('MINES: '+MINES);addMsg('CLICK to reveal  RIGHT-CLICK to flag');render();
  }
  function placeMines(fr,fc){
    let p=0;while(p<MINES){const r=Math.floor(Math.random()*ROWS),c=Math.floor(Math.random()*COLS);if(board[r][c]===-1||(Math.abs(r-fr)<=1&&Math.abs(c-fc)<=1))continue;board[r][c]=-1;p++;}
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){if(board[r][c]===-1)continue;let n=0;for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){if(r+dr>=0&&r+dr<ROWS&&c+dc>=0&&c+dc<COLS&&board[r+dr][c+dc]===-1)n++;}board[r][c]=n;}
  }
  function reveal(r,c){if(r<0||r>=ROWS||c<0||c>=COLS||rev[r][c]||flagged[r][c])return;rev[r][c]=true;if(board[r][c]===0){for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++)reveal(r+dr,c+dc);}}
  const NC=['','#00f5ff','#06d6a0','#ff006e','#ff4500','#ff0','#8338ec','#fff','#aaa'];
  function render(){
    let ex=document.getElementById('msUI');if(ex)ex.remove();
    const wrap=document.createElement('div');wrap.id='msUI';wrap.style.cssText='display:grid;grid-template-columns:repeat('+COLS+',1fr);gap:3px;max-width:400px;';
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
      const cell=document.createElement('div');
      const isRev=rev[r][c],isFlag=flagged[r][c],isMine=board[r][c]===-1;
      cell.style.cssText='width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:.75rem;cursor:pointer;border:1px solid rgba(255,255,255,.1);background:'+(isRev?'#0a0010':'#12001f')+';color:'+(isRev&&!isMine?NC[board[r][c]]||'#fff':'#fff')+';';
      cell.textContent=isRev?(isMine?'üí£':(board[r][c]>0?board[r][c]:'')):isFlag?'üö©':'';
      cell.onclick=()=>{if(over||won||flagged[r][c])return;if(first){placeMines(r,c);first=false;}if(board[r][c]===-1){rev[r][c]=true;over=true;for(let rr=0;rr<ROWS;rr++)for(let cc=0;cc<COLS;cc++)if(board[rr][cc]===-1)rev[rr][cc]=true;addMsg('üí• BOOM! Game over.');}else{reveal(r,c);const safe=ROWS*COLS-MINES;if(rev.flat().filter(Boolean).length>=safe){won=true;addMsg('üèÜ CLEARED! You win!');}}render();};
      cell.oncontextmenu=e=>{e.preventDefault();if(!rev[r][c])flagged[r][c]=!flagged[r][c];render();};
      wrap.appendChild(cell);
    }
    cont.insertBefore(wrap,cont.querySelector('#gamemsg'));
  }
  init();addRestartBtn(init);
}

function gameTicTacToe(){
  let board,turn,over;
  const cont=getCont();
  function init(){board=Array(9).fill('');turn='X';over=false;setScore('YOUR TURN (X)');addMsg('Click a cell to play vs CPU');render();}
  function check(b,p){const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];return wins.some(([a,b2,c])=>b[a]===p&&b[b2]===p&&b[c]===p);}
  function cpuMove(){const empty=board.map((v,i)=>v===''?i:-1).filter(i=>i>=0);if(!empty.length)return;for(const p of['O','X']){for(const i of empty){const t=[...board];t[i]=p;if(check(t,p)){board[i]='O';return;}}}const center=board[4]===''?4:-1;if(center>=0){board[4]='O';return;}const corners=[0,2,6,8].filter(i=>board[i]==='');if(corners.length){board[corners[Math.floor(Math.random()*corners.length)]]='O';return;}board[empty[Math.floor(Math.random()*empty.length)]]='O';}
  function render(){
    let ex=document.getElementById('ttUI');if(ex)ex.remove();
    const grid=document.createElement('div');grid.id='ttUI';grid.style.cssText='display:grid;grid-template-columns:repeat(3,1fr);gap:6px;max-width:260px;';
    board.forEach((val,i)=>{
      const cell=document.createElement('div');
      cell.style.cssText='width:82px;height:82px;display:flex;align-items:center;justify-content:center;font-size:2.2rem;cursor:'+(val||over?'default':'pointer')+';border:2px solid '+(val?'rgba(131,56,236,.7)':'rgba(255,255,255,.15)')+';background:#0d0d1a;color:'+(val==='X'?'#ff006e':'#06d6a0')+';transition:border-color .2s;';
      cell.textContent=val;
      cell.onclick=()=>{if(val||over||turn!=='X')return;board[i]='X';if(check(board,'X')){over=true;setScore('üèÜ YOU WIN!');addMsg('');render();return;}if(board.every(v=>v)){over=true;setScore('DRAW!');render();return;}turn='O';setScore('CPU THINKING...');render();setTimeout(()=>{cpuMove();if(check(board,'O')){over=true;setScore('CPU WINS!');addMsg('Better luck next time');}else if(board.every(v=>v)){over=true;setScore('DRAW!');}else{turn='X';setScore('YOUR TURN (X)');}render();},500);};
      grid.appendChild(cell);
    });
    cont.insertBefore(grid,cont.querySelector('#gamemsg'));
  }
  init();addRestartBtn(init);
}

function gameDodge(){
  const C=makeCanvas(420,440);const ctx=C.getContext('2d');
  let ship,meteors,score,alive,frame,mouseX;
  function reset(){ship={x:C.width/2,y:C.height-55};meteors=[];score=0;alive=true;frame=0;mouseX=C.width/2;spawnM();addMsg('MOVE MOUSE OVER CANVAS TO DODGE');setScore(0);}
  function spawnM(){meteors.push({x:20+Math.random()*(C.width-40),y:-20,r:8+Math.random()*14,vx:(Math.random()-.5)*2,vy:2.5+score*.015});}
  C.addEventListener('mousemove',e=>{const r=C.getBoundingClientRect();mouseX=(e.clientX-r.left)*(C.width/r.width);});
  function draw(){
    ctx.fillStyle='#00001a';ctx.fillRect(0,0,C.width,C.height);
    for(let i=0;i<22;i++){const x=(i*71)%C.width,y=(i*47+frame)%C.height;ctx.fillStyle='rgba(255,255,255,.2)';ctx.fillRect(x,y,1,1);}
    meteors.forEach(m=>{ctx.fillStyle='#ff4500';ctx.shadowColor='#ff4500';ctx.shadowBlur=10;ctx.beginPath();ctx.arc(m.x,m.y,m.r,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;});
    ctx.fillStyle='#00f5ff';ctx.shadowColor='#00f5ff';ctx.shadowBlur=16;
    ctx.beginPath();ctx.moveTo(ship.x,ship.y-16);ctx.lineTo(ship.x-11,ship.y+10);ctx.lineTo(ship.x+11,ship.y+10);ctx.closePath();ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='12px Orbitron';ctx.textAlign='left';ctx.fillText('SCORE: '+score,8,20);
    if(!alive){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#ff006e';ctx.font='22px Orbitron';ctx.textAlign='center';ctx.shadowColor='#ff006e';ctx.shadowBlur=18;ctx.fillText('DESTROYED!',C.width/2,C.height/2-10);ctx.fillStyle='#fff';ctx.font='12px Share Tech Mono';ctx.fillText('SCORE: '+score,C.width/2,C.height/2+18);ctx.shadowBlur=0;}
  }
  function tick(){
    if(!alive){draw();return;}
    frame++;ship.x+=(mouseX-ship.x)*.1;ship.x=Math.max(14,Math.min(C.width-14,ship.x));
    meteors.forEach(m=>{m.x+=m.vx;m.y+=m.vy;});
    meteors=meteors.filter(m=>{if(m.y>C.height+20){score++;setScore(score);return false;}return true;});
    if(frame%55===0)spawnM();
    meteors.forEach(m=>{if(Math.hypot(m.x-ship.x,m.y-ship.y)<m.r+10)alive=false;});
    draw();
  }
  reset();gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);reset();gameInterval=setInterval(tick,16);});
}

function gameNumberGuess(){
  let secret,guesses,over;
  const cont=getCont();
  function reset(){secret=Math.floor(Math.random()*100)+1;guesses=7;over=false;setScore('GUESSES LEFT: 7');addMsg('GUESS A NUMBER FROM 1 TO 100');renderInput();}
  function renderInput(){
    let ex=document.getElementById('ngUI');if(ex)ex.remove();
    const wrap=document.createElement('div');wrap.id='ngUI';wrap.style.cssText='display:flex;flex-direction:column;align-items:center;gap:10px;width:100%;';
    const inp=document.createElement('input');inp.type='number';inp.min=1;inp.max=100;inp.style.cssText='background:#0d0d1a;border:1px solid #00f5ff;color:#00f5ff;padding:10px 20px;font-size:1.3rem;text-align:center;width:160px;outline:none;font-family:Orbitron,sans-serif;';
    const btn=document.createElement('button');btn.className='restart-btn';btn.style.borderColor='#06d6a0';btn.style.color='#06d6a0';btn.textContent='GUESS';
    const hist=document.createElement('div');hist.id='ngHist';hist.style.cssText='color:rgba(255,255,255,.45);font-size:.72rem;text-align:center;line-height:1.8;max-height:120px;overflow-y:auto;width:100%;';
    function guess(){
      if(over)return;const v=parseInt(inp.value);if(!v||v<1||v>100){addMsg('Enter a number 1‚Äì100!');return;}
      guesses--;const h=document.getElementById('ngHist');
      if(v===secret){over=true;setScore('üèÜ FOUND IT IN '+(7-guesses)+' GUESSES!');addMsg('The number was '+secret+'!');h.innerHTML='<span style="color:#06d6a0">'+v+' ‚úì CORRECT!</span><br>'+h.innerHTML;}
      else{const hint=v<secret?'‚¨Ü TOO LOW':'‚¨á TOO HIGH';h.innerHTML='<span style="color:'+(v<secret?'#00f5ff':'#ff006e')+'">'+v+' '+hint+'</span><br>'+h.innerHTML;setScore('GUESSES LEFT: '+guesses);if(guesses<=0){over=true;addMsg('GAME OVER! Answer was '+secret);}}
      inp.value='';if(!over)inp.focus();
    }
    btn.onclick=guess;inp.onkeydown=e=>{if(e.key==='Enter')guess();};
    wrap.appendChild(inp);wrap.appendChild(btn);wrap.appendChild(hist);
    cont.insertBefore(wrap,cont.querySelector('#gamemsg'));
    setTimeout(()=>inp.focus(),80);
  }
  reset();addRestartBtn(reset);
}

function gameClicker(){
  let energy=0,perClick=1,perSec=0;
  const upgrades=[
    {name:'AMPLIFIER',cost:10,level:0,fn:()=>perClick++,baseCost:10},
    {name:'AUTO-BOT',cost:25,level:0,fn:()=>perSec++,baseCost:25},
    {name:'MULTIPLIER',cost:100,level:0,fn:()=>perClick+=5,baseCost:100},
    {name:'REACTOR',cost:200,level:0,fn:()=>perSec+=10,baseCost:200},
    {name:'QUANTUM CORE',cost:500,level:0,fn:()=>perClick*=2,baseCost:500},
  ];
  auxTimer=setInterval(()=>{energy+=perSec;render();},1000);
  function render(){
    setScore(Math.floor(energy)+' ENERGY');
    let ex=document.getElementById('ckUI');if(ex)ex.remove();
    const wrap=document.createElement('div');wrap.id='ckUI';wrap.style.cssText='display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;';
    const btn=document.createElement('div');btn.style.cssText='width:130px;height:130px;border-radius:50%;background:radial-gradient(circle,#1a0030,#0d0d1a);border:2px solid #8338ec;display:flex;align-items:center;justify-content:center;font-size:2.8rem;cursor:pointer;box-shadow:0 0 30px rgba(131,56,236,.4);user-select:none;transition:transform .06s;';btn.textContent='‚öõÔ∏è';
    btn.onclick=()=>{energy+=perClick;render();btn.style.transform='scale(0.9)';setTimeout(()=>btn.style.transform='scale(1)',70);};
    const stats=document.createElement('div');stats.style.cssText='color:rgba(255,255,255,.55);font-size:.72rem;text-align:center;';stats.textContent='+'+perClick+'/click  +'+perSec+'/sec';
    const ug=document.createElement('div');ug.style.cssText='display:flex;flex-direction:column;gap:5px;width:100%;max-width:300px;';
    upgrades.forEach(u=>{const can=energy>=u.cost;const row=document.createElement('div');row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:7px 12px;background:#0d0d1a;border:1px solid '+(can?'#8338ec':'rgba(131,56,236,.2)')+';opacity:'+(can?1:.5)+';cursor:'+(can?'pointer':'default')+';';row.innerHTML='<span style="font-size:.72rem">'+u.name+' <span style="opacity:.5">(Lv'+u.level+')</span></span><span style="color:#ffbe0b;font-size:.72rem">'+u.cost+' ‚ö°</span>';row.onclick=()=>{if(energy>=u.cost){energy-=u.cost;u.fn();u.level++;u.cost=Math.floor(u.cost*2.5);render();}};ug.appendChild(row);});
    wrap.appendChild(btn);wrap.appendChild(stats);wrap.appendChild(ug);
    const cont=getCont();cont.insertBefore(wrap,cont.querySelector('#gamemsg'));
    addMsg('CLICK TO HARVEST ENERGY');
  }
  render();
  addRestartBtn(()=>{clearInterval(auxTimer);energy=0;perClick=1;perSec=0;upgrades.forEach(u=>{u.level=0;u.cost=u.baseCost;});auxTimer=setInterval(()=>{energy+=perSec;render();},1000);render();});
}

function gameSimon(){
  const COLORS=['#ff006e','#06d6a0','#ffbe0b','#8338ec'];const NAMES=['RED','GREEN','YELLOW','PURPLE'];
  let sequence=[],playerSeq=[],round=0,accepting=false,over=false;
  const cont=getCont();
  const g=document.createElement('div');g.id='simonGrid';g.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:10px;';
  COLORS.forEach((c,i)=>{
    const btn=document.createElement('div');btn.id='simon'+i;
    btn.style.cssText='width:118px;height:118px;background:'+c+'35;border:2px solid '+c+';border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:Orbitron,sans-serif;font-size:.66rem;color:'+c+';letter-spacing:.1em;transition:all .1s;';btn.textContent=NAMES[i];
    btn.onclick=()=>{if(!accepting||over)return;lightUp(i);setTimeout(()=>lightDown(i),200);playerSeq.push(i);const idx=playerSeq.length-1;if(playerSeq[idx]!==sequence[idx]){over=true;addMsg('WRONG! Reached round '+round);return;}if(playerSeq.length===sequence.length)setTimeout(nextRound,700);};
    g.appendChild(btn);
  });
  cont.insertBefore(g,cont.querySelector('#gamemsg'));
  function lightUp(c){const el=document.getElementById('simon'+c);if(el){el.style.filter='brightness(2.5)';el.style.boxShadow='0 0 30px '+COLORS[c];}}
  function lightDown(c){const el=document.getElementById('simon'+c);if(el){el.style.filter='brightness(1)';el.style.boxShadow='none';}}
  function nextRound(){round++;setScore('ROUND: '+round);accepting=false;playerSeq=[];sequence.push(Math.floor(Math.random()*4));let i=0;function flash(){if(i>=sequence.length){accepting=true;addMsg('YOUR TURN ‚Äî REPEAT THE SEQUENCE');return;}const c=sequence[i];lightUp(c);setTimeout(()=>{lightDown(c);setTimeout(()=>{i++;flash();},220);},520);}setTimeout(flash,600);}
  addMsg('WATCH THE PATTERN THEN REPEAT IT');setScore('ROUND: 0');nextRound();
  addRestartBtn(()=>{sequence=[];playerSeq=[];round=0;accepting=false;over=false;COLORS.forEach((_,i)=>lightDown(i));addMsg('WATCH THE PATTERN THEN REPEAT IT');setScore('ROUND: 0');nextRound();});
}

function gameWordScramble(){
  const WORDS=[{w:'ARCADE',h:'A place with coin games'},{w:'PIXEL',h:'Smallest unit of display'},{w:'NEON',h:'Glowing gas used in signs'},{w:'CONSOLE',h:'A gaming system'},{w:'JOYSTICK',h:'A physical game controller'},{w:'SPRITE',h:'2D game character image'},{w:'POLYGON',h:'3D shape building block'},{w:'DUNGEON',h:'Underground RPG maze'},{w:'QUARTER',h:'Coin to insert in arcade'},{w:'VECTOR',h:'Line-based graphics style'},{w:'AVATAR',h:'Player representation'},{w:'RESPAWN',h:'Coming back after defeat'}];
  let word,scrambled,score=0,lives=3,tl,timer;
  function sc(w){const a=w.split('');for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a.join('');}
  function nextWord(){clearInterval(timer);tl=20;const e=WORDS[Math.floor(Math.random()*WORDS.length)];word=e.w;do{scrambled=sc(word);}while(scrambled===word);renderWord();}
  function renderWord(){
    let ex=document.getElementById('wsUI');if(ex)ex.remove();
    const wrap=document.createElement('div');wrap.id='wsUI';wrap.style.cssText='display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;';
    const tbar=document.createElement('div');tbar.style.cssText='width:85%;height:6px;background:#1a1a2e;border-radius:3px;overflow:hidden;';
    const fill=document.createElement('div');fill.id='twFill';fill.style.cssText='height:100%;width:100%;background:#06d6a0;transition:width 1s linear;';tbar.appendChild(fill);wrap.appendChild(tbar);
    const sd=document.createElement('div');sd.style.cssText='font-family:Orbitron,sans-serif;font-size:2rem;font-weight:700;color:#ffbe0b;letter-spacing:.25em;text-shadow:0 0 18px #ffbe0b;';sd.textContent=scrambled;wrap.appendChild(sd);
    const hd=document.createElement('div');hd.style.cssText='color:rgba(255,255,255,.4);font-size:.72rem;';hd.textContent='HINT: '+WORDS.find(x=>x.w===word).h;wrap.appendChild(hd);
    const inp=document.createElement('input');inp.type='text';inp.maxLength=word.length;inp.style.cssText='background:#0d0d1a;border:1px solid #00f5ff;color:#00f5ff;padding:10px 20px;font-family:Share Tech Mono,monospace;font-size:1.2rem;text-align:center;width:220px;outline:none;text-transform:uppercase;letter-spacing:.18em;';inp.placeholder=word.split('').map(()=>'_').join('');inp.oninput=()=>inp.value=inp.value.toUpperCase();
    inp.onkeydown=e=>{if(e.key!=='Enter')return;clearInterval(timer);if(inp.value===word){score+=tl;setScore('SCORE: '+score+'  LIVES: '+'‚ô•'.repeat(lives));addMsg('CORRECT! +'+tl+' pts');setTimeout(nextWord,900);}else{lives--;addMsg('WRONG! Answer: '+word);setScore('SCORE: '+score+'  LIVES: '+'‚ô•'.repeat(Math.max(0,lives)));if(lives<=0){addMsg('GAME OVER! Final: '+score);}else setTimeout(nextWord,1200);}};
    wrap.appendChild(inp);
    const info=document.createElement('div');info.style.cssText='color:rgba(255,255,255,.3);font-size:.68rem;';info.textContent='PRESS ENTER TO SUBMIT';wrap.appendChild(info);
    const cont=getCont();cont.insertBefore(wrap,cont.querySelector('#gamemsg'));
    setTimeout(()=>inp.focus(),50);
    timer=setInterval(()=>{tl--;const f=document.getElementById('twFill');if(f){f.style.width=(tl/20*100)+'%';f.style.background=tl>10?'#06d6a0':tl>5?'#ffbe0b':'#ff006e';}if(tl<=0){clearInterval(timer);lives--;addMsg('TIME UP! Answer: '+word);setScore('SCORE: '+score+'  LIVES: '+'‚ô•'.repeat(Math.max(0,lives)));if(lives<=0)addMsg('GAME OVER! Final: '+score);else setTimeout(nextWord,1200);}},1000);
  }
  setScore('SCORE: 0  LIVES: ‚ô•‚ô•‚ô•');addMsg('UNSCRAMBLE THE WORD IN 20 SECONDS!');nextWord();
  addRestartBtn(()=>{clearInterval(timer);score=0;lives=3;setScore('SCORE: 0  LIVES: ‚ô•‚ô•‚ô•');addMsg('UNSCRAMBLE THE WORD!');nextWord();});
}

// ============================================================
// ============================================================
// NEW 12 2D GAMES
// ============================================================
// ============================================================

// TETRIS
function gameTetris(){
  const C=makeCanvas(280,500);const ctx=C.getContext('2d');
  const COLS=10,ROWS=20,BS=C.width/COLS;
  const SHAPES=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,0],[1,0],[1,1]],[[0,1],[0,1],[1,1]],[[0,1,1],[1,1,0]],[[1,1,0],[0,1,1]]];
  const CLRS=['#00f5ff','#ffbe0b','#8338ec','#ff6b35','#00f5ff','#ff006e','#06d6a0'];
  let board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  let cur=spawn(),cx=3,cy=0,score=0,alive=true,tick2=0;
  function spawn(){const i=Math.floor(Math.random()*SHAPES.length);return{s:SHAPES[i],c:CLRS[i]};}
  function collides(s,ox,oy){return s.some((row,r)=>row.some((v,c)=>v&&(oy+r>=ROWS||ox+c<0||ox+c>=COLS||board[oy+r][ox+c])));}
  function place(){cur.s.forEach((row,r)=>row.forEach((v,c)=>{if(v)board[cy+r][cx+c]=cur.c;}));let lines=0;board=board.filter(row=>{if(row.every(v=>v)){lines++;return false;}return true;});while(board.length<ROWS)board.unshift(Array(COLS).fill(0));score+=lines*100;setScore('SCORE: '+score);cur=spawn();cx=3;cy=0;if(collides(cur.s,cx,cy))alive=false;}
  function rotate(s){return s[0].map((_,c)=>s.map(row=>row[c]).reverse());}
  function draw(){
    ctx.fillStyle='#00040a';ctx.fillRect(0,0,C.width,C.height);
    board.forEach((row,r)=>row.forEach((v,c)=>{if(v){ctx.fillStyle=v;ctx.shadowBlur=5;ctx.shadowColor=v;ctx.fillRect(c*BS+1,r*BS+1,BS-2,BS-2);ctx.shadowBlur=0;}}));
    cur.s.forEach((row,r)=>row.forEach((v,c)=>{if(v){ctx.fillStyle=cur.c;ctx.shadowBlur=10;ctx.shadowColor=cur.c;ctx.fillRect((cx+c)*BS+1,(cy+r)*BS+1,BS-2,BS-2);ctx.shadowBlur=0;}}));
    ctx.strokeStyle='rgba(0,245,255,.05)';for(let r=0;r<=ROWS;r++){ctx.beginPath();ctx.moveTo(0,r*BS);ctx.lineTo(C.width,r*BS);ctx.stroke();}for(let c=0;c<=COLS;c++){ctx.beginPath();ctx.moveTo(c*BS,0);ctx.lineTo(c*BS,C.height);ctx.stroke();}
    if(!alive){ctx.fillStyle='rgba(0,0,0,.8)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#ff006e';ctx.font='16px Orbitron';ctx.textAlign='center';ctx.fillText('GAME OVER',C.width/2,C.height/2-8);ctx.fillStyle='#fff';ctx.font='11px Share Tech Mono';ctx.fillText('SCORE: '+score,C.width/2,C.height/2+16);ctx.fillText('Press R to restart',C.width/2,C.height/2+36);}
  }
  const keys={};
  document.addEventListener('keydown',function tK(e){
    if(!currentGame||currentGame!=='tetris')return document.removeEventListener('keydown',tK);
    if(!alive)return;
    if(e.key==='ArrowLeft'&&!collides(cur.s,cx-1,cy))cx--;
    if(e.key==='ArrowRight'&&!collides(cur.s,cx+1,cy))cx++;
    if(e.key==='ArrowDown'){if(!collides(cur.s,cx,cy+1))cy++;else place();}
    if(e.key==='ArrowUp'){const r=rotate(cur.s);if(!collides(r,cx,cy))cur.s=r;}
    e.preventDefault();
  });
  setScore('SCORE: 0');addMsg('‚Üê ‚Üí move  ‚Üë rotate  ‚Üì drop');
  function loop(){
    tick2++;if(tick2%20===0){if(!alive){draw();return;}if(!collides(cur.s,cx,cy+1))cy++;else place();}draw();gameInterval=requestAnimationFrame(loop);
  }
  gameInterval=requestAnimationFrame(loop);
  addRestartBtn(()=>{cancelAnimationFrame(gameInterval);board=Array.from({length:ROWS},()=>Array(COLS).fill(0));cur=spawn();cx=3;cy=0;score=0;alive=true;tick2=0;setScore('SCORE: 0');gameInterval=requestAnimationFrame(loop);});
}

// ASTEROIDS
function gameAsteroids(){
  const C=makeCanvas(500,430);const ctx=C.getContext('2d');
  let ship,asteroids,bullets,score,alive,frame,bCool;
  function rand(min,max){return min+Math.random()*(max-min);}
  function spawnA(x,y,r){const ang=rand(0,Math.PI*2),spd=rand(.6,1.8);const pts=Array.from({length:8},(_,i)=>{const a=i/8*Math.PI*2;return{x:Math.cos(a)*(r+rand(-r*.3,r*.4)),y:Math.sin(a)*(r+rand(-r*.3,r*.4))};});asteroids.push({x,y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,r,pts});}
  function reset(){ship={x:C.width/2,y:C.height/2,angle:0,vx:0,vy:0};asteroids=[];bullets=[];score=0;alive=true;frame=0;bCool=0;for(let i=0;i<5;i++)spawnA(rand(0,C.width),rand(0,C.height),rand(25,38));setScore('SCORE: 0');addMsg('A/D rotate  W thrust  SPACE fire');}
  const keys={};
  document.addEventListener('keydown',function aK(e){if(!currentGame||currentGame!=='asteroids')return document.removeEventListener('keydown',aK);keys[e.key]=true;if(e.key===' ')e.preventDefault();});
  document.addEventListener('keyup',e=>keys[e.key]=false);
  function draw(){
    ctx.fillStyle='#050015';ctx.fillRect(0,0,C.width,C.height);
    for(let i=0;i<22;i++){ctx.fillStyle='rgba(255,255,255,.2)';ctx.fillRect((i*73)%C.width,(i*47)%C.height,1,1);}
    asteroids.forEach(a=>{ctx.strokeStyle='#8338ec';ctx.lineWidth=2;ctx.shadowBlur=8;ctx.shadowColor='#8338ec';ctx.beginPath();a.pts.forEach((p,i)=>ctx[i?'lineTo':'moveTo'](a.x+p.x,a.y+p.y));ctx.closePath();ctx.stroke();ctx.shadowBlur=0;});
    bullets.forEach(b=>{ctx.fillStyle='#ffbe0b';ctx.shadowBlur=8;ctx.shadowColor='#ffbe0b';ctx.beginPath();ctx.arc(b.x,b.y,3,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;});
    if(alive){ctx.save();ctx.translate(ship.x,ship.y);ctx.rotate(ship.angle);ctx.strokeStyle='#00f5ff';ctx.lineWidth=2;ctx.shadowBlur=12;ctx.shadowColor='#00f5ff';ctx.beginPath();ctx.moveTo(0,-16);ctx.lineTo(-10,12);ctx.lineTo(10,12);ctx.closePath();ctx.stroke();if(keys['w']||keys['ArrowUp']){ctx.strokeStyle='#ff4500';ctx.beginPath();ctx.moveTo(-5,12);ctx.lineTo(0,24);ctx.lineTo(5,12);ctx.stroke();}ctx.shadowBlur=0;ctx.restore();}
    ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='12px Share Tech Mono';ctx.textAlign='left';ctx.fillText('SCORE: '+score,8,20);
    if(!alive){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#8338ec';ctx.font='20px Orbitron';ctx.textAlign='center';ctx.shadowColor='#8338ec';ctx.shadowBlur=18;ctx.fillText('GAME OVER',C.width/2,C.height/2-8);ctx.fillStyle='#fff';ctx.font='11px Share Tech Mono';ctx.fillText('SCORE: '+score,C.width/2,C.height/2+18);ctx.shadowBlur=0;}
  }
  function tick(){
    if(!alive){draw();return;}
    frame++;bCool--;
    if(keys['a']||keys['ArrowLeft'])ship.angle-=.065;
    if(keys['d']||keys['ArrowRight'])ship.angle+=.065;
    if(keys['w']||keys['ArrowUp']){ship.vx+=Math.sin(ship.angle)*.22;ship.vy-=Math.cos(ship.angle)*.22;}
    ship.vx*=.98;ship.vy*=.98;
    ship.x=(ship.x+ship.vx+C.width)%C.width;ship.y=(ship.y+ship.vy+C.height)%C.height;
    if(keys[' ']&&bCool<=0){bullets.push({x:ship.x,y:ship.y,vx:Math.sin(ship.angle)*9,vy:-Math.cos(ship.angle)*9,life:55});bCool=14;}
    bullets=bullets.filter(b=>{b.x+=b.vx;b.y+=b.vy;b.life--;return b.life>0;});
    asteroids.forEach(a=>{a.x=(a.x+a.vx+C.width)%C.width;a.y=(a.y+a.vy+C.height)%C.height;});
    bullets.forEach((b,bi)=>{asteroids.forEach((a,ai)=>{if(Math.hypot(b.x-a.x,b.y-a.y)<a.r){bullets.splice(bi,1);score+=Math.floor(100/a.r);setScore('SCORE: '+score);if(a.r>18){spawnA(a.x,a.y,a.r*.55);spawnA(a.x,a.y,a.r*.55);}asteroids.splice(ai,1);if(asteroids.length===0)for(let i=0;i<6;i++)spawnA(rand(0,C.width),rand(0,C.height),28);}});});
    asteroids.forEach(a=>{if(Math.hypot(ship.x-a.x,ship.y-a.y)<a.r-5)alive=false;});
    draw();
  }
  reset();gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);reset();gameInterval=setInterval(tick,16);});
}

// PLATFORMER
function gamePlatformer(){
  const C=makeCanvas(480,380);const ctx=C.getContext('2d');
  const plats=[{x:0,y:350,w:480,h:30},{x:80,y:290,w:100,h:10},{x:240,y:250,w:90,h:10},{x:50,y:210,w:110,h:10},{x:300,y:170,w:80,h:10},{x:150,y:130,w:90,h:10},{x:320,y:90,w:100,h:10},{x:60,y:55,w:80,h:10}];
  const coins=[];plats.forEach((p,i)=>{if(i>0)coins.push({x:p.x+p.w/2,y:p.y-16,alive:true});});
  let player={x:50,y:320,w:14,h:20,vx:0,vy:0,og:false};let score=0,frame=0;const keys={};
  document.addEventListener('keydown',function pK(e){if(!currentGame||currentGame!=='platformer')return document.removeEventListener('keydown',pK);keys[e.key]=true;if(e.key===' ')e.preventDefault();});
  document.addEventListener('keyup',e=>keys[e.key]=false);
  function draw(){
    ctx.fillStyle='#000a00';ctx.fillRect(0,0,C.width,C.height);
    plats.forEach(p=>{ctx.fillStyle='#06d6a0';ctx.shadowBlur=10;ctx.shadowColor='#06d6a0';ctx.fillRect(p.x,p.y,p.w,p.h);ctx.shadowBlur=0;});
    coins.filter(c=>c.alive).forEach(c=>{ctx.fillStyle='#ffbe0b';ctx.shadowBlur=12;ctx.shadowColor='#ffbe0b';ctx.beginPath();ctx.arc(c.x,c.y,6,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;});
    ctx.fillStyle='#00f5ff';ctx.shadowBlur=12;ctx.shadowColor='#00f5ff';ctx.fillRect(player.x,player.y,player.w,player.h);ctx.shadowBlur=0;
    ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='12px Orbitron';ctx.textAlign='left';ctx.fillText('COINS: '+score,8,20);
    if(coins.every(c=>!c.alive)){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#06d6a0';ctx.font='18px Orbitron';ctx.textAlign='center';ctx.fillText('YOU WIN! üèÜ',C.width/2,C.height/2-8);ctx.fillStyle='#fff';ctx.font='11px Share Tech Mono';ctx.fillText('All coins collected!',C.width/2,C.height/2+18);}
  }
  setScore('COINS: 0');addMsg('A/D move  SPACE jump  Collect all coins!');
  function tick(){
    if(coins.every(c=>!c.alive)){draw();return;}
    if(keys['a']||keys['ArrowLeft'])player.vx=-4;else if(keys['d']||keys['ArrowRight'])player.vx=4;else player.vx=0;
    if((keys[' ']||keys['ArrowUp']||keys['w'])&&player.og){player.vy=-11;player.og=false;}
    player.vy+=.55;player.x+=player.vx;player.y+=player.vy;
    player.og=false;
    plats.forEach(p=>{if(player.x+player.w>p.x&&player.x<p.x+p.w&&player.y+player.h>p.y&&player.y+player.h<p.y+p.h+10&&player.vy>=0){player.y=p.y-player.h;player.vy=0;player.og=true;}});
    player.x=Math.max(0,Math.min(C.width-player.w,player.x));
    if(player.y>400){player.y=320;player.vy=0;}
    coins.forEach(c=>{if(c.alive&&Math.abs(player.x+player.w/2-c.x)<12&&Math.abs(player.y+player.h/2-c.y)<14){c.alive=false;score++;setScore('COINS: '+score);}});
    draw();
  }
  gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);player={x:50,y:320,w:14,h:20,vx:0,vy:0,og:false};score=0;coins.forEach(c=>c.alive=true);setScore('COINS: 0');gameInterval=setInterval(tick,16);});
}

// RACING
function gameRacing(){
  const C=makeCanvas(380,500);const ctx=C.getContext('2d');
  const LW=C.width/3,LANES=[LW/2,LW*1.5,LW*2.5];
  let player={x:C.width/2,y:C.height-85,w:28,h:48};
  let cars=[],score=0,alive=true,frame=0,roadOff=0;const keys={};
  function spawnCar(){const l=Math.floor(Math.random()*3);cars.push({x:LANES[l]-14,y:-60,w:28,h:48,c:['#ff006e','#00f5ff','#8338ec','#ff4500'][Math.floor(Math.random()*4)]});}
  document.addEventListener('keydown',function rK(e){if(!currentGame||currentGame!=='racing')return document.removeEventListener('keydown',rK);keys[e.key]=true;e.preventDefault();});
  document.addEventListener('keyup',e=>keys[e.key]=false);
  function draw(){
    ctx.fillStyle='#111118';ctx.fillRect(0,0,C.width,C.height);
    ctx.fillStyle='#1a1a2a';ctx.fillRect(0,0,C.width,C.height);
    for(let i=1;i<3;i++){ctx.strokeStyle='rgba(255,190,11,.35)';ctx.lineWidth=2;ctx.setLineDash([28,18]);ctx.beginPath();ctx.moveTo(i*LW,(roadOff)%46-46);ctx.lineTo(i*LW,C.height);ctx.stroke();ctx.setLineDash([]);}
    cars.forEach(c=>{ctx.fillStyle=c.c;ctx.shadowBlur=10;ctx.shadowColor=c.c;ctx.fillRect(c.x,c.y,c.w,c.h);ctx.fillStyle='rgba(0,0,0,.45)';ctx.fillRect(c.x+4,c.y+8,c.w-8,c.h-16);ctx.shadowBlur=0;});
    ctx.fillStyle='#ffbe0b';ctx.shadowBlur=14;ctx.shadowColor='#ffbe0b';ctx.fillRect(player.x,player.y,player.w,player.h);ctx.fillStyle='rgba(0,0,0,.45)';ctx.fillRect(player.x+4,player.y+8,player.w-8,player.h-16);ctx.shadowBlur=0;
    ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='12px Share Tech Mono';ctx.textAlign='left';ctx.fillText('SCORE: '+score,8,20);
    if(!alive){ctx.fillStyle='rgba(0,0,0,.78)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#ff006e';ctx.font='20px Orbitron';ctx.textAlign='center';ctx.shadowColor='#ff006e';ctx.shadowBlur=18;ctx.fillText('CRASH!',C.width/2,C.height/2-10);ctx.fillStyle='#fff';ctx.font='11px Share Tech Mono';ctx.fillText('SCORE: '+score,C.width/2,C.height/2+18);ctx.shadowBlur=0;}
  }
  function tick(){
    if(!alive){draw();return;}
    frame++;const spd=3+score*.018;roadOff+=spd;
    if(keys['ArrowLeft']||keys['a'])player.x=Math.max(0,player.x-5);
    if(keys['ArrowRight']||keys['d'])player.x=Math.min(C.width-player.w,player.x+5);
    cars.forEach(c=>c.y+=spd);
    cars=cars.filter(c=>{if(c.y>C.height+10){score++;setScore('SCORE: '+score);return false;}return true;});
    if(frame%65===0)spawnCar();
    cars.forEach(c=>{if(player.x<c.x+c.w&&player.x+player.w>c.x&&player.y<c.y+c.h&&player.y+player.h>c.y)alive=false;});
    draw();
  }
  setScore('SCORE: 0');addMsg('A / D  or  ‚Üê ‚Üí to steer');
  spawnCar();gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);cars=[];score=0;alive=true;frame=0;roadOff=0;player.x=C.width/2;spawnCar();setScore('SCORE: 0');gameInterval=setInterval(tick,16);});
}

// PIXEL PAINT
function gamePaint(){
  const C=makeCanvas(500,400);const ctx=C.getContext('2d');
  const PALETTE=['#ff006e','#ff4500','#ffbe0b','#06d6a0','#00f5ff','#8338ec','#fff','#000','#444','transparent'];
  let color='#ff006e',painting=false,brushSize=6;
  ctx.fillStyle='#111';ctx.fillRect(0,0,C.width,C.height);
  // Draw palette bar
  function drawPalette(){
    ctx.fillStyle='#0a0a18';ctx.fillRect(0,0,C.width,36);
    PALETTE.forEach((c,i)=>{
      ctx.fillStyle=c==='transparent'?'#333':c;ctx.fillRect(6+i*46,6,36,24);
      if(c==='transparent'){ctx.strokeStyle='#fff';ctx.lineWidth=1;ctx.strokeRect(6+i*46,6,36,24);ctx.beginPath();ctx.moveTo(6+i*46,30);ctx.lineTo(6+i*46+36,6);ctx.strokeStyle='#f00';ctx.stroke();}
      if(c===color){ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.strokeRect(5+i*46,5,38,26);}
    });
    ctx.fillStyle='rgba(255,255,255,.4)';ctx.font='10px Share Tech Mono';ctx.textAlign='right';ctx.fillText('SIZE:'+brushSize,C.width-6,22);
  }
  drawPalette();
  function getPos(e){const r=C.getBoundingClientRect();return{x:(e.clientX-r.left)*(C.width/r.width),y:(e.clientY-r.top)*(C.height/r.height)};}
  C.addEventListener('mousedown',e=>{const {x,y}=getPos(e);if(y<36){const ci=Math.floor((x-6)/46);if(ci>=0&&ci<PALETTE.length){color=PALETTE[ci];drawPalette();}return;}painting=true;ctx.beginPath();ctx.moveTo(x,y);});
  C.addEventListener('mousemove',e=>{if(!painting)return;const {x,y}=getPos(e);if(y<36)return;if(color==='transparent'){ctx.clearRect(x-brushSize,y-brushSize,brushSize*2,brushSize*2);ctx.fillStyle='#111';ctx.fillRect(x-brushSize,y-brushSize,brushSize*2,brushSize*2);}else{ctx.strokeStyle=color;ctx.lineWidth=brushSize;ctx.lineCap='round';ctx.lineTo(x,y);ctx.stroke();}});
  C.addEventListener('mouseup',()=>{painting=false;ctx.beginPath();});
  C.addEventListener('wheel',e=>{brushSize=Math.max(2,Math.min(30,brushSize+(e.deltaY>0?-1:1)));drawPalette();e.preventDefault();},{passive:false});
  setScore('');addMsg('Click palette to pick color ¬∑ Scroll to resize brush');
  addRestartBtn(()=>{ctx.fillStyle='#111';ctx.fillRect(0,0,C.width,C.height);drawPalette();color='#ff006e';});
}

// QUIZ
function gameQuiz(){
  const QS=[
    {q:'What does CPU stand for?',a:'Central Processing Unit',opts:['Central Processing Unit','Core Power Unit','Computer Program Utility','Central Program Uploader']},
    {q:'Which company made the SNES?',a:'Nintendo',opts:['Sega','Sony','Nintendo','Atari']},
    {q:'What language is Python named after?',a:"Monty Python's Flying Circus",opts:['A snake','Monty Python\'s Flying Circus','A math term','A Greek letter']},
    {q:'What does RAM stand for?',a:'Random Access Memory',opts:['Read And Modify','Random Access Memory','Runtime Array Module','Rapid Action Memory']},
    {q:'Which game has the highest Metacritic score?',a:'The Legend of Zelda: Ocarina of Time',opts:['Super Mario 64','Half-Life 2','The Legend of Zelda: Ocarina of Time','Halo: Combat Evolved']},
    {q:'What year was the first iPhone released?',a:'2007',opts:['2005','2006','2007','2008']},
    {q:'What does GPU stand for?',a:'Graphics Processing Unit',opts:['Graphics Processing Unit','General Performance Utility','Game Power Unit','Global Pixel Upscaler']},
    {q:'Who created Linux?',a:'Linus Torvalds',opts:['Bill Gates','Linus Torvalds','Dennis Ritchie','Steve Wozniak']},
    {q:'What is binary base?',a:'Base 2',opts:['Base 8','Base 16','Base 2','Base 10']},
    {q:'The @ symbol in email is called?',a:'At sign',opts:['At sign','Ampersand','Asterisk','Caret']},
    {q:'What does HTML stand for?',a:'HyperText Markup Language',opts:['HyperText Markup Language','High Transfer Mode Link','Hyper Transfer Meta Layer','HyperText Method Language']},
    {q:'First commercially successful home console?',a:'Atari 2600',opts:['Magnavox Odyssey','Colecovision','Atari 2600','Intellivision']},
    {q:'What is 1 KB equal to?',a:'1024 bytes',opts:['1000 bytes','512 bytes','2048 bytes','1024 bytes']},
    {q:'What does API stand for?',a:'Application Programming Interface',opts:['Automated Program Integrator','Application Programming Interface','Advanced Protocol Input','Async Process Interface']},
    {q:'Python was created by?',a:'Guido van Rossum',opts:['James Gosling','Brendan Eich','Guido van Rossum','Dennis Ritchie']},
    {q:'What year did Minecraft release (full)?',a:'2011',opts:['2009','2010','2011','2012']},
    {q:'Which sorting algorithm is fastest avg?',a:'Quicksort',opts:['Bubble Sort','Insertion Sort','Quicksort','Selection Sort']},
    {q:'RGB stands for?',a:'Red Green Blue',opts:['Red Green Blue','Rate Gain Boost','Render Grid Base','Red Graph Byte']},
    {q:'What is a pixel?',a:'Smallest unit of a digital image',opts:['A type of color','Smallest unit of a digital image','A rendering shader','A frame buffer bit']},
    {q:'Which company made Pac-Man?',a:'Namco',opts:['Atari','Konami','Namco','Capcom']},
  ];
  let idx=0,score=0,answered=false;const shuffled=[...QS].sort(()=>Math.random()-.5);
  const cont=getCont();
  function render(){
    let ex=document.getElementById('qzUI');if(ex)ex.remove();
    if(idx>=shuffled.length){setScore('FINAL SCORE: '+score+'/'+shuffled.length);addMsg('üéâ Quiz complete!');addRestartBtn(()=>{idx=0;score=0;answered=false;shuffled.sort(()=>Math.random()-.5);setScore('');addMsg('');render();});return;}
    const q=shuffled[idx];const opts=[...q.opts].sort(()=>Math.random()-.5);
    const wrap=document.createElement('div');wrap.id='qzUI';wrap.style.cssText='display:flex;flex-direction:column;gap:10px;width:100%;max-width:480px;';
    const qel=document.createElement('div');qel.style.cssText='color:#fff;font-size:.82rem;line-height:1.5;padding:12px;background:#0d0d1a;border-left:3px solid #00f5ff;';qel.textContent=(idx+1)+'. '+q.q;wrap.appendChild(qel);
    opts.forEach(opt=>{const btn=document.createElement('div');btn.style.cssText='padding:10px 14px;background:#0a0a18;border:1px solid rgba(255,255,255,.12);cursor:pointer;font-size:.75rem;transition:all .15s;color:rgba(255,255,255,.8);';btn.textContent=opt;
      btn.onclick=()=>{if(answered)return;answered=true;if(opt===q.a){btn.style.background='rgba(6,214,160,.2)';btn.style.borderColor='#06d6a0';btn.style.color='#06d6a0';score++;setScore('SCORE: '+score+'/'+(idx+1));}else{btn.style.background='rgba(255,0,110,.2)';btn.style.borderColor='#ff006e';btn.style.color='#ff006e';document.querySelectorAll('#qzUI > div').forEach(el=>{if(el.textContent===q.a){el.style.background='rgba(6,214,160,.2)';el.style.borderColor='#06d6a0';el.style.color='#06d6a0';}});}setTimeout(()=>{idx++;answered=false;render();},1200);};
      wrap.appendChild(btn);
    });
    cont.insertBefore(wrap,cont.querySelector('#gamemsg'));
  }
  setScore('SCORE: 0/0');addMsg('Select the correct answer!');render();
}

// MAZE
function gameMaze(){
  const C=makeCanvas(500,500);const ctx=C.getContext('2d');
  const COLS=21,ROWS=21,CS=C.width/COLS;
  let grid,player,end,solved;
  function generate(){
    grid=Array.from({length:ROWS},(_,r)=>Array.from({length:COLS},(_,c)=>({r,c,walls:[true,true,true,true],visited:false})));
    function idx(r,c){return r>=0&&r<ROWS&&c>=0&&c<COLS?grid[r][c]:null;}
    const stack=[grid[0][0]];grid[0][0].visited=true;
    while(stack.length){const cur=stack[stack.length-1];const neighbors=[[cur.r-1,cur.c],[cur.r+1,cur.c],[cur.r,cur.c-1],[cur.r,cur.c+1]].map(([r,c])=>idx(r,c)).filter(n=>n&&!n.visited);if(!neighbors.length){stack.pop();continue;}const next=neighbors[Math.floor(Math.random()*neighbors.length)];next.visited=true;const dr=next.r-cur.r,dc=next.c-cur.c;if(dr===1){cur.walls[2]=false;next.walls[0]=false;}if(dr===-1){cur.walls[0]=false;next.walls[2]=false;}if(dc===1){cur.walls[1]=false;next.walls[3]=false;}if(dc===-1){cur.walls[3]=false;next.walls[1]=false;}stack.push(next);}
    player={r:0,c:0};end={r:ROWS-1,c:COLS-1};solved=false;
  }
  function draw(){
    ctx.fillStyle='#100000';ctx.fillRect(0,0,C.width,C.height);
    ctx.strokeStyle='#ff006e';ctx.lineWidth=1.5;
    grid.forEach(row=>row.forEach(cell=>{const x=cell.c*CS,y=cell.r*CS;ctx.beginPath();if(cell.walls[0]){ctx.moveTo(x,y);ctx.lineTo(x+CS,y);}if(cell.walls[1]){ctx.moveTo(x+CS,y);ctx.lineTo(x+CS,y+CS);}if(cell.walls[2]){ctx.moveTo(x,y+CS);ctx.lineTo(x+CS,y+CS);}if(cell.walls[3]){ctx.moveTo(x,y);ctx.lineTo(x,y+CS);}ctx.stroke();}));
    ctx.fillStyle='#06d6a0';ctx.shadowBlur=14;ctx.shadowColor='#06d6a0';ctx.beginPath();ctx.arc(end.c*CS+CS/2,end.r*CS+CS/2,CS/3,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle='#00f5ff';ctx.shadowBlur=12;ctx.shadowColor='#00f5ff';ctx.beginPath();ctx.arc(player.c*CS+CS/2,player.r*CS+CS/2,CS/3,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    if(solved){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#06d6a0';ctx.font='20px Orbitron';ctx.textAlign='center';ctx.shadowColor='#06d6a0';ctx.shadowBlur=18;ctx.fillText('ESCAPED! üèÜ',C.width/2,C.height/2);ctx.shadowBlur=0;}
  }
  document.addEventListener('keydown',function mK(e){
    if(!currentGame||currentGame!=='maze')return document.removeEventListener('keydown',mK);
    if(solved)return;const cell=grid[player.r][player.c];
    if(e.key==='ArrowUp'&&!cell.walls[0])player.r--;
    if(e.key==='ArrowRight'&&!cell.walls[1])player.c++;
    if(e.key==='ArrowDown'&&!cell.walls[2])player.r++;
    if(e.key==='ArrowLeft'&&!cell.walls[3])player.c--;
    e.preventDefault();
    if(player.r===end.r&&player.c===end.c)solved=true;
    draw();
  });
  generate();setScore('');addMsg('ARROW KEYS to navigate to the green exit');draw();
  addRestartBtn(()=>{generate();draw();});
}

// CONNECT 4
function gameConnect4(){
  const COLS=7,ROWS=6;let board,turn,over;
  const cont=getCont();
  function init(){board=Array.from({length:ROWS},()=>Array(COLS).fill(0));turn=1;over=false;setScore('YOUR TURN (RED)');addMsg('Click a column to drop your token');render();}
  function check(b,p){
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
      if(c+3<COLS&&[0,1,2,3].every(i=>b[r][c+i]===p))return true;
      if(r+3<ROWS&&[0,1,2,3].every(i=>b[r+i][c]===p))return true;
      if(r+3<ROWS&&c+3<COLS&&[0,1,2,3].every(i=>b[r+i][c+i]===p))return true;
      if(r+3<ROWS&&c-3>=0&&[0,1,2,3].every(i=>b[r+i][c-i]===p))return true;
    }return false;
  }
  function drop(col){if(over)return;let row=-1;for(let r=ROWS-1;r>=0;r--){if(!board[r][col]){row=r;break;}}if(row<0)return;board[row][col]=turn;if(check(board,turn)){over=true;setScore((turn===1?'YOU WIN! üèÜ':'CPU WINS'));addMsg(turn===1?'Congratulations!':'Better luck next time');render();return;}if(board[0].every((_,c)=>board[0][c]!==0)){over=true;setScore('DRAW!');render();return;}turn=turn===1?2:1;if(turn===2){setScore('CPU THINKING...');render();setTimeout(cpuTurn,400);}else setScore('YOUR TURN (RED)');render();}
  function cpuTurn(){let best=-1;for(let c=0;c<COLS;c++){const b2=board.map(r=>[...r]);let row=-1;for(let r=ROWS-1;r>=0;r--){if(!b2[r][c]){row=r;break;}}if(row<0)continue;b2[row][c]=2;if(check(b2,2)){best=c;break;}b2[row][c]=0;}if(best<0)for(let c=0;c<COLS;c++){const b2=board.map(r=>[...r]);let row=-1;for(let r=ROWS-1;r>=0;r--){if(!b2[r][c]){row=r;break;}}if(row<0)continue;b2[row][c]=1;if(check(b2,1)){best=c;break;}b2[row][c]=0;}if(best<0){const avail=[...Array(COLS).keys()].filter(c=>board[0][c]===0);best=avail[Math.floor(Math.random()*avail.length)]||0;}drop(best);}
  function render(){
    let ex=document.getElementById('c4UI');if(ex)ex.remove();
    const wrap=document.createElement('div');wrap.id='c4UI';wrap.style.cssText='display:grid;grid-template-columns:repeat(7,1fr);gap:5px;background:#0a0a30;padding:10px;border:1px solid rgba(0,0,255,.3);';
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){const cell=document.createElement('div');cell.style.cssText='width:52px;height:52px;border-radius:50%;background:'+(board[r][c]===1?'#ff006e':board[r][c]===2?'#ffbe0b':'#0d0d28')+';border:2px solid '+(board[r][c]===1?'#ff006e':board[r][c]===2?'#ffbe0b':'rgba(255,255,255,.1)')+';cursor:'+(over||r>0||board[0][c]?'default':'pointer')+';transition:all .15s;box-shadow:'+(board[r][c]===1?'0 0 12px #ff006e':board[r][c]===2?'0 0 12px #ffbe0b':'none')+';';cell.onclick=()=>{if(!over&&turn===1)drop(c);};wrap.appendChild(cell);}
    cont.insertBefore(wrap,cont.querySelector('#gamemsg'));
  }
  init();addRestartBtn(init);
}

// WHACK-A-BOT
function gameWhack(){
  const C=makeCanvas(420,420);const ctx=C.getContext('2d');
  let holes,score,lives,frame,active,missed,raf2;
  function reset(){holes=Array.from({length:9},(_,i)=>({x:60+(i%3)*140,y:80+Math.floor(i/3)*130,show:false,timer:0}));score=0;lives=3;frame=0;active=0;missed=0;setScore('SCORE:0 LIVES:3');addMsg('CLICK bots to smash them!');}
  function draw(){
    ctx.fillStyle='#0a0500';ctx.fillRect(0,0,C.width,C.height);
    holes.forEach(h=>{ctx.fillStyle='#1a0a00';ctx.shadowBlur=8;ctx.shadowColor='#333';ctx.beginPath();ctx.ellipse(h.x,h.y+18,34,14,0,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
      if(h.show){ctx.fillStyle='#ffbe0b';ctx.shadowBlur=16;ctx.shadowColor='#ffbe0b';ctx.beginPath();ctx.arc(h.x,h.y,28,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(h.x-9,h.y-5,5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(h.x+9,h.y-5,5,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ff0';ctx.fillRect(h.x-8,h.y+7,16,4);ctx.shadowBlur=0;}
    });
    ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='12px Orbitron';ctx.textAlign='left';ctx.fillText('SCORE:'+score,8,20);
    ctx.fillStyle='#ff006e';ctx.textAlign='right';ctx.fillText('‚ù§'.repeat(Math.max(0,lives)),C.width-8,20);
    if(lives<=0){ctx.fillStyle='rgba(0,0,0,.78)';ctx.fillRect(0,0,C.width,C.height);ctx.fillStyle='#ff006e';ctx.font='20px Orbitron';ctx.textAlign='center';ctx.shadowColor='#ff006e';ctx.shadowBlur=18;ctx.fillText('GAME OVER',C.width/2,C.height/2-8);ctx.fillStyle='#fff';ctx.font='11px Share Tech Mono';ctx.fillText('SCORE: '+score,C.width/2,C.height/2+18);ctx.shadowBlur=0;}
  }
  const speed=()=>Math.max(20,60-score);
  function tick(){
    if(lives<=0){draw();return;}
    frame++;active--;
    if(active<=0){const show=holes.filter(h=>h.show);if(show.length<3){const avail=holes.filter(h=>!h.show);if(avail.length){const h=avail[Math.floor(Math.random()*avail.length)];h.show=true;h.timer=speed();}}active=8;}
    holes.forEach(h=>{if(h.show){h.timer--;if(h.timer<=0){h.show=false;lives--;setScore('SCORE:'+score+' LIVES:'+lives);}}});
    draw();
  }
  C.addEventListener('click',e=>{if(lives<=0){reset();return;}const r=C.getBoundingClientRect();const mx=(e.clientX-r.left)*(C.width/r.width),my=(e.clientY-r.top)*(C.height/r.height);holes.forEach(h=>{if(h.show&&Math.hypot(mx-h.x,my-h.y)<30){h.show=false;h.timer=0;score+=10;setScore('SCORE:'+score+' LIVES:'+lives);}});});
  reset();gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);reset();gameInterval=setInterval(tick,16);});
}

// RHYTHM
function gameRhythm(){
  const C=makeCanvas(480,440);const ctx=C.getContext('2d');
  const LANES=4,LANE_W=C.width/LANES,STRIKE_Y=C.height-60;
  const COLORS=['#ff006e','#00f5ff','#06d6a0','#ffbe0b'];
  const KEYS=['a','s','d','f'];
  let notes=[],score=0,combo=0,maxCombo=0,frame=0;
  function spawnNote(){const lane=Math.floor(Math.random()*LANES);notes.push({lane,y:-20,speed:4+score*.003});}
  function draw(){
    ctx.fillStyle='#1a0010';ctx.fillRect(0,0,C.width,C.height);
    for(let i=0;i<LANES;i++){ctx.fillStyle='rgba(255,255,255,.04)';ctx.fillRect(i*LANE_W,0,LANE_W-2,C.height);}
    ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(0,STRIKE_Y-6,C.width,60);
    for(let i=0;i<LANES;i++){ctx.fillStyle=COLORS[i]+'55';ctx.strokeStyle=COLORS[i];ctx.lineWidth=2;ctx.shadowBlur=12;ctx.shadowColor=COLORS[i];ctx.fillRect(i*LANE_W+8,STRIKE_Y+2,LANE_W-18,40);ctx.strokeRect(i*LANE_W+8,STRIKE_Y+2,LANE_W-18,40);ctx.shadowBlur=0;ctx.fillStyle='rgba(255,255,255,.8)';ctx.font='bold 14px Share Tech Mono';ctx.textAlign='center';ctx.fillText(KEYS[i].toUpperCase(),(i+.5)*LANE_W,STRIKE_Y+26);}
    notes.forEach(n=>{ctx.fillStyle=COLORS[n.lane];ctx.shadowBlur=14;ctx.shadowColor=COLORS[n.lane];ctx.fillRect(n.lane*LANE_W+8,n.y,LANE_W-18,28);ctx.shadowBlur=0;});
    ctx.fillStyle='rgba(255,255,255,.7)';ctx.font='12px Orbitron';ctx.textAlign='left';ctx.fillText('SCORE: '+score,8,22);ctx.fillText('COMBO: x'+combo,8,40);
  }
  function hit(lane){const tol=50;const match=notes.findIndex(n=>n.lane===lane&&Math.abs(n.y+14-STRIKE_Y)<tol);if(match>=0){notes.splice(match,1);score+=10*(combo+1);combo++;maxCombo=Math.max(maxCombo,combo);setScore('SCORE: '+score+' | COMBO: x'+combo);}else{combo=0;}}
  document.addEventListener('keydown',function rK(e){
    if(!currentGame||currentGame!=='rhythm')return document.removeEventListener('keydown',rK);
    const idx=KEYS.indexOf(e.key);if(idx>=0)hit(idx);
  });
  setScore('SCORE: 0');addMsg('Press A S D F when notes hit the bar!');
  function tick(){frame++;notes.forEach(n=>n.y+=n.speed);notes=notes.filter(n=>{if(n.y>C.height){combo=0;return false;}return true;});if(frame%40===0)spawnNote();draw();}
  gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);notes=[];score=0;combo=0;frame=0;setScore('SCORE: 0');gameInterval=setInterval(tick,16);});
}

// WORDLE
function gameWordle(){
  const WORDS=['CYBER','PIXEL','NEONS','LASER','GRIDS','BYTES','CORES','DRIVE','MOUSE','FRAME','STACK','LOOPS','DEBUG','PATCH','QUERY'];
  let secret,guesses,current,over;
  const cont=getCont();
  function init(){secret=WORDS[Math.floor(Math.random()*WORDS.length)];guesses=[];current='';over=false;setScore('GUESS THE 5-LETTER WORD IN 6 TRIES');addMsg('Type 5 letters and press ENTER');render();}
  function render(){
    let ex=document.getElementById('wdUI');if(ex)ex.remove();
    const wrap=document.createElement('div');wrap.id='wdUI';wrap.style.cssText='display:flex;flex-direction:column;gap:6px;align-items:center;';
    for(let r=0;r<6;r++){const row=document.createElement('div');row.style.cssText='display:flex;gap:5px;';
      for(let c=0;c<5;c++){const cell=document.createElement('div');const isGuessed=r<guesses.length;const letter=isGuessed?guesses[r][c].l:(r===guesses.length&&c<current.length?current[c]:'');const state=isGuessed?guesses[r][c].s:'';cell.style.cssText='width:52px;height:52px;display:flex;align-items:center;justify-content:center;font-family:Orbitron,sans-serif;font-size:1.3rem;font-weight:700;border:2px solid '+(state==='correct'?'#06d6a0':state==='present'?'#ffbe0b':state==='absent'?'#444':letter?'rgba(255,255,255,.4)':'rgba(255,255,255,.15)')+';background:'+(state==='correct'?'rgba(6,214,160,.2)':state==='present'?'rgba(255,190,11,.2)':state==='absent'?'rgba(50,50,50,.5)':'#0d0d1a')+';color:'+(state==='correct'?'#06d6a0':state==='present'?'#ffbe0b':'#fff')+';';cell.textContent=letter;row.appendChild(cell);}
      wrap.appendChild(row);}
    const status=document.createElement('div');status.style.cssText='color:rgba(255,255,255,.4);font-size:.68rem;margin-top:4px;text-align:center;';status.textContent='Remaining: '+(6-guesses.length)+' guesses';wrap.appendChild(status);
    cont.insertBefore(wrap,cont.querySelector('#gamemsg'));
  }
  document.addEventListener('keydown',function wK(e){
    if(!currentGame||currentGame!=='wordle')return document.removeEventListener('keydown',wK);
    if(over)return;
    if(e.key==='Backspace'){current=current.slice(0,-1);render();}
    else if(e.key==='Enter'&&current.length===5){
      const result=current.split('').map((l,i)=>{let s='absent';if(l===secret[i])s='correct';else if(secret.includes(l))s='present';return{l,s};});
      guesses.push(result);
      if(result.every(r=>r.s==='correct')){over=true;setScore('üèÜ CORRECT! Word was '+secret);addMsg('Brilliant!');} else if(guesses.length>=6){over=true;setScore('GAME OVER ¬∑ Word was: '+secret);addMsg('Better luck next time!');}
      current='';render();
    } else if(e.key.length===1&&/[a-zA-Z]/.test(e.key)&&current.length<5){current+=e.key.toUpperCase();render();}
  });
  init();addRestartBtn(()=>{init();});
}

// MINI CHESS
function gameChess(){
  const board=[
    ['bR','bN','bB','bQ','bK','bB','bN','bR'],
    ['bP','bP','bP','bP','bP','bP','bP','bP'],
    ['','','','','','','',''],['','','','','','','',''],
    ['','','','','','','',''],['','','','','','','',''],
    ['wP','wP','wP','wP','wP','wP','wP','wP'],
    ['wR','wN','wB','wQ','wK','wB','wN','wR'],
  ];
  const SYM={wK:'‚ôî',wQ:'‚ôï',wR:'‚ôñ',wB:'‚ôó',wN:'‚ôò',wP:'‚ôô',bK:'‚ôö',bQ:'‚ôõ',bR:'‚ôú',bB:'‚ôù',bN:'‚ôû',bP:'‚ôü'};
  let selected=null,turn='w',over=false;
  const cont=getCont();
  function render(){
    let ex=document.getElementById('chUI');if(ex)ex.remove();
    const wrap=document.createElement('div');wrap.id='chUI';wrap.style.cssText='display:grid;grid-template-columns:repeat(8,1fr);gap:1px;border:2px solid rgba(255,255,255,.2);';
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
      const cell=document.createElement('div');const isLight=(r+c)%2===0;const piece=board[r][c];const isSel=selected&&selected[0]===r&&selected[1]===c;
      cell.style.cssText='width:56px;height:56px;display:flex;align-items:center;justify-content:center;font-size:1.7rem;cursor:pointer;background:'+(isSel?'rgba(255,190,11,.4)':isLight?'#d4a96a':'#8b6343')+';transition:filter .1s;';
      cell.textContent=piece?SYM[piece]||'':'';
      cell.onclick=()=>{
        if(over)return;
        if(selected){
          const [sr,sc]=selected;
          if(sr===r&&sc===c){selected=null;render();return;}
          if(board[r][c]&&board[r][c][0]===turn&&!(sr===r&&sc===c)){selected=[r,c];render();return;}
          // simple move (no full chess validation, just basic capture)
          const piece2=board[sr][sc];
          if(board[r][c]&&board[r][c][0]===turn){selected=[r,c];render();return;}
          board[r][c]=piece2;board[sr][sc]='';selected=null;
          if(!board.flat().includes('bK')){over=true;setScore('‚ôî YOU WIN!');}
          else if(!board.flat().includes('wK')){over=true;setScore('CPU WINS');}
          else{turn='b';setScore('CPU THINKING...');render();setTimeout(cpuMove,600);}
          render();
        } else {
          if(piece&&piece[0]===turn){selected=[r,c];render();}
        }
      };
      wrap.appendChild(cell);
    }
    cont.insertBefore(wrap,cont.querySelector('#gamemsg'));
  }
  function cpuMove(){if(over)return;const bPieces=[];for(let r=0;r<8;r++)for(let c=0;c<8;c++)if(board[r][c]&&board[r][c][0]==='b')bPieces.push([r,c]);if(!bPieces.length)return;const [sr,sc]=bPieces[Math.floor(Math.random()*bPieces.length)];const targets=[];for(let r=0;r<8;r++)for(let c=0;c<8;c++)if(!board[r][c]||board[r][c][0]==='w')targets.push([r,c]);if(!targets.length)return;const [tr,tc]=targets[Math.floor(Math.random()*targets.length)];board[tr][tc]=board[sr][sc];board[sr][sc]='';if(!board.flat().includes('wK')){over=true;setScore('CPU WINS!');}turn='w';setScore('YOUR TURN (WHITE)');render();}
  setScore('YOUR TURN (WHITE)');addMsg('Click a piece, then click where to move');render();
  addRestartBtn(gameChess);
}

// ============================================================
// ============================================================
// 3 WEBGL 3D GAMES using Three.js
// ============================================================
// ============================================================

// 3D GAME 1: CUBE BLAST
function gameCube3D(){
  const cont = getCont();
  const W=560,H=420;
  const wrapper=document.createElement('div');wrapper.style.cssText='position:relative;width:'+W+'px;height:'+H+'px;max-width:100%;cursor:crosshair;';
  const canvas=document.createElement('canvas');canvas.width=W;canvas.height=H;canvas.style.cssText='width:100%;height:100%;display:block;';
  wrapper.appendChild(canvas);cont.insertBefore(wrapper,cont.querySelector('#gamemsg'));
  const renderer=new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setSize(W,H);renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.shadowMap.enabled=true;
  const scene=new THREE.Scene();scene.background=new THREE.Color(0x050010);
  scene.fog=new THREE.FogExp2(0x050010,.04);
  const camera=new THREE.PerspectiveCamera(70,W/H,.1,200);camera.position.set(0,4,14);camera.lookAt(0,0,0);
  // Lights
  const alight=new THREE.AmbientLight(0x220044,.8);scene.add(alight);
  const plight=new THREE.PointLight(0x00f5ff,2,40);plight.position.set(0,10,0);scene.add(plight);
  const plight2=new THREE.PointLight(0xff006e,2,30);plight2.position.set(-10,5,-5);scene.add(plight2);
  // Floor grid
  const grid=new THREE.GridHelper(30,30,0x112244,0x081122);scene.add(grid);
  // Cubes
  const cubes=[];const COLORS_C=[0xff006e,0x00f5ff,0x06d6a0,0xffbe0b,0x8338ec,0xff4500];
  function spawnCube(){
    const geo=new THREE.BoxGeometry(1.2,1.2,1.2);
    const mat=new THREE.MeshPhongMaterial({color:COLORS_C[Math.floor(Math.random()*COLORS_C.length)],emissive:COLORS_C[Math.floor(Math.random()*COLORS_C.length)],emissiveIntensity:.3,shininess:100});
    const mesh=new THREE.Mesh(geo,mat);
    mesh.position.set((Math.random()-.5)*20,1+Math.random()*5,(Math.random()-.5)*12-3);
    mesh.castShadow=true;scene.add(mesh);
    cubes.push({mesh,vy:-(.01+Math.random()*.02),alive:true});
    if(cubes.length>40)cubes.shift();
  }
  for(let i=0;i<20;i++)spawnCube();
  // Crosshair raycaster
  const raycaster=new THREE.Raycaster();const mouse=new THREE.Vector2();
  let score=0,shots=30,frame2=0;
  canvas.addEventListener('mousemove',e=>{const r=canvas.getBoundingClientRect();mouse.x=((e.clientX-r.left)/r.width)*2-1;mouse.y=-((e.clientY-r.top)/r.height)*2+1;});
  canvas.addEventListener('click',e=>{
    if(shots<=0)return;shots--;
    raycaster.setFromCamera(mouse,camera);
    const meshes=cubes.filter(c=>c.alive).map(c=>c.mesh);
    const intersects=raycaster.intersectObjects(meshes);
    if(intersects.length){const hit=cubes.find(c=>c.mesh===intersects[0].object);if(hit){hit.alive=false;scene.remove(hit.mesh);score+=10;setScore('SCORE: '+score+' | SHOTS: '+shots);spawnCube();spawnCube();}}
  });
  setScore('SCORE: 0 | SHOTS: 30');addMsg('AIM with mouse ¬∑ CLICK to shoot glowing cubes');
  let running=true;
  function animate(){
    if(!running)return;requestAnimationFrame(animate);frame2++;
    cubes.forEach(c=>{if(c.alive){c.mesh.rotation.x+=.01;c.mesh.rotation.y+=.015;c.mesh.position.y+=c.vy;if(c.mesh.position.y<.6){c.vy=Math.abs(c.vy);}}});
    if(frame2%80===0)spawnCube();
    camera.position.x=Math.sin(frame2*.005)*3;
    renderer.render(scene,camera);
    if(shots<=0){const overlay=new THREE.Mesh(new THREE.PlaneGeometry(100,100),new THREE.MeshBasicMaterial({color:0,transparent:true,opacity:.7}));overlay.position.z=1;camera.add(overlay);scene.add(camera);addMsg('OUT OF AMMO! SCORE: '+score);running=false;}
  }
  animate();
  gameCleanup=()=>{running=false;renderer.dispose();};
  addRestartBtn(()=>{gameCleanup();setTimeout(()=>gameCube3D(),80);});
}

// 3D GAME 2: TURBO DRIFT RACING
function gameRace3D(){
  const cont=getCont();
  const W=560,H=420;
  const wrapper=document.createElement('div');wrapper.style.cssText='position:relative;width:'+W+'px;height:'+H+'px;max-width:100%;';
  const canvas=document.createElement('canvas');canvas.width=W;canvas.height=H;canvas.style.cssText='width:100%;height:100%;display:block;';
  wrapper.appendChild(canvas);cont.insertBefore(wrapper,cont.querySelector('#gamemsg'));
  const renderer=new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setSize(W,H);renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.shadowMap.enabled=true;
  const scene=new THREE.Scene();scene.background=new THREE.Color(0x000010);
  scene.fog=new THREE.Fog(0x000010,30,80);
  const camera=new THREE.PerspectiveCamera(65,W/H,.1,200);camera.position.set(0,3,8);camera.lookAt(0,0,-5);
  // Lights
  scene.add(new THREE.AmbientLight(0x111133,.9));
  const headlight=new THREE.SpotLight(0xffffff,2,40,.4);headlight.position.set(0,3,6);scene.add(headlight);
  const neonL=new THREE.PointLight(0xff006e,3,20);neonL.position.set(-8,1,0);scene.add(neonL);
  const neonR=new THREE.PointLight(0x00f5ff,3,20);neonR.position.set(8,1,0);scene.add(neonR);
  // Road
  const roadMat=new THREE.MeshPhongMaterial({color:0x111122,shininess:80});
  const roadGeo=new THREE.PlaneGeometry(10,200);const road=new THREE.Mesh(roadGeo,roadMat);
  road.rotation.x=-Math.PI/2;road.position.z=-80;scene.add(road);
  // Road stripes
  const stripes=[];function makeStripe(z){const s=new THREE.Mesh(new THREE.PlaneGeometry(.2,4),new THREE.MeshBasicMaterial({color:0xffff00}));s.rotation.x=-Math.PI/2;s.position.set(0,.02,z);scene.add(s);stripes.push(s);}
  for(let i=0;i<20;i++)makeStripe(-i*8);
  // Neon barriers
  function makeBarrier(x,z){const b=new THREE.Mesh(new THREE.BoxGeometry(.3,1,8),new THREE.MeshPhongMaterial({color:x<0?0xff006e:0x00f5ff,emissive:x<0?0xff006e:0x00f5ff,emissiveIntensity:.5}));b.position.set(x,.5,z);scene.add(b);return b;}
  const lWall=[],rWall=[];for(let i=0;i<12;i++){lWall.push(makeBarrier(-5.5,-i*14));rWall.push(makeBarrier(5.5,-i*14));}
  // Player car
  const carGroup=new THREE.Group();
  const carBody=new THREE.Mesh(new THREE.BoxGeometry(1.6,.5,3),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x00f5ff,emissiveIntensity:.2,shininess:200}));
  carBody.position.y=.25;carGroup.add(carBody);
  const carRoof=new THREE.Mesh(new THREE.BoxGeometry(1.2,.45,1.8),new THREE.MeshPhongMaterial({color:0x002244,shininess:100}));
  carRoof.position.set(0,.7,-.1);carGroup.add(carRoof);
  [[.8,0,1.4],[-.8,0,1.4],[.8,0,-1.4],[-.8,0,-1.4]].forEach(([x,y,z])=>{const w=new THREE.Mesh(new THREE.CylinderGeometry(.35,.35,.3,12),new THREE.MeshPhongMaterial({color:0x222222,shininess:50}));w.rotation.z=Math.PI/2;w.position.set(x,y,z);carGroup.add(w);});
  carGroup.position.set(0,.6,4);scene.add(carGroup);
  // Obstacles
  const obstacles=[];function spawnObs(){const x=(Math.random()-.5)*7;const geo=new THREE.BoxGeometry(1.5,1.2,2.5);const mat=new THREE.MeshPhongMaterial({color:0x8338ec,emissive:0x8338ec,emissiveIntensity:.2});const mesh=new THREE.Mesh(geo,mat);mesh.position.set(x,1,-60);scene.add(mesh);obstacles.push({mesh,passed:false});}
  for(let i=0;i<6;i++)spawnObs();
  let carX=0,score=0,alive=true,speed=.4,frame3=0;const keys={};
  document.addEventListener('keydown',function rrK(e){if(!currentGame||currentGame!=='race3d')return document.removeEventListener('keydown',rrK);keys[e.key]=true;e.preventDefault();});
  document.addEventListener('keyup',e=>keys[e.key]=false);
  setScore('SCORE: 0');addMsg('A / D  or  ‚Üê ‚Üí to steer ¬∑ Avoid purple obstacles!');
  let running=true;
  function animate(){
    if(!running)return;requestAnimationFrame(animate);frame3++;
    if(!alive){renderer.render(scene,camera);return;}
    speed=Math.min(.9,.4+score*.002);
    if(keys['a']||keys['ArrowLeft'])carX=Math.max(-3.8,carX-.06);
    if(keys['d']||keys['ArrowRight'])carX=Math.min(3.8,carX+.06);
    carGroup.position.x+=(carX-carGroup.position.x)*.1;
    carGroup.rotation.z=(carX-carGroup.position.x)*.3;
    // Scroll stripes and walls
    stripes.forEach(s=>{s.position.z+=speed;if(s.position.z>6)s.position.z-=160;});
    lWall.forEach(w=>{w.position.z+=speed;if(w.position.z>6)w.position.z-=168;});
    rWall.forEach(w=>{w.position.z+=speed;if(w.position.z>6)w.position.z-=168;});
    // Obstacles
    obstacles.forEach(o=>{o.mesh.position.z+=speed;o.mesh.rotation.y+=.02;if(o.mesh.position.z>8){o.mesh.position.z=-60;o.mesh.position.x=(Math.random()-.5)*7;o.passed=false;}if(o.mesh.position.z>2&&!o.passed){o.passed=true;score++;setScore('SCORE: '+score);}if(Math.abs(o.mesh.position.x-carGroup.position.x)<1.3&&o.mesh.position.z>3&&o.mesh.position.z<6){alive=false;addMsg('CRASH! SCORE: '+score);}});
    neonL.position.z=carGroup.position.z-5;neonR.position.z=carGroup.position.z-5;
    renderer.render(scene,camera);
  }
  animate();
  gameCleanup=()=>{running=false;renderer.dispose();};
  addRestartBtn(()=>{gameCleanup();setTimeout(()=>gameRace3D(),80);});
}

// 3D GAME 3: NEON DUNGEON FPS
function gameFPS3D(){
  const cont=getCont();
  const W=560,H=420;
  const wrapper=document.createElement('div');wrapper.style.cssText='position:relative;width:'+W+'px;height:'+H+'px;max-width:100%;cursor:none;';
  const canvas=document.createElement('canvas');canvas.width=W;canvas.height=H;canvas.style.cssText='width:100%;height:100%;display:block;';
  // Crosshair overlay
  const chDiv=document.createElement('div');chDiv.style.cssText='position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:20px;height:20px;pointer-events:none;';chDiv.innerHTML='<div style="position:absolute;top:50%;left:0;width:100%;height:2px;background:#0f0;transform:translateY(-50%)"></div><div style="position:absolute;left:50%;top:0;height:100%;width:2px;background:#0f0;transform:translateX(-50%)"></div>';
  wrapper.appendChild(canvas);wrapper.appendChild(chDiv);
  cont.insertBefore(wrapper,cont.querySelector('#gamemsg'));
  const renderer=new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setSize(W,H);renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  const scene=new THREE.Scene();scene.background=new THREE.Color(0x000000);scene.fog=new THREE.Fog(0x000000,2,28);
  const camera=new THREE.PerspectiveCamera(80,W/H,.05,100);camera.position.set(0,1.6,0);
  // Lights
  scene.add(new THREE.AmbientLight(0x110022,.6));
  const torchL=new THREE.PointLight(0xff4500,2,10);camera.add(torchL);scene.add(camera);
  // Dungeon walls
  const wallMat=new THREE.MeshPhongMaterial({color:0x222233,shininess:20});
  const floorMat=new THREE.MeshPhongMaterial({color:0x111122,shininess:5});
  const ceilMat=new THREE.MeshPhongMaterial({color:0x0a0a18,shininess:2});
  const MAZE_MAP=[
    [1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,1,0,0,0,0,1],
    [1,0,1,0,1,0,1,1,0,1],
    [1,0,1,0,0,0,1,0,0,1],
    [1,0,1,1,1,0,1,0,1,1],
    [1,0,0,0,1,0,0,0,0,1],
    [1,1,1,0,1,1,1,1,0,1],
    [1,0,0,0,0,0,0,1,0,1],
    [1,0,1,1,1,0,1,0,0,1],
    [1,1,1,1,1,1,1,1,1,1],
  ];
  const CELL=4;
  MAZE_MAP.forEach((row,r)=>row.forEach((v,c)=>{
    if(v){const wall=new THREE.Mesh(new THREE.BoxGeometry(CELL,4,CELL),wallMat);wall.position.set(c*CELL,2,r*CELL);scene.add(wall);
      // Neon trim
      const trim=new THREE.Mesh(new THREE.BoxGeometry(CELL,.08,CELL),new THREE.MeshBasicMaterial({color:0x00f5ff}));trim.position.set(c*CELL,3.9,r*CELL);scene.add(trim);}
    else{const fl=new THREE.Mesh(new THREE.PlaneGeometry(CELL,CELL),floorMat);fl.rotation.x=-Math.PI/2;fl.position.set(c*CELL,0,r*CELL);scene.add(fl);
      const cl=new THREE.Mesh(new THREE.PlaneGeometry(CELL,CELL),ceilMat);cl.rotation.x=Math.PI/2;cl.position.set(c*CELL,4,r*CELL);scene.add(cl);}
  }));
  // Neon lights in dungeon
  const neonColors=[0xff006e,0x00f5ff,0x06d6a0,0x8338ec];
  [[1.5,3,1.5],[4,3,5],[7,3,7],[3,3,8]].forEach((pos,i)=>{const nl=new THREE.PointLight(neonColors[i%4],3,10);nl.position.set(...pos);scene.add(nl);});
  // Enemies (floating orbs)
  const enemies=[];const enemyPositions=[[3*CELL,1.6,3*CELL],[7*CELL,1.6,5*CELL],[3*CELL,1.6,7*CELL],[7*CELL,1.6,7*CELL],[5*CELL,1.6,2*CELL]];
  enemyPositions.forEach((pos,i)=>{
    const geo=new THREE.SphereGeometry(.5,12,12);const mat=new THREE.MeshPhongMaterial({color:0xff2200,emissive:0xff0000,emissiveIntensity:.5,shininess:100});
    const mesh=new THREE.Mesh(geo,mat);mesh.position.set(...pos);scene.add(mesh);
    const elight=new THREE.PointLight(0xff2200,2,5);mesh.add(elight);
    enemies.push({mesh,alive:true,t:Math.random()*Math.PI*2});
  });
  // Gun mesh (simple)
  const gunGroup=new THREE.Group();const gunBody=new THREE.Mesh(new THREE.BoxGeometry(.12,.1,.4),new THREE.MeshPhongMaterial({color:0x444444}));gunBody.position.set(.18,-.15,.1);gunGroup.add(gunBody);camera.add(gunGroup);
  camera.position.set(1.5*CELL,1.6,1.5*CELL);
  // Controls
  const keys2={};let yaw=0,pitch=0,score=0,ammo=20,alive=true;
  document.addEventListener('keydown',function fK(e){if(!currentGame||currentGame!=='fps3d')return document.removeEventListener('keydown',fK);keys2[e.key]=true;e.preventDefault();});
  document.addEventListener('keyup',e=>keys2[e.key]=false);
  // Mouse look
  let lastX=W/2,lastY=H/2,mouseLookActive=false;
  canvas.addEventListener('click',()=>{canvas.requestPointerLock&&canvas.requestPointerLock();});
  document.addEventListener('pointerlockchange',()=>{mouseLookActive=document.pointerLockElement===canvas;});
  document.addEventListener('mousemove',e=>{
    if(!mouseLookActive)return;
    yaw-=e.movementX*.002;pitch-=e.movementY*.002;pitch=Math.max(-1.1,Math.min(1.1,pitch));
  });
  // Shoot
  const raycaster2=new THREE.Raycaster();
  canvas.addEventListener('mousedown',e=>{
    if(e.button!==0||!alive||ammo<=0)return;ammo--;
    setScore('ENEMIES: '+(enemies.filter(en=>en.alive).length)+' | AMMO: '+ammo);
    raycaster2.setFromCamera(new THREE.Vector2(0,0),camera);
    const meshes=enemies.filter(en=>en.alive).map(en=>en.mesh);
    const hits=raycaster2.intersectObjects(meshes);
    if(hits.length){const en=enemies.find(en=>en.mesh===hits[0].object);if(en){en.alive=false;scene.remove(en.mesh);score+=100;setScore('SCORE: '+score+' | ENEMIES LEFT: '+enemies.filter(en=>en.alive).length+' | AMMO: '+ammo);}}
    // Gun kick
    gunGroup.position.z=.1;setTimeout(()=>gunGroup.position.z=0,80);
  });
  function isWall(x,z){const col=Math.round(x/CELL),row=Math.round(z/CELL);if(row<0||row>=MAZE_MAP.length||col<0||col>=MAZE_MAP[0].length)return true;return MAZE_MAP[row][col]===1;}
  setScore('ENEMIES: '+enemies.length+' | AMMO: 20');addMsg('WASD move ¬∑ Mouse look ¬∑ CLICK to shoot ¬∑ Click canvas to capture mouse');
  let running=true,frame4=0;
  function animate(){
    if(!running)return;requestAnimationFrame(animate);frame4++;
    if(alive){
      const spd=.07;const fwd=new THREE.Vector3(-Math.sin(yaw),0,-Math.cos(yaw)).multiplyScalar(spd);const rgt=new THREE.Vector3(-Math.sin(yaw+Math.PI/2),0,-Math.cos(yaw+Math.PI/2)).multiplyScalar(spd);
      const oldX=camera.position.x,oldZ=camera.position.z;
      if(keys2['w']||keys2['ArrowUp']){camera.position.add(fwd);}
      if(keys2['s']||keys2['ArrowDown']){camera.position.sub(fwd);}
      if(keys2['a']||keys2['ArrowLeft']){camera.position.sub(rgt);}
      if(keys2['d']||keys2['ArrowRight']){camera.position.add(rgt);}
      if(isWall(camera.position.x,camera.position.z)){camera.position.x=oldX;camera.position.z=oldZ;}
      camera.rotation.order='YXZ';camera.rotation.y=yaw;camera.rotation.x=pitch;
      torchL.position.copy(camera.position);
    }
    enemies.forEach(en=>{if(!en.alive)return;en.t+=.02;en.mesh.position.y=1.6+Math.sin(en.t)*.3;en.mesh.rotation.y+=.03;if(Math.random()<.002&&Math.hypot(en.mesh.position.x-camera.position.x,en.mesh.position.z-camera.position.z)<8){alive=false;addMsg('YOU DIED! Score: '+score);}});
    if(enemies.every(en=>!en.alive)){addMsg('üèÜ ALL ENEMIES DEFEATED! Score: '+score);alive=false;}
    renderer.render(scene,camera);
  }
  animate();
  gameCleanup=()=>{running=false;renderer.dispose();document.exitPointerLock&&document.exitPointerLock();};
  addRestartBtn(()=>{gameCleanup();setTimeout(()=>gameFPS3D(),80);});
}

// ============================================================

// ============================================================
// HELPERS FOR NEW 3D GAMES
// ============================================================
function g3Canvas(w,h){
  const c=document.createElement('canvas');c.width=w;c.height=h;
  c.style.cssText='max-width:100%;display:block;border:1px solid rgba(255,107,53,0.4);cursor:crosshair;';
  getCont().appendChild(c);return c;
}
function g3Renderer(canvas,shadows){
  const r=new THREE.WebGLRenderer({canvas,antialias:true});
  r.setSize(canvas.width,canvas.height);r.setPixelRatio(Math.min(devicePixelRatio,2));
  if(shadows)r.shadowMap.enabled=true;return r;
}
function g3Loop(fn){let on=true;(function tick(){if(!on)return;requestAnimationFrame(tick);fn();})();return()=>on=false;}
function mkMesh(geo,mat,px,py,pz){const m=new THREE.Mesh(geo,mat);m.position.set(px||0,py||0,pz||0);return m;}
function mkLight(type,col,intensity,dist,px,py,pz){
  const l=type==='point'?new THREE.PointLight(col,intensity,dist):type==='dir'?new THREE.DirectionalLight(col,intensity):new THREE.AmbientLight(col,intensity);
  if(px!==undefined)l.position.set(px,py,pz);return l;
}

// ============================================================
// G3-1: VOID ARMADA ‚Äî 3D Space Shooter
// ============================================================
function g3SpaceShooter(){
  const cv=g3Canvas(580,420),rr=g3Renderer(cv);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x000008);
  const cam=new THREE.PerspectiveCamera(68,580/420,.1,200);
  cam.position.set(0,6,0);cam.rotation.x=-Math.PI/2.3;
  sc.add(mkLight('ambient',0x112244,1));
  const pl=mkLight('point',0x4466ff,2,100,0,40,0);sc.add(pl);
  // Stars
  const sg=new THREE.BufferGeometry(),sv=[];
  for(let i=0;i<1200;i++)sv.push((Math.random()-.5)*200,(Math.random()-.5)*100,(Math.random()-.5)*200);
  sg.setAttribute('position',new THREE.Float32BufferAttribute(sv,3));
  sc.add(new THREE.Points(sg,new THREE.PointsMaterial({color:0xffffff,size:.25})));
  // Player ship
  const sg2=new THREE.Group();
  const hull=new THREE.Mesh(new THREE.ConeGeometry(.7,2.4,6),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x003366,emissiveIntensity:.4,shininess:180}));
  hull.rotation.x=Math.PI;sg2.add(hull);
  const wing=new THREE.Mesh(new THREE.BoxGeometry(3.2,.12,.9),new THREE.MeshPhongMaterial({color:0x005577}));
  wing.position.y=-.3;sg2.add(wing);
  const tl=new THREE.PointLight(0x00aaff,3,6);tl.position.y=.9;sg2.add(tl);
  sg2.position.set(0,0,9);sc.add(sg2);
  const enemies=[],pb=[],eb=[];let score=0,lives=3,frame=0,cool=0;
  function spawnE(){
    const g=new THREE.Group();
    const m=new THREE.Mesh(new THREE.OctahedronGeometry(.75,0),new THREE.MeshPhongMaterial({color:0x8338ec,emissive:0x440088,emissiveIntensity:.4}));
    g.add(m);g.position.set((Math.random()-.5)*18,0,-35-Math.random()*15);sc.add(g);
    enemies.push({g,m,spd:.04+score*.0003});
  }
  for(let i=0;i<10;i++)spawnE();
  const mx={x:0};
  cv.addEventListener('mousemove',e=>{const r=cv.getBoundingClientRect();mx.x=((e.clientX-r.left)/r.width-.5)*18;});
  function fire(){if(cool>0)return;cool=10;const b=new THREE.Mesh(new THREE.CylinderGeometry(.07,.07,.9,6),new THREE.MeshBasicMaterial({color:0x00ffff}));b.position.copy(sg2.position);b.position.z-=1.5;sc.add(b);pb.push({m:b,vz:-.62});}
  cv.addEventListener('click',fire);
  document.addEventListener('keydown',function vak(e){if(currentGame!=='g3_spaceshooter')return document.removeEventListener('keydown',vak);if(e.key===' '){fire();e.preventDefault();}});
  setScore('SCORE:0 | LIVES:‚ô•‚ô•‚ô•');addMsg('MOUSE to steer ¬∑ CLICK or SPACE to fire');
  const stop=g3Loop(()=>{
    frame++;cool--;
    sg2.position.x+=(mx.x-sg2.position.x)*.09;sg2.position.x=Math.max(-8,Math.min(8,sg2.position.x));
    sg2.rotation.z=-(mx.x-sg2.position.x)*.05;
    if(frame%22===0)fire();
    enemies.forEach(e=>{e.g.position.z+=e.spd;e.m.rotation.y+=.04;
      if(e.g.position.z>10){lives--;e.g.position.set((Math.random()-.5)*18,0,-35);setScore('SCORE:'+score+' | LIVES:'+'‚ô•'.repeat(Math.max(0,lives)));if(lives<=0)addMsg('GAME OVER! Score:'+score);}
      if(frame%80===0&&Math.random()<.5){const b=new THREE.Mesh(new THREE.SphereGeometry(.2,6,6),new THREE.MeshBasicMaterial({color:0xff00ff}));b.position.copy(e.g.position);sc.add(b);eb.push({m:b,vz:.18});}
    });
    if(frame%100===0)spawnE();
    for(let i=pb.length-1;i>=0;i--){pb[i].m.position.z+=pb[i].vz;let hit=false;
      for(let j=enemies.length-1;j>=0;j--){if(Math.hypot(pb[i].m.position.x-enemies[j].g.position.x,pb[i].m.position.z-enemies[j].g.position.z)<1.2){sc.remove(pb[i].m);pb.splice(i,1);sc.remove(enemies[j].g);enemies.splice(j,1);score+=10;setScore('SCORE:'+score+' | LIVES:'+'‚ô•'.repeat(lives));spawnE();hit=true;break;}}
      if(!hit&&pb[i]&&pb[i].m.position.z<-55){sc.remove(pb[i].m);pb.splice(i,1);}
    }
    for(let i=eb.length-1;i>=0;i--){eb[i].m.position.z+=eb[i].vz;
      if(Math.hypot(eb[i].m.position.x-sg2.position.x,eb[i].m.position.z-sg2.position.z)<1.2){lives--;sc.remove(eb[i].m);eb.splice(i,1);setScore('SCORE:'+score+' | LIVES:'+'‚ô•'.repeat(Math.max(0,lives)));}
      else if(eb[i]&&eb[i].m.position.z>12){sc.remove(eb[i].m);eb.splice(i,1);}
    }
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};
  addRestartBtn(()=>{gameCleanup();setTimeout(g3SpaceShooter,60);});
}

// ============================================================
// G3-2: IRON TANK ARENA
// ============================================================
function g3Tank(){
  const cv=g3Canvas(580,420),rr=g3Renderer(cv,true);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x0a1005);sc.fog=new THREE.Fog(0x0a1005,40,120);
  sc.add(mkLight('ambient',0x334422,.9));
  const dl=mkLight('dir',0xffffaa,1.5,0,20,30,10);dl.castShadow=true;sc.add(dl);
  const cam=new THREE.PerspectiveCamera(65,580/420,.1,300);
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(80,80),new THREE.MeshPhongMaterial({color:0x1a2e10}));
  ground.rotation.x=-Math.PI/2;ground.receiveShadow=true;sc.add(ground);
  // Walls
  [[40,2,0,2,4,80],[-40,2,0,2,4,80],[0,2,40,80,4,2],[0,2,-40,80,4,2]].forEach(([x,y,z,w,h,d])=>{
    const wall=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshPhongMaterial({color:0x334422}));
    wall.position.set(x,y,z);sc.add(wall);
  });
  // Player tank
  const tg=new THREE.Group();
  const hull=new THREE.Mesh(new THREE.BoxGeometry(3,1,4.5),new THREE.MeshPhongMaterial({color:0x336633,shininess:30}));hull.position.set(0,.5,0);tg.add(hull);
  const turret=new THREE.Mesh(new THREE.CylinderGeometry(.9,.9,.6,10),new THREE.MeshPhongMaterial({color:0x2a5522}));turret.position.set(0,1.3,0);tg.add(turret);
  const barrel=new THREE.Mesh(new THREE.CylinderGeometry(.16,.16,2.5,8),new THREE.MeshPhongMaterial({color:0x1a3311}));
  barrel.position.set(0,1.55,1.6);barrel.rotation.x=Math.PI/2;tg.add(barrel);
  tg.position.set(5,0,5);sc.add(tg);
  const enemies=[];
  function spawnEnemy(){
    const eg=new THREE.Group();
    const eh=new THREE.Mesh(new THREE.BoxGeometry(2.5,.8,3.5),new THREE.MeshPhongMaterial({color:0x660000}));eh.position.set(0,.4,0);eg.add(eh);
    const et=new THREE.Mesh(new THREE.CylinderGeometry(.7,.7,.5,8),new THREE.MeshPhongMaterial({color:0x880000}));et.position.set(0,1,0);eg.add(et);
    const ebarrel=new THREE.Mesh(new THREE.CylinderGeometry(.13,.13,2,8),new THREE.MeshPhongMaterial({color:0x550000}));
    ebarrel.position.set(0,.95,1.2);ebarrel.rotation.x=Math.PI/2;eg.add(ebarrel);
    eg.position.set((Math.random()-.5)*60,0,(Math.random()-.5)*60);sc.add(eg);
    enemies.push({g:eg,hp:2,cool:80+Math.random()*80,alive:true});
  }
  for(let i=0;i<5;i++)spawnEnemy();
  const pb=[],eb=[];let score=0,hp=3,tAngle=0,cool=0,frame=0;
  const keys={};
  document.addEventListener('keydown',function tak(e){if(currentGame!=='g3_tank')return document.removeEventListener('keydown',tak);keys[e.key]=true;e.preventDefault();});
  document.addEventListener('keyup',e=>delete keys[e.key]);
  const mx={x:0};cv.addEventListener('mousemove',e=>{const r=cv.getBoundingClientRect();mx.x=((e.clientX-r.left)/r.width-.5)*2;});
  cv.addEventListener('click',()=>{
    if(cool>0)return;cool=22;
    const angle=tAngle+mx.x*Math.PI*.6;
    const dir=new THREE.Vector3(Math.sin(angle),0,Math.cos(angle));
    const b=new THREE.Mesh(new THREE.SphereGeometry(.25,6,6),new THREE.MeshBasicMaterial({color:0xffff00}));
    b.position.set(tg.position.x+dir.x*3,1.5,tg.position.z+dir.z*3);sc.add(b);pb.push({m:b,vx:dir.x*.8,vz:dir.z*.8});
  });
  setScore('SCORE:0 | HP:‚ô•‚ô•‚ô•');addMsg('WASD move ¬∑ MOUSE aim turret ¬∑ CLICK to fire');
  const stop=g3Loop(()=>{
    frame++;cool--;
    if(keys['a']||keys['ArrowLeft'])tAngle+=.04;if(keys['d']||keys['ArrowRight'])tAngle-=.04;
    if(keys['w']||keys['ArrowUp']){tg.position.x+=Math.sin(tAngle)*.13;tg.position.z+=Math.cos(tAngle)*.13;}
    if(keys['s']||keys['ArrowDown']){tg.position.x-=Math.sin(tAngle)*.13;tg.position.z-=Math.cos(tAngle)*.13;}
    tg.position.x=Math.max(-38,Math.min(38,tg.position.x));tg.position.z=Math.max(-38,Math.min(38,tg.position.z));
    tg.rotation.y=tAngle;
    cam.position.set(tg.position.x-Math.sin(tAngle)*10,9,tg.position.z-Math.cos(tAngle)*10);cam.lookAt(tg.position);
    for(let i=pb.length-1;i>=0;i--){pb[i].m.position.x+=pb[i].vx;pb[i].m.position.z+=pb[i].vz;let hit=false;
      for(let j=enemies.length-1;j>=0;j--){if(!enemies[j].alive)continue;
        if(Math.hypot(pb[i].m.position.x-enemies[j].g.position.x,pb[i].m.position.z-enemies[j].g.position.z)<2.2){
          enemies[j].hp--;sc.remove(pb[i].m);pb.splice(i,1);
          if(enemies[j].hp<=0){sc.remove(enemies[j].g);enemies[j].alive=false;score+=50;setScore('SCORE:'+score+' | HP:'+'‚ô•'.repeat(hp));spawnEnemy();}hit=true;break;}}
      if(!hit&&pb[i]&&(Math.abs(pb[i].m.position.x)>42||Math.abs(pb[i].m.position.z)>42)){sc.remove(pb[i].m);pb.splice(i,1);}
    }
    enemies.filter(e=>e.alive).forEach(e=>{e.cool--;
      const dx=tg.position.x-e.g.position.x,dz=tg.position.z-e.g.position.z,ang=Math.atan2(dx,dz);
      e.g.rotation.y=ang;e.g.position.x+=Math.sin(ang)*.04;e.g.position.z+=Math.cos(ang)*.04;
      if(e.cool<=0){e.cool=100+Math.random()*80;const b=new THREE.Mesh(new THREE.SphereGeometry(.2,6,6),new THREE.MeshBasicMaterial({color:0xff4400}));b.position.set(e.g.position.x,1,e.g.position.z);sc.add(b);eb.push({m:b,vx:Math.sin(ang)*.35,vz:Math.cos(ang)*.35});}
    });
    for(let i=eb.length-1;i>=0;i--){eb[i].m.position.x+=eb[i].vx;eb[i].m.position.z+=eb[i].vz;
      if(Math.hypot(eb[i].m.position.x-tg.position.x,eb[i].m.position.z-tg.position.z)<2){hp--;sc.remove(eb[i].m);eb.splice(i,1);setScore('SCORE:'+score+' | HP:'+'‚ô•'.repeat(Math.max(0,hp)));if(hp<=0)addMsg('TANK DESTROYED! Score:'+score);}
      else if(eb[i]&&(Math.abs(eb[i].m.position.x)>42||Math.abs(eb[i].m.position.z)>42)){sc.remove(eb[i].m);eb.splice(i,1);}
    }
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Tank,60);});
}

// ============================================================
// G3-3: WORMHOLE DASH
// ============================================================
function g3Wormhole(){
  const cv=g3Canvas(580,420),rr=g3Renderer(cv);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x000000);
  const cam=new THREE.PerspectiveCamera(82,580/420,.05,200);
  const pts=[];for(let i=0;i<80;i++){const t=i/80*Math.PI*6;pts.push(new THREE.Vector3(Math.sin(t)*4,Math.cos(t*1.3)*2.5,i*2.5));}
  const curve=new THREE.CatmullRomCurve3(pts);
  const tube=new THREE.Mesh(new THREE.TubeGeometry(curve,200,3,14,false),new THREE.MeshPhongMaterial({color:0x1a0066,side:THREE.BackSide,emissive:0x0a0033,emissiveIntensity:.5,shininess:80}));sc.add(tube);
  const RCOLS=[0x00f5ff,0xff006e,0x06d6a0,0xffbe0b];
  for(let i=4;i<76;i+=4){const rm=new THREE.Mesh(new THREE.TorusGeometry(2.4,.1,6,24),new THREE.MeshBasicMaterial({color:RCOLS[i%4]}));const p=curve.getPoint(i/80);rm.position.copy(p);rm.lookAt(curve.getPoint(Math.min((i+1)/80,1)));sc.add(rm);}
  const walls=[];const offsets=[[2.5,0],[-2.5,0],[0,2],[0,-2]];
  for(let i=8;i<72;i+=5){const s=i%4;const wm=new THREE.Mesh(new THREE.BoxGeometry(.9,.9,.9),new THREE.MeshPhongMaterial({color:0xff2200,emissive:0xff0000,emissiveIntensity:.5}));const p=curve.getPoint(i/80);wm.position.set(p.x+offsets[s][0],p.y+offsets[s][1],p.z);sc.add(wm);walls.push(wm);}
  const shipM=new THREE.Mesh(new THREE.ConeGeometry(.22,.7,6),new THREE.MeshBasicMaterial({color:0x00ffff}));shipM.rotation.x=Math.PI/2;sc.add(shipM);
  let t=0,score=0,alive=true,frame=0;
  const mx={x:0,y:0};cv.addEventListener('mousemove',e=>{const r=cv.getBoundingClientRect();mx.x=((e.clientX-r.left)/r.width-.5)*3.5;mx.y=-((e.clientY-r.top)/r.height-.5)*3;});
  setScore('SCORE:0');addMsg('MOUSE to steer ¬∑ Dodge RED obstacles!');
  const stop=g3Loop(()=>{
    frame++;if(alive)t=Math.min(t+.0025,1);
    const p=curve.getPoint(t),pn=curve.getPoint(Math.min(t+.01,1));
    const ox=p.x+mx.x*.7,oy=p.y+mx.y*.7;
    cam.position.set(ox,oy,p.z);cam.lookAt(pn.x,pn.y,pn.z);
    shipM.position.set(ox,oy,p.z+1.5);
    walls.forEach(w=>{if(Math.hypot(w.position.x-ox,w.position.y-oy,w.position.z-p.z)<1){alive=false;addMsg('CRASHED! Score:'+Math.floor(score/30));}});
    score++;if(frame%60===0)setScore('SCORE:'+Math.floor(score/30));
    if(t>=.99)addMsg('üèÜ ESCAPED! Score:'+Math.floor(score/30));
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Wormhole,60);});
}

// ============================================================
// G3-4: MARBLE MADNESS 3D
// ============================================================
function g3Marble(){
  const cv=g3Canvas(560,470),rr=g3Renderer(cv,true);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x05000a);
  sc.add(mkLight('ambient',0x330055,1));
  const dl=mkLight('dir',0xffffff,1.5);dl.position.set(10,20,10);dl.castShadow=true;sc.add(dl);
  const cam=new THREE.PerspectiveCamera(65,560/470,.1,150);cam.position.set(0,14,14);cam.lookAt(0,0,-4);
  const PCOLS=[0x8338ec,0x00f5ff,0xff006e,0x06d6a0,0xffbe0b,0x8338ec,0xff006e,0xffffff];
  const platData=[[0,0,0,8],[-3,2,-7,3.5],[2,4,-14,3],[-2,6,-21,4],[3,8,-28,3],[0,10,-35,5],[-2,12,-42,3],[0,14,-49,6]];
  const plats=platData.map(([x,y,z,w],i)=>{
    const m=new THREE.Mesh(new THREE.BoxGeometry(w,.4,3.2),new THREE.MeshPhongMaterial({color:PCOLS[i],emissive:PCOLS[i],emissiveIntensity:i===7?.5:.15,shininess:80}));
    m.position.set(x,y,z);m.receiveShadow=true;sc.add(m);
    if(i===7){const gl=new THREE.PointLight(0xffffff,4,8);m.add(gl);}
    return{m,x,y,z,w};
  });
  const marble=new THREE.Mesh(new THREE.SphereGeometry(.48,14,14),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x003366,emissiveIntensity:.4,shininess:200}));
  marble.castShadow=true;marble.position.set(0,.65,1.5);sc.add(marble);
  const ml=new THREE.PointLight(0x00f5ff,2,5);marble.add(ml);
  let vx=0,vy=0,vz=0,fell=0;const keys={};
  document.addEventListener('keydown',function mbk(e){if(currentGame!=='g3_marble')return document.removeEventListener('keydown',mbk);keys[e.key]=true;e.preventDefault();});
  document.addEventListener('keyup',e=>delete keys[e.key]);
  setScore('');addMsg('ARROW KEYS to tilt ¬∑ Guide marble to the WHITE platform!');
  const stop=g3Loop(()=>{
    if(keys['ArrowLeft'])vx=Math.max(-.13,vx-.007);if(keys['ArrowRight'])vx=Math.min(.13,vx+.007);
    if(keys['ArrowUp'])vz=Math.max(-.13,vz-.007);if(keys['ArrowDown'])vz=Math.min(.13,vz+.007);
    vx*=.97;vz*=.97;vy-=.008;
    marble.position.x+=vx;marble.position.y+=vy;marble.position.z+=vz;
    marble.rotation.x+=vz*3;marble.rotation.z-=vx*3;
    plats.forEach(p=>{if(marble.position.x>p.x-p.w/2-.5&&marble.position.x<p.x+p.w/2+.5&&marble.position.z>p.z-2.1&&marble.position.z<p.z+2.1&&marble.position.y>=p.y-.05&&marble.position.y<=p.y+1){vy=0;marble.position.y=p.y+.48;}});
    if(marble.position.y<-12){fell++;marble.position.set(0,.65,1.5);vx=0;vy=0;vz=0;setScore('Fell '+fell+'x!');}
    if(Math.hypot(marble.position.x,marble.position.z+49)<3.5&&Math.abs(marble.position.y-14)<2)addMsg('üèÜ GOAL! Marble reached the portal!');
    cam.position.set(marble.position.x*.35,marble.position.y+13,marble.position.z+13);cam.lookAt(marble.position.x*.3,marble.position.y+1,marble.position.z);
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Marble,60);});
}

// ============================================================
// G3-5: NEXUS TOWER DEFENSE
// ============================================================
function g3Tower(){
  const cv=g3Canvas(580,420),rr=g3Renderer(cv);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x060a04);
  sc.add(mkLight('ambient',0x334422,1));const pl=mkLight('point',0xaaffaa,2,100,0,30,0);sc.add(pl);
  const cam=new THREE.PerspectiveCamera(58,580/420,.1,200);cam.position.set(0,30,2);cam.lookAt(0,0,5);
  const GS=8,CS=3;const cells=[];
  for(let r=0;r<GS;r++)for(let c=0;c<GS;c++){
    const m=new THREE.Mesh(new THREE.BoxGeometry(CS-.12,.2,CS-.12),new THREE.MeshPhongMaterial({color:(r+c)%2===0?0x1a2a10:0x152208}));
    m.position.set((c-GS/2)*CS,.1,(r-GS/2)*CS);sc.add(m);cells.push({m,r,c,hasTower:false,isPath:false});
  }
  const PATH=[[0,0],[1,0],[2,0],[3,0],[3,1],[3,2],[3,3],[2,3],[1,3],[0,3],[0,4],[0,5],[1,5],[2,5],[3,5],[3,6],[3,7],[4,7],[5,7],[6,7],[7,7]];
  PATH.forEach(([r,c])=>{const cl=cells.find(x=>x.r===r&&x.c===c);if(cl){cl.isPath=true;cl.m.material.color.setHex(0x2a3a15);}});
  const towers=[],enemies=[],lasers=[];let score=30,lives=20,wave=0;
  function spawnWave(){wave++;setScore('SCORE:'+score+' | LIVES:'+lives+' | WAVE:'+wave);
    for(let i=0;i<wave*3;i++)setTimeout(()=>{
      const eg=new THREE.Group();const em=new THREE.Mesh(new THREE.BoxGeometry(.8,.8,.8),new THREE.MeshPhongMaterial({color:0x8338ec,emissive:0x330088,emissiveIntensity:.3}));eg.add(em);
      const ps=PATH[0];eg.position.set((ps[1]-GS/2)*CS,.5,(ps[0]-GS/2)*CS);sc.add(eg);
      enemies.push({g:eg,m:em,pi:0,spd:.02+wave*.002,alive:true,hp:wave});
    },i*550);
  }
  cv.addEventListener('click',e=>{
    const r2=cv.getBoundingClientRect();const mx=((e.clientX-r2.left)/r2.width-.5)*26,mz=((e.clientY-r2.top)/r2.height-.5)*18+5;
    const col=Math.round(mx/CS+GS/2),row=Math.round(mz/CS+GS/2);const cell=cells.find(cl=>cl.r===row&&cl.c===col);
    if(cell&&!cell.hasTower&&!cell.isPath&&score>=10){score-=10;cell.hasTower=true;
      const tg=new THREE.Group();
      const tb=new THREE.Mesh(new THREE.CylinderGeometry(.3,.4,.85,8),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x00aaaa,emissiveIntensity:.3}));tg.add(tb);
      const th=new THREE.Mesh(new THREE.SphereGeometry(.32,8,8),new THREE.MeshPhongMaterial({color:0x00ffaa}));th.position.y=.75;tg.add(th);
      tg.position.set(cell.m.position.x,.6,cell.m.position.z);sc.add(tg);towers.push({g:tg,cool:0});}
    setScore('SCORE:'+score+' | LIVES:'+lives+' | WAVE:'+wave);
  });
  document.addEventListener('keydown',function tdk(e){if(currentGame!=='g3_tower')return document.removeEventListener('keydown',tdk);if(e.key===' '||e.key==='Enter'){score+=30;spawnWave();e.preventDefault();}});
  setScore('SCORE:30 | LIVES:20 | WAVE:0');addMsg('CLICK grid to build towers (10pts) ¬∑ SPACE to start wave');
  const stop=g3Loop(()=>{
    towers.forEach(t=>{t.cool--;if(t.cool>0)return;const alive=enemies.filter(e=>e.alive);if(!alive.length)return;const near=alive.sort((a,b)=>Math.hypot(a.g.position.x-t.g.position.x,a.g.position.z-t.g.position.z)-Math.hypot(b.g.position.x-t.g.position.x,b.g.position.z-t.g.position.z))[0];if(Math.hypot(near.g.position.x-t.g.position.x,near.g.position.z-t.g.position.z)<7){near.hp--;if(near.hp<=0){near.alive=false;sc.remove(near.g);score+=5;setScore('SCORE:'+score+' | LIVES:'+lives+' | WAVE:'+wave);}const b=new THREE.Mesh(new THREE.SphereGeometry(.1,4,4),new THREE.MeshBasicMaterial({color:0x00ffff}));b.position.copy(t.g.position);sc.add(b);lasers.push({m:b,target:near,life:16});t.cool=38;}});
    for(let i=lasers.length-1;i>=0;i--){if(lasers[i].target&&lasers[i].target.g)lasers[i].m.position.lerp(lasers[i].target.g.position,.4);lasers[i].life--;if(lasers[i].life<=0){sc.remove(lasers[i].m);lasers.splice(i,1);}}
    enemies.filter(e=>e.alive).forEach(e=>{if(e.pi>=PATH.length-1){lives--;sc.remove(e.g);e.alive=false;setScore('SCORE:'+score+' | LIVES:'+lives+' | WAVE:'+wave);if(lives<=0)addMsg('BASE DESTROYED! Score:'+score);return;}const nxt=PATH[e.pi+1],tx=(nxt[1]-GS/2)*CS,tz=(nxt[0]-GS/2)*CS,dx=tx-e.g.position.x,dz=tz-e.g.position.z,d=Math.hypot(dx,dz);if(d<.1)e.pi++;else{e.g.position.x+=dx/d*e.spd;e.g.position.z+=dz/d*e.spd;}e.m.rotation.y+=.06;});
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Tower,60);});
}

// ============================================================
// G3-6: NEON BRAWLER
// ============================================================
function g3Brawler(){
  const cv=g3Canvas(580,420),rr=g3Renderer(cv,true);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x08000f);sc.fog=new THREE.Fog(0x08000f,40,100);
  sc.add(mkLight('ambient',0x440066,.9));const pl=mkLight('point',0xaa00ff,3,60,0,20,0);sc.add(pl);
  const cam=new THREE.PerspectiveCamera(70,580/420,.1,150);cam.position.set(0,14,14);cam.lookAt(0,0,0);
  const arena=new THREE.Mesh(new THREE.CylinderGeometry(10,10,.3,32),new THREE.MeshPhongMaterial({color:0x1a003a,shininess:50}));arena.receiveShadow=true;sc.add(arena);
  for(let i=0;i<24;i++){const post=new THREE.Mesh(new THREE.CylinderGeometry(.14,.14,2,6),new THREE.MeshPhongMaterial({color:0x8338ec,emissive:0x440088,emissiveIntensity:.3}));const ang=i/24*Math.PI*2;post.position.set(Math.cos(ang)*10,.8,Math.sin(ang)*10);sc.add(post);}
  const player=new THREE.Mesh(new THREE.SphereGeometry(.8,14,14),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x00aacc,emissiveIntensity:.4,shininess:200}));
  player.position.set(0,.8,5);sc.add(player);const pLight=new THREE.PointLight(0x00f5ff,2,6);player.add(pLight);
  const enemies=[],crystals=[];
  function spawnE(){const ang=Math.random()*Math.PI*2;const em=new THREE.Mesh(new THREE.OctahedronGeometry(.8,1),new THREE.MeshPhongMaterial({color:0xff2200,emissive:0x880000,emissiveIntensity:.4}));em.position.set(Math.cos(ang)*6,.8,Math.sin(ang)*6);const el=new THREE.PointLight(0xff0000,1.5,5);em.add(el);sc.add(em);enemies.push({m:em,alive:true});}
  function spawnC(){const ang=Math.random()*Math.PI*2,r=Math.random()*7;const cm=new THREE.Mesh(new THREE.OctahedronGeometry(.4,0),new THREE.MeshPhongMaterial({color:0xffbe0b,emissive:0xaa8800,emissiveIntensity:.5}));cm.position.set(Math.cos(ang)*r,1,Math.sin(ang)*r);sc.add(cm);crystals.push({m:cm,alive:true});}
  for(let i=0;i<6;i++)spawnE();for(let i=0;i<4;i++)spawnC();
  let score=0,hp=5,frame=0,dashing=false;const keys={};
  document.addEventListener('keydown',function brk(e){if(currentGame!=='g3_brawler')return document.removeEventListener('keydown',brk);keys[e.key]=true;if(e.key===' '){dashing=true;setTimeout(()=>dashing=false,280);}e.preventDefault();});
  document.addEventListener('keyup',e=>delete keys[e.key]);
  setScore('SCORE:0 | HP:‚ô•‚ô•‚ô•‚ô•‚ô•');addMsg('WASD/ARROWS move ¬∑ SPACE to DASH-ATTACK through enemies!');
  const stop=g3Loop(()=>{
    frame++;const spd=dashing?.35:.12;
    if(keys['a']||keys['ArrowLeft'])player.position.x-=spd;if(keys['d']||keys['ArrowRight'])player.position.x+=spd;
    if(keys['w']||keys['ArrowUp'])player.position.z-=spd;if(keys['s']||keys['ArrowDown'])player.position.z+=spd;
    const d2=Math.hypot(player.position.x,player.position.z);if(d2>9.2){player.position.x*=9.2/d2;player.position.z*=9.2/d2;}
    player.rotation.y+=.04;
    enemies.filter(e=>e.alive).forEach(e=>{const dx=player.position.x-e.m.position.x,dz=player.position.z-e.m.position.z,dist=Math.hypot(dx,dz);e.m.position.x+=dx/dist*.04;e.m.position.z+=dz/dist*.04;e.m.rotation.y+=.06;if(dist<1.6){if(dashing){e.alive=false;sc.remove(e.m);score+=20;setScore('SCORE:'+score+' | HP:'+'‚ô•'.repeat(hp));spawnE();}else{hp--;e.alive=false;sc.remove(e.m);setScore('SCORE:'+score+' | HP:'+'‚ô•'.repeat(Math.max(0,hp)));if(hp<=0)addMsg('DEFEATED! Score:'+score);spawnE();}}});
    crystals.filter(c=>c.alive).forEach(c=>{c.m.rotation.y+=.06;c.m.position.y=1+Math.sin(frame*.06+c.m.position.x)*.2;if(Math.hypot(player.position.x-c.m.position.x,player.position.z-c.m.position.z)<1.4){c.alive=false;sc.remove(c.m);score+=10;hp=Math.min(5,hp+1);setScore('SCORE:'+score+' | HP:'+'‚ô•'.repeat(hp));spawnC();}});
    cam.position.set(player.position.x*.3,14,player.position.z*.3+14);cam.lookAt(0,0,0);
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Brawler,60);});
}

// ============================================================
// G3-7: CYBERBALL PINBALL
// ============================================================
function g3Pinball(){
  const cv=g3Canvas(420,560),rr=g3Renderer(cv,true);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x03000a);
  sc.add(mkLight('ambient',0x220044,.8));const pl=mkLight('point',0xaa44ff,2,50,0,20,0);sc.add(pl);
  const cam=new THREE.PerspectiveCamera(60,420/560,.1,100);cam.position.set(0,18,12);cam.lookAt(0,0,0);
  const table=new THREE.Mesh(new THREE.BoxGeometry(8,.2,14),new THREE.MeshPhongMaterial({color:0x0a0020,shininess:40}));table.position.y=-1;sc.add(table);
  const wallMat=new THREE.MeshPhongMaterial({color:0x8338ec,emissive:0x440088,emissiveIntensity:.3});
  const wL=new THREE.Mesh(new THREE.BoxGeometry(.3,1.5,14),wallMat);wL.position.set(-4,0,0);sc.add(wL);
  const wR=new THREE.Mesh(new THREE.BoxGeometry(.3,1.5,14),wallMat);wR.position.set(4,0,0);sc.add(wR);
  const wTop=new THREE.Mesh(new THREE.BoxGeometry(8,.2,.3),new THREE.MeshPhongMaterial({color:0x8338ec}));wTop.position.set(0,0,-7);sc.add(wTop);
  const bumpers=[];[[-1.5,0,-2],[1.5,0,-2],[0,0,-4],[-2,0,0],[2,0,0]].forEach(([x,y,z])=>{
    const bm=new THREE.Mesh(new THREE.CylinderGeometry(.6,.6,.8,12),new THREE.MeshPhongMaterial({color:0xff006e,emissive:0x880022,emissiveIntensity:.4}));
    bm.position.set(x,.3,z);sc.add(bm);bm.add(new THREE.PointLight(0xff006e,2,4));bumpers.push(bm);
  });
  const flipL=new THREE.Mesh(new THREE.BoxGeometry(2.2,.3,.5),new THREE.MeshPhongMaterial({color:0x00f5ff}));flipL.position.set(-1.5,.2,5.5);sc.add(flipL);
  const flipR=new THREE.Mesh(new THREE.BoxGeometry(2.2,.3,.5),new THREE.MeshPhongMaterial({color:0x00f5ff}));flipR.position.set(1.5,.2,5.5);sc.add(flipR);
  const ball=new THREE.Mesh(new THREE.SphereGeometry(.4,12,12),new THREE.MeshPhongMaterial({color:0xffbe0b,emissive:0x884400,emissiveIntensity:.3,shininess:200}));
  ball.position.set(0,.4,-5);sc.add(ball);ball.add(new THREE.PointLight(0xffbe0b,2,4));
  let bvx=.04,bvz=.12,score=0,lAng=0,rAng=0,launched=false;const keys={};
  document.addEventListener('keydown',function pbk(e){if(currentGame!=='g3_pinball')return document.removeEventListener('keydown',pbk);keys[e.key]=true;if((e.key==='z'||e.key==='Z')&&!launched){launched=true;bvz=-.2;}e.preventDefault();});
  document.addEventListener('keyup',e=>delete keys[e.key]);
  setScore('SCORE:0');addMsg('Z = left flipper  /  = right flipper ¬∑ Press Z to launch!');
  const stop=g3Loop(()=>{
    const lt=keys['z']||keys['Z']?-.5:.3,rt=keys['/']?.5:-.3;lAng+=(lt-lAng)*.25;rAng+=(rt-rAng)*.25;flipL.rotation.z=lAng;flipR.rotation.z=rAng;
    if(!launched)return;ball.position.x+=bvx;ball.position.z+=bvz;bvz+=.003;
    if(ball.position.x<-3.6||ball.position.x>3.6){bvx*=-1;ball.position.x=Math.max(-3.6,Math.min(3.6,ball.position.x));}
    if(ball.position.z<-6.8){bvz=Math.abs(bvz);score++;setScore('SCORE:'+score);}
    bumpers.forEach(bm=>{const dx=ball.position.x-bm.position.x,dz=ball.position.z-bm.position.z,d=Math.hypot(dx,dz);if(d<1){bvx=dx/d*.18;bvz=dz/d*.18;score+=10;setScore('SCORE:'+score);bm.material.emissiveIntensity=1;setTimeout(()=>bm.material.emissiveIntensity=.4,150);}});
    if(ball.position.z>5&&ball.position.z<6.5){if(ball.position.x<0&&(keys['z']||keys['Z']))bvz=-Math.abs(bvz)*.9;if(ball.position.x>0&&keys['/'])bvz=-Math.abs(bvz)*.9;}
    if(ball.position.z>7.5){ball.position.set(0,.4,-5);bvx=.04;bvz=.12;launched=false;addMsg('Ball lost! Score:'+score+' ‚Äî Press Z to relaunch');}
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Pinball,60);});
}

// ============================================================
// G3-8: CLOUD SURFER
// ============================================================
function g3SkySurf(){
  const cv=g3Canvas(580,420),rr=g3Renderer(cv,true);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x0a1540);sc.fog=new THREE.Fog(0x0a1540,30,100);
  sc.add(mkLight('ambient',0x334488,1));const dl=mkLight('dir',0xffffff,1.5);dl.position.set(20,30,10);sc.add(dl);
  const cam=new THREE.PerspectiveCamera(70,580/420,.1,150);cam.position.set(0,4,10);cam.lookAt(0,2,0);
  const plats=[];
  function mkPlat(z){const w=3+Math.random()*5,x=(Math.random()-.5)*10;const m=new THREE.Mesh(new THREE.BoxGeometry(w,.4,4),new THREE.MeshPhongMaterial({color:0xffffff,transparent:true,opacity:.88}));m.position.set(x,0,z);sc.add(m);plats.push({m,x,w});}
  for(let i=0;i<18;i++)mkPlat(-i*7);
  const player=new THREE.Mesh(new THREE.SphereGeometry(.52,10,10),new THREE.MeshPhongMaterial({color:0xff006e,emissive:0x880022,emissiveIntensity:.3}));
  player.position.set(0,.9,5);sc.add(player);const pLight=new THREE.PointLight(0xff006e,2,5);player.add(pLight);
  const birds=[];for(let i=0;i<6;i++){const b=new THREE.Mesh(new THREE.ConeGeometry(.35,.8,4),new THREE.MeshPhongMaterial({color:0xff6600}));b.position.set((Math.random()-.5)*10,Math.random()*2-1,-30-Math.random()*20);b.rotation.z=Math.PI/2;sc.add(b);birds.push({m:b,vy:Math.sin(i)*.012});}
  let vy=0,onGround=false,score=0,alive=true,frame=0,speed=.14;const keys={};
  document.addEventListener('keydown',function ssk(e){if(currentGame!=='g3_skysurf')return document.removeEventListener('keydown',ssk);keys[e.key]=true;if(e.key===' '&&onGround){vy=.19;onGround=false;}e.preventDefault();});
  document.addEventListener('keyup',e=>delete keys[e.key]);
  setScore('SCORE:0');addMsg('A/D move ¬∑ SPACE jump ¬∑ Stay on the platforms!');
  const stop=g3Loop(()=>{
    frame++;if(!alive)return;speed=Math.min(.28,.14+score*.0015);
    if(keys['a']||keys['ArrowLeft'])player.position.x=Math.max(-7,player.position.x-.11);
    if(keys['d']||keys['ArrowRight'])player.position.x=Math.min(7,player.position.x+.11);
    vy-=.007;player.position.y+=vy;onGround=false;
    plats.forEach(p=>{p.m.position.z+=speed;if(p.m.position.z>12){p.m.position.z-=130;p.x=(Math.random()-.5)*10;p.m.position.x=p.x;p.w=3+Math.random()*5;p.m.scale.x=p.w/4;}
      if(player.position.y>=.66&&player.position.y<=1.3&&player.position.x>p.x-p.w/2&&player.position.x<p.x+p.w/2&&player.position.z>p.m.position.z-2.2&&player.position.z<p.m.position.z+2.2){vy=0;player.position.y=.95;onGround=true;}});
    birds.forEach(b=>{b.m.position.z+=speed*1.6;b.m.position.y+=b.vy;if(b.m.position.z>12){b.m.position.z=-30-Math.random()*20;b.m.position.x=(Math.random()-.5)*10;}if(Math.hypot(b.m.position.x-player.position.x,b.m.position.y-player.position.y,b.m.position.z-player.position.z)<1.1){alive=false;addMsg('HIT! Score:'+Math.floor(score));}});
    if(player.position.y<-7){alive=false;addMsg('FELL! Score:'+Math.floor(score));}
    score+=.05;if(frame%60===0)setScore('SCORE:'+Math.floor(score));
    cam.position.set(player.position.x*.2,5,11);cam.lookAt(player.position.x*.25,2,0);
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3SkySurf,60);});
}

// ============================================================
// G3-9: QUANTUM SNIPER
// ============================================================
function g3Sniper(){
  const cv=g3Canvas(580,420),rr=g3Renderer(cv);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x050a02);sc.fog=new THREE.Fog(0x050a02,60,200);
  sc.add(mkLight('ambient',0x224411,.9));const dl=mkLight('dir',0xffffcc,1.8);dl.position.set(30,60,0);sc.add(dl);
  const cam=new THREE.PerspectiveCamera(78,580/420,.1,300);cam.position.set(0,3,22);
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(200,100),new THREE.MeshPhongMaterial({color:0x0d1a08}));ground.rotation.x=-Math.PI/2;sc.add(ground);
  for(let i=0;i<20;i++){const t=new THREE.Mesh(new THREE.ConeGeometry(.5,2.5,6),new THREE.MeshPhongMaterial({color:0x0a3a0a}));t.position.set((Math.random()-.5)*50,.7,-20-Math.random()*50);sc.add(t);}
  const TCOLS=[0xff006e,0x00f5ff,0xffbe0b,0x8338ec,0x06d6a0];const targets=[];
  function spawnT(){const x=(Math.random()-.5)*50,z=-25-Math.random()*50;const m=new THREE.Mesh(new THREE.CylinderGeometry(.6,.6,2.5,12),new THREE.MeshPhongMaterial({color:TCOLS[Math.floor(Math.random()*5)],emissive:TCOLS[Math.floor(Math.random()*5)],emissiveIntensity:.25}));m.position.set(x,1.25+.6,z);sc.add(m);targets.push({m,alive:true,spd:(.4+Math.random()*.5)*(Math.random()<.5?1:-1)});}
  for(let i=0;i<10;i++)spawnT();
  // Scope overlay
  const scope=document.createElement('div');scope.style.cssText='width:'+cv.width+'px;height:'+cv.height+'px;pointer-events:none;position:relative;margin-top:-'+cv.height+'px;z-index:2;';
  scope.innerHTML='<svg width="'+cv.width+'" height="'+cv.height+'" style="position:absolute;top:0;left:0"><circle cx="50%" cy="50%" r="26%" stroke="#0f0" stroke-width="1" fill="rgba(0,10,0,0.1)"/><line x1="50%" y1="5%" x2="50%" y2="95%" stroke="#0f0" stroke-width=".7" opacity=".6"/><line x1="5%" y1="50%" x2="95%" y2="50%" stroke="#0f0" stroke-width=".7" opacity=".6"/><circle cx="50%" cy="50%" r="3" fill="#0f0"/></svg>';
  getCont().appendChild(scope);
  let yaw=0,pitch=0,score=0,ammo=12,ml=false;
  cv.addEventListener('click',()=>cv.requestPointerLock&&cv.requestPointerLock());
  document.addEventListener('pointerlockchange',()=>ml=document.pointerLockElement===cv);
  document.addEventListener('mousemove',e=>{if(!ml)return;yaw-=e.movementX*.0025;pitch=Math.max(-.4,Math.min(.4,pitch-e.movementY*.0025));});
  const ray=new THREE.Raycaster();
  cv.addEventListener('mousedown',e=>{if(e.button!==0||ammo<=0||!ml)return;ammo--;ray.setFromCamera(new THREE.Vector2(0,0),cam);const hits=ray.intersectObjects(targets.filter(t=>t.alive).map(t=>t.m));if(hits.length){const t=targets.find(t=>t.m===hits[0].object);if(t){t.alive=false;sc.remove(t.m);score+=100;setScore('SCORE:'+score+' | AMMO:'+ammo);setTimeout(spawnT,600);}}else setScore('MISS! Score:'+score+' | AMMO:'+ammo);if(ammo<=0)addMsg('OUT OF AMMO! Final score:'+score);});
  setScore('SCORE:0 | AMMO:12');addMsg('CLICK canvas to lock mouse ¬∑ MOVE to aim ¬∑ CLICK to fire');
  const stop=g3Loop(()=>{
    targets.forEach(t=>{if(!t.alive)return;t.m.position.x+=t.spd*.04;t.m.rotation.y+=.015;if(t.m.position.x>28||t.m.position.x<-28)t.spd*=-1;});
    cam.rotation.order='YXZ';cam.rotation.y=yaw;cam.rotation.x=pitch;
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();scope.remove();document.exitPointerLock&&document.exitPointerLock();};
  addRestartBtn(()=>{gameCleanup();setTimeout(g3Sniper,60);});
}

// ============================================================
// G3-10: BEAT SPHERE ‚Äî 3D Rhythm
// ============================================================
function g3Rhythm(){
  const cv=g3Canvas(580,420),rr=g3Renderer(cv);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x04000f);sc.add(mkLight('ambient',0x110033,.8));
  const cam=new THREE.PerspectiveCamera(75,580/420,.1,100);cam.position.set(0,2,14);cam.lookAt(0,1,0);
  const LANE_X=[-4.5,-1.5,1.5,4.5],LKEYS=['a','s','d','f'],LCOLS=[0xff006e,0x00f5ff,0x06d6a0,0xffbe0b];
  LANE_X.forEach((x,i)=>{
    const bar=new THREE.Mesh(new THREE.BoxGeometry(2.5,.2,2.5),new THREE.MeshPhongMaterial({color:LCOLS[i],emissive:LCOLS[i],emissiveIntensity:.15,transparent:true,opacity:.6}));
    bar.position.set(x,.1,9);sc.add(bar);bar.add(new THREE.PointLight(LCOLS[i],1.5,5));
    const lbl=new THREE.Mesh(new THREE.BoxGeometry(1.8,.1,1.8),new THREE.MeshPhongMaterial({color:LCOLS[i],emissive:LCOLS[i],emissiveIntensity:.4}));lbl.position.set(x,.2,10.5);sc.add(lbl);
  });
  const track=new THREE.Mesh(new THREE.PlaneGeometry(12,30),new THREE.MeshPhongMaterial({color:0x0d0d2a}));track.rotation.x=-Math.PI/2;track.position.set(0,0,-5);sc.add(track);
  const notes=[],effects=[];let score=0,combo=0,missed=0,frame=0;
  function spawnNote(){const lane=Math.floor(Math.random()*4);const nm=new THREE.Mesh(new THREE.SphereGeometry(.7,12,12),new THREE.MeshPhongMaterial({color:LCOLS[lane],emissive:LCOLS[lane],emissiveIntensity:.5,shininess:120}));nm.position.set(LANE_X[lane],.7,-22-Math.random()*6);nm.add(new THREE.PointLight(LCOLS[lane],2,4));sc.add(nm);notes.push({m:nm,lane,spd:.12+score*.0005});}
  function hitLane(lane){const idx=notes.findIndex(n=>n.lane===lane&&n.m.position.z>6&&n.m.position.z<13);if(idx>=0){const col=LCOLS[lane];const flash=new THREE.Mesh(new THREE.SphereGeometry(1.2,8,8),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:.9}));flash.position.set(LANE_X[lane],.7,9);sc.add(flash);effects.push({m:flash,life:14});sc.remove(notes[idx].m);notes.splice(idx,1);combo++;score+=10*combo;setScore('SCORE:'+score+' | COMBO:x'+combo);}else combo=0;}
  document.addEventListener('keydown',function rtk(e){if(currentGame!=='g3_rhythm')return document.removeEventListener('keydown',rtk);const i=LKEYS.indexOf(e.key.toLowerCase());if(i>=0)hitLane(i);e.preventDefault();});
  setScore('SCORE:0 | COMBO:x0');addMsg('Press A S D F when orbs reach the glowing bars!');
  const stop=g3Loop(()=>{
    frame++;if(frame%38===0)spawnNote();
    for(let i=notes.length-1;i>=0;i--){notes[i].m.position.z+=notes[i].spd;notes[i].m.rotation.y+=.04;if(notes[i].m.position.z>13){missed++;combo=0;sc.remove(notes[i].m);notes.splice(i,1);if(missed>=10)addMsg('GAME OVER! Score:'+score);}}
    for(let i=effects.length-1;i>=0;i--){effects[i].m.scale.addScalar(.1);effects[i].m.material.opacity-=.07;effects[i].life--;if(effects[i].life<=0){sc.remove(effects[i].m);effects.splice(i,1);}}
    cam.position.x=Math.sin(frame*.018)*.4;rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Rhythm,60);});
}

// ============================================================
// G3-11: STELLAR FORGE ‚Äî Galaxy Builder
// ============================================================
function g3Galaxy(){
  const cv=g3Canvas(580,470),rr=g3Renderer(cv);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0);sc.add(mkLight('ambient',0x111133,.5));
  const cam=new THREE.PerspectiveCamera(70,580/470,.1,1000);cam.position.set(0,0,80);cam.lookAt(0,0,0);
  const sg=new THREE.BufferGeometry(),sv=[];for(let i=0;i<2000;i++)sv.push((Math.random()-.5)*500,(Math.random()-.5)*500,(Math.random()-.5)*500);sg.setAttribute('position',new THREE.Float32BufferAttribute(sv,3));sc.add(new THREE.Points(sg,new THREE.PointsMaterial({color:0xffffff,size:.35})));
  const bodies=[];let score=0,frame=0;const SCOLS=[0xffaa00,0xffffff,0x00aaff,0xff4400,0xaaffff];
  function addBody(x,y,z,r,isStar){const col=SCOLS[Math.floor(Math.random()*SCOLS.length)];const m=new THREE.Mesh(new THREE.SphereGeometry(r,14,14),new THREE.MeshPhongMaterial({color:col,emissive:col,emissiveIntensity:isStar?.6:.1,shininess:isStar?200:30}));m.position.set(x,y,z);if(isStar){const sl=new THREE.PointLight(col,2,r*8);m.add(sl);}sc.add(m);bodies.push({m,r,mass:r*r*(isStar?5:1),vx:0,vy:0,vz:0});score+=isStar?10:2;setScore('BODIES:'+bodies.length+' | SCORE:'+score);}
  cv.addEventListener('click',e=>{const r2=cv.getBoundingClientRect();const mx=((e.clientX-r2.left)/r2.width-.5)*100,my=-((e.clientY-r2.top)/r2.height-.5)*85;addBody(mx,my,(Math.random()-.5)*20,2+Math.random()*4,Math.random()>.6);});
  setScore('BODIES:0 | SCORE:0');addMsg('CLICK to place stars & planets ¬∑ Watch gravity pull them together!');
  const stop=g3Loop(()=>{
    frame++;cam.rotation.y=Math.sin(frame*.003)*.04;
    bodies.forEach((a,ai)=>{bodies.forEach((b,bi)=>{if(ai===bi)return;const dx=b.m.position.x-a.m.position.x,dy=b.m.position.y-a.m.position.y,dz=b.m.position.z-a.m.position.z,d2=dx*dx+dy*dy+dz*dz+4,f=b.mass/(d2*Math.sqrt(d2))*.8;a.vx+=dx*f;a.vy+=dy*f;a.vz+=dz*f;});});
    bodies.forEach(b=>{b.vx*=.995;b.vy*=.995;b.vz*=.995;b.m.position.x+=b.vx;b.m.position.y+=b.vy;b.m.position.z+=b.vz;b.m.rotation.y+=.01;});
    for(let i=bodies.length-1;i>=0;i--){for(let j=i-1;j>=0;j--){if(!bodies[i]||!bodies[j])continue;if(bodies[i].m.position.distanceTo(bodies[j].m.position)<bodies[i].r+bodies[j].r){const bi2=bodies[i].mass>=bodies[j].mass?i:j,si=bi2===i?j:i;bodies[bi2].r=Math.cbrt(bodies[bi2].r**3+bodies[si].r**3);bodies[bi2].m.scale.setScalar(bodies[bi2].r/2.5);bodies[bi2].mass+=bodies[si].mass;sc.remove(bodies[si].m);bodies.splice(si,1);break;}}}
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Galaxy,60);});
}

// ============================================================
// G3-12: NEON BOWLING
// ============================================================
function g3Bowling(){
  const cv=g3Canvas(540,450),rr=g3Renderer(cv,true);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x040010);sc.add(mkLight('ambient',0x221144,.9));const pl=mkLight('point',0x8844ff,3,60,0,20,0);sc.add(pl);
  const cam=new THREE.PerspectiveCamera(65,540/450,.1,100);cam.position.set(0,4,16);cam.lookAt(0,0,0);
  const lane=new THREE.Mesh(new THREE.BoxGeometry(5,.15,28),new THREE.MeshPhongMaterial({color:0x1a0a44,shininess:80}));lane.receiveShadow=true;sc.add(lane);
  const gL=new THREE.Mesh(new THREE.BoxGeometry(.5,.12,28),new THREE.MeshPhongMaterial({color:0x0a0020}));gL.position.set(-2.85,.06,0);sc.add(gL);
  const gR=new THREE.Mesh(new THREE.BoxGeometry(.5,.12,28),new THREE.MeshPhongMaterial({color:0x0a0020}));gR.position.set(2.85,.06,0);sc.add(gR);
  const backWall=new THREE.Mesh(new THREE.BoxGeometry(5,.4,.4),new THREE.MeshPhongMaterial({color:0x8338ec,emissive:0x440088,emissiveIntensity:.3}));backWall.position.set(0,.2,-13);sc.add(backWall);
  const pins=[];const PIN_POS=[[0,-11],[-.6,-12.1],[.6,-12.1],[-1.2,-13.2],[0,-13.2],[1.2,-13.2],[-1.8,-14.3],[-.6,-14.3],[.6,-14.3],[1.8,-14.3]];
  function resetPins(){pins.forEach(p=>sc.remove(p.m));pins.length=0;PIN_POS.forEach(([x,z])=>{const m=new THREE.Mesh(new THREE.CylinderGeometry(.22,.28,.9,10),new THREE.MeshPhongMaterial({color:0xffffff,emissive:0x444444,emissiveIntensity:.15,shininess:120}));m.position.set(x,.55,z);m.castShadow=true;sc.add(m);m.add(new THREE.PointLight(0xffffff,1,2));pins.push({m,knocked:false,vx:0,vz:0});});}
  resetPins();
  const ball=new THREE.Mesh(new THREE.SphereGeometry(.55,14,14),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x003366,emissiveIntensity:.35,shininess:200}));ball.position.set(0,.55,12);ball.castShadow=true;sc.add(ball);ball.add(new THREE.PointLight(0x00f5ff,2,5));
  let aimX=0,bvx=0,bvz=0,rolling=false,charging=false,power=0,score=0,throws=0;
  cv.addEventListener('mousemove',e=>{if(!rolling){const r2=cv.getBoundingClientRect();aimX=((e.clientX-r2.left)/r2.width-.5)*3;ball.position.x=aimX;}});
  cv.addEventListener('mousedown',()=>{if(!rolling)charging=true;});
  cv.addEventListener('mouseup',()=>{if(charging&&!rolling){rolling=true;charging=false;bvz=-(power*.24+.14);bvx=aimX*-.01;throws++;setScore('SCORE:'+score+' | THROWS:'+throws);}});
  setScore('SCORE:0 | THROWS:0');addMsg('MOUSE to aim ¬∑ HOLD & RELEASE to bowl!');
  const stop=g3Loop(()=>{
    if(charging)power=Math.min(1,power+.02);
    if(rolling){ball.position.x+=bvx;ball.position.z+=bvz;ball.rotation.x+=bvz*.5;ball.position.x=Math.max(-2.1,Math.min(2.1,ball.position.x));
      pins.forEach(p=>{if(p.knocked)return;const dx=ball.position.x-p.m.position.x,dz=ball.position.z-p.m.position.z,d=Math.hypot(dx,dz);if(d<.95){p.knocked=true;p.vx=dx*.12;p.vz=dz*.12;score+=100;setScore('SCORE:'+score+' | THROWS:'+throws);}});
      pins.forEach(p=>{if(!p.knocked)return;p.m.position.x+=p.vx;p.m.position.z+=p.vz;p.m.rotation.z+=.05;p.vx*=.88;p.vz*=.88;});
      if(ball.position.z<-15.5||Math.abs(ball.position.x)>2.3){ball.position.set(0,.55,12);rolling=false;bvx=0;bvz=0;power=0;if(pins.every(p=>p.knocked)){addMsg('üé≥ STRIKE! Score:'+score);setTimeout(resetPins,1200);}}
    }
    cam.position.set(ball.position.x*.2,4,16);rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Bowling,60);});
}

// ============================================================
// G3-13: NEON UNDEAD ‚Äî Wave Survival
// ============================================================
function g3Zombie(){
  const cv=g3Canvas(580,420),rr=g3Renderer(cv,true);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x020210);sc.fog=new THREE.Fog(0x020210,25,70);
  sc.add(mkLight('ambient',0x111133,.7));const pl=mkLight('point',0x00ff44,2,40,0,15,0);sc.add(pl);
  const cam=new THREE.PerspectiveCamera(70,580/420,.1,100);cam.position.set(0,10,0);cam.lookAt(0,0,0);cam.rotation.x=-Math.PI/2;
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(40,40),new THREE.MeshPhongMaterial({color:0x0a1005}));ground.rotation.x=-Math.PI/2;ground.receiveShadow=true;sc.add(ground);
  sc.add(new THREE.GridHelper(40,20,0x112211,0x0a1508));
  const tg=new THREE.Group();
  const tBase=new THREE.Mesh(new THREE.CylinderGeometry(.6,.7,.5,10),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x00aaaa,emissiveIntensity:.3}));tg.add(tBase);
  const tBarrel=new THREE.Mesh(new THREE.CylinderGeometry(.1,.1,1.5,8),new THREE.MeshPhongMaterial({color:0x006688}));tBarrel.position.set(.75,.3,0);tBarrel.rotation.z=Math.PI/2;tg.add(tBarrel);
  tg.position.y=.3;sc.add(tg);
  const zombies=[],bullets=[];let score=0,hp=5,wave=0,frame=0,wTimer=0;
  function spawnZ(){const ang=Math.random()*Math.PI*2;const zm=new THREE.Mesh(new THREE.BoxGeometry(.8,.8,.8),new THREE.MeshPhongMaterial({color:0x44ff44,emissive:0x228822,emissiveIntensity:.4}));zm.position.set(Math.cos(ang)*18,.4,Math.sin(ang)*18);zm.castShadow=true;sc.add(zm);zombies.push({m:zm,alive:true,spd:.04+wave*.005});}
  function nextWave(){wave++;setScore('SCORE:'+score+' | HP:'+'‚ô•'.repeat(Math.max(0,hp))+' | WAVE:'+wave);for(let i=0;i<wave*4;i++)setTimeout(spawnZ,i*350);}
  setTimeout(nextWave,1000);
  setScore('SCORE:0 | HP:‚ô•‚ô•‚ô•‚ô•‚ô• | WAVE:1');addMsg('Auto-turret fires ¬∑ Survive zombie waves!');
  const stop=g3Loop(()=>{
    frame++;wTimer++;
    if(frame%20===0){const alive=zombies.filter(z=>z.alive);if(alive.length>0){const near=alive.reduce((a,b)=>a.m.position.length()<b.m.position.length()?a:b);tg.lookAt(near.m.position);const dir=near.m.position.clone().normalize();const b=new THREE.Mesh(new THREE.SphereGeometry(.18,6,6),new THREE.MeshBasicMaterial({color:0x00ffff}));b.position.set(tg.position.x,tg.position.y+.6,tg.position.z);sc.add(b);bullets.push({m:b,vx:dir.x*.4,vz:dir.z*.4});}}
    for(let i=bullets.length-1;i>=0;i--){bullets[i].m.position.x+=bullets[i].vx;bullets[i].m.position.z+=bullets[i].vz;let hit=false;for(let j=zombies.length-1;j>=0;j--){if(!zombies[j].alive)continue;if(Math.hypot(bullets[i].m.position.x-zombies[j].m.position.x,bullets[i].m.position.z-zombies[j].m.position.z)<.9){zombies[j].alive=false;sc.remove(zombies[j].m);sc.remove(bullets[i].m);bullets.splice(i,1);score+=10;setScore('SCORE:'+score+' | HP:'+'‚ô•'.repeat(Math.max(0,hp))+' | WAVE:'+wave);hit=true;break;}}if(!hit&&bullets[i]&&(Math.abs(bullets[i].m.position.x)>22||Math.abs(bullets[i].m.position.z)>22)){sc.remove(bullets[i].m);bullets.splice(i,1);}}
    zombies.filter(z=>z.alive).forEach(z=>{const dx=-z.m.position.x,dz=-z.m.position.z,d=Math.hypot(dx,dz);z.m.position.x+=dx/d*z.spd;z.m.position.z+=dz/d*z.spd;z.m.rotation.y+=.06;if(d<1.2){hp--;z.alive=false;sc.remove(z.m);setScore('SCORE:'+score+' | HP:'+'‚ô•'.repeat(Math.max(0,hp))+' | WAVE:'+wave);if(hp<=0)addMsg('OVERRUN! Score:'+score);}});
    if(wTimer>400&&zombies.every(z=>!z.alive)){wTimer=0;setTimeout(nextWave,1500);}
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Zombie,60);});
}

// ============================================================
// G3-14: ZERO-G GOLF
// ============================================================
function g3Minigolf(){
  const cv=g3Canvas(560,470),rr=g3Renderer(cv,true);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x000010);sc.add(mkLight('ambient',0x222244,.9));const pl=mkLight('point',0x4466ff,2,80,0,20,0);sc.add(pl);
  const sg=new THREE.BufferGeometry(),sv=[];for(let i=0;i<800;i++)sv.push((Math.random()-.5)*300,(Math.random()-.5)*300,(Math.random()-.5)*300);sg.setAttribute('position',new THREE.Float32BufferAttribute(sv,3));sc.add(new THREE.Points(sg,new THREE.PointsMaterial({color:0xffffff,size:.3})));
  const cam=new THREE.PerspectiveCamera(70,560/470,.1,300);cam.position.set(0,8,16);cam.lookAt(0,0,0);
  const HOLES=[{bx:0,by:0,bz:0,hx:8,hy:0,hz:-8,par:3},{bx:8,by:2,bz:-8,hx:0,hy:4,hz:-18,par:3},{bx:0,by:4,bz:-18,hx:-8,hy:1,hz:-26,par:4},{bx:-8,by:1,bz:-26,hx:4,hy:-1,hz:-36,par:3},{bx:4,by:-1,bz:-36,hx:-2,hy:3,hz:-46,par:4}];
  let holeIdx=0,total=0,strokes=0;
  const ball=new THREE.Mesh(new THREE.SphereGeometry(.5,12,12),new THREE.MeshPhongMaterial({color:0xffffff,shininess:200}));ball.castShadow=true;sc.add(ball);ball.add(new THREE.PointLight(0xffffff,1.5,5));
  const bv=new THREE.Vector3();
  const cup=new THREE.Mesh(new THREE.CylinderGeometry(.7,.7,.15,14),new THREE.MeshPhongMaterial({color:0xff006e,emissive:0xff006e,emissiveIntensity:.5}));sc.add(cup);
  const cupL=new THREE.PointLight(0xff006e,3,8);sc.add(cupL);
  const asts=[];for(let i=0;i<14;i++){const ap=new THREE.Mesh(new THREE.SphereGeometry(1.5+Math.random(),8,8),new THREE.MeshPhongMaterial({color:0x334466}));ap.position.set((Math.random()-.5)*30,(Math.random()-.5)*10,-Math.random()*50);ap.receiveShadow=true;sc.add(ap);asts.push(ap);}
  function setupHole(){const h=HOLES[holeIdx];ball.position.set(h.bx,h.by+.8,h.bz);bv.set(0,0,0);cup.position.set(h.hx,h.hy+.1,h.hz);cupL.position.set(h.hx,h.hy+3,h.hz);strokes=0;setScore('HOLE '+(holeIdx+1)+'/5 | PAR '+h.par+' | STROKES:0 | TOTAL:'+total);addMsg('CLICK & DRAG to aim ¬∑ RELEASE to shoot');}
  let dragging=false,ds={x:0,y:0};
  cv.addEventListener('mousedown',e=>{if(bv.length()<.05){dragging=true;const r2=cv.getBoundingClientRect();ds={x:e.clientX-r2.left,y:e.clientY-r2.top};}});
  cv.addEventListener('mouseup',e=>{if(!dragging)return;dragging=false;const r2=cv.getBoundingClientRect();const dx=(e.clientX-r2.left-ds.x)*.018,dz=(e.clientY-r2.top-ds.y)*.018;bv.set(-dx,0,-dz);if(bv.length()>.05){strokes++;setScore('HOLE '+(holeIdx+1)+'/5 | PAR '+HOLES[holeIdx].par+' | STROKES:'+strokes+' | TOTAL:'+total);}});
  setupHole();
  const stop=g3Loop(()=>{
    bv.y-=.003;bv.multiplyScalar(.993);ball.position.add(bv);ball.rotation.x+=bv.z*.5;ball.rotation.z-=bv.x*.5;
    asts.forEach(ap=>{const d=ball.position.distanceTo(ap.position),cr=ap.geometry.parameters.radius+.5;if(d<cr){const n=ball.position.clone().sub(ap.position).normalize();ball.position.copy(ap.position).addScaledVector(n,cr+.02);bv.reflect(n).multiplyScalar(.55);}});
    if(ball.position.distanceTo(cup.position)<.9&&bv.length()<.35){total+=strokes;if(holeIdx<HOLES.length-1){holeIdx++;addMsg('‚õ≥ IN THE HOLE! Moving to hole '+(holeIdx+1)+'...');setTimeout(setupHole,1500);}else addMsg('üèÜ GAME COMPLETE! Total:'+total+' (Par:17)');}
    if(Math.abs(ball.position.x)>70||Math.abs(ball.position.y)>70||Math.abs(ball.position.z)>70)setupHole();
    cam.position.lerp(new THREE.Vector3(ball.position.x*.3,ball.position.y+8,ball.position.z+16),.04);cam.lookAt(ball.position);
    rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Minigolf,60);});
}

// ============================================================
// G3-15: QUANTUM CANVAS ‚Äî Particle Art
// ============================================================
function g3Particles(){
  const cv=g3Canvas(580,470),rr=g3Renderer(cv);
  const sc=new THREE.Scene();sc.background=new THREE.Color(0x02000a);sc.add(mkLight('ambient',0x110022,.5));
  const cam=new THREE.PerspectiveCamera(70,580/470,.1,200);cam.position.set(0,0,40);cam.lookAt(0,0,0);
  const MAX=4000;const pos=new Float32Array(MAX*3),col=new Float32Array(MAX*3),sz=new Float32Array(MAX);
  const geo=new THREE.BufferGeometry();geo.setAttribute('position',new THREE.BufferAttribute(pos,3));geo.setAttribute('color',new THREE.BufferAttribute(col,3));geo.setAttribute('size',new THREE.BufferAttribute(sz,1));
  const mat=new THREE.PointsMaterial({size:.8,vertexColors:true,transparent:true,opacity:.9,blending:THREE.AdditiveBlending,depthWrite:false});
  sc.add(new THREE.Points(geo,mat));
  const PAL=[[1,.0,.43],[0,.96,1],[0.02,.84,.63],[1,.75,.04],[.51,.22,.93],[1,.42,.13],[.1,.9,.5],[1,.1,.8]];
  let frame=0,pCount=0,painting=false;const mx={x:0,y:0};
  cv.addEventListener('mousemove',e=>{const r2=cv.getBoundingClientRect();mx.x=((e.clientX-r2.left)/r2.width-.5)*38;mx.y=-((e.clientY-r2.top)/r2.height-.5)*28;if(!painting||pCount>=MAX)return;const c=PAL[Math.floor(frame/90)%PAL.length];for(let i=0;i<8;i++){const idx=pCount%MAX;pos[idx*3]=mx.x+(Math.random()-.5)*3;pos[idx*3+1]=mx.y+(Math.random()-.5)*3;pos[idx*3+2]=(Math.random()-.5)*6;col[idx*3]=c[0];col[idx*3+1]=c[1];col[idx*3+2]=c[2];sz[idx]=.4+Math.random()*1.4;pCount++;}geo.attributes.position.needsUpdate=true;geo.attributes.color.needsUpdate=true;geo.attributes.size.needsUpdate=true;setScore('PARTICLES:'+Math.min(pCount,MAX));});
  cv.addEventListener('mousedown',()=>painting=true);cv.addEventListener('mouseup',()=>painting=false);
  const xbtn=document.createElement('button');xbtn.className='restart-btn';xbtn.style.cssText+='border-color:#8338ec;color:#8338ec;margin:6px 4px;';xbtn.textContent='üí• EXPLODE';
  xbtn.onclick=()=>{for(let i=0;i<Math.min(pCount,MAX);i++){pos[i*3]+=(Math.random()-.5)*10;pos[i*3+1]+=(Math.random()-.5)*10;pos[i*3+2]+=(Math.random()-.5)*10;}geo.attributes.position.needsUpdate=true;};
  getCont().appendChild(xbtn);
  setScore('PARTICLES:0');addMsg('CLICK & DRAG to paint neon particles ¬∑ Color shifts over time');
  const stop=g3Loop(()=>{
    frame++;for(let i=0;i<Math.min(pCount,MAX);i++){pos[i*3+2]+=Math.sin(frame*.01+i*.08)*.004;}geo.attributes.position.needsUpdate=true;
    cam.position.x=Math.sin(frame*.005)*3;cam.position.y=Math.cos(frame*.007)*1.5;cam.lookAt(0,0,0);rr.render(sc,cam);
  });
  gameCleanup=()=>{stop();rr.dispose();};addRestartBtn(()=>{gameCleanup();setTimeout(g3Particles,60);});
}


// ============================================================
// ============================================================
// GAMES4 ‚Äî 15 BONUS GAMES
// ============================================================
// ============================================================

// ‚îÄ‚îÄ G4-1: CONWAY'S GAME OF LIFE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Life(){
  const COLS=80,ROWS=60,SZ=8;
  const C=makeCanvas(COLS*SZ,ROWS*SZ);const ctx=C.getContext('2d');
  let grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  let running=false,gen=0;
  // Random seed
  function randomize(){grid=Array.from({length:ROWS},()=>Array.from({length:COLS},()=>Math.random()<.25?1:0));gen=0;draw();}
  function next(){
    const ng=Array.from({length:ROWS},()=>Array(COLS).fill(0));
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
      let n=0;for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){if(dr===0&&dc===0)continue;const nr=(r+dr+ROWS)%ROWS,nc=(c+dc+COLS)%COLS;n+=grid[nr][nc];}
      if(grid[r][c]===1)ng[r][c]=n===2||n===3?1:0;else ng[r][c]=n===3?1:0;
    }
    grid=ng;gen++;const pop=grid.flat().reduce((a,v)=>a+v,0);setScore('GEN:'+gen+' | POP:'+pop);
  }
  function draw(){ctx.fillStyle='#05050f';ctx.fillRect(0,0,C.width,C.height);for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)if(grid[r][c]){ctx.fillStyle=`hsl(${(r*3+c*2+gen)%360},90%,60%)`;ctx.fillRect(c*SZ,r*SZ,SZ-1,SZ-1);}}
  C.addEventListener('click',e=>{const rc=C.getBoundingClientRect();const gr=Math.floor((e.clientY-rc.top)/SZ);const gc=Math.floor((e.clientX-rc.left)/SZ);if(gr>=0&&gr<ROWS&&gc>=0&&gc<COLS){grid[gr][gc]^=1;draw();}});
  // Controls
  const ctrlDiv=document.createElement('div');ctrlDiv.style.cssText='display:flex;gap:8px;padding:6px;flex-wrap:wrap;';
  const mkBtn=(lbl,fn)=>{const b=document.createElement('button');b.className='restart-btn';b.style.margin='2px';b.textContent=lbl;b.onclick=fn;ctrlDiv.appendChild(b);return b;};
  const runBtn=mkBtn('‚ñ∂ RUN',()=>{running=!running;runBtn.textContent=running?'‚è∏ PAUSE':'‚ñ∂ RUN';});
  mkBtn('‚ü≥ RANDOM',randomize);mkBtn('üóë CLEAR',()=>{grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));gen=0;draw();setScore('GEN:0 | POP:0');});
  getCont().appendChild(ctrlDiv);
  randomize();setScore('GEN:0 | POP:'+grid.flat().reduce((a,v)=>a+v,0));addMsg('CLICK cells to toggle ¬∑ RUN to simulate');
  gameInterval=setInterval(()=>{if(running){next();draw();}},80);
}

// ‚îÄ‚îÄ G4-2: SNAKE DUEL (2-player local) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Snake2(){
  const W=600,H=480,SZ=20;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  let s1={body:[{x:5,y:12}],dir:{x:1,y:0},alive:true,score:0};
  let s2={body:[{x:24,y:12}],dir:{x:-1,y:0},alive:true,score:0};
  let food={x:15,y:12},frame=0;
  function placeFood(){food={x:Math.floor(Math.random()*(W/SZ)),y:Math.floor(Math.random()*(H/SZ))};}
  document.addEventListener('keydown',function sd2k(e){
    if(currentGame!=='g4_snake2')return document.removeEventListener('keydown',sd2k);
    if(e.key==='w'&&s1.dir.y===0)s1.dir={x:0,y:-1};if(e.key==='s'&&s1.dir.y===0)s1.dir={x:0,y:1};
    if(e.key==='a'&&s1.dir.x===0)s1.dir={x:-1,y:0};if(e.key==='d'&&s1.dir.x===0)s1.dir={x:1,y:0};
    if(e.key==='ArrowUp'&&s2.dir.y===0)s2.dir={x:0,y:-1};if(e.key==='ArrowDown'&&s2.dir.y===0)s2.dir={x:0,y:1};
    if(e.key==='ArrowLeft'&&s2.dir.x===0)s2.dir={x:-1,y:0};if(e.key==='ArrowRight'&&s2.dir.x===0)s2.dir={x:1,y:0};
    e.preventDefault();
  });
  function moveSnake(s,other){
    if(!s.alive)return;
    const head={x:(s.body[0].x+s.dir.x+W/SZ)%(W/SZ),y:(s.body[0].y+s.dir.y+H/SZ)%(H/SZ)};
    const allBodies=[...s.body,...other.body];
    if(allBodies.some(b=>b.x===head.x&&b.y===head.y)){s.alive=false;return;}
    s.body.unshift(head);
    if(head.x===food.x&&head.y===food.y){s.score++;placeFood();}else s.body.pop();
  }
  function draw(){
    ctx.fillStyle='#05050f';ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='rgba(0,245,255,0.06)';for(let x=0;x<W;x+=SZ){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
    for(let y=0;y<H;y+=SZ){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
    // Food
    ctx.fillStyle='#ffbe0b';ctx.shadowColor='#ffbe0b';ctx.shadowBlur=10;ctx.fillRect(food.x*SZ+3,food.y*SZ+3,SZ-6,SZ-6);ctx.shadowBlur=0;
    // Snake 1 (cyan)
    s1.body.forEach((b,i)=>{ctx.fillStyle=i===0?'#00f5ff':'#0099aa';ctx.fillRect(b.x*SZ+1,b.y*SZ+1,SZ-2,SZ-2);});
    // Snake 2 (pink)
    s2.body.forEach((b,i)=>{ctx.fillStyle=i===0?'#ff006e':'#880033';ctx.fillRect(b.x*SZ+1,b.y*SZ+1,SZ-2,SZ-2);});
    if(!s1.alive||!s2.alive){ctx.fillStyle='#fff';ctx.font='bold 28px "Press Start 2P",monospace';ctx.textAlign='center';ctx.fillText(!s1.alive?'üîµ P2 WINS!':'üî¥ P1 WINS!',W/2,H/2);}
  }
  setScore('P1(WASD):0 | P2(ARROWS):0');addMsg('P1: WASD ¬∑ P2: ARROW KEYS ¬∑ Eat food, avoid bodies!');
  gameInterval=setInterval(()=>{
    if(!s1.alive||!s2.alive)return;
    frame++;moveSnake(s1,s2);moveSnake(s2,s1);draw();setScore('P1:'+s1.score+' | P2:'+s2.score);
  },120);
  addRestartBtn(()=>{clearInterval(gameInterval);g4Snake2();});
}

// ‚îÄ‚îÄ G4-3: SOKOBAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Sokoban(){
  const LEVELS=[
    ['#####','#@$.#','#####'],
    ['######','#@  .#','# $  #','#  ###','######'],
    ['#######','#.  ###','#  $  #','### $ #','  #@  #','  #####'],
    ['########','####  .#','#@ $   #','# $  ###','#   ###','#.  #','######'],
    ['#######','#     #','# .$. #','# $@$ #','# .$. #','#     #','#######'],
  ];
  let level=0,grid,px,py,moves;
  function loadLevel(){
    const raw=LEVELS[level];moves=0;
    grid=raw.map(row=>row.split(''));
    grid.forEach((row,r)=>row.forEach((c,col)=>{if(c==='@'||c==='+'){px=col;py=r;}if(c==='@')grid[r][col]=' ';if(c==='+')grid[r][col]='.';} ));
    setScore('LEVEL:'+(level+1)+'/'+LEVELS.length+' | MOVES:0');draw();
  }
  const SZ=52,PAD=20;
  let maxW=0,maxH=0;LEVELS.forEach(lv=>{maxW=Math.max(maxW,lv[0].length);maxH=Math.max(maxH,lv.length);});
  const W=maxW*SZ+PAD*2,H=maxH*SZ+PAD*2+40;
  const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  const COLS2={wall:'#334455',floor:'#0a0a1a',target:'#ff006e',box:'#ff8800',boxOK:'#06d6a0',player:'#00f5ff'};
  function draw(){
    ctx.fillStyle='#05050f';ctx.fillRect(0,0,W,H);
    const rows=grid.length,cols=grid[0].length;
    const ox=PAD+(maxW-cols)*SZ/2,oy=PAD+(maxH-rows)*SZ/2;
    grid.forEach((row,r)=>row.forEach((c,col)=>{
      const x=ox+col*SZ,y=oy+r*SZ;
      if(c==='#'){ctx.fillStyle=COLS2.wall;ctx.fillRect(x,y,SZ,SZ);ctx.strokeStyle='#445566';ctx.strokeRect(x+1,y+1,SZ-2,SZ-2);}
      else{ctx.fillStyle=COLS2.floor;ctx.fillRect(x,y,SZ,SZ);}
      if(c==='.'||c==='*'){ctx.fillStyle=COLS2.target;ctx.beginPath();ctx.arc(x+SZ/2,y+SZ/2,6,0,Math.PI*2);ctx.fill();}
      if(c==='$'||c==='*'){ctx.fillStyle=c==='*'?COLS2.boxOK:COLS2.box;ctx.fillRect(x+4,y+4,SZ-8,SZ-8);ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.strokeRect(x+4,y+4,SZ-8,SZ-8);}
    }));
    // Player
    const px2=ox+px*SZ,py2=oy+py*SZ;
    ctx.fillStyle=COLS2.player;ctx.beginPath();ctx.arc(px2+SZ/2,py2+SZ/2,SZ/2-4,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#002244';ctx.font=`${SZ-12}px sans-serif`;ctx.textAlign='center';ctx.fillText('‚óâ',px2+SZ/2,py2+SZ/2+5);
  }
  document.addEventListener('keydown',function sok(e){
    if(currentGame!=='g4_sokoban')return document.removeEventListener('keydown',sok);
    const dirs={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};
    if(e.key==='r'){loadLevel();return;}
    if(!dirs[e.key])return;e.preventDefault();
    const [dx,dy]=dirs[e.key],nx=px+dx,ny=py+dy,nnx=nx+dx,nny=ny+dy;
    const here=(grid[ny]&&grid[ny][nx]);if(!here||here==='#')return;
    if(here==='$'||here==='*'){
      const beyond=(grid[nny]&&grid[nny][nnx]);if(!beyond||beyond==='#'||beyond==='$'||beyond==='*')return;
      grid[nny][nnx]=beyond==='.'?'*':'$';grid[ny][nx]=here==='*'?'.':' ';
    }
    px=nx;py=ny;moves++;
    setScore('LEVEL:'+(level+1)+'/'+LEVELS.length+' | MOVES:'+moves);draw();
    if(grid.every(row=>!row.includes('$'))){setTimeout(()=>{if(level<LEVELS.length-1){level++;loadLevel();addMsg('Level '+(level+1)+'!');}else addMsg('üèÜ ALL LEVELS COMPLETE!');},400);}
  });
  loadLevel();addMsg('ARROW KEYS move/push ¬∑ R resets level');
  addRestartBtn(()=>{level=0;loadLevel();});
}

// ‚îÄ‚îÄ G4-4: BLACKJACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Blackjack(){
  const SUITS=['‚ô†','‚ô•','‚ô¶','‚ô£'];const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  let deck=[],player=[],dealer=[],chips=200,bet=0,state='bet';
  function makeDeck(){deck=[];SUITS.forEach(s=>RANKS.forEach(r=>deck.push({r,s})));deck.sort(()=>Math.random()-.5);}
  function val(hand){let v=0,aces=0;hand.forEach(c=>{const rv=parseInt(c.r)||({'J':10,'Q':10,'K':10,'A':11}[c.r]);v+=rv;if(c.r==='A')aces++;});while(v>21&&aces-->0)v-=10;return v;}
  function render(){
    getCont().innerHTML='';
    const style=`<style>
      .bj{font-family:'Share Tech Mono',monospace;color:#fff;padding:12px;max-width:520px;}
      .bj-hand{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;}
      .card{width:52px;height:72px;background:#fff;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,.5);}
      .card.red{color:#cc0000;}.card.back{background:#0a0a3a;color:#00f5ff;border:2px solid #00f5ff;}
      .bj-row{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0;}
      .bj-btn{padding:10px 20px;border:1px solid var(--cyan);color:var(--cyan);background:transparent;cursor:pointer;font-family:inherit;font-size:.85rem;letter-spacing:2px;transition:all .15s;}
      .bj-btn:hover{background:var(--cyan);color:#000;}
      .bj-btn.red-btn{border-color:var(--pink);color:var(--pink)}.bj-btn.red-btn:hover{background:var(--pink);color:#fff}
      .chips{font-size:1.1rem;color:var(--yellow);text-shadow:0 0 8px var(--yellow);margin:8px 0;}
      .msg{color:var(--green);font-size:1rem;margin:8px 0;min-height:1.4em;}
    </style>`;
    const isRed=c=>c.s==='‚ô•'||c.s==='‚ô¶';
    const cardHTML=(c,back=false)=>back?`<div class="card back">üÇ†</div>`:`<div class="card ${isRed(c)?'red':''}">${c.r}${c.s}</div>`;
    const dCards=dealer.map((c,i)=>cardHTML(c,state==='playing'&&i===1)).join('');
    const pCards=player.map(c=>cardHTML(c)).join('');
    const dVal=state==='playing'?val([dealer[0]]):val(dealer);
    const msg=state==='result'?getResult():'';
    const betBtns=state==='bet'?`<div class="bj-row"><button class="bj-btn" onclick="bjBet(10)">BET 10</button><button class="bj-btn" onclick="bjBet(25)">BET 25</button><button class="bj-btn" onclick="bjBet(50)">BET 50</button><button class="bj-btn" onclick="bjBet(chips)">ALL IN</button></div>`:'';
    const playBtns=state==='playing'?`<div class="bj-row"><button class="bj-btn" onclick="bjHit()">HIT</button><button class="bj-btn" onclick="bjStand()">STAND</button><button class="bj-btn" onclick="bjDouble()">DOUBLE DOWN</button></div>`:'';
    const nextBtn=state==='result'?`<div class="bj-row"><button class="bj-btn" onclick="bjNext()">NEXT HAND</button></div>`:'';
    getCont().innerHTML=style+`<div class="bj"><div class="chips">üí∞ CHIPS: ${chips}${bet?' | BET: '+bet:''}</div><div class="msg">${msg}</div><div>DEALER (${dVal})</div><div class="bj-hand">${dCards}</div><div>PLAYER (${val(player)||''})</div><div class="bj-hand">${pCards}</div>${betBtns}${playBtns}${nextBtn}</div>`;
    setScore('CHIPS: '+chips+(bet?' | BET: '+bet:''));
  }
  function getResult(){const pv=val(player),dv=val(dealer);if(pv>21)return'üí• BUST! Dealer wins.';if(dv>21)return'üéâ Dealer bust! You win '+bet+'!';if(pv===21&&player.length===2)return'üÉè BLACKJACK! You win '+(bet*1.5|0)+'!';if(pv>dv)return'üéâ You win '+bet+'!';if(pv<dv)return'üòû Dealer wins.';return'ü§ù Push ‚Äî bet returned.';}
  function deal(){makeDeck();player=[deck.pop(),deck.pop()];dealer=[deck.pop(),deck.pop()];state='playing';if(val(player)===21)bjStand();else render();}
  window.bjBet=(n)=>{if(state!=='bet')return;bet=Math.min(n,chips);chips-=bet;deal();};
  window.bjHit=()=>{if(state!=='playing')return;player.push(deck.pop());if(val(player)>21){settle(-bet);}render();};
  window.bjStand=()=>{if(state!=='playing')return;while(val(dealer)<17)dealer.push(deck.pop());const pv=val(player),dv=val(dealer);let gain=0;if(pv>21)gain=-bet;else if(dv>21||pv>dv)gain=pv===21&&player.length===2?bet*1.5|0:bet;else if(pv===dv)gain=0;else gain=-bet;settle(gain);};
  window.bjDouble=()=>{if(state!=='playing'||player.length!==2)return;chips-=bet;bet*=2;player.push(deck.pop());bjStand();};
  function settle(gain){state='result';chips+=bet+gain;if(chips<=0){chips=200;addMsg('Broke! Resetting to 200 chips.');}render();}
  window.bjNext=()=>{bet=0;state='bet';render();};
  makeDeck();state='bet';render();addMsg('Choose a bet to start!');
}

// ‚îÄ‚îÄ G4-5: TOWER OF HANOI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Hanoi(){
  const W=580,H=340;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  let discs=5,pegs=[[],[],[]],selected=null,moves=0;
  function reset(n){discs=n;pegs=[[],[],[]];for(let i=n;i>=1;i--)pegs[0].push(i);selected=null;moves=0;draw();setScore('MOVES:0 | OPTIMAL:'+(Math.pow(2,n)-1));}
  const PEG_X=[120,290,460],BASE_Y=280,DISC_H=18,MAX_W=160;
  const COLS3=['#ff006e','#ff6b35','#ffbe0b','#06d6a0','#00f5ff','#8338ec','#ff006e'];
  function draw(){
    ctx.fillStyle='#05050f';ctx.fillRect(0,0,W,H);
    // Base
    ctx.fillStyle='#223344';ctx.fillRect(20,BASE_Y+DISC_H,W-40,14);
    // Pegs
    PEG_X.forEach((x,pi)=>{
      ctx.fillStyle=selected===pi?'#ffbe0b':'#445566';ctx.fillRect(x-5,80,10,BASE_Y-80);
      pegs[pi].forEach((d,di)=>{const w=d/discs*MAX_W,y=BASE_Y-(di+1)*DISC_H;ctx.fillStyle=COLS3[d%COLS3.length];ctx.shadowColor=COLS3[d%COLS3.length];ctx.shadowBlur=8;ctx.fillRect(x-w/2,y,w,DISC_H-2);ctx.shadowBlur=0;});
      ctx.fillStyle='#aaa';ctx.font='11px monospace';ctx.textAlign='center';ctx.fillText(['A','B','C'][pi],x,BASE_Y+DISC_H+28);
    });
    if(pegs[2].length===discs&&pegs[2][0]===1){ctx.fillStyle='#06d6a0';ctx.font='bold 22px "Press Start 2P",monospace';ctx.textAlign='center';ctx.fillText('YOU WIN! üèÜ',W/2,50);}
  }
  C.addEventListener('click',e=>{
    const r=C.getBoundingClientRect();const mx=e.clientX-r.left;
    const pi=PEG_X.findIndex(x=>Math.abs(mx-x)<MAX_W/2);if(pi<0)return;
    if(selected===null){if(pegs[pi].length>0)selected=pi;}
    else{
      if(pi!==selected){const top=pegs[selected][pegs[selected].length-1];const destTop=pegs[pi][pegs[pi].length-1];
        if(!destTop||destTop>top){pegs[pi].push(pegs[selected].pop());moves++;setScore('MOVES:'+moves+' | OPTIMAL:'+(Math.pow(2,discs)-1));}}
      selected=null;
    }
    draw();
  });
  // Disc count buttons
  const d=document.createElement('div');d.style.cssText='display:flex;gap:8px;padding:6px;';
  [3,4,5,6,7].forEach(n=>{const b=document.createElement('button');b.className='restart-btn';b.style.margin='2px';b.textContent=n+' DISCS';b.onclick=()=>reset(n);d.appendChild(b);});
  getCont().appendChild(d);
  reset(discs);addMsg('Click a peg to pick up top disc ¬∑ Click another to place');
}

// ‚îÄ‚îÄ G4-6: PIXEL AQUARIUM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Aquarium(){
  const W=580,H=420;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  const fish=[],food_p=[];
  function mkFish(x,y,type){return{x,y,vx:(Math.random()-.5)*2,vy:(Math.random()-.5)*.8,type,size:type==='predator'?14:8,hp:type==='predator'?3:1,age:0};}
  for(let i=0;i<18;i++)fish.push(mkFish(Math.random()*W,Math.random()*H,'prey'));
  for(let i=0;i<4;i++)fish.push(mkFish(Math.random()*W,Math.random()*H,'predator'));
  C.addEventListener('click',e=>{const r=C.getBoundingClientRect();food_p.push({x:e.clientX-r.left,y:e.clientY-r.top,life:200});});
  let frame=0;
  function update(){
    frame++;
    fish.forEach((f,fi)=>{
      f.age++;let ax=0,ay=0;
      if(f.type==='prey'){
        // Flee predators
        fish.filter(o=>o.type==='predator').forEach(p=>{const dx=f.x-p.x,dy=f.y-p.y,d=Math.hypot(dx,dy);if(d<80){ax+=dx/d*3;ay+=dy/d*3;}});
        // Seek food
        food_p.forEach(fp=>{const dx=fp.x-f.x,dy=fp.y-f.y,d=Math.hypot(dx,dy);if(d<120){ax+=dx/d*.5;ay+=dy/d*.5;}});
        // Flocking
        const near=fish.filter((o,oi)=>oi!==fi&&o.type==='prey'&&Math.hypot(o.x-f.x,o.y-f.y)<60);
        if(near.length){const cx=near.reduce((s,o)=>s+o.x,0)/near.length,cy=near.reduce((s,o)=>s+o.y,0)/near.length;ax+=(cx-f.x)*.01;ay+=(cy-f.y)*.01;ax+=near.reduce((s,o)=>s+(f.x-o.x)/Math.max(1,Math.hypot(o.x-f.x,o.y-f.y)),0)*.3;ay+=near.reduce((s,o)=>s+(f.y-o.y)/Math.max(1,Math.hypot(o.x-f.x,o.y-f.y)),0)*.3;}
      } else {
        // Predator hunts nearest prey
        const prey=fish.filter(o=>o.type==='prey');if(prey.length){const t=prey.reduce((a,b)=>Math.hypot(b.x-f.x,b.y-f.y)<Math.hypot(a.x-f.x,a.y-f.y)?b:a);const dx=t.x-f.x,dy=t.y-f.y,d=Math.hypot(dx,dy);ax+=dx/d*1.5;ay+=dy/d*1.5;if(d<f.size+t.size){fish.splice(fish.indexOf(t),1);f.hp++;if(f.hp>6)f.hp=6;}}
      }
      f.vx=Math.max(-3,Math.min(3,f.vx+ax*.1+(Math.random()-.5)*.15));f.vy=Math.max(-2,Math.min(2,f.vy+ay*.1+(Math.random()-.5)*.1));
      f.x=(f.x+f.vx+W)%W;f.y=Math.max(10,Math.min(H-10,f.y+f.vy));
    });
    // Eat food
    food_p.forEach((fp,fi)=>{fp.life--;fish.filter(f=>f.type==='prey'&&Math.hypot(fp.x-f.x,fp.y-f.y)<15).forEach(f=>{f.hp++;food_p.splice(fi,1);});});
    // Spawn
    if(frame%180===0&&fish.filter(f=>f.type==='prey').length<25)fish.push(mkFish(0,Math.random()*H,'prey'));
    if(frame%400===0&&fish.filter(f=>f.type==='predator').length<6)fish.push(mkFish(0,Math.random()*H,'predator'));
    food_p.forEach((fp,fi)=>{if(fp.life<=0)food_p.splice(fi,1);});
  }
  function draw(){
    ctx.fillStyle='rgba(2,5,20,0.35)';ctx.fillRect(0,0,W,H);
    // Bubbles
    if(frame%8===0){ctx.strokeStyle='rgba(0,200,255,0.15)';ctx.lineWidth=1;ctx.beginPath();const bx=Math.random()*W,by=H;ctx.arc(bx,by,2,0,Math.PI*2);ctx.stroke();}
    food_p.forEach(fp=>{ctx.fillStyle=`rgba(100,255,100,${fp.life/200})`;ctx.beginPath();ctx.arc(fp.x,fp.y,4,0,Math.PI*2);ctx.fill();});
    fish.forEach(f=>{
      const angle=Math.atan2(f.vy,f.vx);ctx.save();ctx.translate(f.x,f.y);ctx.rotate(angle);
      const col=f.type==='predator'?'#ff006e':'#00f5ff';const sz=f.size;
      ctx.fillStyle=col;ctx.beginPath();ctx.ellipse(0,0,sz,sz*.6,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=col;ctx.beginPath();ctx.moveTo(-sz,0);ctx.lineTo(-sz-sz*.6,sz*.5);ctx.lineTo(-sz-sz*.6,-sz*.5);ctx.closePath();ctx.fill();
      ctx.restore();
    });
    const prey=fish.filter(f=>f.type==='prey').length,pred=fish.filter(f=>f.type==='predator').length;
    setScore('üê† PREY:'+prey+' | ü¶à PREDATORS:'+pred);
  }
  addMsg('CLICK to add food ¬∑ Watch fish school, hunt and flee!');
  gameInterval=setInterval(()=>{update();draw();},30);
  addRestartBtn(()=>{clearInterval(gameInterval);g4Aquarium();});
}

// ‚îÄ‚îÄ G4-7: BRICK BLITZ (Breakout + power-ups) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Breakout2(){
  const W=580,H=480;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  let bricks=[],balls=[],powerups=[],paddle={x:W/2-50,w:100,y:H-30,h:12},score=0,lives=3,multi=1,frame=0;
  function makeBricks(){bricks=[];for(let r=0;r<6;r++)for(let c=0;c<10;c++){const x=c*56+8,y=r*28+50,hp=r<2?1:r<4?2:3;const pu=Math.random()<.15?['wide','multi','extra','laser'][Math.floor(Math.random()*4)]:null;bricks.push({x,y,w:50,h:22,hp,maxHp:hp,pu});}}
  function addBall(x,y,a){balls.push({x:x||W/2,y:y||H-60,vx:Math.sin(a||-.4)*5,vy:Math.cos(a||-.4)*-5});}
  function reset(){bricks=[];balls=[];powerups=[];paddle={x:W/2-50,w:100,y:H-30,h:12};score=0;lives=3;multi=1;frame=0;makeBricks();addBall();setScore('SCORE:0 | LIVES:‚ô•‚ô•‚ô• | x1');}
  C.addEventListener('mousemove',e=>{const r=C.getBoundingClientRect();paddle.x=Math.max(0,Math.min(W-paddle.w,e.clientX-r.left-paddle.w/2));});
  function draw(){
    ctx.fillStyle='#05050f';ctx.fillRect(0,0,W,H);
    bricks.forEach(b=>{const c=b.hp===b.maxHp?['#ff006e','#ffbe0b','#8338ec'][b.maxHp-1]:'#445566';ctx.fillStyle=c;ctx.fillRect(b.x,b.y,b.w,b.h);ctx.strokeStyle='rgba(255,255,255,0.15)';ctx.strokeRect(b.x,b.y,b.w,b.h);if(b.pu){ctx.fillStyle='#fff';ctx.font='10px sans-serif';ctx.textAlign='center';ctx.fillText(b.pu[0].toUpperCase(),b.x+b.w/2,b.y+b.h/2+4);}});
    ctx.fillStyle='#00f5ff';ctx.shadowColor='#00f5ff';ctx.shadowBlur=12;ctx.fillRect(paddle.x,paddle.y,paddle.w,paddle.h);ctx.shadowBlur=0;
    balls.forEach(b=>{ctx.fillStyle='#ffbe0b';ctx.beginPath();ctx.arc(b.x,b.y,6,0,Math.PI*2);ctx.fill();});
    powerups.forEach(p=>{ctx.fillStyle='#06d6a0';ctx.fillRect(p.x-12,p.y-8,24,16);ctx.fillStyle='#fff';ctx.font='9px sans-serif';ctx.textAlign='center';ctx.fillText(p.type,p.x,p.y+4);});
  }
  function tick(){
    frame++;
    balls.forEach((b,bi)=>{
      b.x+=b.vx;b.y+=b.vy;
      if(b.x<6||b.x>W-6)b.vx*=-1;if(b.y<6)b.vy*=-1;
      if(b.x>paddle.x&&b.x<paddle.x+paddle.w&&b.y>paddle.y-6&&b.y<paddle.y+paddle.h){b.vy=-Math.abs(b.vy);const off=(b.x-(paddle.x+paddle.w/2))/(paddle.w/2);b.vx=off*6;}
      if(b.y>H+10){balls.splice(bi,1);if(!balls.length){lives--;setScore('SCORE:'+score+' | LIVES:'+'‚ô•'.repeat(Math.max(0,lives))+' | x'+multi);if(lives<=0){addMsg('GAME OVER! Score:'+score);clearInterval(gameInterval);}else addBall();}}
      bricks.forEach((br,bri)=>{if(b.x>br.x&&b.x<br.x+br.w&&b.y>br.y&&b.y<br.y+br.h){b.vy*=-1;br.hp--;score+=10*multi;if(br.hp<=0){if(br.pu)powerups.push({x:br.x+25,y:br.y,vy:2,type:br.pu});bricks.splice(bri,1);}setScore('SCORE:'+score+' | LIVES:'+'‚ô•'.repeat(lives)+' | x'+multi);}});
    });
    powerups.forEach((p,pi)=>{p.y+=p.vy;if(p.y>paddle.y&&p.y<paddle.y+20&&p.x>paddle.x&&p.x<paddle.x+paddle.w){if(p.type==='wide')paddle.w=Math.min(200,paddle.w+40);if(p.type==='multi'){multi++;addBall(balls[0]?balls[0].x:W/2,balls[0]?balls[0].y:H-60,.4);addBall(balls[0]?balls[0].x:W/2,balls[0]?balls[0].y:H-60,-.8);}if(p.type==='extra')lives++;if(p.type==='laser')score+=500;powerups.splice(pi,1);}else if(p.y>H)powerups.splice(pi,1);});
    if(!bricks.length){addMsg('üèÜ ALL BRICKS CLEARED! Score:'+score);clearInterval(gameInterval);}
    draw();
  }
  reset();addMsg('MOUSE to move paddle ¬∑ Break all bricks ¬∑ Catch power-ups!');
  gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);reset();gameInterval=setInterval(tick,16);});
}

// ‚îÄ‚îÄ G4-8: GRAVITY WARS (hot-seat artillery) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Gravity(){
  const W=580,H=420;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  const players=[{x:60,y:0,color:'#00f5ff',name:'P1',angle:45,power:50,score:0},{x:W-60,y:0,color:'#ff006e',name:'P2',angle:135,power:50,score:0}];
  // Terrain
  const terrain=[];for(let x=0;x<W;x++){const h=H-60-Math.sin(x*.02)*30-Math.sin(x*.07)*15-Math.sin(x*.003)*40;terrain.push(Math.max(30,Math.min(H-20,h)));}
  players.forEach(p=>{p.y=terrain[p.x]-16;});
  let turn=0,proj=null,exploding=null,inputMode=true,frame=0;
  function draw(){
    ctx.fillStyle='#05050f';ctx.fillRect(0,0,W,H);
    // Stars
    ctx.fillStyle='rgba(255,255,255,0.3)';for(let i=0;i<50;i++){const sx=(i*137)%W,sy=(i*89)%80;ctx.fillRect(sx,sy,1,1);}
    // Terrain
    ctx.fillStyle='#1a2e10';ctx.beginPath();ctx.moveTo(0,H);terrain.forEach((h,x)=>ctx.lineTo(x,h));ctx.lineTo(W,H);ctx.closePath();ctx.fill();
    ctx.strokeStyle='#06d6a0';ctx.lineWidth=2;ctx.beginPath();terrain.forEach((h,x)=>x===0?ctx.moveTo(x,h):ctx.lineTo(x,h));ctx.stroke();ctx.lineWidth=1;
    // Players
    players.forEach((p,pi)=>{
      ctx.fillStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=10;
      ctx.fillRect(p.x-10,p.y-18,20,18);ctx.shadowBlur=0;
      ctx.fillStyle='#fff';ctx.font='10px monospace';ctx.textAlign='center';ctx.fillText(p.name,p.x,p.y-22);
      // Aim line
      if(pi===turn&&inputMode){const rad=p.angle*Math.PI/180;ctx.strokeStyle=p.color+'88';ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(p.x,p.y-9);ctx.lineTo(p.x+Math.cos(rad)*p.power*.5,p.y-9-Math.sin(rad)*p.power*.5);ctx.stroke();ctx.setLineDash([]);}
    });
    // Projectile
    if(proj){ctx.fillStyle='#ffbe0b';ctx.shadowColor='#ffbe0b';ctx.shadowBlur=12;ctx.beginPath();ctx.arc(proj.x,proj.y,4,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
    // Explosion
    if(exploding){const r=exploding.r;ctx.fillStyle=`rgba(255,100,0,${1-r/30})`;ctx.beginPath();ctx.arc(exploding.x,exploding.y,r,0,Math.PI*2);ctx.fill();}
    // HUD
    const cur=players[turn];ctx.fillStyle='#fff';ctx.font='11px "Share Tech Mono",monospace';ctx.textAlign='left';
    ctx.fillText(`${cur.name} | Angle:${Math.round(cur.angle)}¬∞ | Power:${Math.round(cur.power)} | ‚Üê ‚Üí adjust angle ¬∑ ‚Üë ‚Üì power ¬∑ SPACE fire`,8,H-6);
    ctx.textAlign='left';ctx.fillStyle='#00f5ff';ctx.fillText('P1:'+players[0].score,8,18);ctx.fillStyle='#ff006e';ctx.textAlign='right';ctx.fillText('P2:'+players[1].score,W-8,18);
  }
  document.addEventListener('keydown',function gwk(e){
    if(currentGame!=='g4_gravity')return document.removeEventListener('keydown',gwk);
    if(!inputMode)return;const p=players[turn];
    if(e.key==='ArrowLeft')p.angle=Math.max(5,p.angle-2);if(e.key==='ArrowRight')p.angle=Math.min(175,p.angle+2);
    if(e.key==='ArrowUp')p.power=Math.min(100,p.power+2);if(e.key==='ArrowDown')p.power=Math.max(10,p.power-2);
    if(e.key===' '){inputMode=false;const rad=p.angle*Math.PI/180;const spd=p.power*.12;proj={x:p.x,y:p.y-9,vx:Math.cos(rad)*spd,vy:-Math.sin(rad)*spd};e.preventDefault();}
    draw();
  });
  function updateProj(){
    if(!proj)return;proj.vy+=0.12;proj.x+=proj.vx;proj.y+=proj.vy;
    const tx=Math.round(proj.x);if(tx>=0&&tx<W&&proj.y>=terrain[tx]){explode(proj.x,proj.y);return;}
    if(proj.x<0||proj.x>W||proj.y>H){proj=null;turn^=1;inputMode=true;addMsg(players[turn].name+"'s turn");draw();return;}
    // Hit player?
    const other=players[turn^1];if(Math.hypot(proj.x-other.x,proj.y-other.y)<18){explode(proj.x,proj.y);players[turn].score++;setScore('P1:'+players[0].score+' | P2:'+players[1].score);addMsg(players[turn].name+' SCORES!');setTimeout(()=>{other.x=turn===0?W-60:60;other.y=terrain[other.x]-16;},500);}
  }
  function explode(ex,ey){proj=null;exploding={x:ex,y:ey,r:1};const ei=setInterval(()=>{exploding.r+=2;if(exploding.r>30){exploding=null;clearInterval(ei);turn^=1;inputMode=true;addMsg(players[turn].name+"'s turn");}draw();},20);}
  setScore('P1:0 | P2:0');addMsg("P1's turn ‚Äî ‚Üê ‚Üí angle, ‚Üë ‚Üì power, SPACE fire");
  gameInterval=setInterval(()=>{frame++;if(proj)updateProj();draw();},30);
  addRestartBtn(()=>{clearInterval(gameInterval);g4Gravity();});
}

// ‚îÄ‚îÄ G4-9: PIPE DREAM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Pipes(){
  const COLS=9,ROWS=7,SZ=64;const W=COLS*SZ,H=ROWS*SZ+60;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  // Pipe types: 0=empty, 1=straight-H, 2=straight-V, 3=bend-NE, 4=bend-NW, 5=bend-SE, 6=bend-SW, 7=tee, 8=cross
  // Connections [N,E,S,W]
  const CONN={0:[0,0,0,0],1:[0,1,0,1],2:[1,0,1,0],3:[1,1,0,0],4:[1,0,0,1],5:[0,1,1,0],6:[0,0,1,1],7:[1,1,1,0],8:[1,1,1,1]};
  const PIECES=[1,1,2,2,3,4,5,6,7,8];
  let grid,queue,water,level=0,flowing=false,fillT=0;
  function newLevel(){
    grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));water=Array.from({length:ROWS},()=>Array(COLS).fill(0));
    queue=[...PIECES].sort(()=>Math.random()-.5).slice(0,5);flowing=false;fillT=0;
    // Source at left, drain at right
    grid[Math.floor(ROWS/2)][0]=2;grid[Math.floor(ROWS/2)][COLS-1]=2;setScore('LEVEL:'+(level+1)+' ¬∑ CLICK cells to place ¬∑ SPACE to start flow');draw();
  }
  function nextPiece(){return queue[0];}
  C.addEventListener('click',e=>{
    if(flowing)return;const r2=C.getBoundingClientRect();const col=Math.floor((e.clientX-r2.left)/SZ),row=Math.floor((e.clientY-r2.top)/SZ);
    if(row<0||row>=ROWS||col<0||col>=COLS)return;if(col===0||col===COLS-1)return;
    grid[row][col]=nextPiece();queue.shift();queue.push(PIECES[Math.floor(Math.random()*PIECES.length)]);draw();
  });
  document.addEventListener('keydown',function ppk(e){if(currentGame!=='g4_pipes')return document.removeEventListener('keydown',ppk);if(e.key===' '){flowing=true;e.preventDefault();}});
  function drawPipe(x,y,type,fill){
    const c=CONN[type],cx=x+SZ/2,cy=y+SZ/2,r=SZ*.35;
    ctx.strokeStyle=fill?'#06d6a0':'#334455';ctx.lineWidth=fill?12:8;ctx.lineCap='round';
    if(c[0]){ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx,y);ctx.stroke();}
    if(c[1]){ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(x+SZ,cy);ctx.stroke();}
    if(c[2]){ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx,y+SZ);ctx.stroke();}
    if(c[3]){ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(x,cy);ctx.stroke();}
    ctx.strokeStyle=fill?'#00ff88':'#445566';ctx.lineWidth=fill?4:2;ctx.beginPath();ctx.arc(cx,cy,4,0,Math.PI*2);ctx.stroke();
  }
  function draw(){
    ctx.fillStyle='#05050f';ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='#111';for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){ctx.strokeRect(c*SZ,r*SZ,SZ,SZ);}
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){if(grid[r][c])drawPipe(c*SZ,r*SZ,grid[r][c],water[r][c]);}
    // Queue preview
    ctx.fillStyle='#0a0a2a';ctx.fillRect(0,ROWS*SZ,W,60);ctx.fillStyle='#aaa';ctx.font='10px monospace';ctx.textAlign='left';ctx.fillText('NEXT:',6,ROWS*SZ+18);
    queue.slice(0,5).forEach((p,i)=>{ctx.save();ctx.translate(60+i*70,ROWS*SZ+5);drawPipe(0,0,p,false);ctx.restore();});
    // Source/drain markers
    const sr=Math.floor(ROWS/2);ctx.fillStyle='#ffbe0b';ctx.font='bold 18px sans-serif';ctx.textAlign='center';ctx.fillText('‚ñ∂',SZ/2,sr*SZ+SZ/2+6);ctx.fillText('‚óÄ',(COLS-.5)*SZ,sr*SZ+SZ/2+6);
  }
  // Simple flood fill for water
  function flowStep(){
    const sr=Math.floor(ROWS/2);let changed=false;
    water[sr][0]=1;
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){if(!water[r][c])continue;const type=grid[r][c];if(!type)continue;const conn=CONN[type];
      if(conn[0]&&r>0&&grid[r-1][c]&&CONN[grid[r-1][c]][2]&&!water[r-1][c]){water[r-1][c]=1;changed=true;}
      if(conn[1]&&c<COLS-1&&grid[r][c+1]&&CONN[grid[r][c+1]][3]&&!water[r][c+1]){water[r][c+1]=1;changed=true;}
      if(conn[2]&&r<ROWS-1&&grid[r+1][c]&&CONN[grid[r+1][c]][0]&&!water[r+1][c]){water[r+1][c]=1;changed=true;}
      if(conn[3]&&c>0&&grid[r][c-1]&&CONN[grid[r][c-1]][1]&&!water[r][c-1]){water[r][c-1]=1;changed=true;}
    }
    if(water[sr][COLS-1]){addMsg('üèÜ FLOW COMPLETE! Level '+(level+1)+' done!');flowing=false;level++;setTimeout(newLevel,1400);}
    else if(!changed&&flowing){addMsg('üíß Flow stopped ‚Äî pipe incomplete!');flowing=false;}
    return changed;
  }
  newLevel();addMsg('Click to place pipes ¬∑ SPACE to start water flow');
  gameInterval=setInterval(()=>{if(flowing){fillT++;if(fillT%8===0)flowStep();}draw();},30);
  addRestartBtn(()=>{clearInterval(gameInterval);level=0;newLevel();gameInterval=setInterval(()=>{if(flowing){fillT++;if(fillT%8===0)flowStep();}draw();},30);});
}

// ‚îÄ‚îÄ G4-10: ROGUE DEPTHS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Dungeon(){
  const CW=29,CH=21,SZ=22;const W=CW*SZ,H=CH*SZ+30;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  let map,px,py,monsters,items,level=1,hp=10,maxHp=10,gold=0,atk=2,xp=0,xpNext=10;
  function genMap(){
    map=Array.from({length:CH},()=>Array(CW).fill(1));
    const rooms=[];
    for(let i=0;i<8;i++){const rw=4+Math.floor(Math.random()*5),rh=3+Math.floor(Math.random()*4),rx=1+Math.floor(Math.random()*(CW-rw-2)),ry=1+Math.floor(Math.random()*(CH-rh-2));rooms.push({x:rx,y:ry,w:rw,h:rh});for(let r=ry;r<ry+rh;r++)for(let c=rx;c<rx+rw;c++)map[r][c]=0;}
    for(let i=1;i<rooms.length;i++){const a=rooms[i-1],b=rooms[i];let cx=Math.floor(a.x+a.w/2),cy=Math.floor(a.y+a.h/2),tx=Math.floor(b.x+b.w/2),ty=Math.floor(b.y+b.h/2);while(cx!==tx){map[cy][cx]=0;cx+=cx<tx?1:-1;}while(cy!==ty){map[cy][cx]=0;cy+=cy<ty?1:-1;}}
    // Place player in first room center
    const r0=rooms[0];px=Math.floor(r0.x+r0.w/2);py=Math.floor(r0.y+r0.h/2);map[py][px]=0;
    // Exit in last room
    const rL=rooms[rooms.length-1];map[Math.floor(rL.y+rL.h/2)][Math.floor(rL.x+rL.w/2)]=3;
    // Monsters & items
    monsters=[];items=[];
    rooms.slice(1).forEach(r=>{if(Math.random()<.7){const mx=r.x+1+Math.floor(Math.random()*(r.w-2)),my=r.y+1+Math.floor(Math.random()*(r.h-2));if(map[my][mx]===0)monsters.push({x:mx,y:my,hp:level+1,maxHp:level+1,atk:level,type:Math.random()<.3?'boss':'mob',alive:true});}if(Math.random()<.5){const ix=r.x+Math.floor(Math.random()*r.w),iy=r.y+Math.floor(Math.random()*r.h);if(map[iy][ix]===0)items.push({x:ix,y:iy,type:Math.random()<.5?'gold':'hp',alive:true});}});
  }
  function draw(){
    ctx.fillStyle='#05050f';ctx.fillRect(0,0,W,H);
    const TCOLS2={0:'#111420',1:'#334',3:'#06d6a0'};
    for(let r=0;r<CH;r++)for(let c=0;c<CW;c++){const t=map[r][c];ctx.fillStyle=TCOLS2[t]||'#05050f';ctx.fillRect(c*SZ,r*SZ,SZ,SZ);if(t===3){ctx.fillStyle='#06d6a0';ctx.font=`${SZ-4}px sans-serif`;ctx.textAlign='center';ctx.fillText('‚¨á',c*SZ+SZ/2,r*SZ+SZ-2);}}
    items.filter(i=>i.alive).forEach(i=>{ctx.font=`${SZ-6}px sans-serif`;ctx.textAlign='center';ctx.fillText(i.type==='gold'?'üí∞':'‚ù§Ô∏è',i.x*SZ+SZ/2,i.y*SZ+SZ-2);});
    monsters.filter(m=>m.alive).forEach(m=>{ctx.fillStyle=m.type==='boss'?'#ff006e':'#ff4400';ctx.font=`${SZ-4}px sans-serif`;ctx.textAlign='center';ctx.fillText(m.type==='boss'?'üëπ':'üíÄ',m.x*SZ+SZ/2,m.y*SZ+SZ-3);const hpW=(m.hp/m.maxHp)*(SZ-4);ctx.fillStyle='#500';ctx.fillRect(m.x*SZ+2,m.y*SZ,SZ-4,3);ctx.fillStyle='#f00';ctx.fillRect(m.x*SZ+2,m.y*SZ,hpW,3);});
    // Player
    ctx.fillStyle='#00f5ff';ctx.font=`${SZ-4}px sans-serif`;ctx.textAlign='center';ctx.fillText('üßô',px*SZ+SZ/2,py*SZ+SZ-3);
    // HUD
    ctx.fillStyle='#0a0a1a';ctx.fillRect(0,CH*SZ,W,30);ctx.fillStyle='#fff';ctx.font='11px "Share Tech Mono",monospace';ctx.textAlign='left';
    ctx.fillText(`‚ù§Ô∏è${hp}/${maxHp} | ‚öîÔ∏è${atk} | üí∞${gold} | XP:${xp}/${xpNext} | LVL:${level}`,6,CH*SZ+19);
  }
  document.addEventListener('keydown',function dgk(e){
    if(currentGame!=='g4_dungeon')return document.removeEventListener('keydown',dgk);
    const dirs={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};
    if(!dirs[e.key])return;e.preventDefault();
    const[dx,dy]=dirs[e.key],nx=px+dx,ny=py+dy;
    if(nx<0||nx>=CW||ny<0||ny>=CH||map[ny][nx]===1)return;
    // Fight monster?
    const mon=monsters.find(m=>m.alive&&m.x===nx&&m.y===ny);
    if(mon){mon.hp-=atk;if(mon.hp<=0){mon.alive=false;xp+=mon.type==='boss'?5:2;gold+=mon.type==='boss'?10:2+Math.floor(Math.random()*4);setScore('Killed '+mon.type+'!');if(xp>=xpNext){xp=0;xpNext=Math.round(xpNext*1.6);atk++;maxHp+=2;hp=Math.min(maxHp,hp+3);setScore('LEVEL UP! ATK:'+atk);}}else{hp-=mon.atk;setScore('You hit for '+atk+', took '+mon.atk);if(hp<=0){addMsg('üíÄ YOU DIED | Score:'+gold+' gold');return;}}draw();return;}
    px=nx;py=ny;
    // Pick up item
    items.filter(i=>i.alive&&i.x===px&&i.y===py).forEach(i=>{i.alive=false;if(i.type==='gold'){gold+=5+Math.floor(Math.random()*10);}else{hp=Math.min(maxHp,hp+4);}});
    // Exit?
    if(map[py][px]===3){level++;hp=Math.min(maxHp,hp+5);setScore('Floor '+level+'!');genMap();}
    draw();setScore('‚ù§Ô∏è'+hp+'/'+maxHp+' | ‚öîÔ∏è'+atk+' | üí∞'+gold+' | Floor:'+level);
  });
  genMap();draw();addMsg('ARROW KEYS to move/fight ¬∑ ‚¨á = next floor ¬∑ Collect üí∞ & ‚ù§Ô∏è');
  addRestartBtn(()=>{level=1;hp=10;maxHp=10;gold=0;atk=2;xp=0;xpNext=10;genMap();draw();setScore('');addMsg('ARROW KEYS to move/fight');});
}

// ‚îÄ‚îÄ G4-11: CODE RAIN (Matrix typing) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4CodeRain(){
  const W=580,H=460;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  const CHARS='„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„ÉéABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&';
  const COLS2=Math.floor(W/20),drops=Array(COLS2).fill(0).map(()=>Math.floor(Math.random()*40));
  const streams=Array(COLS2).fill(null).map(()=>({chars:Array(30).fill('').map(()=>CHARS[Math.floor(Math.random()*CHARS.length)]),active:Math.random()<.4,highlighted:Math.random()<.15}));
  let score=0,combo=0,typed='',targetStream=null,frame=0;
  function pickTarget(){const active=streams.map((s,i)=>({s,i})).filter(({s})=>s.active&&s.highlighted&&s.chars.join('').trim().length>0);if(active.length){const pick=active[Math.floor(Math.random()*active.length)];targetStream=pick.i;setScore('TYPE THE GREEN STREAM | SCORE:'+score+' | COMBO:x'+combo);}else targetStream=null;}
  const input=document.createElement('input');input.style.cssText='background:#0a0a1a;border:1px solid #00f5ff;color:#00f5ff;padding:6px 12px;font-size:1rem;font-family:"Share Tech Mono",monospace;width:220px;outline:none;letter-spacing:2px;';
  input.placeholder='type here...';input.setAttribute('autocomplete','off');getCont().appendChild(input);setTimeout(()=>input.focus(),100);
  input.addEventListener('input',()=>{
    typed=input.value.toLowerCase();
    if(targetStream!==null){const target=streams[targetStream].chars.slice(0,8).join('').toLowerCase().replace(/\s/g,'');
      if(target.startsWith(typed)){if(typed.length>=5){score+=10*Math.max(1,combo);combo++;streams[targetStream].chars=Array(30).fill('').map(()=>CHARS[Math.floor(Math.random()*CHARS.length)]);streams[targetStream].highlighted=Math.random()<.15;typed='';input.value='';pickTarget();setScore('SCORE:'+score+' | COMBO:x'+combo);}}else{combo=0;input.value='';typed='';}}
  });
  function draw(){
    ctx.fillStyle='rgba(2,5,2,0.15)';ctx.fillRect(0,0,W,H);
    streams.forEach((s,ci)=>{
      if(!s.active)return;
      s.chars.forEach((ch,ri)=>{
        const y=(drops[ci]+ri)%Math.floor(H/20)*20;if(y<0)return;
        const intensity=1-ri/s.chars.length;
        if(ci===targetStream){ctx.fillStyle=ri===0?'#ffffff':`rgba(0,255,0,${intensity})`;}
        else if(s.highlighted&&ri<3){ctx.fillStyle=`rgba(0,255,128,${intensity*.8})`;}
        else{ctx.fillStyle=`rgba(0,${80+Math.floor(intensity*175)},0,${intensity*.7})`;}
        ctx.font=ri===0?'bold 16px monospace':'14px monospace';ctx.fillText(ch,ci*20,y);
      });
    });
    ctx.fillStyle='rgba(2,5,2,0.6)';ctx.fillRect(0,H-50,W,50);
    ctx.fillStyle='#0f0';ctx.font='12px monospace';ctx.textAlign='left';ctx.fillText('TYPE green streams ¬∑ Score:'+score+' Combo:x'+combo,8,H-12);
  }
  setScore('SCORE:0 | COMBO:x1');addMsg('Type the highlighted GREEN characters as they fall!');
  pickTarget();
  gameInterval=setInterval(()=>{
    frame++;if(frame%3===0){drops.forEach((d,i)=>{drops[i]=(d+1)%(Math.floor(H/20)+10);if(Math.random()<.01)streams[i].active=!streams[i].active;if(Math.random()<.005)streams[i].highlighted=!streams[i].highlighted;streams[i].chars[0]=CHARS[Math.floor(Math.random()*CHARS.length)];});}
    if(frame%120===0)pickTarget();draw();
  },50);
  gameCleanup=()=>{clearInterval(gameInterval);input.remove();};
  addRestartBtn(()=>{gameCleanup();score=0;combo=0;g4CodeRain();});
}

// ‚îÄ‚îÄ G4-12: RICOCHET ROYALE (Multi-ball Pong) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Pong2(){
  const W=600,H=460;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  const PH=80,PW=12;let p1={y:H/2-PH/2,score:0},p2={y:H/2-PH/2,score:0};
  const balls=[1,2,3].map((_,i)=>({x:W/2,y:H/4+i*H/4,vx:(i%2===0?1:-1)*4.5,vy:(Math.random()-.5)*5}));
  const keys={};
  document.addEventListener('keydown',function pong2k(e){if(currentGame!=='g4_pong2')return document.removeEventListener('keydown',pong2k);keys[e.key]=true;e.preventDefault();});
  document.addEventListener('keyup',e=>delete keys[e.key]);
  function draw(){
    ctx.fillStyle='#05050f';ctx.fillRect(0,0,W,H);
    ctx.setLineDash([8,8]);ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.beginPath();ctx.moveTo(W/2,0);ctx.lineTo(W/2,H);ctx.stroke();ctx.setLineDash([]);
    // Paddles
    ctx.fillStyle='#00f5ff';ctx.shadowColor='#00f5ff';ctx.shadowBlur=12;ctx.fillRect(10,p1.y,PW,PH);
    ctx.fillStyle='#ff006e';ctx.shadowColor='#ff006e';ctx.fillRect(W-10-PW,p2.y,PW,PH);ctx.shadowBlur=0;
    // Balls
    balls.forEach((b,i)=>{const col=['#ffbe0b','#8338ec','#06d6a0'][i];ctx.fillStyle=col;ctx.shadowColor=col;ctx.shadowBlur=14;ctx.beginPath();ctx.arc(b.x,b.y,8,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;});
    // Scores
    ctx.fillStyle='#fff';ctx.font='48px "Press Start 2P",monospace';ctx.textAlign='center';ctx.fillText(p1.score,W/4,60);ctx.fillText(p2.score,3*W/4,60);
    ctx.font='11px monospace';ctx.fillStyle='#888';ctx.fillText('W/S',30,H-8);ctx.fillText('‚Üë/‚Üì',W-30,H-8);
  }
  function tick(){
    if(keys['w'])p1.y=Math.max(0,p1.y-7);if(keys['s'])p1.y=Math.min(H-PH,p1.y+7);
    if(keys['ArrowUp'])p2.y=Math.max(0,p2.y-7);if(keys['ArrowDown'])p2.y=Math.min(H-PH,p2.y+7);
    balls.forEach(b=>{b.x+=b.vx;b.y+=b.vy;
      if(b.y<8||b.y>H-8)b.vy*=-1;
      if(b.x<22+PW&&b.y>p1.y&&b.y<p1.y+PH){b.vx=Math.abs(b.vx)*1.04;b.vy+=(Math.random()-.5)*2;}
      if(b.x>W-22-PW&&b.y>p2.y&&b.y<p2.y+PH){b.vx=-Math.abs(b.vx)*1.04;b.vy+=(Math.random()-.5)*2;}
      b.vx=Math.max(-10,Math.min(10,b.vx));b.vy=Math.max(-8,Math.min(8,b.vy));
      if(b.x<0){p2.score++;b.x=W/2;b.vx=4.5;b.vy=(Math.random()-.5)*5;setScore('P1:'+p1.score+' | P2:'+p2.score);if(p2.score>=10)addMsg('P2 WINS! Score:'+p2.score);}
      if(b.x>W){p1.score++;b.x=W/2;b.vx=-4.5;b.vy=(Math.random()-.5)*5;setScore('P1:'+p1.score+' | P2:'+p2.score);if(p1.score>=10)addMsg('P1 WINS! Score:'+p1.score);}
    });
    draw();
  }
  setScore('P1:0 | P2:0');addMsg('P1: W/S ¬∑ P2: ‚Üë/‚Üì ¬∑ 3 balls at once! First to 10 wins');
  gameInterval=setInterval(tick,16);
  addRestartBtn(()=>{clearInterval(gameInterval);g4Pong2();});
}

// ‚îÄ‚îÄ G4-13: CYBER SLOTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Slots(){
  const SYMS=['üíé','7Ô∏è‚É£','üîî','‚≠ê','üçí','üçã','üçá','üé∞'];
  const PAYS={'üíéüíéüíé':500,'7Ô∏è‚É£7Ô∏è‚É£7Ô∏è‚É£':200,'üîîüîîüîî':100,'‚≠ê‚≠ê‚≠ê':50,'üçíüçíüçí':30,'üçãüçãüçã':20,'üçáüçáüçá':15,'üíéüíé':25,'7Ô∏è‚É£7Ô∏è‚É£':15,'üîîüîî':10,'‚≠ê‚≠ê':5,'üçíüçí':4,'üé∞üé∞üé∞':1000};
  let chips=100,bet=10,spinning=false,reels=[[0,1,2],[2,3,4],[4,5,6]],frame=0;
  function render(){
    getCont().innerHTML='';
    const s=document.createElement('div');s.style.cssText='font-family:"Share Tech Mono",monospace;padding:16px;max-width:500px;text-align:center;';
    const reelHTML=reels.map(r=>`<div style="display:flex;flex-direction:column;gap:4px">${r.map((i,ri)=>`<div style="font-size:${ri===1?'2.8rem':'1.8rem'};padding:8px 16px;background:${ri===1?'#1a0a3a':'#0a0a1a'};border:${ri===1?'2px solid #8338ec':'1px solid #222'};border-radius:6px;transition:all .1s;${ri===1?'box-shadow:0 0 18px #8338ec44':''}">${SYMS[i%SYMS.length]}</div>`).join('')}</div>`).join('');
    const msg2=spinning?'SPINNING...':'';
    s.innerHTML=`
      <div style="font-size:1.4rem;color:#ffbe0b;text-shadow:0 0 10px #ffbe0b;margin-bottom:12px">üé∞ CYBER SLOTS üé∞</div>
      <div style="display:flex;gap:12px;justify-content:center;margin:16px 0;padding:16px;background:#05050f;border:2px solid #8338ec;border-radius:8px">${reelHTML}</div>
      <div style="color:#aaa;margin:8px 0;min-height:1.4em" id="slotmsg">${msg2}</div>
      <div style="color:#ffbe0b;font-size:1.1rem;margin:8px 0">üí∞ CHIPS: ${chips} | BET: ${bet}</div>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:12px">
        <button class="restart-btn" onclick="slotsSetBet(5)" style="margin:2px">BET 5</button>
        <button class="restart-btn" onclick="slotsSetBet(10)" style="margin:2px">BET 10</button>
        <button class="restart-btn" onclick="slotsSetBet(25)" style="margin:2px">BET 25</button>
        <button class="restart-btn" onclick="slotsSpin()" style="margin:2px;border-color:#ff006e;color:#ff006e;font-size:1rem;padding:10px 24px">SPIN!</button>
      </div>
    `;
    getCont().appendChild(s);setScore('CHIPS:'+chips+' | BET:'+bet);
  }
  window.slotsSetBet=(n)=>{if(!spinning&&chips>=n){bet=n;render();}};
  window.slotsSpin=()=>{
    if(spinning||chips<bet)return;chips-=bet;spinning=true;render();
    let ticks=0;const iv=setInterval(()=>{
      ticks++;reels=reels.map(r=>r.map(()=>Math.floor(Math.random()*SYMS.length)));render();
      const msg=document.getElementById('slotmsg');if(msg)msg.textContent='SPINNING...';
      if(ticks>20){clearInterval(iv);spinning=false;
        const row=[SYMS[reels[0][1]%SYMS.length],SYMS[reels[1][1]%SYMS.length],SYMS[reels[2][1]%SYMS.length]];
        let win=0;const k3=row.join('');const k2=row.slice(0,2).join('');
        if(PAYS[k3])win=PAYS[k3]*bet/10;else if(PAYS[k2])win=PAYS[k2]*bet/10;
        chips+=win;if(chips<=0)chips=50;render();
        const m=document.getElementById('slotmsg');if(m)m.textContent=win?`üéâ WIN! +${Math.round(win)} chips (${row.join('')})`:'No win this time...';
        setScore('CHIPS:'+chips+' | BET:'+bet);
      }
    },80);
  };
  render();addMsg('Set your bet and SPIN ¬∑ Match symbols to win ¬∑ üé∞üé∞üé∞ = JACKPOT!');
}

// ‚îÄ‚îÄ G4-14: PIXEL FORTRESS (2D Tower Defense) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Defense(){
  const W=580,H=440;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  const CELLW=36,CELLH=36,GW=Math.floor(W/CELLW),GH=Math.floor(H/CELLH);
  // Path: top-left to bottom-right zigzag
  const PATH2=[];for(let i=0;i<GW;i++)PATH2.push({x:i,y:i%2===0?1:GH-2});
  // Smooth path
  const SPATH=[];for(let i=0;i<PATH2.length-1;i++){const a=PATH2[i],b=PATH2[i+1];const dy=b.y>a.y?1:-1;for(let y=a.y;y!==b.y;y+=dy)SPATH.push({x:a.x,y});SPATH.push({x:b.x,y:b.y});}
  const pathSet=new Set(SPATH.map(p=>`${p.x},${p.y}`));
  const TOWER_TYPES={cannon:{cost:20,range:3.5,dmg:15,rate:60,color:'#ffbe0b',emoji:'üí£'},laser:{cost:35,range:5,dmg:8,rate:15,color:'#00f5ff',emoji:'‚ö°'},slow:{cost:15,range:3,dmg:1,rate:30,color:'#8338ec',emoji:'‚ùÑÔ∏è'}};
  let towers=[],enemies2=[],bullets2=[],lives2=20,gold2=100,wave2=0,wTimer2=0,selType='cannon',frame=0;
  function spawnWave2(){wave2++;for(let i=0;i<wave2*3;i++)setTimeout(()=>{const hp=8+wave2*4;enemies2.push({pi:0,hp,maxHp:hp,spd:(1+wave2*.08)*(Math.random()*.4+.8),slow:0,alive:true,id:Date.now()+Math.random()});},i*500);}
  function draw(){
    ctx.fillStyle='#0a1005';ctx.fillRect(0,0,W,H);
    // Grid
    for(let r=0;r<GH;r++)for(let c=0;c<GW;c++){ctx.fillStyle=pathSet.has(`${c},${r}`)?'#1a2e10':'#0d150a';ctx.fillRect(c*CELLW,r*CELLH,CELLW-1,CELLH-1);}
    // Path arrows
    ctx.fillStyle='#2a4a20';SPATH.forEach((p,i)=>{if(i%3===0){ctx.font='10px sans-serif';ctx.textAlign='center';ctx.fillText('‚ñ∂',p.x*CELLW+CELLW/2,p.y*CELLH+CELLH/2+4);}});
    // Towers
    towers.forEach(t=>{const tt=TOWER_TYPES[t.type];ctx.fillStyle='#0a0a1a';ctx.fillRect(t.x*CELLW+2,t.y*CELLH+2,CELLW-4,CELLH-4);ctx.font=`${CELLW-8}px sans-serif`;ctx.textAlign='center';ctx.fillText(tt.emoji,t.x*CELLW+CELLW/2,t.y*CELLH+CELLH-4);});
    // Enemies
    enemies2.filter(e=>e.alive).forEach(e=>{const sp=SPATH[Math.min(e.pi,SPATH.length-1)];const ex=sp.x*CELLW+CELLW/2,ey=sp.y*CELLH+CELLH/2;const r=CELLH*.38;ctx.fillStyle=e.slow>0?'#8338ec':'#ff2200';ctx.beginPath();ctx.arc(ex,ey,r,0,Math.PI*2);ctx.fill();const hw=(e.hp/e.maxHp)*(CELLW-6);ctx.fillStyle='#500';ctx.fillRect(ex-CELLW/2+3,ey-r-5,CELLW-6,3);ctx.fillStyle='#0f0';ctx.fillRect(ex-CELLW/2+3,ey-r-5,hw,3);});
    // Bullets
    bullets2.forEach(b=>{ctx.fillStyle=b.color||'#ffbe0b';ctx.beginPath();ctx.arc(b.x,b.y,3,0,Math.PI*2);ctx.fill();});
    // HUD
    ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(0,H-34,W,34);ctx.fillStyle='#aaa';ctx.font='11px "Share Tech Mono",monospace';ctx.textAlign='left';
    ctx.fillText(`üí∞${gold2} | ‚ù§Ô∏è${lives2} | WAVE:${wave2} | SELECT: ${selType.toUpperCase()} (1=CANNONüí£ 2=LASER‚ö° 3=SLOW‚ùÑÔ∏è) | SPACE=next wave`,6,H-12);
  }
  C.addEventListener('click',e=>{const r2=C.getBoundingClientRect();const cx=Math.floor((e.clientX-r2.left)/CELLW),cy=Math.floor((e.clientY-r2.top)/CELLH);if(pathSet.has(`${cx},${cy}`))return;if(towers.find(t=>t.x===cx&&t.y===cy))return;const tt=TOWER_TYPES[selType];if(gold2<tt.cost)return;gold2-=tt.cost;towers.push({x:cx,y:cy,type:selType,cool:0});});
  document.addEventListener('keydown',function dfk(e){if(currentGame!=='g4_defense')return document.removeEventListener('keydown',dfk);if(e.key==='1')selType='cannon';if(e.key==='2')selType='laser';if(e.key==='3')selType='slow';if(e.key===' '){spawnWave2();e.preventDefault();}});
  setScore('üí∞100 | ‚ù§Ô∏è20 | WAVE:0');addMsg('CLICK to place towers ¬∑ 1/2/3 select type ¬∑ SPACE = next wave');
  gameInterval=setInterval(()=>{
    frame++;
    // Move enemies
    enemies2.filter(e=>e.alive).forEach(e=>{const spd=e.slow>0?e.spd*.4:e.spd;e.pi+=spd*.08;e.slow=Math.max(0,e.slow-1);if(e.pi>=SPATH.length){e.alive=false;lives2--;setScore('üí∞'+gold2+' | ‚ù§Ô∏è'+lives2+' | WAVE:'+wave2);if(lives2<=0)addMsg('BASE DESTROYED! Score:'+(wave2*100));}});
    // Tower firing
    towers.forEach(t=>{t.cool--;if(t.cool>0)return;const tt=TOWER_TYPES[t.type];const tx=t.x*CELLW+CELLW/2,ty=t.y*CELLH+CELLH/2;const near=enemies2.filter(e=>e.alive).map(e=>{const sp=SPATH[Math.min(Math.floor(e.pi),SPATH.length-1)];const ex=sp.x*CELLW+CELLW/2,ey=sp.y*CELLH+CELLH/2;return{e,ex,ey,d:Math.hypot(ex-tx,ey-ty)};}).filter(({d})=>d<tt.range*CELLW).sort((a,b)=>a.d-b.d)[0];if(!near)return;t.cool=tt.rate;near.e.hp-=tt.dmg;if(t.type==='slow')near.e.slow=60;if(near.e.hp<=0){near.e.alive=false;gold2+=5+wave2;setScore('üí∞'+gold2+' | ‚ù§Ô∏è'+lives2+' | WAVE:'+wave2);}bullets2.push({x:tx,y:ty,tx:near.ex,ty:near.ey,spd:6,color:tt.color,life:12});});
    // Bullets
    bullets2.forEach((b,bi)=>{const dx=b.tx-b.x,dy=b.ty-b.y,d=Math.hypot(dx,dy);if(d<b.spd){bullets2.splice(bi,1);return;}b.x+=dx/d*b.spd;b.y+=dy/d*b.spd;b.life--;if(b.life<=0)bullets2.splice(bi,1);});
    wTimer2++;if(wTimer2>300&&enemies2.every(e=>!e.alive)&&wave2>0){wTimer2=0;setTimeout(spawnWave2,1500);}
    draw();
  },30);
  addRestartBtn(()=>{clearInterval(gameInterval);g4Defense();});
}

// ‚îÄ‚îÄ G4-15: SAND SIMULATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g4Sand(){
  const SZ=3,COLS3=Math.floor(580/SZ),ROWS3=Math.floor(430/SZ);
  const W=COLS3*SZ,H=ROWS3*SZ;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  const EMPTY=0,SAND=1,WATER=2,FIRE=3,STONE=4,SMOKE=5,WOOD=6;
  const COLS_MAP={[EMPTY]:'#05050f',[SAND]:'#c8a04a',[WATER]:'#1a6aff',[FIRE]:'#ff4400',[STONE]:'#667788',[SMOKE]:'#445566',[WOOD]:'#6b3a1f'};
  let grid=Array.from({length:ROWS3},()=>new Uint8Array(COLS3));
  let selMat=SAND,painting=false,frame=0;
  const mousePos={x:0,y:0};
  C.addEventListener('mousedown',e=>{painting=true;});C.addEventListener('mouseup',()=>painting=false);
  C.addEventListener('mousemove',e=>{const r=C.getBoundingClientRect();mousePos.x=Math.floor((e.clientX-r.left)/SZ);mousePos.y=Math.floor((e.clientY-r.top)/SZ);});
  function paint(){if(!painting)return;const r=3;for(let dy=-r;dy<=r;dy++)for(let dx=-r;dx<=r;dx++){const x=mousePos.x+dx,y=mousePos.y+dy;if(x>=0&&x<COLS3&&y>=0&&y<ROWS3&&dx*dx+dy*dy<=r*r){if(grid[y][x]===EMPTY||selMat===EMPTY)grid[y][x]=selMat;}}}
  function step(){
    for(let r=ROWS3-1;r>=0;r--){const leftFirst=Math.random()<.5;for(let c=leftFirst?0:COLS3-1;leftFirst?c<COLS3:c>=0;leftFirst?c++:c--){const t=grid[r][c];if(t===EMPTY||t===STONE)continue;
      if(t===SAND){if(r<ROWS3-1){if(grid[r+1][c]===EMPTY){grid[r+1][c]=SAND;grid[r][c]=EMPTY;}else if(grid[r+1][c]===WATER){grid[r+1][c]=SAND;grid[r][c]=WATER;}else{const d=Math.random()<.5?-1:1;if(c+d>=0&&c+d<COLS3&&grid[r+1][c+d]===EMPTY){grid[r+1][c+d]=SAND;grid[r][c]=EMPTY;}}}}
      else if(t===WATER){if(r<ROWS3-1&&grid[r+1][c]===EMPTY){grid[r+1][c]=WATER;grid[r][c]=EMPTY;}else{const d=Math.random()<.5?-1:1;if(c+d>=0&&c+d<COLS3&&grid[r][c+d]===EMPTY){grid[r][c+d]=WATER;grid[r][c]=EMPTY;}else if(c-d>=0&&c-d<COLS3&&grid[r][c-d]===EMPTY){grid[r][c-d]=WATER;grid[r][c]=EMPTY;}}}
      else if(t===FIRE){// Spread and burn
        if(Math.random()<.02)grid[r][c]=EMPTY;if(r>0&&grid[r-1][c]===EMPTY&&Math.random()<.3){grid[r-1][c]=Math.random()<.3?SMOKE:FIRE;}if(r>0&&grid[r-1][c]===WOOD&&Math.random()<.05)grid[r-1][c]=FIRE;if(grid[r][c]===FIRE&&r<ROWS3-1&&grid[r+1][c]===WATER){grid[r][c]=SMOKE;grid[r+1][c]=EMPTY;}const dirs2=[[-1,0],[1,0],[0,-1],[0,1]];dirs2.forEach(([dx,dy])=>{const nx2=c+dx,ny2=r+dy;if(nx2>=0&&nx2<COLS3&&ny2>=0&&ny2<ROWS3){if(grid[ny2][nx2]===WOOD&&Math.random()<.03)grid[ny2][nx2]=FIRE;if(grid[ny2][nx2]===WATER){grid[r][c]=EMPTY;}}}); }
      else if(t===SMOKE){if(r>0&&grid[r-1][c]===EMPTY&&Math.random()<.4){grid[r-1][c]=SMOKE;grid[r][c]=EMPTY;}if(Math.random()<.015)grid[r][c]=EMPTY;}
    }}
  }
  function draw(){
    const img=ctx.createImageData(W,H);const d=img.data;
    for(let r=0;r<ROWS3;r++)for(let c=0;c<COLS3;c++){
      const t=grid[r][c];let col=COLS_MAP[t]||'#05050f';
      if(t===FIRE)col=Math.random()<.5?'#ff4400':'#ff8800';
      if(t===SMOKE)col=Math.random()<.5?'#445566':'#556677';
      const hex=col.replace('#','');const ri2=parseInt(hex.substr(0,2),16),gi=parseInt(hex.substr(2,2),16),bi=parseInt(hex.substr(4,2),16);
      for(let py2=0;py2<SZ;py2++)for(let px2=0;px2<SZ;px2++){const i=((r*SZ+py2)*W+(c*SZ+px2))*4;d[i]=ri2;d[i+1]=gi;d[i+2]=bi;d[i+3]=255;}
    }
    ctx.putImageData(img,0,0);
    const cells=grid.flat().reduce((a,v)=>a+(v>0?1:0),0);setScore('CELLS:'+cells+' | '+['SANDüü°','WATERüíß','FIREüî•','STONEü™®','WOODü™µ'][selMat-1]||'ERASER');
  }
  // Controls
  const ctrl=document.createElement('div');ctrl.style.cssText='display:flex;gap:6px;padding:6px;flex-wrap:wrap;';
  const mats=[['üü° SAND',SAND,'#c8a04a'],['üíß WATER',WATER,'#1a6aff'],['üî• FIRE',FIRE,'#ff4400'],['ü™® STONE',STONE,'#667788'],['ü™µ WOOD',WOOD,'#6b3a1f'],['üóë ERASE',EMPTY,'#333']];
  mats.forEach(([lbl,mat,clr])=>{const b=document.createElement('button');b.className='restart-btn';b.style.cssText=`margin:2px;border-color:${clr};color:${clr};`;b.textContent=lbl;b.onclick=()=>{selMat=mat;};ctrl.appendChild(b);});
  getCont().appendChild(ctrl);
  addMsg('CLICK & DRAG to place material ¬∑ Watch sand, water and fire interact!');
  setScore('CELLS:0 | SANDüü°');
  gameInterval=setInterval(()=>{frame++;paint();step();if(frame%2===0)draw();},20);
  addRestartBtn(()=>{clearInterval(gameInterval);grid=Array.from({length:ROWS3},()=>new Uint8Array(COLS3));g4Sand();});
}


// ============================================================
// GAMES5 ‚Äî 15 MEGA PACK GAMES
// ============================================================

// ‚îÄ‚îÄ G5-1: BLITZ CHESS (3-min timer) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5Chess2(){
  // Reuse the full chess engine with a 3-min blitz clock overlay
  const PIECE_UNICODE={wK:'‚ôî',wQ:'‚ôï',wR:'‚ôñ',wB:'‚ôó',wN:'‚ôò',wP:'‚ôô',bK:'‚ôö',bQ:'‚ôõ',bR:'‚ôú',bB:'‚ôù',bN:'‚ôû',bP:'‚ôü'};
  const initBoard=()=>[
    ['bR','bN','bB','bQ','bK','bB','bN','bR'],
    ['bP','bP','bP','bP','bP','bP','bP','bP'],
    [null,null,null,null,null,null,null,null],
    [null,null,null,null,null,null,null,null],
    [null,null,null,null,null,null,null,null],
    [null,null,null,null,null,null,null,null],
    ['wP','wP','wP','wP','wP','wP','wP','wP'],
    ['wR','wN','wB','wQ','wK','wB','wN','wR'],
  ];
  let board=initBoard(),sel=null,turn='w',moveCount=0,gameOver=false;
  let wTime=180,bTime=180;
  const SZ=60,W=SZ*8,H=SZ*8+44;
  const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  function isW(p){return p&&p[0]==='w';}function isB(p){return p&&p[0]==='b';}
  function inBounds(r,c){return r>=0&&r<8&&c>=0&&c<8;}
  function getMoves(board,r,c){
    const p=board[r][c];if(!p)return[];const col=p[0],type=p[1],moves=[];
    const slide=(dr,dc)=>{let nr=r+dr,nc=c+dc;while(inBounds(nr,nc)){if(board[nr][nc]){if(board[nr][nc][0]!==col)moves.push([nr,nc]);break;}moves.push([nr,nc]);nr+=dr;nc+=dc;}};
    if(type==='P'){const dir=col==='w'?-1:1,start=col==='w'?6:1;if(inBounds(r+dir,c)&&!board[r+dir][c]){moves.push([r+dir,c]);if(r===start&&!(board[r+2*dir]&&board[r+2*dir][c]))moves.push([r+2*dir,c]);}[-1,1].forEach(dc=>{if(inBounds(r+dir,c+dc)&&(board[r+dir]&&board[r+dir][c+dc])&&board[r+dir][c+dc][0]!==col)moves.push([r+dir,c+dc]);});}
    if(type==='N'){[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr,dc])=>{if(inBounds(r+dr,c+dc)&&(board[r+dr][c+dc]&&board[r+dr][c+dc][0])!==col)moves.push([r+dr,c+dc]);});}
    if(type==='R'||type==='Q'){[[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc])=>slide(dr,dc));}
    if(type==='B'||type==='Q'){[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc])=>slide(dr,dc));}
    if(type==='K'){[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([dr,dc])=>{if(inBounds(r+dr,c+dc)&&(board[r+dr][c+dc]&&board[r+dr][c+dc][0])!==col)moves.push([r+dr,c+dc]);});}
    return moves;
  }
  function aiMove(){
    // Simple greedy AI: pick move with highest capture value
    const vals={P:1,N:3,B:3,R:5,Q:9,K:100};let best=null,bestScore=-999;
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){if((board[r][c]&&board[r][c][0]!=='b'))continue;getMoves(board,r,c).forEach(([nr,nc])=>{const cap=board[nr][nc]?vals[board[nr][nc][1]]||0:0;const rand=Math.random()*0.5;if(cap+rand>bestScore){bestScore=cap+rand;best={r,c,nr,nc};}});}
    if(best){const p=board[best.r][best.c];board[best.nr][best.nc]=p;board[best.r][best.c]=null;if(p==='bP'&&best.nr===7)board[best.nr][best.nc]='bQ';turn='w';}
    draw();
  }
  function draw(){
    ctx.clearRect(0,0,W,H);
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
      ctx.fillStyle=(r+c)%2===0?'#e8d5b0':'#8b6340';ctx.fillRect(c*SZ,r*SZ,SZ,SZ);
      if(sel&&getMoves(board,sel[0],sel[1]).some(([mr,mc])=>mr===r&&mc===c)){ctx.fillStyle='rgba(0,245,255,0.35)';ctx.fillRect(c*SZ,r*SZ,SZ,SZ);}
      if(sel&&sel[0]===r&&sel[1]===c){ctx.fillStyle='rgba(0,245,255,0.5)';ctx.fillRect(c*SZ,r*SZ,SZ,SZ);}
      if(board[r][c]){ctx.font=`${SZ-10}px serif`;ctx.textAlign='center';ctx.fillStyle=board[r][c][0]==='w'?'#fff':'#111';ctx.strokeStyle=board[r][c][0]==='w'?'#333':'#fff';ctx.lineWidth=1;ctx.strokeText(PIECE_UNICODE[board[r][c]],c*SZ+SZ/2,r*SZ+SZ-8);ctx.fillText(PIECE_UNICODE[board[r][c]],c*SZ+SZ/2,r*SZ+SZ-8);}
    }
    // Timer bar
    ctx.fillStyle='#0a0a1a';ctx.fillRect(0,SZ*8,W,44);
    const fmt=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
    ctx.font='bold 18px "Share Tech Mono",monospace';ctx.textAlign='left';ctx.fillStyle=wTime<30?'#ff0':'#00f5ff';ctx.fillText('WHITE: '+fmt(wTime),8,SZ*8+28);
    ctx.textAlign='right';ctx.fillStyle=bTime<30?'#ff0':'#ff006e';ctx.fillText('BLACK: '+fmt(bTime),W-8,SZ*8+28);
    ctx.textAlign='center';ctx.fillStyle='#aaa';ctx.font='11px monospace';ctx.fillText(gameOver?'GAME OVER':`${turn==='w'?'WHITE':'BLACK'} to move`,W/2,SZ*8+28);
  }
  C.addEventListener('click',e=>{
    if(gameOver||turn!=='w')return;
    const r2=C.getBoundingClientRect(),r=Math.floor((e.clientY-r2.top)/SZ),c=Math.floor((e.clientX-r2.left)/SZ);
    if(!inBounds(r,c))return;
    if(sel){const moves=getMoves(board,sel[0],sel[1]);if(moves.some(([mr,mc])=>mr===r&&mc===c)){const p=board[sel[0]][sel[1]];board[r][c]=p;board[sel[0]][sel[1]]=null;if(p==='wP'&&r===0)board[r][c]='wQ';sel=null;turn='b';moveCount++;draw();setTimeout(aiMove,300);return;}sel=null;}
    if((board[r][c]&&board[r][c][0]==='w'))sel=[r,c];draw();
  });
  setScore('WHITE: 3:00 | BLACK: 3:00');addMsg('Click piece then click destination ¬∑ AI plays Black');
  const clock=setInterval(()=>{if(gameOver)return;if(turn==='w')wTime--;else bTime--;if(wTime<=0||bTime<=0){gameOver=true;addMsg((wTime<=0?'Black':'White')+' wins on time!');clearInterval(clock);}draw();setScore(`WHITE:${Math.floor(wTime/60)}:${String(wTime%60).padStart(2,'0')} | BLACK:${Math.floor(bTime/60)}:${String(bTime%60).padStart(2,'0')}`);},1000);
  gameCleanup=()=>{clearInterval(clock);};draw();
  addRestartBtn(()=>{if(gameCleanup)gameCleanup();g5Chess2();});
}

// ‚îÄ‚îÄ G5-2: ROAD HOPPER (Frogger) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5Frogger(){
  const W=520,H=520,ROWS=13,SZ=40;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  const LANE_TYPES=['safe','road','road','road','road','water','water','water','water','road','road','road','safe'];
  const lanes=LANE_TYPES.map((type,i)=>{
    const objs=[];if(type==='road'){for(let j=0;j<3;j++)objs.push({x:Math.random()*W,w:60+Math.random()*60,spd:(1.5+Math.random()*2)*(i%2===0?1:-1)});}
    if(type==='water'){for(let j=0;j<4;j++)objs.push({x:Math.random()*W,w:80+Math.random()*60,spd:(1+Math.random()*1.5)*(i%2===0?1:-1)});}
    return{type,objs};
  });
  let frog={x:W/2,y:(ROWS-1)*SZ+SZ/2},lives=3,score=0,safe=new Set(),onLog=false,frame=0;
  function draw(){
    // Background lanes
    lanes.forEach((lane,i)=>{const y=i*SZ;ctx.fillStyle=lane.type==='road'?'#1a1a1a':lane.type==='water'?'#0a1aff':lane.type==='safe'?'#1a3a0a':'#0a0a0a';ctx.fillRect(0,y,W,SZ);});
    // Road markings
    lanes.forEach((lane,i)=>{if(lane.type==='road'){ctx.strokeStyle='rgba(255,255,0,0.15)';ctx.setLineDash([20,15]);ctx.beginPath();ctx.moveTo(0,i*SZ+SZ/2);ctx.lineTo(W,i*SZ+SZ/2);ctx.stroke();ctx.setLineDash([]);}});
    // Safe zone home bases
    for(let x=40;x<W-20;x+=100){if(safe.has(x))ctx.fillStyle='#06d6a0';else ctx.fillStyle='#2a4a1a';ctx.fillRect(x,0,60,SZ);}
    // Lane objects
    lanes.forEach((lane,i)=>{const y=i*SZ;lane.objs.forEach(o=>{if(lane.type==='road'){// Car
      ctx.fillStyle='#ff2200';ctx.fillRect(o.x,y+6,o.w,SZ-12);ctx.fillStyle='#ff8800';ctx.fillRect(o.x+4,y+8,o.w-8,SZ-16);}else if(lane.type==='water'){// Log
      ctx.fillStyle='#6b3a1f';ctx.fillRect(o.x,y+8,o.w,SZ-16);ctx.fillStyle='#8b5a3a';ctx.fillRect(o.x+2,y+10,o.w-4,SZ-20);}});});
    // Frog
    ctx.fillStyle='#44ff44';ctx.shadowColor='#00ff00';ctx.shadowBlur=10;ctx.beginPath();ctx.arc(frog.x,frog.y,14,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle='#222';ctx.fillRect(frog.x-8,frog.y-6,5,5);ctx.fillRect(frog.x+3,frog.y-6,5,5);
    // HUD
    ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(0,ROWS*SZ,W,24);ctx.fillStyle='#fff';ctx.font='12px monospace';ctx.textAlign='left';ctx.fillText('LIVES:'+'üê∏'.repeat(lives)+'  SCORE:'+score,8,ROWS*SZ+16);
  }
  function update(){
    frame++;const row=Math.floor(frog.y/SZ);const lane=lanes[row];onLog=false;
    if(lane){lane.objs.forEach(o=>{o.x+=o.spd;if(o.x>W+100)o.x=-100;if(o.x<-100)o.x=W+100;});
      if(lane.type==='water'){let onAny=false;lane.objs.forEach(o=>{if(frog.x>o.x&&frog.x<o.x+o.w){onAny=true;frog.x+=o.spd;}});if(!onAny){die();return;}}
      if(lane.type==='road'){lane.objs.forEach(o=>{if(frog.x>o.x-10&&frog.x<o.x+o.w+10&&frog.y>row*SZ+4&&frog.y<row*SZ+SZ-4){die();return;}});}
    }
    if(frog.x<0||frog.x>W){die();return;}
    if(row===0){// Reached top
      const slotX=Math.round((frog.x-40)/100)*100+40;if(!safe.has(slotX)){safe.add(slotX);score+=100;setScore('SCORE:'+score);}frog={x:W/2,y:(ROWS-1)*SZ+SZ/2};if(safe.size>=4)addMsg('üèÜ ALL HOME! Score:'+score);}
  }
  function die(){lives--;frog={x:W/2,y:(ROWS-1)*SZ+SZ/2};setScore('LIVES:'+'üê∏'.repeat(lives)+' SCORE:'+score);if(lives<=0){addMsg('GAME OVER! Score:'+score);clearInterval(gameInterval);}}
  document.addEventListener('keydown',function frogk(e){
    if(currentGame!=='g5_frogger')return document.removeEventListener('keydown',frogk);
    const step=SZ;if(e.key==='ArrowUp')frog.y-=step;if(e.key==='ArrowDown')frog.y=Math.min((ROWS-1)*SZ+SZ/2,frog.y+step);
    if(e.key==='ArrowLeft')frog.x-=step;if(e.key==='ArrowRight')frog.x+=step;e.preventDefault();
  });
  setScore('LIVES:üê∏üê∏üê∏ SCORE:0');addMsg('ARROW KEYS to hop ¬∑ Cross road and river ¬∑ Reach the green spots!');
  gameInterval=setInterval(()=>{update();draw();},30);
  addRestartBtn(()=>{clearInterval(gameInterval);g5Frogger();});
}

// ‚îÄ‚îÄ G5-3: HEX 2048 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g52048(){
  const SZ=4;const C=makeCanvas(360,420);const ctx=C.getContext('2d');
  let grid=Array.from({length:SZ},()=>Array(SZ).fill(0)),score=0,best=0;
  const TCOLS={0:'#1a1a2e',2:'#16213e',4:'#0f3460',8:'#533483',16:'#e94560',32:'#f5a623',64:'#f76707',128:'#f9ca24',256:'#6bcb77',512:'#4d96ff',1024:'#ff6b6b',2048:'#ffd700'};
  function addTile(){const empty=[];for(let r=0;r<SZ;r++)for(let c=0;c<SZ;c++)if(!grid[r][c])empty.push([r,c]);if(!empty.length)return;const[r,c]=empty[Math.floor(Math.random()*empty.length)];grid[r][c]=Math.random()<.9?2:4;}
  function slide(row){const f=row.filter(x=>x);const merged=[];let skip=false;for(let i=0;i<f.length;i++){if(!skip&&i<f.length-1&&f[i]===f[i+1]){merged.push(f[i]*2);score+=f[i]*2;skip=true;}else if(!skip){merged.push(f[i]);}else skip=false;}while(merged.length<SZ)merged.push(0);return merged;}
  function move(dir){let moved=false;const prev=JSON.stringify(grid);
    if(dir==='left')grid=grid.map(r=>slide(r));
    if(dir==='right')grid=grid.map(r=>slide([...r].reverse()).reverse());
    if(dir==='up'){for(let c=0;c<SZ;c++){const col=grid.map(r=>r[c]);const s=slide(col);s.forEach((v,r)=>grid[r][c]=v);}}
    if(dir==='down'){for(let c=0;c<SZ;c++){const col=grid.map(r=>r[c]).reverse();const s=slide(col).reverse();s.forEach((v,r)=>grid[r][c]=v);}}
    if(JSON.stringify(grid)!==prev){addTile();moved=true;}best=Math.max(best,score);draw();
    if(grid.some(r=>r.includes(2048)))addMsg('üèÜ 2048 REACHED! Keep going...');return moved;
  }
  function draw(){
    ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,360,420);ctx.fillStyle='#1a1a3a';ctx.fillRect(10,60,340,340);
    const T=SZ,gap=8,tSz=(340-gap*(T+1))/T;
    for(let r=0;r<T;r++)for(let c=0;c<T;c++){const v=grid[r][c],x=10+gap+(c*(tSz+gap)),y=60+gap+(r*(tSz+gap));ctx.fillStyle=TCOLS[Math.min(v,2048)]||'#ffd700';ctx.fillRect(x,y,tSz,tSz);if(v){const fs=v>=1024?20:v>=128?24:28;ctx.fillStyle=v<=4?'#ccc':'#fff';ctx.font=`bold ${fs}px "Share Tech Mono",monospace`;ctx.textAlign='center';ctx.fillText(v,x+tSz/2,y+tSz/2+fs/3);}}
    ctx.fillStyle='#fff';ctx.font='bold 20px "Share Tech Mono",monospace';ctx.textAlign='left';ctx.fillText('SCORE',20,40);ctx.fillText(score,20,55);ctx.textAlign='right';ctx.fillStyle='#ffbe0b';ctx.fillText('BEST',340,40);ctx.fillText(best,340,55);
  }
  document.addEventListener('keydown',function g2048k(e){
    if(currentGame!=='g5_2048')return document.removeEventListener('keydown',g2048k);
    const map={ArrowLeft:'left',ArrowRight:'right',ArrowUp:'up',ArrowDown:'down'};if(map[e.key]){move(map[e.key]);setScore('SCORE:'+score+' | BEST:'+best);e.preventDefault();}
  });
  addTile();addTile();draw();setScore('SCORE:0');addMsg('ARROW KEYS to slide tiles ¬∑ Merge matching numbers ‚Üí reach 2048!');
  addRestartBtn(()=>{grid=Array.from({length:SZ},()=>Array(SZ).fill(0));score=0;addTile();addTile();draw();setScore('SCORE:0');});
}

// ‚îÄ‚îÄ G5-4: PIXEL ARTIST (16√ó16 canvas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5PixelArtist(){
  const SZ=24,GRID=16,W=SZ*GRID,H=SZ*GRID+80;const C=makeCanvas(W+120,H);const ctx=C.getContext('2d');
  let pixels=Array.from({length:GRID},()=>Array(GRID).fill('#0a0a1a'));
  let color='#ff006e',tool='draw',painting=false;
  const PAL=['#ff006e','#ff6b35','#ffbe0b','#06d6a0','#00f5ff','#8338ec','#ffffff','#aaaaaa','#555555','#000000','#ff0000','#00ff00','#0000ff','#ff8800','#8800ff','#0088ff'];
  function draw(){
    ctx.fillStyle='#05050f';ctx.fillRect(0,0,C.width,H);
    for(let r=0;r<GRID;r++)for(let c=0;c<GRID;c++){ctx.fillStyle=pixels[r][c];ctx.fillRect(c*SZ,r*SZ,SZ,SZ);ctx.strokeStyle='rgba(255,255,255,0.05)';ctx.strokeRect(c*SZ,r*SZ,SZ,SZ);}
    // Palette
    ctx.fillStyle='#1a1a2e';ctx.fillRect(W,0,120,H);ctx.fillStyle='#aaa';ctx.font='10px monospace';ctx.textAlign='center';ctx.fillText('PALETTE',W+60,16);
    PAL.forEach((p,i)=>{const px2=W+8+(i%4)*26,py=24+(Math.floor(i/4))*26;ctx.fillStyle=p;ctx.fillRect(px2,py,22,22);if(p===color){ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.strokeRect(px2-1,py-1,24,24);ctx.lineWidth=1;}});
    // Tools
    ctx.fillStyle='#aaa';ctx.font='10px monospace';ctx.textAlign='center';ctx.fillText('TOOLS',W+60,H-54);
    [['‚úèÔ∏è','draw'],['üóë','erase'],['ü™£','fill']].forEach(([lbl,t],i)=>{ctx.fillStyle=tool===t?'#00f5ff':'#334';ctx.fillRect(W+8+i*36,H-48,32,24);ctx.fillStyle='#fff';ctx.font='12px sans-serif';ctx.textAlign='center';ctx.fillText(lbl,W+24+i*36,H-30);});
    // Preview mini at bottom
    const ps=4;ctx.fillStyle='#0a0a1a';ctx.fillRect(W+8,H-22,GRID*ps+4,GRID*ps+4);
    for(let r=0;r<GRID;r++)for(let c=0;c<GRID;c++){ctx.fillStyle=pixels[r][c];ctx.fillRect(W+10+c*ps,H-20+r*ps,ps,ps);}
  }
  function floodFill(r,c,target,replacement){if(r<0||r>=GRID||c<0||c>=GRID||pixels[r][c]!==target||pixels[r][c]===replacement)return;pixels[r][c]=replacement;floodFill(r+1,c,target,replacement);floodFill(r-1,c,target,replacement);floodFill(r,c+1,target,replacement);floodFill(r,c-1,target,replacement);}
  function paint(e){
    const rect=C.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top;
    if(mx>=W){// Palette click
      PAL.forEach((p,i)=>{const px2=W+8+(i%4)*26,py=24+(Math.floor(i/4))*26;if(mx>px2&&mx<px2+22&&my>py&&my<py+22)color=p;});
      // Tool click
      [['draw',0],['erase',1],['fill',2]].forEach(([t,i])=>{if(mx>W+8+i*36&&mx<W+40+i*36&&my>H-48&&my<H-24)tool=t;});
      draw();return;
    }
    const c=Math.floor(mx/SZ),r=Math.floor(my/SZ);if(r<0||r>=GRID||c<0||c>=GRID)return;
    if(tool==='draw')pixels[r][c]=color;else if(tool==='erase')pixels[r][c]='#0a0a1a';else if(tool==='fill'){const target=pixels[r][c];if(target!==color)floodFill(r,c,target,color);}
    draw();
  }
  C.addEventListener('mousedown',e=>{painting=true;paint(e);});
  C.addEventListener('mousemove',e=>{if(painting)paint(e);});
  C.addEventListener('mouseup',()=>painting=false);
  draw();setScore('DRAW ¬∑ 16√ó16 PIXEL ART');addMsg('Click palette to pick color ¬∑ Tools: ‚úèÔ∏è Draw  üóë Erase  ü™£ Fill');
  addRestartBtn(()=>{pixels=Array.from({length:GRID},()=>Array(GRID).fill('#0a0a1a'));draw();});
}

// ‚îÄ‚îÄ G5-5: MASTERMIND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5Mastermind(){
  const COLORS=['#ff006e','#00f5ff','#ffbe0b','#06d6a0','#8338ec','#ff6b35'];
  const CNAMES=['üî¥','üîµ','üü°','üü¢','üü£','üü†'];
  let secret=[],guesses=[],current=[],maxTurns=10,won=false;
  function newGame(){secret=Array.from({length:4},()=>Math.floor(Math.random()*6));guesses=[];current=[];won=false;render();}
  function score2(guess,sec){let blacks=0,whites=0;const gs=[...guess],ss=[...sec];for(let i=0;i<4;i++)if(gs[i]===ss[i]){blacks++;gs[i]=ss[i]=-1;}for(let i=0;i<4;i++)if(gs[i]>=0){const j=ss.indexOf(gs[i]);if(j>=0){whites++;ss[j]=-1;}}return{blacks,whites};}
  function render(){
    getCont().innerHTML=`<style>
      .mm{font-family:"Share Tech Mono",monospace;padding:12px;max-width:440px;}
      .mm-row{display:flex;align-items:center;gap:10px;margin:5px 0;padding:5px;background:#0a0a1a;border-radius:6px;}
      .mm-peg{width:36px;height:36px;border-radius:50%;border:2px solid #333;cursor:pointer;transition:.15s;display:inline-block;}
      .mm-peg:hover{transform:scale(1.1);}
      .mm-hint{display:grid;grid-template-columns:1fr 1fr;gap:3px;width:28px;}
      .mm-hpeg{width:10px;height:10px;border-radius:50%;background:#333;}
      .mm-hpeg.black{background:#fff;}.mm-hpeg.white{background:#aaa;}
      .mm-colors{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap;}
      .mm-btn{padding:8px 18px;border:1px solid var(--cyan);color:var(--cyan);background:0;cursor:pointer;font-family:inherit;letter-spacing:2px;}
      .mm-btn:hover{background:var(--cyan);color:#000;}
      .secret{display:flex;gap:8px;margin:8px 0;}
    </style><div class="mm">`;
    let html='<div style="color:#aaa;font-size:.85rem;margin-bottom:8px">Crack the 4-color code! ‚ö´=right color+place ‚ö™=right color wrong place</div>';
    // Past guesses
    guesses.forEach((g,gi)=>{const{blacks,whites}=score2(g.guess,secret);html+=`<div class="mm-row">${g.guess.map(c=>`<div class="mm-peg" style="background:${COLORS[c]};border-color:${COLORS[c]}"></div>`).join('')}<div class="mm-hint">${Array(blacks).fill('<div class="mm-hpeg black"></div>').join('')}${Array(whites).fill('<div class="mm-hpeg white"></div>').join('')}${Array(4-blacks-whites).fill('<div class="mm-hpeg"></div>').join('')}</div><span style="color:#aaa;font-size:.75rem">${blacks}‚ö´${whites}‚ö™</span></div>`;});
    // Current row
    if(!won&&guesses.length<maxTurns){html+=`<div class="mm-row">${[0,1,2,3].map(i=>`<div class="mm-peg" style="background:${current[i]!==undefined?COLORS[current[i]]:'#222'};border-color:${current[i]!==undefined?COLORS[current[i]]:'#555'}" onclick="mmPick(${i})"></div>`).join('')}<button class="mm-btn" onclick="mmSubmit()">CHECK</button></div>`;
    html+=`<div style="color:#aaa;font-size:.8rem;margin:4px 0">Click a peg slot, then choose color below:</div>`;
    html+=`<div class="mm-colors">${COLORS.map((c,i)=>`<div class="mm-peg" style="background:${c};border-color:${c}" onclick="mmColor(${i})">${CNAMES[i]}</div>`).join('')}</div>`;}
    if(won)html+=`<div style="color:#06d6a0;font-size:1.1rem;margin:12px 0">üèÜ CRACKED in ${guesses.length} guesses!</div>`;
    if(!won&&guesses.length>=maxTurns)html+=`<div style="color:#ff006e;margin:8px 0">üíÄ FAILED! Secret was: ${secret.map(c=>CNAMES[c]).join(' ')}</div><div class="secret">${secret.map(c=>`<div class="mm-peg" style="background:${COLORS[c]};border-color:${COLORS[c]}"></div>`).join('')}</div>`;
    html+=`<button class="mm-btn" style="margin-top:10px" onclick="mmNew()">NEW GAME</button></div>`;
    getCont().innerHTML=html;setScore('TURN:'+(guesses.length+1)+'/'+maxTurns);
  }
  let selSlot=0;window.mmPick=(i)=>{selSlot=i;};
  window.mmColor=(c)=>{current[selSlot]=c;selSlot=(selSlot+1)%4;render();};
  window.mmSubmit=()=>{if(current.filter(x=>x!==undefined).length<4)return;guesses.push({guess:[...current]});const{blacks}=score2(current,secret);if(blacks===4)won=true;current=[];render();};
  window.mmNew=newGame;newGame();addMsg('Click slot ‚Üí pick color ‚Üí CHECK ¬∑ Deduce the hidden code!');
}

// ‚îÄ‚îÄ G5-6: ORBIT DEFENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5Orbit(){
  const W=520,H=520;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  const CX=W/2,CY=H/2;let angle=0,bullets=[],asteroids=[],score=0,lives=3,frame=0,rotSpd=0;
  const SHIP_R=120;
  function spawnAst(){const a=Math.random()*Math.PI*2,dist=W*.55;asteroids.push({x:CX+Math.cos(a)*dist,y:CY+Math.sin(a)*dist,vx:-Math.cos(a)*1.2,vy:-Math.sin(a)*1.2,r:10+Math.random()*14,alive:true});}
  for(let i=0;i<5;i++)spawnAst();
  const keys={};
  document.addEventListener('keydown',function orbk(e){if(currentGame!=='g5_orbit')return document.removeEventListener('keydown',orbk);keys[e.key]=true;if(e.key===' '){const bx=CX+Math.cos(angle)*SHIP_R,by=CY+Math.sin(angle)*SHIP_R;bullets.push({x:bx,y:by,vx:Math.cos(angle)*7,vy:Math.sin(angle)*7,life:60});e.preventDefault();}});
  document.addEventListener('keyup',e=>delete keys[e.key]);
  function draw(){
    ctx.fillStyle='#02020f';ctx.fillRect(0,0,W,H);
    // Stars
    for(let i=0;i<80;i++){ctx.fillStyle='rgba(255,255,255,'+(0.2+((i*137)%10)*.06)+')';ctx.fillRect((i*137)%W,(i*89)%H,1,1);}
    // Orbit ring
    ctx.strokeStyle='rgba(0,245,255,0.1)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(CX,CY,SHIP_R,0,Math.PI*2);ctx.stroke();
    // Planet
    ctx.fillStyle='#1a4aff';ctx.shadowColor='#4488ff';ctx.shadowBlur=20;ctx.beginPath();ctx.arc(CX,CY,30,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    // Ship
    const sx=CX+Math.cos(angle)*SHIP_R,sy=CY+Math.sin(angle)*SHIP_R;
    ctx.save();ctx.translate(sx,sy);ctx.rotate(angle+Math.PI/2);ctx.fillStyle='#00f5ff';ctx.shadowColor='#00f5ff';ctx.shadowBlur=10;ctx.beginPath();ctx.moveTo(0,-12);ctx.lineTo(-8,10);ctx.lineTo(8,10);ctx.closePath();ctx.fill();ctx.shadowBlur=0;ctx.restore();
    // Bullets
    bullets.forEach(b=>{ctx.fillStyle='#ffbe0b';ctx.shadowColor='#ffbe0b';ctx.shadowBlur=8;ctx.beginPath();ctx.arc(b.x,b.y,3,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;});
    // Asteroids
    asteroids.filter(a=>a.alive).forEach(a=>{ctx.fillStyle='#8b6340';ctx.strokeStyle='#c8a04a';ctx.lineWidth=2;ctx.beginPath();ctx.arc(a.x,a.y,a.r,0,Math.PI*2);ctx.fill();ctx.stroke();});
    // Lives
    ctx.fillStyle='#fff';ctx.font='12px monospace';ctx.textAlign='left';ctx.fillText('LIVES:'+'‚òÖ'.repeat(lives),8,20);ctx.textAlign='right';ctx.fillText('SCORE:'+score,W-8,20);
  }
  function tick(){
    frame++;if(keys['a']||keys['ArrowLeft'])angle-=.05;if(keys['d']||keys['ArrowRight'])angle+=.05;
    for(let i=bullets.length-1;i>=0;i--){bullets[i].x+=bullets[i].vx;bullets[i].y+=bullets[i].vy;bullets[i].life--;if(bullets[i].life<=0){bullets.splice(i,1);continue;}let hit=false;for(let j=asteroids.length-1;j>=0;j--){if(!asteroids[j].alive)continue;if(Math.hypot(bullets[i].x-asteroids[j].x,bullets[i].y-asteroids[j].y)<asteroids[j].r+3){asteroids[j].alive=false;score+=Math.round(10/asteroids[j].r*20);bullets.splice(i,1);hit=true;setTimeout(spawnAst,500);break;}}if(hit)break;}
    asteroids.filter(a=>a.alive).forEach(a=>{a.x+=a.vx;a.y+=a.vy;if(Math.hypot(a.x-CX,a.y-CY)<32){a.alive=false;lives--;setScore('SCORE:'+score+' | LIVES:'+'‚òÖ'.repeat(Math.max(0,lives)));if(lives<=0){addMsg('PLANET DESTROYED! Score:'+score);clearInterval(gameInterval);}setTimeout(spawnAst,600);}});
    if(frame%180===0)spawnAst();setScore('SCORE:'+score+' | LIVES:'+'‚òÖ'.repeat(lives));draw();
  }
  setScore('SCORE:0 | LIVES:‚òÖ‚òÖ‚òÖ');addMsg('A/D to orbit ¬∑ SPACE to fire ¬∑ Protect the planet!');
  gameInterval=setInterval(tick,30);addRestartBtn(()=>{clearInterval(gameInterval);g5Orbit();});
}

// ‚îÄ‚îÄ G5-7: YAHTZEE BLITZ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5Yahtzee(){
  const CATS=['Ones','Twos','Threes','Fours','Fives','Sixes','Three of a Kind','Four of a Kind','Full House','Small Straight','Large Straight','Yahtzee','Chance'];
  let dice=[1,1,1,1,1],held=[false,false,false,false,false],rolls=0,scores={},turn=0;
  function rollDice(){if(rolls>=3)return;dice=dice.map((d,i)=>held[i]?d:Math.floor(Math.random()*6)+1);rolls++;render();}
  function calcCat(cat){
    const counts=Array(7).fill(0);dice.forEach(d=>counts[d]++);const sum=dice.reduce((a,b)=>a+b,0);const vals=[1,2,3,4,5,6];
    if(cat==='Yahtzee')return counts.some(c=>c>=5)?50:0;
    if(cat==='Chance')return sum;
    if(['Ones','Twos','Threes','Fours','Fives','Sixes'].includes(cat)){const v=['Ones','Twos','Threes','Fours','Fives','Sixes'].indexOf(cat)+1;return counts[v]*v;}
    if(cat==='Three of a Kind')return counts.some(c=>c>=3)?sum:0;
    if(cat==='Four of a Kind')return counts.some(c=>c>=4)?sum:0;
    if(cat==='Full House')return(counts.some(c=>c===3)&&counts.some(c=>c===2))?25:0;
    const sorted=[...new Set(dice)].sort((a,b)=>a-b);const run=a=>{let m=1,mx=1;for(let i=1;i<a.length;i++){m=a[i]===a[i-1]+1?m+1:1;mx=Math.max(mx,m);}return mx;};
    if(cat==='Small Straight')return run(sorted)>=4?30:0;
    if(cat==='Large Straight')return run(sorted)>=5?40:0;
    return 0;
  }
  function render(){
    const total=Object.values(scores).reduce((a,b)=>a+b,0);
    let html=`<style>.yz{font-family:"Share Tech Mono",monospace;padding:10px;max-width:480px;}.die{width:50px;height:50px;background:#1a1a3a;border:2px solid #445;border-radius:8px;font-size:1.8rem;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:.15s;margin:4px;}.die.held{border-color:#00f5ff;background:#001a3a;box-shadow:0 0 10px #00f5ff66;}.yz-cat{display:flex;justify-content:space-between;padding:3px 6px;cursor:pointer;border-radius:4px;}.yz-cat:hover:not(.scored){background:#1a1a3a;}.yz-cat.scored{opacity:.6;cursor:default;}.yz-btn{padding:8px 18px;border:1px solid var(--cyan);color:var(--cyan);background:0;cursor:pointer;font-family:inherit;margin:4px;letter-spacing:2px;}.yz-btn:hover{background:var(--cyan);color:#000;}</style><div class="yz">`;
    html+=`<div style="display:flex;gap:4px;margin:10px 0;flex-wrap:wrap;">${dice.map((d,i)=>`<div class="die${held[i]?' held':''}" onclick="yzHold(${i})">${['','‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][d]}</div>`).join('')}</div>`;
    html+=`<div><button class="yz-btn" onclick="yzRoll()" ${rolls>=3?'disabled style="opacity:.5"':''}>üé≤ ROLL (${3-rolls} left)</button></div>`;
    html+='<div style="margin-top:10px;border:1px solid #333;border-radius:6px;overflow:hidden;">';
    CATS.forEach(cat=>{const isScored=scores[cat]!==undefined;const preview=!isScored&&rolls>0?calcCat(cat):null;html+=`<div class="yz-cat${isScored?' scored':''}" onclick="${isScored||rolls===0?'':'yzScore(\''+cat+'\')'}"><span style="color:#aaa">${cat}</span><span style="color:${isScored?'#ffbe0b':preview!==null?'#06d6a0':'#555'}">${isScored?scores[cat]:preview!==null?preview+'?':'‚Äî'}</span></div>`;});
    html+=`</div><div style="margin-top:8px;color:#ffbe0b;font-size:1rem">TOTAL: ${total} | TURNS LEFT: ${13-turn}</div>`;
    if(turn>=13)html+=`<div style="color:#06d6a0;margin-top:8px">üèÜ FINAL SCORE: ${total}</div>`;
    html+=`<button class="yz-btn" onclick="yzNew()" style="margin-top:8px">NEW GAME</button></div>`;
    getCont().innerHTML=html;setScore('TOTAL:'+total+' | TURNS:'+(13-turn));
  }
  window.yzHold=(i)=>{if(rolls===0)return;held[i]=!held[i];render();};
  window.yzRoll=()=>{rollDice();};
  window.yzScore=(cat)=>{if(rolls===0||scores[cat]!==undefined)return;scores[cat]=calcCat(cat);held=Array(5).fill(false);rolls=0;turn++;render();};
  window.yzNew=()=>{dice=[1,1,1,1,1];held=Array(5).fill(false);rolls=0;scores={};turn=0;render();};
  render();addMsg('Roll dice, hold keepers, score categories ¬∑ 13 rounds total');
}

// ‚îÄ‚îÄ G5-8: MORSE DECODER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5Morse(){
  const CODE={A:'.-',B:'-...',C:'-.-.',D:'-..',E:'.',F:'..-.',G:'--.',H:'....',I:'..',J:'.---',K:'-.-',L:'.-..',M:'--',N:'-.',O:'---',P:'.--.',Q:'--.-',R:'.-.',S:'...',T:'-',U:'..-',V:'...-',W:'.--',X:'-..-',Y:'-.--',Z:'--..'};
  let target='',score=0,streak=0,lives=3,showingMorse=false,canType=false;
  function play(letter){const code=CODE[letter];showingMorse=true;canType=false;render('Listening...');let t=0;const dots=code.split('');let i=0;function next(){if(i>=dots.length){setTimeout(()=>{showingMorse=false;canType=true;render('Type the letter!');},400);return;}const sym=dots[i++];// visual flash
    render(code.substring(0,i));setTimeout(next,sym==='.'?250:600);}next();}
  function newRound(){target=Object.keys(CODE)[Math.floor(Math.random()*26)];setTimeout(()=>play(target),400);}
  function render(hint){
    getCont().innerHTML='';
    const d=document.createElement('div');d.style.cssText='font-family:"Share Tech Mono",monospace;padding:20px;max-width:400px;text-align:center;';
    d.innerHTML=`<div style="font-size:3rem;margin:10px;min-height:4rem;color:#ffbe0b;letter-spacing:8px">${hint||'...'}</div>
      <div style="color:#aaa;font-size:.85rem;margin:8px">Current letter morse pattern shown above</div>
      <div style="font-size:1.2rem;margin:12px;color:#00f5ff">SCORE: ${score} | STREAK: ${streak} | LIVES: ${'‚ô•'.repeat(lives)}</div>
      <div style="margin:16px 0"><input id="morseInput" maxlength="1" style="background:#0a0a1a;border:2px solid ${canType?'#00f5ff':'#333'};color:#00f5ff;padding:12px;font-size:2rem;width:60px;text-align:center;font-family:inherit;outline:none;text-transform:uppercase" placeholder="?" ${canType?'':'disabled'}></div>
      <div style="color:#555;font-size:.75rem;margin:8px">Type the letter you hear</div>`;
    getCont().appendChild(d);
    const inp=document.getElementById('morseInput');
    if(inp&&canType){inp.focus();inp.addEventListener('input',()=>{const v=inp.value.toUpperCase();if(v&&v>=('A')&&v<=('Z')){if(v===target){score+=10+streak*2;streak++;setScore('SCORE:'+score+' | STREAK:'+streak);}else{lives--;streak=0;if(lives<=0){render('GAME OVER! Score:'+score);return;}}newRound();}});}
  }
  setScore('SCORE:0 | STREAK:0');addMsg('Listen to the Morse pattern ¬∑ Type the matching letter!');newRound();
  addRestartBtn(()=>{score=0;streak=0;lives=3;newRound();});
}

// ‚îÄ‚îÄ G5-9: LUNAR LANDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5Lander(){
  const W=560,H=460;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  let lander={x:W/2,y:60,vx:1.5,vy:0,angle:0,fuel:100},landed=false,crashed=false,score=0;
  // Generate terrain
  const terrain=[];const PADS=[];let i=0;while(i<W){const segW=30+Math.floor(Math.random()*40);const h=H-80-Math.floor(Math.random()*200);if(Math.random()<.15&&PADS.length<3){const pw=70;PADS.push({x:i,y:H-80,w:pw});for(let px=i;px<i+pw;px++)terrain.push({x:px,y:H-80});i+=pw;}else{for(let x=i;x<i+segW&&x<W;x++){terrain.push({x,y:h});}i+=segW;}}
  const keys={};
  document.addEventListener('keydown',function lndk(e){if(currentGame!=='g5_lander')return document.removeEventListener('keydown',lndk);keys[e.key]=true;e.preventDefault();});
  document.addEventListener('keyup',e=>delete keys[e.key]);
  function draw(){
    ctx.fillStyle='#02020f';ctx.fillRect(0,0,W,H);
    // Stars
    for(let si=0;si<60;si++){ctx.fillStyle='rgba(255,255,255,.4)';ctx.fillRect((si*137+23)%W,(si*89)%100,1,1);}
    // Terrain
    ctx.fillStyle='#445566';ctx.beginPath();ctx.moveTo(0,H);terrain.forEach(p=>ctx.lineTo(p.x,p.y));ctx.lineTo(W,H);ctx.closePath();ctx.fill();
    // Pads
    PADS.forEach(p=>{ctx.fillStyle='#06d6a0';ctx.fillRect(p.x,p.y,p.w,4);ctx.fillStyle='rgba(6,214,160,0.2)';ctx.fillRect(p.x,p.y,p.w,H-p.y);});
    // Lander
    ctx.save();ctx.translate(lander.x,lander.y);ctx.rotate(lander.angle);
    ctx.fillStyle=crashed?'#ff0000':'#00f5ff';ctx.shadowColor=crashed?'#ff0':'#00f5ff';ctx.shadowBlur=10;
    ctx.beginPath();ctx.moveTo(0,-18);ctx.lineTo(-12,10);ctx.lineTo(12,10);ctx.closePath();ctx.fill();
    // Legs
    ctx.strokeStyle='#aaa';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(-12,10);ctx.lineTo(-18,18);ctx.moveTo(12,10);ctx.lineTo(18,18);ctx.stroke();
    // Thruster flame
    if(keys['ArrowUp']&&lander.fuel>0){ctx.fillStyle='rgba(255,120,0,.8)';ctx.beginPath();ctx.moveTo(-5,10);ctx.lineTo(5,10);ctx.lineTo(0,22+Math.random()*10);ctx.closePath();ctx.fill();}
    ctx.shadowBlur=0;ctx.restore();
    // HUD
    ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(0,0,W,34);ctx.fillStyle='#0f0';ctx.font='12px "Share Tech Mono",monospace';ctx.textAlign='left';
    ctx.fillText(`FUEL:${Math.round(lander.fuel)}%  VX:${lander.vx.toFixed(1)}  VY:${lander.vy.toFixed(1)}  ALT:${Math.round(H-lander.y)}`,8,20);
    if(landed){ctx.fillStyle='#06d6a0';ctx.font='bold 22px monospace';ctx.textAlign='center';ctx.fillText('‚úì SOFT LANDING! +'+score,W/2,H/2);}
    if(crashed){ctx.fillStyle='#ff4400';ctx.font='bold 22px monospace';ctx.textAlign='center';ctx.fillText('üí• CRASHED!',W/2,H/2);}
  }
  function tick(){
    if(landed||crashed)return;
    if(keys['ArrowLeft'])lander.angle-=.03;
    if(keys['ArrowRight'])lander.angle+=.03;
    if(keys['ArrowUp']&&lander.fuel>0){lander.vx+=Math.sin(lander.angle)*.15*-1;lander.vy-=Math.cos(lander.angle)*.15;lander.fuel=Math.max(0,lander.fuel-.4);}
    lander.vy+=0.04;lander.x+=lander.vx;lander.y+=lander.vy;
    lander.x=(lander.x+W)%W;
    // Collision
    const tx=Math.round(lander.x);if(tx>=0&&tx<terrain.length){const ty=(terrain[tx]&&terrain[tx].y);if(ty&&lander.y+18>ty){const speed=Math.hypot(lander.vx,lander.vy);const onPad=PADS.some(p=>lander.x>p.x&&lander.x<p.x+p.w);const upright=Math.abs(lander.angle)<0.3;if(onPad&&upright&&speed<2.5){landed=true;score=Math.round(lander.fuel*2+(2.5-speed)*50);setScore('LANDED! Score:'+score);}else{crashed=true;setScore('CRASHED! Speed:'+speed.toFixed(1));}}}
    setScore(`FUEL:${Math.round(lander.fuel)}% | VY:${lander.vy.toFixed(1)} | VX:${lander.vx.toFixed(1)}`);draw();
  }
  addMsg('‚Üë THRUST ¬∑ ‚Üê ‚Üí ROTATE ¬∑ Land on GREEN pads softly!');
  gameInterval=setInterval(tick,30);addRestartBtn(()=>{clearInterval(gameInterval);g5Lander();});draw();
}

// ‚îÄ‚îÄ G5-10: TRON LIGHTCYCLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5Tron(){
  const W=580,H=460,SZ=10;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  const GW=Math.floor(W/SZ),GH=Math.floor(H/SZ);
  let p1,p2,trail1,trail2,alive1,alive2,score1=0,score2=0;
  function reset(){p1={x:Math.floor(GW*.25),y:Math.floor(GH/2),dx:1,dy:0};p2={x:Math.floor(GW*.75),y:Math.floor(GH/2),dx:-1,dy:0};trail1=new Set();trail2=new Set();alive1=true;alive2=true;trail1.add(`${p1.x},${p1.y}`);trail2.add(`${p2.x},${p2.y}`);}
  document.addEventListener('keydown',function tronk(e){
    if(currentGame!=='g5_tron')return document.removeEventListener('keydown',tronk);
    if(e.key==='w'&&p1.dy!==1){p1.dx=0;p1.dy=-1;}if(e.key==='s'&&p1.dy!==-1){p1.dx=0;p1.dy=1;}
    if(e.key==='a'&&p1.dx!==1){p1.dx=-1;p1.dy=0;}if(e.key==='d'&&p1.dx!==-1){p1.dx=1;p1.dy=0;}
    if(e.key==='ArrowUp'&&p2.dy!==1){p2.dx=0;p2.dy=-1;}if(e.key==='ArrowDown'&&p2.dy!==-1){p2.dx=0;p2.dy=1;}
    if(e.key==='ArrowLeft'&&p2.dx!==1){p2.dx=-1;p2.dy=0;}if(e.key==='ArrowRight'&&p2.dx!==-1){p2.dx=1;p2.dy=0;}
    e.preventDefault();
  });
  function move(p,trail,alive){if(!alive)return alive;const nx=p.x+p.dx,ny=p.y+p.dy;if(nx<0||nx>=GW||ny<0||ny>=GH)return false;if(trail1.has(`${nx},${ny}`)||trail2.has(`${nx},${ny}`))return false;p.x=nx;p.y=ny;trail.add(`${nx},${ny}`);return true;}
  function draw(){
    ctx.fillStyle='#02020a';ctx.fillRect(0,0,W,H);
    trail1.forEach(k=>{const[x,y]=k.split(',');ctx.fillStyle='#00f5ff';ctx.fillRect(+x*SZ,+y*SZ,SZ-1,SZ-1);});
    trail2.forEach(k=>{const[x,y]=k.split(',');ctx.fillStyle='#ff006e';ctx.fillRect(+x*SZ,+y*SZ,SZ-1,SZ-1);});
    // Heads
    ctx.fillStyle='#ffffff';ctx.fillRect(p1.x*SZ,p1.y*SZ,SZ,SZ);ctx.fillRect(p2.x*SZ,p2.y*SZ,SZ,SZ);
    if(!alive1||!alive2){ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(0,0,W,H);ctx.font='bold 28px "Press Start 2P",monospace';ctx.textAlign='center';ctx.fillStyle='#fff';ctx.fillText(alive1&&!alive2?'üîµ P1 WINS!':!alive1&&alive2?'üî¥ P2 WINS!':'üí• DRAW!',W/2,H/2);ctx.font='14px monospace';ctx.fillText('Score: P1 '+score1+' ‚Äî P2 '+score2,W/2,H/2+40);}
  }
  reset();setScore('P1(WASD):0 | P2(ARROWS):0');addMsg('P1: WASD ¬∑ P2: ARROWS ¬∑ Leave light trails ¬∑ Survive longest!');
  gameInterval=setInterval(()=>{
    if(!alive1&&!alive2)return;alive1=move(p1,trail1,alive1);alive2=move(p2,trail2,alive2);
    if(!alive1&&!alive2){setScore('DRAW!');}else if(!alive1){score2++;setScore('P1:'+score1+' | P2:'+score2);setTimeout(()=>{reset();},1200);}else if(!alive2){score1++;setScore('P1:'+score1+' | P2:'+score2);setTimeout(()=>{reset();},1200);}
    draw();
  },60);
  addRestartBtn(()=>{clearInterval(gameInterval);g5Tron();});
}

// ‚îÄ‚îÄ G5-11: PIT STRATEGY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5PitStrategy(){
  const LAPS=10,TYRE_TYPES=['SOFT','MEDIUM','HARD'];const TYRE_PACE={SOFT:1,MEDIUM:1.4,HARD:1.8};const TYRE_LIFE={SOFT:3,MEDIUM:5,HARD:8};
  let lap=1,pos=1,tyre='MEDIUM',tyreAge=0,fuel=100,weather='DRY',pitUsed=0,log=[];
  function lapTime(){const base=90;const tyrePenalty=TYRE_PACE[tyre]*(1+tyreAge*.08);const fuelEffect=fuel*.005;const wBonus=weather==='WET'&&tyre==='SOFT'?-2:weather==='WET'?4:0;return(base+tyrePenalty+fuelEffect+wBonus+(Math.random()-.5)*2).toFixed(2);}
  function render(){
    getCont().innerHTML='';const d=document.createElement('div');d.style.cssText='font-family:"Share Tech Mono",monospace;padding:12px;max-width:480px;';
    const tyreColor={SOFT:'#ff2200',MEDIUM:'#ffaa00',HARD:'#aaaaaa'};
    d.innerHTML=`<style>.pit-btn{padding:8px 16px;border:1px solid var(--cyan);color:var(--cyan);background:0;cursor:pointer;font-family:inherit;margin:4px;letter-spacing:1px;font-size:.85rem;}.pit-btn:hover{background:var(--cyan);color:#000;}.pit-btn.red{border-color:var(--pink);color:var(--pink)}.pit-btn.red:hover{background:var(--pink)}</style>
    <div style="display:flex;gap:20px;margin-bottom:12px;flex-wrap:wrap;">
      <div><div style="color:#aaa;font-size:.75rem">LAP</div><div style="font-size:1.8rem;color:#fff">${lap}/${LAPS}</div></div>
      <div><div style="color:#aaa;font-size:.75rem">POSITION</div><div style="font-size:1.8rem;color:#ffbe0b">P${pos}</div></div>
      <div><div style="color:#aaa;font-size:.75rem">TYRE</div><div style="font-size:1.2rem;color:${tyreColor[tyre]}">${tyre} (${tyreAge} laps)</div></div>
      <div><div style="color:#aaa;font-size:.75rem">FUEL</div><div style="font-size:1.2rem;color:#00f5ff">${fuel.toFixed(0)}%</div></div>
      <div><div style="color:#aaa;font-size:.75rem">WEATHER</div><div style="font-size:1.2rem;color:#8338ec">${weather}</div></div>
    </div>
    <div style="margin:8px 0;color:#aaa;font-size:.8rem">‚ö† ${tyreAge>=TYRE_LIFE[tyre]?'<span style=color:#ff2200>TYRES WORN OUT ‚Äî PIT NOW!</span>':fuel<20?'<span style=color:#ffaa00>LOW FUEL</span>':'All systems nominal'}</div>
    <div>
      <button class="pit-btn" onclick="pitDoLap()">‚ñ∂ RUN LAP</button>
      <button class="pit-btn red" onclick="pitStop()">üîß PIT STOP (+25s)</button>
    </div>
    <div style="margin:8px 0;font-size:.8rem;color:#aaa">Change tyres: ${TYRE_TYPES.map(t=>`<button class="pit-btn" style="padding:4px 10px;margin:2px;font-size:.75rem;${t===tyre?'opacity:.4':''}" onclick="pitTyre('${t}')">${t}</button>`).join('')}</div>
    <div style="margin-top:10px;border-top:1px solid #222;padding-top:8px;max-height:160px;overflow-y:auto;font-size:.8rem;">${log.slice(-8).reverse().map(l=>`<div style="color:#667;padding:1px 0">${l}</div>`).join('')}</div>
    ${lap>LAPS?`<div style="color:#ffbe0b;font-size:1.1rem;margin-top:10px">üèÅ RACE COMPLETE! Final position: P${pos}</div>`:''}`;
    getCont().appendChild(d);setScore('LAP:'+lap+'/'+LAPS+' | P'+pos);
  }
  window.pitDoLap=()=>{if(lap>LAPS)return;const t=+lapTime();tyreAge++;fuel=Math.max(0,fuel-9-Math.random()*2);if(Math.random()<.1)weather=weather==='DRY'?'WET':'DRY';// AI opponents
    const aiTime=t+(Math.random()-.4)*3;pos=aiTime<t?Math.min(pos+1,10):Math.max(pos-1,1);log.push(`Lap ${lap}: ${t}s | P${pos} | ${tyre}(${tyreAge})`);lap++;if(tyreAge>TYRE_LIFE[tyre]+1)pos=Math.min(pos+2,10);render();};
  window.pitStop=()=>{if(lap>LAPS)return;log.push(`LAP ${lap}: PIT STOP (+25s) ‚Äî fitting ${tyre}`);tyreAge=0;fuel=100;pitUsed++;pos=Math.min(pos+2,10);lap++;render();};
  window.pitTyre=(t)=>{tyre=t;render();};
  render();addMsg('RUN LAP each lap ¬∑ PIT STOP when tyres wear or fuel drops ¬∑ Manage strategy!');
  addRestartBtn(()=>{lap=1;pos=1;tyre='MEDIUM';tyreAge=0;fuel=100;weather='DRY';pitUsed=0;log=[];render();});
}

// ‚îÄ‚îÄ G5-12: NEON REVERSI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5Reversi(){
  const N=8;let board,turn,score;
  function newGame(){board=Array.from({length:N},()=>Array(N).fill(0));board[3][3]=1;board[4][4]=1;board[3][4]=2;board[4][3]=2;turn=1;updateScore();draw();}
  function updateScore(){const flat=board.flat();score={1:flat.filter(x=>x===1).length,2:flat.filter(x=>x===2).length};}
  const DIRS=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
  function getFlips(r,c,t){if(board[r][c])return[];const opp=3-t,flips=[];DIRS.forEach(([dr,dc])=>{let cr=r+dr,cc=c+dc,line=[];while(cr>=0&&cr<N&&cc>=0&&cc<N&&board[cr][cc]===opp){line.push([cr,cc]);cr+=dr;cc+=dc;}if(cr>=0&&cr<N&&cc>=0&&cc<N&&board[cr][cc]===t&&line.length)flips.push(...line);});return flips;}
  function validMoves(t){const m=[];for(let r=0;r<N;r++)for(let c=0;c<N;c++)if(!board[r][c]&&getFlips(r,c,t).length)m.push([r,c]);return m;}
  function play(r,c,t){const flips=getFlips(r,c,t);if(!flips.length)return false;board[r][c]=t;flips.forEach(([fr,fc])=>board[fr][fc]=t);updateScore();return true;}
  function aiMove(){const moves=validMoves(2);if(!moves.length)return;// prefer corners then edges
    const corners=moves.filter(([r,c])=>(r===0||r===7)&&(c===0||c===7));const best=corners.length?corners[0]:moves.sort(([r1,c1],[r2,c2])=>getFlips(r2,c2,2).length-getFlips(r1,c1,2).length)[0];play(best[0],best[1],2);turn=1;if(!validMoves(1).length){if(!validMoves(2).length)endGame();else{turn=2;setTimeout(aiMove,400);}}draw();}
  function endGame(){const msg=score[1]>score[2]?'YOU WIN! üéâ':score[1]<score[2]?'AI WINS':'DRAW';addMsg(msg+` | ${score[1]}-${score[2]}`);}
  const SZ=52,W=N*SZ+2,H=N*SZ+2;const C=makeCanvas(W,H);const ctx=C.getContext('2d');
  function draw(){
    ctx.fillStyle='#0a1a0a';ctx.fillRect(0,0,W,H);const vm=validMoves(1);
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){const x=c*SZ+1,y=r*SZ+1;ctx.fillStyle=(r+c)%2===0?'#1a2e1a':'#0f200f';ctx.fillRect(x,y,SZ-1,SZ-1);if(vm.some(([mr,mc])=>mr===r&&mc===c)){ctx.fillStyle='rgba(6,214,160,0.2)';ctx.fillRect(x,y,SZ-1,SZ-1);}if(board[r][c]){const cx2=x+SZ/2,cy=y+SZ/2;ctx.fillStyle=board[r][c]===1?'#00f5ff':'#ff006e';ctx.shadowColor=ctx.fillStyle;ctx.shadowBlur=10;ctx.beginPath();ctx.arc(cx2,cy,SZ/2-5,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}}
    setScore('YOU(üîµ):'+score[1]+' | AI(üî¥):'+score[2]+' | '+(turn===1?'YOUR TURN':'AI thinking...'));
  }
  C.addEventListener('click',e=>{if(turn!==1)return;const r2=C.getBoundingClientRect();const r=Math.floor((e.clientY-r2.top)/SZ),c=Math.floor((e.clientX-r2.left)/SZ);if(play(r,c,1)){turn=2;draw();const vm=validMoves(1);if(vm.length||validMoves(2).length)setTimeout(aiMove,400);else endGame();}});
  newGame();addMsg('Click green-highlighted squares to place your disc (üîµ). Flip AI discs!');addRestartBtn(()=>newGame());
}

// ‚îÄ‚îÄ G5-13: ANTIVIRUS (Flood fill territory) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5Antivirus(){
  const N=14;const COLORS=['#ff006e','#00f5ff','#ffbe0b','#06d6a0','#8338ec','#ff6b35'];
  let grid,playerColor,aiColor,turns;
  function newGame(){grid=Array.from({length:N},()=>Array.from({length:N},()=>Math.floor(Math.random()*6)));playerColor=grid[N-1][0];aiColor=grid[0][N-1];turns=0;draw();}
  function flood(startR,startC,newCol,owned){const old=grid[startR][startC];if(old===newCol)return;const queue=[[startR,startC]];const visited=new Set([`${startR},${startC}`]);while(queue.length){const[r,c]=queue.shift();grid[r][c]=newCol;[[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc])=>{const nr=r+dr,nc=c+dc;if(nr>=0&&nr<N&&nc>=0&&nc<N&&!visited.has(`${nr},${nc}`)&&grid[nr][nc]===old){visited.add(`${nr},${nc}`);queue.push([nr,nc]);}});}}
  function countOwned(c){return grid.flat().filter(x=>x===c).length;}
  function draw(){
    const SZ=34,W=N*SZ+140,H=N*SZ+60;if(!C_av){window.C_av=makeCanvas(W,H);}const C2=window.C_av;if(!C2)return;const ctx2=C2.getContext('2d');
    ctx2.fillStyle='#05050f';ctx2.fillRect(0,0,W,H);
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){ctx2.fillStyle=COLORS[grid[r][c]];ctx2.fillRect(c*SZ+1,r*SZ+1,SZ-2,SZ-2);}
    // Player corner marker
    ctx2.strokeStyle='#fff';ctx2.lineWidth=3;ctx2.strokeRect(1,(N-1)*SZ+1,SZ-2,SZ-2);ctx2.strokeRect((N-1)*SZ+1,1,SZ-2,SZ-2);
    // Color picker
    ctx2.fillStyle='#111';ctx2.fillRect(N*SZ+8,0,130,H);ctx2.fillStyle='#aaa';ctx2.font='10px monospace';ctx2.textAlign='center';ctx2.fillText('YOUR COLOR',N*SZ+70,18);
    COLORS.forEach((col,i)=>{const bx=N*SZ+12+(i%2)*62,by=24+(Math.floor(i/2))*52;ctx2.fillStyle=col;ctx2.fillRect(bx,by,54,44);ctx2.fillStyle='rgba(0,0,0,0.4)';if(col===COLORS[playerColor]){ctx2.strokeStyle='#fff';ctx2.lineWidth=3;ctx2.strokeRect(bx,by,54,44);}ctx2.fillStyle='#fff';ctx2.font='bold 11px monospace';ctx2.textAlign='center';ctx2.fillText(i+1,bx+27,by+26);});
    const pScore=countOwned(playerColor),aScore=countOwned(aiColor),total=N*N;
    ctx2.fillStyle='#aaa';ctx2.font='11px monospace';ctx2.textAlign='center';ctx2.fillText('YOU: '+pScore,N*SZ+70,H-64);ctx2.fillText('AI: '+aScore,N*SZ+70,H-48);ctx2.fillText('TURN: '+turns,N*SZ+70,H-32);ctx2.fillText(pScore+aScore>=total?'GAME OVER':'Playing...',N*SZ+70,H-16);
    setScore('YOU:'+pScore+' | AI:'+aScore+' | '+(pScore>aScore?'WINNING':'LOSING'));
    C2.onclick=e=>{const r2=C2.getBoundingClientRect();const c2i=Math.floor((e.clientX-r2.left-N*SZ-12)%62/62);const row2=Math.floor((e.clientY-r2.top-24)/52)*2+Math.floor((e.clientX-r2.left-N*SZ-12)/62);const ci=row2;if(ci>=0&&ci<6){const newCol=ci;if(newCol!==playerColor&&newCol!==aiColor){flood(N-1,0,newCol,playerColor);playerColor=newCol;turns++;// AI move: pick color that gains most
        let bestCol=-1,bestGain=0;for(let k=0;k<6;k++){if(k===playerColor||k===aiColor)continue;const sim=JSON.parse(JSON.stringify(grid));let gain=0;const tmp=[...sim.flat()].filter(x=>x===k).length;if(tmp>bestGain){bestGain=tmp;bestCol=k;}}if(bestCol>=0){flood(0,N-1,bestCol,aiColor);aiColor=bestCol;}draw();}}};
  }
  let C_av=null;window.C_av=null;
  // Create canvas via makeCanvas wrapper
  const C2=makeCanvas(N*34+140,N*34+60);window.C_av=C2;
  const ctx2=C2.getContext('2d');
  newGame();addMsg('Click color buttons (bottom-right) to flood-fill ¬∑ Cover more than AI!');
  addRestartBtn(()=>{window.C_av=null;g5Antivirus();});
}

// ‚îÄ‚îÄ G5-14: SPEED MATH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5SpeedMath(){
  let q,ans,score=0,streak=0,lives=3,timer=0,maxTimer=8,frame=0;
  function newQ(){const ops=['+','-','√ó','√∑'];const op=ops[Math.floor(Math.random()*Math.min(4,1+Math.floor(score/5)))];let a,b;if(op==='+'){a=Math.floor(Math.random()*(50+score*2));b=Math.floor(Math.random()*(50+score*2));ans=a+b;}else if(op==='-'){a=Math.floor(Math.random()*(50+score*2));b=Math.floor(Math.random()*a+1);ans=a-b;}else if(op==='√ó'){a=Math.floor(Math.random()*12)+1;b=Math.floor(Math.random()*12)+1;ans=a*b;}else{b=Math.floor(Math.random()*11)+2;ans=Math.floor(Math.random()*11)+1;a=ans*b;}q=`${a} ${op} ${b}`;maxTimer=Math.max(4,8-Math.floor(score/8));timer=maxTimer;render();}
  function render(){
    getCont().innerHTML='';const d=document.createElement('div');d.style.cssText='font-family:"Share Tech Mono",monospace;padding:20px;max-width:380px;text-align:center;';
    const pct=timer/maxTimer;const col=pct>.6?'#06d6a0':pct>.3?'#ffbe0b':'#ff006e';
    d.innerHTML=`<div style="background:#1a1a2e;height:8px;border-radius:4px;margin:0 0 16px;"><div style="height:8px;width:${pct*100}%;background:${col};border-radius:4px;transition:width .3s;"></div></div>
    <div style="font-size:2.8rem;color:#ffbe0b;margin:12px;letter-spacing:4px">${q||'...'} = ?</div>
    <div style="font-size:1rem;color:#aaa;margin:8px">SCORE: ${score} | STREAK: ${streak} | LIVES: ${'‚ô•'.repeat(lives)}</div>
    <input id="mathInput" type="number" style="background:#0a0a1a;border:2px solid #00f5ff;color:#00f5ff;padding:12px;font-size:1.6rem;width:120px;text-align:center;font-family:inherit;outline:none;border-radius:6px;" placeholder="?" autofocus>
    <div style="color:#555;font-size:.75rem;margin-top:10px">Press ENTER to submit</div>`;
    getCont().appendChild(d);
    const inp=document.getElementById('mathInput');
    if(inp){inp.focus();inp.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=parseInt(inp.value);if(v===ans){score++;streak++;timer=maxTimer;}else{lives--;streak=0;if(lives<=0){addMsg('GAME OVER! Score:'+score);clearInterval(gameInterval);return;}}newQ();}});}
  }
  newQ();setScore('SCORE:0 | LIVES:‚ô•‚ô•‚ô•');addMsg('Type the answer and press ENTER before time runs out!');
  gameInterval=setInterval(()=>{frame++;if(frame%30===0){timer--;if(timer<=0){lives--;streak=0;if(lives<=0){addMsg('TIME OUT! Score:'+score);clearInterval(gameInterval);}else newQ();}setScore('SCORE:'+score+' | LIVES:'+'‚ô•'.repeat(lives)+' | STREAK:'+streak);const bar=getCont().querySelector('div>div');if(bar)bar.style.width=(timer/maxTimer*100)+'%';}},33);
  addRestartBtn(()=>{clearInterval(gameInterval);score=0;streak=0;lives=3;newQ();gameInterval=setInterval(()=>{frame++;if(frame%30===0){timer--;if(timer<=0){lives--;streak=0;if(lives<=0){addMsg('TIMEOUT! Score:'+score);clearInterval(gameInterval);}else newQ();}}},33);});
}

// ‚îÄ‚îÄ G5-15: RPS ARENA (adaptive AI) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g5RPS(){
  const MOVES=['‚úä','‚úã','‚úåÔ∏è'];const NAMES=['ROCK','PAPER','SCISSORS'];
  let pScore=0,aScore=0,round=0,history=[],aiWeights=[1,1,1],lastResult='',streak=0;
  function getAI(){// weighted random, biased against player's most common move
    const pCounts=[0,0,0];history.forEach(h=>pCounts[h.p]++);const mostUsed=pCounts.indexOf(Math.max(...pCounts));// counter it
    const counterWeights=[...aiWeights];counterWeights[(mostUsed+1)%3]+=history.length*.5;const total=counterWeights.reduce((a,b)=>a+b,0);let r=Math.random()*total;for(let i=0;i<3;i++){r-=counterWeights[i];if(r<=0)return i;}return 2;}
  function play(p){const a=getAI();const result=((p-a+3)%3);// 0=draw,1=win,2=lose
    const win=result===1,draw=result===0;if(win){pScore++;streak++;}else if(!draw){aScore++;streak=0;}else{streak=Math.max(0,streak);}history.push({p,a,result});round++;
    // Penalize AI if it keeps losing
    if(win)aiWeights[a]=Math.max(.5,aiWeights[a]-.2);render(p,a,win?'WIN':draw?'DRAW':'LOSE');
    if(pScore>=10)addMsg('üèÜ YOU WIN! Beat the adaptive AI!');if(aScore>=10)addMsg('AI WINS ‚Äî it learned your patterns!');
  }
  function render(lastP,lastA,result){
    getCont().innerHTML='';const d=document.createElement('div');d.style.cssText='font-family:"Share Tech Mono",monospace;padding:20px;max-width:420px;text-align:center;';
    const rc=result==='WIN'?'#06d6a0':result==='LOSE'?'#ff006e':result==='DRAW'?'#ffbe0b':'';
    d.innerHTML=`<div style="display:flex;justify-content:space-around;margin:16px 0;font-size:3.5rem;">
      <div><div style="color:#00f5ff;font-size:.8rem">YOU</div><div>${lastP!==undefined?MOVES[lastP]:'?'}</div></div>
      <div><div style="font-size:1.4rem;color:${rc||'#aaa'};margin-top:1rem">${result||'VS'}</div></div>
      <div><div style="color:#ff006e;font-size:.8rem">AI</div><div>${lastA!==undefined?MOVES[lastA]:'?'}</div></div>
    </div>
    <div style="margin:12px 0;color:#aaa;font-size:.9rem">YOU ${pScore} ‚Äî ${aScore} AI | Round ${round} | Streak ${streak}</div>
    <div style="color:#555;font-size:.75rem;margin-bottom:12px">AI adapts to your patterns ‚Äî try to be unpredictable!</div>
    <div style="display:flex;gap:12px;justify-content:center;">
      ${MOVES.map((m,i)=>`<button onclick="rpsPlay(${i})" style="background:#0a0a2a;border:2px solid #334;color:#fff;font-size:2rem;padding:12px 18px;border-radius:8px;cursor:pointer;transition:.15s" onmouseover="this.style.borderColor='#00f5ff'" onmouseout="this.style.borderColor='#334'">${m}<br><span style="font-size:.65rem;color:#888">${NAMES[i]}</span></button>`).join('')}
    </div>
    ${history.length>0?`<div style="margin-top:12px;color:#445;font-size:.7rem">History: ${history.slice(-8).map(h=>MOVES[h.p]+(['=','>','<'][h.result]||'?')+MOVES[h.a]).join(' ')}</div>`:''}`;
    getCont().appendChild(d);setScore('YOU:'+pScore+' | AI:'+aScore+' | Round:'+round);
  }
  window.rpsPlay=(p)=>play(p);
  render();addMsg('Choose Rock, Paper or Scissors ¬∑ AI learns your patterns ‚Äî stay unpredictable!');
  addRestartBtn(()=>{pScore=0;aScore=0;round=0;history=[];aiWeights=[1,1,1];streak=0;render();});
}

// ============================================================
// GAMES6 ‚Äî 15 NEW 3D WebGL GAMES
// ============================================================

// ‚îÄ‚îÄ G6-1: MECH WARRIOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Mech(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv,true);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x0a0508);
  sc.fog=new THREE.Fog(0x0a0508,30,120);
  var cam=new THREE.PerspectiveCamera(70,580/420,.1,200);
  cam.position.set(0,14,22);cam.lookAt(0,0,0);
  sc.add(mkLight('ambient',0x221122,1.2));
  var dl=mkLight('dir',0xff8844,2,0,30,20,10);dl.castShadow=true;sc.add(dl);
  var ground=new THREE.Mesh(new THREE.PlaneGeometry(80,80),new THREE.MeshPhongMaterial({color:0x1a0a0a}));
  ground.rotation.x=-Math.PI/2;ground.receiveShadow=true;sc.add(ground);
  // grid lines
  var gl2=new THREE.GridHelper(80,20,0x330011,0x220011);sc.add(gl2);
  // Player mech
  var mech=new THREE.Group();
  var torso=new THREE.Mesh(new THREE.BoxGeometry(2,2.4,1.4),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244,shininess:120}));
  mech.add(torso);
  var head=new THREE.Mesh(new THREE.BoxGeometry(1,0.9,0.9),new THREE.MeshPhongMaterial({color:0x00aacc}));
  head.position.set(0,1.8,0);mech.add(head);
  var legL=new THREE.Mesh(new THREE.BoxGeometry(0.7,2,0.7),new THREE.MeshPhongMaterial({color:0x005577}));
  legL.position.set(-0.7,-2.2,0);mech.add(legL);
  var legR=new THREE.Mesh(new THREE.BoxGeometry(0.7,2,0.7),new THREE.MeshPhongMaterial({color:0x005577}));
  legR.position.set(0.7,-2.2,0);mech.add(legR);
  var cannon=new THREE.Mesh(new THREE.CylinderGeometry(0.18,0.25,1.6,8),new THREE.MeshPhongMaterial({color:0xffbe0b}));
  cannon.rotation.z=Math.PI/2;cannon.position.set(1.4,0.4,0);mech.add(cannon);
  mech.position.set(0,1.2,8);sc.add(mech);
  var mechLight=new THREE.PointLight(0x00f5ff,2,8);mech.add(mechLight);
  // Enemies
  var enemies=[];
  function spawnEnemy(){
    var eg=new THREE.Group();
    var eb=new THREE.Mesh(new THREE.BoxGeometry(1.8,2,1.4),new THREE.MeshPhongMaterial({color:0xff2200,emissive:0x330000}));
    eg.add(eb);
    var eh=new THREE.Mesh(new THREE.BoxGeometry(0.9,0.8,0.8),new THREE.MeshPhongMaterial({color:0xff4400}));
    eh.position.y=1.5;eg.add(eh);
    var el=new THREE.PointLight(0xff2200,1.5,6);eg.add(el);
    var angle=Math.random()*Math.PI*2;var dist=20+Math.random()*15;
    eg.position.set(Math.cos(angle)*dist,1.2,Math.sin(angle)*dist);
    sc.add(eg);
    enemies.push({g:eg,hp:3,spd:0.06+Math.random()*0.04});
  }
  for(var i=0;i<6;i++)spawnEnemy();
  // Bullets
  var bullets=[];var playerHp=10;var score=0;var frame=0;var cool=0;
  var keys={};
  document.addEventListener('keydown',function mk(e){
    if(currentGame!=='g6_mech')return document.removeEventListener('keydown',mk);
    keys[e.key]=true;
    if((e.key===' '||e.key==='f'||e.key==='F')&&cool<=0){
      cool=15;
      var b=new THREE.Mesh(new THREE.SphereGeometry(0.2,6,6),new THREE.MeshBasicMaterial({color:0xffbe0b}));
      var bl=new THREE.PointLight(0xffbe0b,3,5);b.add(bl);
      b.position.copy(mech.position);b.position.y=1.5;
      var dx=Math.sin(mech.rotation.y);var dz=Math.cos(mech.rotation.y);
      sc.add(b);bullets.push({m:b,vx:dx*0.8,vz:dz*0.8,life:60});
      e.preventDefault();
    }
  });
  document.addEventListener('keyup',function mku(e){delete keys[e.key];});
  setScore('HP:'+playerHp+' | SCORE:0 | ENEMIES:6');
  addMsg('WASD move ¬∑ F or SPACE fire ¬∑ Destroy all mechs!');
  var stop=g3Loop(function(){
    frame++;cool--;
    if(keys['a']||keys['ArrowLeft'])mech.rotation.y+=0.05;
    if(keys['d']||keys['ArrowRight'])mech.rotation.y-=0.05;
    if(keys['w']||keys['ArrowUp']){mech.position.x-=Math.sin(mech.rotation.y)*0.18;mech.position.z-=Math.cos(mech.rotation.y)*0.18;}
    if(keys['s']||keys['ArrowDown']){mech.position.x+=Math.sin(mech.rotation.y)*0.12;mech.position.z+=Math.cos(mech.rotation.y)*0.12;}
    mech.position.x=Math.max(-35,Math.min(35,mech.position.x));
    mech.position.z=Math.max(-35,Math.min(35,mech.position.z));
    legL.rotation.x=Math.sin(frame*0.18)*0.4;legR.rotation.x=-Math.sin(frame*0.18)*0.4;
    cam.position.x=mech.position.x+Math.sin(mech.rotation.y)*22;
    cam.position.z=mech.position.z+Math.cos(mech.rotation.y)*22;
    cam.lookAt(mech.position.x,2,mech.position.z);
    enemies.forEach(function(en){
      var dx2=mech.position.x-en.g.position.x;var dz2=mech.position.z-en.g.position.z;
      var d=Math.sqrt(dx2*dx2+dz2*dz2);
      en.g.position.x+=dx2/d*en.spd;en.g.position.z+=dz2/d*en.spd;
      en.g.rotation.y=Math.atan2(dx2,dz2);
      if(d<2.5){playerHp--;setScore('HP:'+Math.max(0,playerHp)+' | SCORE:'+score);en.g.position.x=(Math.random()-0.5)*30;en.g.position.z=(Math.random()-0.5)*30;}
      if(playerHp<=0){addMsg('MECH DESTROYED! Score:'+score);stop();}
    });
    for(var i=bullets.length-1;i>=0;i--){
      bullets[i].m.position.x+=bullets[i].vx;
      bullets[i].m.position.z+=bullets[i].vz;
      bullets[i].life--;
      var hit=false;
      for(var j=enemies.length-1;j>=0;j--){
        var ex=bullets[i].m.position.x-enemies[j].g.position.x;
        var ez=bullets[i].m.position.z-enemies[j].g.position.z;
        if(Math.sqrt(ex*ex+ez*ez)<1.5){
          enemies[j].hp--;hit=true;
          if(enemies[j].hp<=0){sc.remove(enemies[j].g);enemies.splice(j,1);score+=100;spawnEnemy();}
          sc.remove(bullets[i].m);bullets.splice(i,1);
          setScore('HP:'+playerHp+' | SCORE:'+score+' | ENEMIES:'+enemies.length);
          break;
        }
      }
      if(!hit&&bullets[i]&&bullets[i].life<=0){sc.remove(bullets[i].m);bullets.splice(i,1);}
    }
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Mech,60);});
}

// ‚îÄ‚îÄ G6-2: DEPTH CHARGE (Submarine) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Submarine(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x000a1a);
  sc.fog=new THREE.FogExp2(0x000a1a,0.025);
  var cam=new THREE.PerspectiveCamera(70,580/420,.1,150);
  var sub=new THREE.Group();
  var hull=new THREE.Mesh(new THREE.CylinderGeometry(0.7,0.7,5,12),new THREE.MeshPhongMaterial({color:0x336633,emissive:0x112211,shininess:80}));
  hull.rotation.z=Math.PI/2;sub.add(hull);
  var tower=new THREE.Mesh(new THREE.BoxGeometry(0.6,1,1.2),new THREE.MeshPhongMaterial({color:0x224422}));
  tower.position.y=0.9;sub.add(tower);
  var subLight=new THREE.SpotLight(0x00ff88,3,20,0.4,0.5);
  subLight.position.set(2.5,0,0);subLight.target.position.set(10,0,0);
  sub.add(subLight);sub.add(subLight.target);
  sub.position.set(0,0,0);sc.add(sub);
  sc.add(mkLight('ambient',0x001122,1.5));
  sc.add(mkLight('point',0x0044ff,1,40,0,10,0));
  // Particles - underwater bubbles
  var bGeo=new THREE.BufferGeometry();var bv=[];
  for(var i=0;i<200;i++)bv.push((Math.random()-0.5)*60,(Math.random()-0.5)*30,(Math.random()-0.5)*60);
  bGeo.setAttribute('position',new THREE.Float32BufferAttribute(bv,3));
  sc.add(new THREE.Points(bGeo,new THREE.PointsMaterial({color:0x4488ff,size:0.15,transparent:true,opacity:0.6})));
  // Enemy ships (surface targets)
  var ships=[];
  function spawnShip(){
    var sg=new THREE.Group();
    var shull=new THREE.Mesh(new THREE.BoxGeometry(4,0.8,1.5),new THREE.MeshPhongMaterial({color:0x664422}));sg.add(shull);
    var mast=new THREE.Mesh(new THREE.CylinderGeometry(0.08,0.08,2,6),new THREE.MeshPhongMaterial({color:0x443322}));
    mast.position.y=1.4;sg.add(mast);
    sg.position.set((Math.random()-0.5)*40,12,(Math.random()-0.5)*40);
    sg.userData.vx=(Math.random()-0.5)*0.08;sg.userData.vz=(Math.random()-0.5)*0.08;
    sc.add(sg);ships.push({g:sg,hp:2});
  }
  for(var i=0;i<5;i++)spawnShip();
  // Depth charges raining down
  var depthCharges=[];var torpedoes=[];
  var score=0;var hp=5;var frame=0;var cool=0;
  var keys={};
  document.addEventListener('keydown',function subk(e){
    if(currentGame!=='g6_submarine')return document.removeEventListener('keydown',subk);
    keys[e.key]=true;
    if(e.key===' '&&cool<=0){
      cool=20;
      var t=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.15,1,8),new THREE.MeshBasicMaterial({color:0x00ff88}));
      t.rotation.z=Math.PI/2;
      t.position.copy(sub.position);
      sc.add(t);torpedoes.push({m:t,vy:0.3,life:80});
      e.preventDefault();
    }
  });
  document.addEventListener('keyup',function subku(e){delete keys[e.key];});
  setScore('HP:'+hp+' | SCORE:0 | TARGETS:'+ships.length);
  addMsg('WASD move submarine ¬∑ SPACE fire torpedo at surface ships!');
  var stop=g3Loop(function(){
    frame++;cool--;
    if(keys['a']||keys['ArrowLeft'])sub.position.x-=0.15;
    if(keys['d']||keys['ArrowRight'])sub.position.x+=0.15;
    if(keys['w']||keys['ArrowUp'])sub.position.z-=0.15;
    if(keys['s']||keys['ArrowDown'])sub.position.z+=0.15;
    if(keys['q'])sub.position.y=Math.min(8,sub.position.y+0.12);
    if(keys['e'])sub.position.y=Math.max(-12,sub.position.y-0.12);
    sub.position.x=Math.max(-25,Math.min(25,sub.position.x));
    sub.position.z=Math.max(-25,Math.min(25,sub.position.z));
    cam.position.set(sub.position.x-10,sub.position.y+5,sub.position.z+10);
    cam.lookAt(sub.position.x,sub.position.y,sub.position.z);
    ships.forEach(function(s){
      s.g.position.x+=s.g.userData.vx;
      s.g.position.z+=s.g.userData.vz;
      if(Math.abs(s.g.position.x)>25)s.g.userData.vx*=-1;
      if(Math.abs(s.g.position.z)>25)s.g.userData.vz*=-1;
      if(frame%120===0&&Math.random()<0.4){
        var dc=new THREE.Mesh(new THREE.SphereGeometry(0.3,6,6),new THREE.MeshBasicMaterial({color:0xff4400}));
        dc.position.copy(s.g.position);dc.position.y=11;
        sc.add(dc);depthCharges.push({m:dc,vy:-0.12});
      }
    });
    for(var i=depthCharges.length-1;i>=0;i--){
      depthCharges[i].m.position.y+=depthCharges[i].vy;
      var dx=depthCharges[i].m.position.x-sub.position.x;
      var dy=depthCharges[i].m.position.y-sub.position.y;
      var dz=depthCharges[i].m.position.z-sub.position.z;
      if(Math.sqrt(dx*dx+dy*dy+dz*dz)<1.5){hp--;setScore('HP:'+Math.max(0,hp)+' | SCORE:'+score);if(hp<=0){addMsg('SUBMARINE SUNK! Score:'+score);stop();}}
      if(depthCharges[i]&&depthCharges[i].m.position.y<-14){sc.remove(depthCharges[i].m);depthCharges.splice(i,1);}
    }
    for(var i=torpedoes.length-1;i>=0;i--){
      torpedoes[i].m.position.y+=torpedoes[i].vy;
      torpedoes[i].life--;
      var hit=false;
      for(var j=ships.length-1;j>=0;j--){
        var dx2=torpedoes[i].m.position.x-ships[j].g.position.x;
        var dz2=torpedoes[i].m.position.z-ships[j].g.position.z;
        var dy2=torpedoes[i].m.position.y-ships[j].g.position.y;
        if(Math.sqrt(dx2*dx2+dy2*dy2+dz2*dz2)<2.5){
          ships[j].hp--;hit=true;
          if(ships[j].hp<=0){sc.remove(ships[j].g);ships.splice(j,1);score+=200;spawnShip();}
          sc.remove(torpedoes[i].m);torpedoes.splice(i,1);
          setScore('HP:'+hp+' | SCORE:'+score+' | TARGETS:'+ships.length);
          break;
        }
      }
      if(!hit&&torpedoes[i]&&(torpedoes[i].life<=0||torpedoes[i].m.position.y>15)){sc.remove(torpedoes[i].m);torpedoes.splice(i,1);}
    }
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Submarine,60);});
}

// ‚îÄ‚îÄ G6-3: CRYSTAL HARVESTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Crystals(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x000005);
  var cam=new THREE.PerspectiveCamera(75,580/420,.1,200);
  sc.add(mkLight('ambient',0x111133,1.5));
  sc.add(mkLight('point',0x4466ff,2,80,0,20,0));
  // Stars
  var sv=[];for(var i=0;i<800;i++)sv.push((Math.random()-0.5)*160,(Math.random()-0.5)*160,(Math.random()-0.5)*160);
  var sg=new THREE.BufferGeometry();sg.setAttribute('position',new THREE.Float32BufferAttribute(sv,3));
  sc.add(new THREE.Points(sg,new THREE.PointsMaterial({color:0xffffff,size:0.3})));
  // Ship
  var ship=new THREE.Group();
  var shull=new THREE.Mesh(new THREE.ConeGeometry(0.6,2.2,8),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244,shininess:180}));
  shull.rotation.x=Math.PI/2;ship.add(shull);
  var wing1=new THREE.Mesh(new THREE.BoxGeometry(2.4,0.1,0.7),new THREE.MeshPhongMaterial({color:0x005566}));
  ship.add(wing1);
  var thruster=new THREE.PointLight(0x00aaff,3,5);thruster.position.set(0,0,1.2);ship.add(thruster);
  ship.position.set(0,0,0);sc.add(ship);
  // Crystals
  var crystals=[];var CCOLS=[0xff006e,0x00f5ff,0xffbe0b,0x06d6a0,0x8338ec];
  function spawnCrystal(){
    var col=CCOLS[Math.floor(Math.random()*CCOLS.length)];
    var cm=new THREE.Mesh(new THREE.OctahedronGeometry(0.5+Math.random()*0.8,0),new THREE.MeshPhongMaterial({color:col,emissive:col,emissiveIntensity:0.3,shininess:200,transparent:true,opacity:0.85}));
    cm.position.set((Math.random()-0.5)*60,(Math.random()-0.5)*40,(Math.random()-0.5)*60);
    var cl=new THREE.PointLight(col,1.5,4);cm.add(cl);sc.add(cm);
    crystals.push({m:cm,val:Math.floor(Math.random()*3)+1,rot:Math.random()*0.05});
  }
  for(var i=0;i<25;i++)spawnCrystal();
  // Lasers
  var lasers=[];var score=0;var cool=0;var frame=0;
  var keys={};
  document.addEventListener('keydown',function crk(e){
    if(currentGame!=='g6_crystals')return document.removeEventListener('keydown',crk);
    keys[e.key]=true;
    if(e.key===' '&&cool<=0){
      cool=8;
      var l=new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,1.5,6),new THREE.MeshBasicMaterial({color:0xffbe0b}));
      l.rotation.x=Math.PI/2;l.position.copy(ship.position);
      sc.add(l);lasers.push({m:l,vx:Math.sin(ship.rotation.y)*1.2,vy:Math.sin(-ship.rotation.x)*1.2,vz:-Math.cos(ship.rotation.y)*1.2,life:50});
      e.preventDefault();
    }
  });
  document.addEventListener('keyup',function crku(e){delete keys[e.key];});
  setScore('SCORE:0 | CRYSTALS:'+crystals.length);
  addMsg('WASD fly ¬∑ Q/E up/down ¬∑ SPACE blast crystals to harvest!');
  var stop=g3Loop(function(){
    frame++;cool--;
    if(keys['a']||keys['ArrowLeft'])ship.rotation.y+=0.04;
    if(keys['d']||keys['ArrowRight'])ship.rotation.y-=0.04;
    if(keys['w']||keys['ArrowUp'])ship.rotation.x=Math.max(-0.6,ship.rotation.x-0.03);
    if(keys['s']||keys['ArrowDown'])ship.rotation.x=Math.min(0.6,ship.rotation.x+0.03);
    ship.position.x-=Math.sin(ship.rotation.y)*0.2;
    ship.position.y+=Math.sin(-ship.rotation.x)*0.2;
    ship.position.z-=Math.cos(ship.rotation.y)*0.2;
    cam.position.set(ship.position.x+Math.sin(ship.rotation.y)*12,ship.position.y+4,ship.position.z+Math.cos(ship.rotation.y)*12);
    cam.lookAt(ship.position.x,ship.position.y,ship.position.z);
    crystals.forEach(function(c){c.m.rotation.y+=c.rot;c.m.rotation.x+=c.rot*0.5;});
    for(var i=lasers.length-1;i>=0;i--){
      lasers[i].m.position.x+=lasers[i].vx;
      lasers[i].m.position.y+=lasers[i].vy;
      lasers[i].m.position.z+=lasers[i].vz;
      lasers[i].life--;
      var hit=false;
      for(var j=crystals.length-1;j>=0;j--){
        var dx=lasers[i].m.position.x-crystals[j].m.position.x;
        var dy=lasers[i].m.position.y-crystals[j].m.position.y;
        var dz=lasers[i].m.position.z-crystals[j].m.position.z;
        if(Math.sqrt(dx*dx+dy*dy+dz*dz)<1.2){
          score+=crystals[j].val*10;hit=true;
          sc.remove(crystals[j].m);crystals.splice(j,1);spawnCrystal();
          sc.remove(lasers[i].m);lasers.splice(i,1);
          setScore('SCORE:'+score+' | CRYSTALS:'+crystals.length);
          break;
        }
      }
      if(!hit&&lasers[i]&&lasers[i].life<=0){sc.remove(lasers[i].m);lasers.splice(i,1);}
    }
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Crystals,60);});
}

// ‚îÄ‚îÄ G6-4: PORTAL RUNNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Portal(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x050010);
  sc.fog=new THREE.Fog(0x050010,20,80);
  var cam=new THREE.PerspectiveCamera(80,580/420,.1,120);
  sc.add(mkLight('ambient',0x221144,1.5));
  sc.add(mkLight('point',0x8800ff,2,40,0,10,0));
  // Floor tiles
  var tileMat=new THREE.MeshPhongMaterial({color:0x110022,emissive:0x050010});
  for(var tx=-5;tx<=5;tx++)for(var tz=0;tz<=30;tz++){
    var tile=new THREE.Mesh(new THREE.BoxGeometry(1.9,0.1,1.9),tileMat);
    tile.position.set(tx*2,0,tz*2);sc.add(tile);
  }
  // Player ball
  var player=new THREE.Mesh(new THREE.SphereGeometry(0.4,12,12),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244,shininess:200}));
  var pl2=new THREE.PointLight(0x00f5ff,2,5);player.add(pl2);
  player.position.set(0,0.5,2);sc.add(player);
  // Portals
  var portals=[];
  var PCOLS2=[0x8338ec,0xff006e,0x06d6a0,0xffbe0b];
  function makePortal(x,z,col,dest){
    var pg=new THREE.Group();
    var ring=new THREE.Mesh(new THREE.TorusGeometry(1.2,0.2,12,32),new THREE.MeshPhongMaterial({color:col,emissive:col,emissiveIntensity:0.6}));
    pg.add(ring);
    var inner=new THREE.Mesh(new THREE.CircleGeometry(1,24),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.4,side:THREE.DoubleSide}));
    pg.add(inner);
    var pl3=new THREE.PointLight(col,2,6);pg.add(pl3);
    pg.position.set(x,1.2,z);pg.rotation.x=Math.PI/2;
    sc.add(pg);portals.push({g:pg,dest:dest,col:col});
  }
  makePortal(-4,8,PCOLS2[0],{x:6,z:24});makePortal(6,24,PCOLS2[1],{x:-2,z:16});
  makePortal(-2,16,PCOLS2[2],{x:2,z:36});makePortal(2,36,PCOLS2[3],{x:0,z:52});
  // Obstacles
  for(var oi=0;oi<15;oi++){
    var obs=new THREE.Mesh(new THREE.BoxGeometry(1.5,2,1.5),new THREE.MeshPhongMaterial({color:0x660033,emissive:0x330011}));
    obs.position.set((Math.random()-0.5)*10,1,(Math.random()*50)+5);sc.add(obs);
  }
  // Goal
  var goal=new THREE.Mesh(new THREE.CylinderGeometry(1,1,0.3,20),new THREE.MeshPhongMaterial({color:0x06d6a0,emissive:0x006633,emissiveIntensity:0.8}));
  goal.position.set(0,0.2,58);sc.add(goal);
  var gl3=new THREE.PointLight(0x06d6a0,3,8);gl3.position.copy(goal.position);sc.add(gl3);
  var vx=0,vz=0;var won=false;var timer=60;var lastT=Date.now();var frame=0;
  var keys={};
  document.addEventListener('keydown',function prk(e){
    if(currentGame!=='g6_portal')return document.removeEventListener('keydown',prk);
    keys[e.key]=true;e.preventDefault();
  });
  document.addEventListener('keyup',function prku(e){delete keys[e.key];});
  setScore('TIME:60 | PORTALS:4');
  addMsg('WASD or ARROWS to roll ¬∑ Step through portals ¬∑ Reach the exit!');
  var stop=g3Loop(function(){
    frame++;
    var now=Date.now();if(now-lastT>=1000){timer--;lastT=now;setScore('TIME:'+timer);if(timer<=0&&!won){addMsg('TIME UP!');stop();}}
    if(keys['a']||keys['ArrowLeft'])vx-=0.015;
    if(keys['d']||keys['ArrowRight'])vx+=0.015;
    if(keys['w']||keys['ArrowUp'])vz-=0.015;
    if(keys['s']||keys['ArrowDown'])vz+=0.015;
    vx*=0.9;vz*=0.9;
    player.position.x=Math.max(-9,Math.min(9,player.position.x+vx));
    player.position.z+=vz;
    player.rotation.x+=vz*2;player.rotation.z-=vx*2;
    cam.position.set(player.position.x,player.position.y+8,player.position.z+12);
    cam.lookAt(player.position.x,player.position.y,player.position.z+2);
    portals.forEach(function(p){p.g.rotation.z+=0.03;
      var dx=player.position.x-p.g.position.x;var dz=player.position.z-p.g.position.z;
      if(Math.sqrt(dx*dx+dz*dz)<1.5){player.position.x=p.dest.x;player.position.z=p.dest.z;vx=0;vz=0;}
    });
    var gx=player.position.x-goal.position.x;var gz=player.position.z-goal.position.z;
    if(Math.sqrt(gx*gx+gz*gz)<1.5&&!won){won=true;addMsg('YOU WIN! Time left:'+timer+'s ¬∑ Score:'+(timer*100));stop();}
    if(player.position.z>70){player.position.z=0;player.position.x=0;}
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Portal,60);});
}

// ‚îÄ‚îÄ G6-5: BEE SWARM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Swarm(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x0a0a1a);
  sc.fog=new THREE.FogExp2(0x0a0a1a,0.015);
  var cam=new THREE.PerspectiveCamera(70,580/420,.1,150);
  cam.position.set(0,20,0);cam.rotation.x=-Math.PI/2;
  sc.add(mkLight('ambient',0x222244,2));
  sc.add(mkLight('point',0x4466ff,1.5,60,0,20,0));
  // Floor
  var floor=new THREE.Mesh(new THREE.PlaneGeometry(80,80),new THREE.MeshPhongMaterial({color:0x050510}));
  floor.rotation.x=-Math.PI/2;sc.add(floor);
  sc.add(new THREE.GridHelper(80,16,0x111133,0x0a0a22));
  // Player swarm
  var playerSwarm={x:0,z:0,size:8,nodes:[]};
  for(var i=0;i<8;i++){
    var n=new THREE.Mesh(new THREE.SphereGeometry(0.3,6,6),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244}));
    var a=Math.random()*Math.PI*2;var r=Math.random()*1.5;
    n.position.set(Math.cos(a)*r,0.5,Math.sin(a)*r);sc.add(n);
    playerSwarm.nodes.push({m:n,ox:Math.cos(a)*r,oz:Math.sin(a)*r});
  }
  var pl4=new THREE.PointLight(0x00f5ff,2,8);pl4.position.set(0,1,0);sc.add(pl4);
  // Enemy swarms
  var enemySwarms=[];
  function spawnSwarm(size,hostile){
    var sw={x:(Math.random()-0.5)*50,z:(Math.random()-0.5)*50,size:size,hostile:hostile,nodes:[],vx:(Math.random()-0.5)*0.1,vz:(Math.random()-0.5)*0.1};
    var col=hostile?0xff2200:0xffbe0b;
    for(var j=0;j<size;j++){
      var n2=new THREE.Mesh(new THREE.SphereGeometry(0.25,6,6),new THREE.MeshPhongMaterial({color:col,emissive:hostile?0x330000:0x332200}));
      var a2=Math.random()*Math.PI*2;var r2=Math.random()*1.2*(size/5);
      n2.position.set(sw.x+Math.cos(a2)*r2,0.5,sw.z+Math.sin(a2)*r2);
      sc.add(n2);sw.nodes.push({m:n2,ox:Math.cos(a2)*r2,oz:Math.sin(a2)*r2});
    }
    enemySwarms.push(sw);
  }
  for(var i=0;i<4;i++)spawnSwarm(3+Math.floor(Math.random()*5),Math.random()<0.5);
  for(var i=0;i<4;i++)spawnSwarm(10+Math.floor(Math.random()*8),true);
  var score=0;var frame=0;
  var keys={};
  document.addEventListener('keydown',function swk(e){
    if(currentGame!=='g6_swarm')return document.removeEventListener('keydown',swk);
    keys[e.key]=true;e.preventDefault();
  });
  document.addEventListener('keyup',function swku(e){delete keys[e.key];});
  setScore('SWARM SIZE:8 | SCORE:0');
  addMsg('WASD move swarm ¬∑ Absorb smaller swarms ¬∑ Flee larger ones!');
  var stop=g3Loop(function(){
    frame++;
    var spd=0.15;
    if(keys['a']||keys['ArrowLeft'])playerSwarm.x-=spd;
    if(keys['d']||keys['ArrowRight'])playerSwarm.x+=spd;
    if(keys['w']||keys['ArrowUp'])playerSwarm.z-=spd;
    if(keys['s']||keys['ArrowDown'])playerSwarm.z+=spd;
    playerSwarm.x=Math.max(-35,Math.min(35,playerSwarm.x));
    playerSwarm.z=Math.max(-35,Math.min(35,playerSwarm.z));
    pl4.position.set(playerSwarm.x,1,playerSwarm.z);
    playerSwarm.nodes.forEach(function(n,i){
      var ang=frame*0.05+i*(Math.PI*2/playerSwarm.nodes.length);
      var r=0.8+playerSwarm.size*0.12;
      n.m.position.x=playerSwarm.x+Math.cos(ang)*r+Math.sin(frame*0.03+i)*0.3;
      n.m.position.z=playerSwarm.z+Math.sin(ang)*r+Math.cos(frame*0.03+i)*0.3;
    });
    cam.position.x=playerSwarm.x;cam.position.z=playerSwarm.z+20+playerSwarm.size*0.5;
    cam.lookAt(playerSwarm.x,0,playerSwarm.z);
    for(var j=enemySwarms.length-1;j>=0;j--){
      var sw2=enemySwarms[j];
      var dx=playerSwarm.x-sw2.x;var dz=playerSwarm.z-sw2.z;
      var d=Math.sqrt(dx*dx+dz*dz);
      if(sw2.size>playerSwarm.size){sw2.x+=dx/d*0.06;sw2.z+=dz/d*0.06;}
      else{sw2.x-=dx/d*0.04;sw2.z-=dz/d*0.04;}
      sw2.x+=sw2.vx;sw2.z+=sw2.vz;
      sw2.nodes.forEach(function(n,i){
        var ang=frame*0.04+i*(Math.PI*2/sw2.nodes.length);
        var r2=0.6+sw2.size*0.1;
        n.m.position.x=sw2.x+Math.cos(ang)*r2;n.m.position.z=sw2.z+Math.sin(ang)*r2;
      });
      if(d<1.5+playerSwarm.size*0.15+sw2.size*0.1){
        if(sw2.size<=playerSwarm.size){
          sw2.nodes.forEach(function(n){sc.remove(n.m);});
          enemySwarms.splice(j,1);
          score+=sw2.size*10;playerSwarm.size+=Math.floor(sw2.size/2);
          for(var k=0;k<Math.floor(sw2.size/2);k++){
            var nn=new THREE.Mesh(new THREE.SphereGeometry(0.3,6,6),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244}));
            playerSwarm.nodes.push({m:nn,ox:0,oz:0});sc.add(nn);
          }
          setScore('SWARM:'+playerSwarm.size+' | SCORE:'+score);
          spawnSwarm(playerSwarm.size+2+Math.floor(Math.random()*4),true);
        } else {
          playerSwarm.size=Math.max(1,playerSwarm.size-3);
          setScore('SWARM:'+playerSwarm.size+' | SCORE:'+score);
          if(playerSwarm.size<=0){addMsg('SWARM DESTROYED! Score:'+score);stop();}
        }
      }
    }
    if(frame%300===0)spawnSwarm(3+Math.floor(Math.random()*4),Math.random()<0.4);
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Swarm,60);});
}

// ‚îÄ‚îÄ G6-6: SKY FORTRESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Fortress(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x000814);
  sc.fog=new THREE.Fog(0x000814,40,150);
  var cam=new THREE.PerspectiveCamera(75,580/420,.1,200);
  sc.add(mkLight('ambient',0x112233,1.5));
  sc.add(mkLight('point',0x4488ff,2,80,0,40,0));
  // Fortress platform
  var platform=new THREE.Mesh(new THREE.BoxGeometry(20,2,20),new THREE.MeshPhongMaterial({color:0x334455,emissive:0x112233}));
  platform.position.set(0,30,0);sc.add(platform);
  for(var ci=0;ci<4;ci++){
    var corner=new THREE.Mesh(new THREE.BoxGeometry(3,8,3),new THREE.MeshPhongMaterial({color:0x445566}));
    corner.position.set(ci<2?-8:8,34,ci%2===0?-8:8);sc.add(corner);
  }
  // Cannons (targets)
  var cannons=[];var CANNON_POS=[{x:-8,z:-8},{x:8,z:-8},{x:-8,z:8},{x:8,z:8}];
  CANNON_POS.forEach(function(cp){
    var cg=new THREE.Group();
    var cbase=new THREE.Mesh(new THREE.CylinderGeometry(0.8,1,1.5,8),new THREE.MeshPhongMaterial({color:0x223344}));
    cg.add(cbase);
    var cbarrel=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.3,2.5,8),new THREE.MeshPhongMaterial({color:0x334455}));
    cbarrel.rotation.z=Math.PI/2;cbarrel.position.x=1.2;cg.add(cbarrel);
    var cl=new THREE.PointLight(0xff4400,1.5,5);cg.add(cl);
    cg.position.set(cp.x,31.8,cp.z);sc.add(cg);
    cannons.push({g:cg,hp:3,alive:true,x:cp.x,z:cp.z});
  });
  // Player ship
  var pship=new THREE.Group();
  var pshull=new THREE.Mesh(new THREE.ConeGeometry(0.5,1.8,8),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244,shininess:180}));
  pshull.rotation.x=Math.PI/2;pship.add(pshull);
  var pwing=new THREE.Mesh(new THREE.BoxGeometry(2,0.1,0.6),new THREE.MeshPhongMaterial({color:0x005577}));
  pship.add(pwing);
  var plight=new THREE.PointLight(0x00f5ff,2,6);pship.add(plight);
  pship.position.set(0,5,-20);sc.add(pship);
  // Shots and projectiles
  var enemyShots=[];var playerBullets=[];
  var hp2=10;var score=0;var frame=0;var cool=0;
  var keys={};
  document.addEventListener('keydown',function ftk(e){
    if(currentGame!=='g6_fortress')return document.removeEventListener('keydown',ftk);
    keys[e.key]=true;
    if(e.key===' '&&cool<=0){
      cool=12;
      var b=new THREE.Mesh(new THREE.SphereGeometry(0.2,6,6),new THREE.MeshBasicMaterial({color:0xffbe0b}));
      b.position.copy(pship.position);sc.add(b);
      var dx=0;var dy=0.4;var dz=-0.7;
      playerBullets.push({m:b,vx:dx,vy:dy,vz:dz,life:80});
      e.preventDefault();
    }
  });
  document.addEventListener('keyup',function ftku(e){delete keys[e.key];});
  setScore('HP:'+hp2+' | CANNONS:4 | SCORE:0');
  addMsg('WASD fly around fortress ¬∑ SPACE shoot cannons ¬∑ Destroy all 4!');
  var stop=g3Loop(function(){
    frame++;cool--;
    if(keys['a']||keys['ArrowLeft'])pship.position.x-=0.2;
    if(keys['d']||keys['ArrowRight'])pship.position.x+=0.2;
    if(keys['w']||keys['ArrowUp'])pship.position.y=Math.min(50,pship.position.y+0.2);
    if(keys['s']||keys['ArrowDown'])pship.position.y=Math.max(2,pship.position.y-0.2);
    if(keys['q'])pship.position.z-=0.25;
    if(keys['e'])pship.position.z+=0.25;
    pship.position.x=Math.max(-25,Math.min(25,pship.position.x));
    pship.position.z=Math.max(-35,Math.min(35,pship.position.z));
    cam.position.set(pship.position.x,pship.position.y+6,pship.position.z+14);
    cam.lookAt(pship.position.x,pship.position.y,pship.position.z-5);
    // Cannon fire
    if(frame%90===0){
      cannons.filter(function(c){return c.alive;}).forEach(function(c){
        if(Math.random()<0.6){
          var es=new THREE.Mesh(new THREE.SphereGeometry(0.25,6,6),new THREE.MeshBasicMaterial({color:0xff4400}));
          es.position.set(c.x,31.5,c.z);sc.add(es);
          var dx2=pship.position.x-c.x;var dy2=pship.position.y-31.5;var dz2=pship.position.z-c.z;
          var d2=Math.sqrt(dx2*dx2+dy2*dy2+dz2*dz2);
          enemyShots.push({m:es,vx:dx2/d2*0.35,vy:dy2/d2*0.35,vz:dz2/d2*0.35,life:120});
        }
      });
    }
    for(var i=enemyShots.length-1;i>=0;i--){
      enemyShots[i].m.position.x+=enemyShots[i].vx;
      enemyShots[i].m.position.y+=enemyShots[i].vy;
      enemyShots[i].m.position.z+=enemyShots[i].vz;
      enemyShots[i].life--;
      var dx3=enemyShots[i].m.position.x-pship.position.x;
      var dy3=enemyShots[i].m.position.y-pship.position.y;
      var dz3=enemyShots[i].m.position.z-pship.position.z;
      if(Math.sqrt(dx3*dx3+dy3*dy3+dz3*dz3)<1.2){hp2--;setScore('HP:'+Math.max(0,hp2)+' | SCORE:'+score);sc.remove(enemyShots[i].m);enemyShots.splice(i,1);if(hp2<=0){addMsg('SHOT DOWN! Score:'+score);stop();}continue;}
      if(enemyShots[i]&&enemyShots[i].life<=0){sc.remove(enemyShots[i].m);enemyShots.splice(i,1);}
    }
    for(var i=playerBullets.length-1;i>=0;i--){
      playerBullets[i].m.position.x+=playerBullets[i].vx;
      playerBullets[i].m.position.y+=playerBullets[i].vy;
      playerBullets[i].m.position.z+=playerBullets[i].vz;
      playerBullets[i].life--;
      var hit=false;
      for(var j=cannons.length-1;j>=0;j--){
        if(!cannons[j].alive)continue;
        var dx4=playerBullets[i].m.position.x-cannons[j].x;
        var dy4=playerBullets[i].m.position.y-31.5;
        var dz4=playerBullets[i].m.position.z-cannons[j].z;
        if(Math.sqrt(dx4*dx4+dy4*dy4+dz4*dz4)<2){
          cannons[j].hp--;hit=true;
          if(cannons[j].hp<=0){cannons[j].alive=false;sc.remove(cannons[j].g);score+=300;}
          sc.remove(playerBullets[i].m);playerBullets.splice(i,1);
          var alive=cannons.filter(function(c){return c.alive;}).length;
          setScore('HP:'+hp2+' | CANNONS:'+alive+' | SCORE:'+score);
          if(alive===0){addMsg('FORTRESS DESTROYED! Score:'+score);stop();}
          break;
        }
      }
      if(!hit&&playerBullets[i]&&playerBullets[i].life<=0){sc.remove(playerBullets[i].m);playerBullets.splice(i,1);}
    }
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Fortress,60);});
}

// ‚îÄ‚îÄ G6-7: LAVA SURFER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Lava(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x100000);
  sc.fog=new THREE.Fog(0x100000,20,70);
  var cam=new THREE.PerspectiveCamera(80,580/420,.1,100);
  sc.add(mkLight('ambient',0x331100,2));
  sc.add(mkLight('point',0xff4400,3,30,0,8,0));
  // Lava floor
  var lavaMat=new THREE.MeshPhongMaterial({color:0xff2200,emissive:0xff6600,emissiveIntensity:0.5});
  var lavaFloor=new THREE.Mesh(new THREE.PlaneGeometry(20,200),lavaMat);
  lavaFloor.rotation.x=-Math.PI/2;lavaFloor.position.y=-2;sc.add(lavaFloor);
  // Platform track (scrolling)
  var platforms=[];
  function makePlatform(z){
    var w=2+Math.random()*4;var gap=(Math.random()-0.5)*5;
    var p=new THREE.Mesh(new THREE.BoxGeometry(w,0.4,3),new THREE.MeshPhongMaterial({color:0x332211,emissive:0x110800}));
    p.position.set(gap,0,z);sc.add(p);
    platforms.push({m:p,w:w,x:gap});
    return p;
  }
  for(var i=0;i<20;i++)makePlatform(-i*5);
  // Lava jets
  var jets=[];
  for(var i=0;i<8;i++){
    var j2=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.5,3,8),new THREE.MeshBasicMaterial({color:0xff6600}));
    j2.position.set((Math.random()-0.5)*8,-0.5,-20-i*8);sc.add(j2);
    jets.push({m:j2,timer:Math.random()*60,active:false});
  }
  // Player board
  var board=new THREE.Group();
  var bbase=new THREE.Mesh(new THREE.BoxGeometry(1.5,0.3,2.5),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244,shininess:200}));
  board.add(bbase);
  var rider=new THREE.Mesh(new THREE.BoxGeometry(0.6,1.2,0.5),new THREE.MeshPhongMaterial({color:0xffffff}));
  rider.position.y=0.75;board.add(rider);
  var blight=new THREE.PointLight(0x00f5ff,2,5);board.add(blight);
  board.position.set(0,0.5,0);sc.add(board);
  var px5=0;var score=0;var spd=0.12;var alive=true;var frame=0;
  var keys={};
  document.addEventListener('keydown',function lvk(e){
    if(currentGame!=='g6_lava')return document.removeEventListener('keydown',lvk);
    keys[e.key]=true;e.preventDefault();
  });
  document.addEventListener('keyup',function lvku(e){delete keys[e.key];});
  setScore('DISTANCE:0 | SCORE:0');
  addMsg('A/D or ARROWS left/right ¬∑ Surf the lava ¬∑ Dodge jets ¬∑ Never fall!');
  var stop=g3Loop(function(){
    if(!alive)return;
    frame++;spd=0.12+frame*0.0001;
    if(keys['a']||keys['ArrowLeft'])px5=Math.max(-7,px5-0.1);
    if(keys['d']||keys['ArrowRight'])px5=Math.min(7,px5+0.1);
    board.position.x+=(px5-board.position.x)*0.15;
    // Scroll platforms toward player
    platforms.forEach(function(p){p.m.position.z+=spd;});
    jets.forEach(function(j3){j3.m.position.z+=spd;j3.timer--;
      if(j3.timer<=0){j3.active=!j3.active;j3.timer=30+Math.random()*60;}
      j3.m.scale.y=j3.active?(1+Math.sin(frame*0.3)*0.3):0.1;
    });
    if(platforms[platforms.length-1].m.position.z>5)makePlatform(-90);
    for(var i=platforms.length-1;i>=0;i--){if(platforms[i].m.position.z>15){sc.remove(platforms[i].m);platforms.splice(i,1);}}
    for(var i=jets.length-1;i>=0;i--){if(jets[i].m.position.z>8){sc.remove(jets[i].m);jets.splice(i,1);
      var nj=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.5,3,8),new THREE.MeshBasicMaterial({color:0xff6600}));
      nj.position.set((Math.random()-0.5)*8,-0.5,-80-Math.random()*20);sc.add(nj);
      jets.push({m:nj,timer:Math.random()*60,active:false});
    }}
    cam.position.set(board.position.x*0.5,8,15);cam.lookAt(board.position.x*0.3,0,-10);
    // Check on platform
    var onPlatform=false;
    platforms.forEach(function(p){
      var dx=Math.abs(board.position.x-p.m.position.x);var dz=Math.abs(board.position.z-p.m.position.z);
      if(dx<p.w/2+0.5&&dz<2.5)onPlatform=true;
    });
    jets.forEach(function(j3){
      if(j3.active){var dx=Math.abs(board.position.x-j3.m.position.x);var dz=Math.abs(board.position.z-j3.m.position.z);if(dx<1&&dz<1){alive=false;addMsg('BURNED! Distance:'+(score/10)+'m');stop();}}
    });
    if(!onPlatform){board.position.y-=0.15;if(board.position.y<-2){alive=false;addMsg('FELL IN LAVA! Distance:'+(score/10)+'m');stop();}}
    else{board.position.y=0.5;}
    score++;setScore('DIST:'+(score/10|0)+'m | SPD:'+spd.toFixed(2));
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Lava,60);});
}

// ‚îÄ‚îÄ G6-8: BATTLE CHESS 3D ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Chess3D(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv,true);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x0a0a14);
  var cam=new THREE.PerspectiveCamera(55,580/420,.1,100);
  cam.position.set(0,18,20);cam.lookAt(0,0,0);
  sc.add(mkLight('ambient',0x222233,1.5));
  var dl=mkLight('dir',0xffffff,2,0,20,30,10);dl.castShadow=true;sc.add(dl);
  sc.add(mkLight('point',0x4466ff,1,30,-10,10,-10));
  // Board
  var boardGroup=new THREE.Group();
  for(var r=0;r<8;r++)for(var c=0;c<8;c++){
    var tile=new THREE.Mesh(new THREE.BoxGeometry(1.8,0.3,1.8),new THREE.MeshPhongMaterial({color:(r+c)%2===0?0xe8d5b0:0x8b6340}));
    tile.position.set(c*2-7,0,r*2-7);tile.receiveShadow=true;boardGroup.add(tile);
  }
  sc.add(boardGroup);
  // Piece factory
  function makePiece(type,color,r,c){
    var col=color==='w'?0xf0f0f0:0x222222;
    var ecol=color==='w'?0x4488ff:0xff2200;
    var geo;
    if(type==='P')geo=new THREE.CylinderGeometry(0.3,0.4,1,8);
    else if(type==='R')geo=new THREE.CylinderGeometry(0.4,0.4,1.2,4);
    else if(type==='N')geo=new THREE.ConeGeometry(0.4,1.4,6);
    else if(type==='B')geo=new THREE.ConeGeometry(0.3,1.6,8);
    else if(type==='Q')geo=new THREE.SphereGeometry(0.45,10,10);
    else geo=new THREE.OctahedronGeometry(0.5,0);
    var m=new THREE.Mesh(geo,new THREE.MeshPhongMaterial({color:col,emissive:ecol,emissiveIntensity:0.15,shininess:120}));
    m.position.set(c*2-7,0.8,r*2-7);m.castShadow=true;sc.add(m);
    return {m:m,type:type,color:color,r:r,c:c,alive:true};
  }
  var pieces=[];
  var initPcs=[
    {r:0,c:0,t:'R',col:'b'},{r:0,c:1,t:'N',col:'b'},{r:0,c:2,t:'B',col:'b'},{r:0,c:3,t:'Q',col:'b'},
    {r:0,c:4,t:'K',col:'b'},{r:0,c:5,t:'B',col:'b'},{r:0,c:6,t:'N',col:'b'},{r:0,c:7,t:'R',col:'b'},
    {r:7,c:0,t:'R',col:'w'},{r:7,c:1,t:'N',col:'w'},{r:7,c:2,t:'B',col:'w'},{r:7,c:3,t:'Q',col:'w'},
    {r:7,c:4,t:'K',col:'w'},{r:7,c:5,t:'B',col:'w'},{r:7,c:6,t:'N',col:'w'},{r:7,c:7,t:'R',col:'w'},
  ];
  for(var i=0;i<8;i++){initPcs.push({r:1,c:i,t:'P',col:'b'});initPcs.push({r:6,c:i,t:'P',col:'w'});}
  initPcs.forEach(function(p){pieces.push(makePiece(p.t,p.col,p.r,p.c));});
  // Simple interaction
  var selected=null;var turn='w';var highlights=[];
  function clearHighlights(){highlights.forEach(function(h){sc.remove(h);});highlights=[];}
  function highlightCell(r,c){
    var h=new THREE.Mesh(new THREE.BoxGeometry(1.8,0.05,1.8),new THREE.MeshBasicMaterial({color:0x00f5ff,transparent:true,opacity:0.5}));
    h.position.set(c*2-7,0.18,r*2-7);sc.add(h);highlights.push(h);
  }
  function getSimpleMoves(pc){
    var moves=[];var r=pc.r;var c=pc.c;
    if(pc.type==='P'){var d=pc.color==='w'?-1:1;if(r+d>=0&&r+d<8&&!pieces.find(function(p){return p.alive&&p.r===r+d&&p.c===c;}))moves.push([r+d,c]);}
    else if(pc.type==='R'||pc.type==='Q'){[[0,1],[0,-1],[1,0],[-1,0]].forEach(function(dir){for(var k=1;k<8;k++){var nr=r+dir[0]*k;var nc=c+dir[1]*k;if(nr<0||nr>7||nc<0||nc>7)break;var occ=pieces.find(function(p){return p.alive&&p.r===nr&&p.c===nc;});if(occ){if(occ.color!==pc.color)moves.push([nr,nc]);break;}moves.push([nr,nc]);}});}
    else if(pc.type==='B'||pc.type==='Q'){[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(function(dir){for(var k=1;k<8;k++){var nr=r+dir[0]*k;var nc=c+dir[1]*k;if(nr<0||nr>7||nc<0||nc>7)break;var occ2=pieces.find(function(p){return p.alive&&p.r===nr&&p.c===nc;});if(occ2){if(occ2.color!==pc.color)moves.push([nr,nc]);break;}moves.push([nr,nc]);}});}
    else{var KDIRS=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];if(pc.type==='N')KDIRS=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];
      KDIRS.forEach(function(dir){var nr=r+dir[0];var nc=c+dir[1];if(nr>=0&&nr<8&&nc>=0&&nc<8){var occ3=pieces.find(function(p){return p.alive&&p.r===nr&&p.c===nc;});if(!occ3||occ3.color!==pc.color)moves.push([nr,nc]);}});}
    return moves;
  }
  cv.addEventListener('click',function(e){
    if(turn!=='w')return;
    var rect=cv.getBoundingClientRect();var mx=(e.clientX-rect.left)/rect.width*2-1;var my=-(e.clientY-rect.top)/rect.height*2+1;
    var c2=Math.round((mx*9+7)/2);var r2=Math.round((my*-9+7)/2);
    if(r2<0||r2>7||c2<0||c2>7){clearHighlights();selected=null;return;}
    if(selected){
      var moves=getSimpleMoves(selected);
      if(moves.some(function(m){return m[0]===r2&&m[1]===c2;})){
        var cap=pieces.find(function(p){return p.alive&&p.r===r2&&p.c===c2&&p.color==='b';});
        if(cap){cap.alive=false;sc.remove(cap.m);score+=100;if(cap.type==='K'){addMsg('YOU WIN! Score:'+score);stop();return;}}
        selected.r=r2;selected.c=c2;selected.m.position.set(c2*2-7,0.8,r2*2-7);clearHighlights();selected=null;turn='b';score+=5;setScore('SCORE:'+score+' | YOUR TURN');
        setTimeout(function(){aiTurn();},400);return;
      }
      clearHighlights();selected=null;
    }
    var pc=pieces.find(function(p){return p.alive&&p.r===r2&&p.c===c2&&p.color==='w';});
    if(pc){selected=pc;clearHighlights();highlightCell(r2,c2);getSimpleMoves(pc).forEach(function(m){highlightCell(m[0],m[1]);});}
  });
  function aiTurn(){
    var bpieces=pieces.filter(function(p){return p.alive&&p.color==='b';});
    var best=null;var bestScore2=-1;
    bpieces.forEach(function(p){getSimpleMoves(p).forEach(function(m){
      var capVal=0;var cap=pieces.find(function(q){return q.alive&&q.r===m[0]&&q.c===m[1]&&q.color==='w';});
      var vals2={P:1,N:3,B:3,R:5,Q:9,K:100};
      if(cap)capVal=vals2[cap.type]||1;
      if(capVal+Math.random()>bestScore2){bestScore2=capVal+Math.random()*0.5;best={p:p,r:m[0],c:m[1]};}
    });});
    if(best){
      var cap2=pieces.find(function(p){return p.alive&&p.r===best.r&&p.c===best.c&&p.color==='w';});
      if(cap2){cap2.alive=false;sc.remove(cap2.m);if(cap2.type==='K'){addMsg('AI WINS!');stop();return;}}
      best.p.r=best.r;best.p.c=best.c;best.p.m.position.set(best.c*2-7,0.8,best.r*2-7);
    }
    turn='w';setScore('SCORE:'+score+' | YOUR TURN');
  }
  var score=0;setScore('SCORE:0 | YOUR TURN (WHITE)');
  addMsg('Click a piece to select ¬∑ Click destination to move ¬∑ Capture the black King!');
  var stop2=g3Loop(function(){
    pieces.filter(function(p){return p.alive;}).forEach(function(p){p.m.rotation.y+=0.008;});
    rr.render(sc,cam);
  });
  var stop=stop2;
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Chess3D,60);});
}

// ‚îÄ‚îÄ G6-9: DEEP SEA FISHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Fishing(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x000a1a);
  sc.fog=new THREE.FogExp2(0x000a1a,0.02);
  var cam=new THREE.PerspectiveCamera(70,580/420,.1,100);
  cam.position.set(0,5,15);cam.lookAt(0,-5,0);
  sc.add(mkLight('ambient',0x001133,2));
  sc.add(mkLight('point',0x0044ff,2,40,0,10,0));
  // Water surface
  var waterMat=new THREE.MeshPhongMaterial({color:0x003366,transparent:true,opacity:0.6,shininess:200});
  var water=new THREE.Mesh(new THREE.PlaneGeometry(40,40),waterMat);
  water.rotation.x=-Math.PI/2;water.position.y=0;sc.add(water);
  // Boat on surface
  var boat=new THREE.Group();
  var bhull=new THREE.Mesh(new THREE.BoxGeometry(3,0.8,1.5),new THREE.MeshPhongMaterial({color:0x663300}));
  boat.add(bhull);
  var cabin=new THREE.Mesh(new THREE.BoxGeometry(1.2,1,1),new THREE.MeshPhongMaterial({color:0xaa6633}));
  cabin.position.set(-0.5,0.9,0);boat.add(cabin);
  boat.position.set(0,0.2,5);sc.add(boat);
  var bl5=new THREE.PointLight(0xffaa44,1.5,8);bl5.position.copy(boat.position);sc.add(bl5);
  // Line and lure
  var lineGeo=new THREE.BufferGeometry();
  var linePos=new Float32Array([0,0,0, 0,-1,0]);
  lineGeo.setAttribute('position',new THREE.BufferAttribute(linePos,3));
  var line=new THREE.Line(lineGeo,new THREE.LineBasicMaterial({color:0xaaaaaa}));
  sc.add(line);
  var lure=new THREE.Mesh(new THREE.SphereGeometry(0.2,8,8),new THREE.MeshPhongMaterial({color:0xff4400,emissive:0xff2200,emissiveIntensity:0.5}));
  lure.position.set(0,-1,5);sc.add(lure);
  // Fish
  var fish=[];var FCOLS=[0xff8800,0x00f5ff,0xffbe0b,0xff006e,0x06d6a0];
  function spawnFish(){
    var fc=FCOLS[Math.floor(Math.random()*FCOLS.length)];
    var fg=new THREE.Group();
    var fb=new THREE.Mesh(new THREE.SphereGeometry(0.35,8,8),new THREE.MeshPhongMaterial({color:fc}));
    fg.add(fb);
    var ft=new THREE.Mesh(new THREE.ConeGeometry(0.2,0.6,6),new THREE.MeshPhongMaterial({color:fc}));
    ft.rotation.z=Math.PI/2;ft.position.x=-0.6;fg.add(ft);
    fg.position.set((Math.random()-0.5)*20,-(2+Math.random()*15),(Math.random()-0.5)*10);
    fg.userData.vx=(Math.random()-0.5)*0.08;fg.userData.vy=(Math.random()-0.5)*0.02;
    fg.userData.val=Math.floor(Math.random()*3)+1;
    sc.add(fg);fish.push(fg);
  }
  for(var i=0;i<12;i++)spawnFish();
  var lineDepth=1;var reeling=false;var score=0;var frame=0;var state='casting';
  var biting=null;var biteTimer=0;
  document.addEventListener('keydown',function fshk(e){
    if(currentGame!=='g6_fishing')return document.removeEventListener('keydown',fshk);
    if(e.key==='ArrowDown'||e.key==='s')lineDepth=Math.min(18,lineDepth+0.3);
    if((e.key==='ArrowUp'||e.key==='w')&&state==='reeling')lineDepth=Math.max(0,lineDepth-0.5);
    if(e.key===' '){
      if(state==='casting'){state='fishing';lineDepth=1;}
      else if(state==='fishing'&&biting){state='reeling';addMsg('REELING IN! Keep pressing W!');}
      e.preventDefault();
    }
  });
  setScore('SCORE:0 | CAST SPACE, LOWER S, REEL W');
  addMsg('SPACE to cast ¬∑ S to lower lure ¬∑ Wait for bite ¬∑ SPACE hook ¬∑ W reel in!');
  var stop=g3Loop(function(){
    frame++;
    lure.position.y=-(lineDepth);lure.position.x=boat.position.x;lure.position.z=boat.position.z;
    lure.rotation.y+=0.05;
    var lp=linePos;lp[0]=boat.position.x;lp[1]=0.2;lp[2]=boat.position.z;lp[3]=lure.position.x;lp[4]=lure.position.y;lp[5]=lure.position.z;
    lineGeo.attributes.position.needsUpdate=true;
    fish.forEach(function(f){
      f.position.x+=f.userData.vx;f.position.y+=f.userData.vy;
      if(Math.abs(f.position.x)>12){f.userData.vx*=-1;}
      if(f.position.y>-1||f.position.y<-18){f.userData.vy*=-1;}
      f.rotation.y=Math.atan2(f.userData.vx,0.01);
    });
    if(state==='fishing'&&!biting&&frame%60===0){
      for(var i=0;i<fish.length;i++){
        var dx=fish[i].position.x-lure.position.x;var dy=fish[i].position.y-lure.position.y;var dz=fish[i].position.z-lure.position.z;
        if(Math.sqrt(dx*dx+dy*dy+dz*dz)<1.5&&Math.random()<0.4){biting=fish[i];biteTimer=120;addMsg('FISH BITING! Hit SPACE to hook!');break;}
      }
    }
    if(biting){biteTimer--;lure.position.x=biting.position.x;lure.position.z=biting.position.z;
      if(biteTimer<=0){biting=null;state='casting';lineDepth=1;addMsg('It got away!');}
    }
    if(state==='reeling'&&biting){lineDepth=Math.max(0,lineDepth);
      if(lineDepth<0.5){
        var val=biting.userData.val;score+=val*100;
        sc.remove(biting);fish.splice(fish.indexOf(biting),1);spawnFish();
        biting=null;state='casting';lineDepth=1;
        setScore('SCORE:'+score+' | CAUGHT +'+val+'00!');addMsg('FISH CAUGHT! +'+val+'00 pts');
      }
    }
    boat.rotation.y+=Math.sin(frame*0.02)*0.005;boat.position.y=Math.sin(frame*0.03)*0.05+0.2;
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Fishing,60);});
}

// ‚îÄ‚îÄ G6-10: MAGNET MAZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Magnet(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv,true);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x050010);
  var cam=new THREE.PerspectiveCamera(65,580/420,.1,80);
  cam.position.set(0,14,16);cam.lookAt(0,0,0);
  sc.add(mkLight('ambient',0x221144,1.5));
  var dl=mkLight('dir',0x8866ff,2,0,20,20,0);dl.castShadow=true;sc.add(dl);
  // Floor
  var floor=new THREE.Mesh(new THREE.BoxGeometry(16,0.4,16),new THREE.MeshPhongMaterial({color:0x110022}));
  floor.position.y=-0.2;floor.receiveShadow=true;sc.add(floor);
  sc.add(new THREE.GridHelper(16,8,0x330066,0x220044));
  // Walls
  var WALLS=[[0,-7.5,8,1],[0,7.5,8,1],[-7.5,0,1,16],[7.5,0,1,16],
             [0,0,3,0.5],[3,2,0.5,3],[-2,-3,4,0.5],[5,-4,0.5,4]];
  WALLS.forEach(function(w){
    var wm=new THREE.Mesh(new THREE.BoxGeometry(w[2],1.5,w[3]),new THREE.MeshPhongMaterial({color:0x331166,emissive:0x110033}));
    wm.position.set(w[0],0.75,w[1]);sc.add(wm);
  });
  // Metal blocks (attracted/repelled)
  var blocks=[];
  var BPOS=[{x:-4,z:-4},{x:4,z:-4},{x:-4,z:4},{x:2,z:2},{x:-2,z:-2}];
  BPOS.forEach(function(bp){
    var bm=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshPhongMaterial({color:0x8888aa,emissive:0x222244,shininess:200}));
    bm.position.set(bp.x,0.5,bp.z);bm.castShadow=true;sc.add(bm);
    blocks.push({m:bm,vx:0,vz:0});
  });
  // Goal
  var goalMesh=new THREE.Mesh(new THREE.CylinderGeometry(0.7,0.7,0.3,16),new THREE.MeshPhongMaterial({color:0x06d6a0,emissive:0x00aa66,emissiveIntensity:0.8}));
  goalMesh.position.set(6,0.15,6);sc.add(goalMesh);
  sc.add(mkLight('point',0x06d6a0,2,5,6,1,6));
  // Player ball
  var ball=new THREE.Mesh(new THREE.SphereGeometry(0.45,12,12),new THREE.MeshPhongMaterial({color:0xffbe0b,emissive:0x884400,shininess:200}));
  ball.position.set(-5,0.45,-5);ball.castShadow=true;sc.add(ball);
  var ballLight=new THREE.PointLight(0xffbe0b,2,6);ball.add(ballLight);
  var bvx=0;var bvz=0;var attract=true;var score=0;var level=1;var frame=0;
  var keys={};
  document.addEventListener('keydown',function mgk(e){
    if(currentGame!=='g6_magnet')return document.removeEventListener('keydown',mgk);
    keys[e.key]=true;
    if(e.key==='f'||e.key==='F'){attract=!attract;addMsg(attract?'üß≤ ATTRACT':'üîÑ REPEL');e.preventDefault();}
    e.preventDefault();
  });
  document.addEventListener('keyup',function mgku(e){delete keys[e.key];});
  setScore('LEVEL:1 | SCORE:0 | ATTRACT MODE');
  addMsg('WASD move ball ¬∑ F toggle attract/repel blocks ¬∑ Reach the green goal!');
  var stop=g3Loop(function(){
    frame++;
    var ax=0;var az=0;
    if(keys['a']||keys['ArrowLeft'])ax=-0.025;
    if(keys['d']||keys['ArrowRight'])ax=0.025;
    if(keys['w']||keys['ArrowUp'])az=-0.025;
    if(keys['s']||keys['ArrowDown'])az=0.025;
    bvx+=ax;bvz+=az;bvx*=0.88;bvz*=0.88;
    ball.position.x=Math.max(-7,Math.min(7,ball.position.x+bvx));
    ball.position.z=Math.max(-7,Math.min(7,ball.position.z+bvz));
    ball.rotation.z+=bvx;ball.rotation.x+=bvz;
    goalMesh.rotation.y+=0.04;
    blocks.forEach(function(bl){
      var dx=ball.position.x-bl.m.position.x;var dz=ball.position.z-bl.m.position.z;
      var d=Math.sqrt(dx*dx+dz*dz);
      if(d<5){var force=(attract?1:-1)*0.008/(d+0.5);bl.m.userData.vx=(bl.m.userData.vx||0)+dx/d*force;bl.m.userData.vz=(bl.m.userData.vz||0)+dz/d*force;}
      bl.m.userData.vx=(bl.m.userData.vx||0)*0.9;bl.m.userData.vz=(bl.m.userData.vz||0)*0.9;
      bl.m.position.x=Math.max(-7,Math.min(7,bl.m.position.x+(bl.m.userData.vx||0)));
      bl.m.position.z=Math.max(-7,Math.min(7,bl.m.position.z+(bl.m.userData.vz||0)));
      // Block collision with ball
      var dx2=ball.position.x-bl.m.position.x;var dz2=ball.position.z-bl.m.position.z;
      if(Math.abs(dx2)<1&&Math.abs(dz2)<1){bvx+=dx2*0.05;bvz+=dz2*0.05;}
    });
    var gx=ball.position.x-goalMesh.position.x;var gz=ball.position.z-goalMesh.position.z;
    if(Math.sqrt(gx*gx+gz*gz)<1.2){
      score+=200;level++;setScore('LEVEL:'+level+' | SCORE:'+score);
      ball.position.set(-5,0.45,-5);bvx=0;bvz=0;
      addMsg('GOAL! Level '+level+' ‚Äî goal moved!');
      goalMesh.position.set((Math.random()-0.5)*10,(Math.random()-0.5)*10,goalMesh.position.y);
      goalMesh.position.x=(Math.random()-0.5)*12;goalMesh.position.z=(Math.random()-0.5)*12;
    }
    ballLight.color.setHex(attract?0xffbe0b:0x8338ec);
    ball.material.color.setHex(attract?0xffbe0b:0x8338ec);
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Magnet,60);});
}

// ‚îÄ‚îÄ G6-11: DRAGON FLIGHT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Dragon(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x100815);
  sc.fog=new THREE.Fog(0x100815,30,100);
  var cam=new THREE.PerspectiveCamera(75,580/420,.1,150);
  sc.add(mkLight('ambient',0x221133,1.5));
  sc.add(mkLight('point',0xff4400,2,50,0,20,0));
  sc.add(mkLight('point',0x4400ff,1.5,50,10,15,-10));
  // Mountains
  for(var i=0;i<20;i++){
    var mh=4+Math.random()*12;
    var mt=new THREE.Mesh(new THREE.ConeGeometry(3+Math.random()*4,mh,6),new THREE.MeshPhongMaterial({color:0x221133,emissive:0x110022}));
    mt.position.set((Math.random()-0.5)*80,-mh/2+1,(Math.random()-0.5)*80);sc.add(mt);
  }
  // Dragon
  var dragon=new THREE.Group();
  var body=new THREE.Mesh(new THREE.SphereGeometry(1,8,8),new THREE.MeshPhongMaterial({color:0x228822,emissive:0x112211,shininess:100}));
  dragon.add(body);
  var neck=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.5,2,8),new THREE.MeshPhongMaterial({color:0x228822}));
  neck.rotation.x=-0.5;neck.position.set(0,0.5,-1.2);dragon.add(neck);
  var dhead=new THREE.Mesh(new THREE.BoxGeometry(0.8,0.6,1.2),new THREE.MeshPhongMaterial({color:0x228822}));
  dhead.position.set(0,1,-2.2);dragon.add(dhead);
  var wingL=new THREE.Mesh(new THREE.ConeGeometry(0.3,3.5,4),new THREE.MeshPhongMaterial({color:0x116611,transparent:true,opacity:0.8}));
  wingL.rotation.z=Math.PI/2;wingL.position.set(-2.5,0,0);dragon.add(wingL);
  var wingR=new THREE.Mesh(new THREE.ConeGeometry(0.3,3.5,4),new THREE.MeshPhongMaterial({color:0x116611,transparent:true,opacity:0.8}));
  wingR.rotation.z=-Math.PI/2;wingR.position.set(2.5,0,0);dragon.add(wingR);
  var dlight=new THREE.PointLight(0x44ff44,2,8);dragon.add(dlight);
  dragon.position.set(0,8,0);sc.add(dragon);
  // Targets (gold hoards)
  var targets=[];
  function spawnGold(){
    var gg=new THREE.Group();
    for(var k=0;k<6;k++){
      var coin=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,0.1,8),new THREE.MeshPhongMaterial({color:0xffbe0b,emissive:0xff8800,emissiveIntensity:0.5}));
      coin.position.set((Math.random()-0.5)*1.5,Math.random()*0.5,(Math.random()-0.5)*1.5);gg.add(coin);
    }
    gg.position.set((Math.random()-0.5)*40,2+Math.random()*10,(Math.random()-0.5)*40);
    sc.add(gg);targets.push({g:gg,collected:false});
  }
  for(var i=0;i<8;i++)spawnGold();
  // Fire particles
  var fireParticles=[];
  var score=0;var frame=0;var cool=0;
  var keys={};
  document.addEventListener('keydown',function dgk(e){
    if(currentGame!=='g6_dragon')return document.removeEventListener('keydown',dgk);
    keys[e.key]=true;
    if(e.key===' '&&cool<=0){
      cool=5;
      for(var k=0;k<3;k++){
        var fp=new THREE.Mesh(new THREE.SphereGeometry(0.15+Math.random()*0.15,6,6),new THREE.MeshBasicMaterial({color:0xff4400}));
        fp.position.copy(dragon.position);fp.position.y-=0.5;
        var spread=(Math.random()-0.5)*0.15;
        sc.add(fp);fireParticles.push({m:fp,vx:Math.sin(dragon.rotation.y)*0.8+spread,vy:(Math.random()-0.5)*0.1,vz:Math.cos(dragon.rotation.y)*0.8+spread,life:25+Math.floor(Math.random()*15)});
      }
      e.preventDefault();
    }
  });
  document.addEventListener('keyup',function dgku(e){delete keys[e.key];});
  setScore('SCORE:0 | GOLD:0/8');
  addMsg('WASD fly ¬∑ Q/E up/down ¬∑ SPACE breathe fire ¬∑ Collect all gold!');
  var collected=0;
  var stop=g3Loop(function(){
    frame++;cool--;
    if(keys['a']||keys['ArrowLeft'])dragon.rotation.y+=0.04;
    if(keys['d']||keys['ArrowRight'])dragon.rotation.y-=0.04;
    if(keys['w']||keys['ArrowUp'])dragon.rotation.x=Math.max(-0.5,dragon.rotation.x-0.03);
    if(keys['s']||keys['ArrowDown'])dragon.rotation.x=Math.min(0.5,dragon.rotation.x+0.03);
    if(keys['q'])dragon.position.y=Math.min(30,dragon.position.y+0.2);
    if(keys['e'])dragon.position.y=Math.max(3,dragon.position.y-0.2);
    dragon.position.x-=Math.sin(dragon.rotation.y)*0.22;
    dragon.position.z-=Math.cos(dragon.rotation.y)*0.22;
    dragon.position.x=Math.max(-40,Math.min(40,dragon.position.x));
    dragon.position.z=Math.max(-40,Math.min(40,dragon.position.z));
    wingL.rotation.z=Math.PI/2+Math.sin(frame*0.15)*0.4;
    wingR.rotation.z=-Math.PI/2-Math.sin(frame*0.15)*0.4;
    cam.position.set(dragon.position.x+Math.sin(dragon.rotation.y)*14,dragon.position.y+4,dragon.position.z+Math.cos(dragon.rotation.y)*14);
    cam.lookAt(dragon.position.x,dragon.position.y,dragon.position.z);
    targets.forEach(function(t){
      if(t.collected)return;
      t.g.rotation.y+=0.02;
      var dx=dragon.position.x-t.g.position.x;var dy=dragon.position.y-t.g.position.y;var dz=dragon.position.z-t.g.position.z;
      if(Math.sqrt(dx*dx+dy*dy+dz*dz)<3){t.collected=true;sc.remove(t.g);collected++;score+=200;setScore('SCORE:'+score+' | GOLD:'+collected+'/8');
        if(collected>=8){addMsg('ALL GOLD COLLECTED! Score:'+score);stop();}
      }
    });
    for(var i=fireParticles.length-1;i>=0;i--){
      fireParticles[i].m.position.x+=fireParticles[i].vx;
      fireParticles[i].m.position.y+=fireParticles[i].vy;
      fireParticles[i].m.position.z+=fireParticles[i].vz;
      fireParticles[i].life--;
      fireParticles[i].m.material.color.setHex(fireParticles[i].life>15?0xff4400:0xff8800);
      if(fireParticles[i].life<=0){sc.remove(fireParticles[i].m);fireParticles.splice(i,1);}
    }
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Dragon,60);});
}

// ‚îÄ‚îÄ G6-12: CYBER TENNIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Tennis(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv,true);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x000a14);
  var cam=new THREE.PerspectiveCamera(65,580/420,.1,80);
  cam.position.set(0,8,18);cam.lookAt(0,0,0);
  sc.add(mkLight('ambient',0x112233,1.5));
  var dl=mkLight('dir',0x4488ff,2,0,20,20,0);dl.castShadow=true;sc.add(dl);
  // Court
  var courtMat=new THREE.MeshPhongMaterial({color:0x002244,emissive:0x001122});
  var court=new THREE.Mesh(new THREE.BoxGeometry(12,0.2,20),courtMat);
  court.receiveShadow=true;sc.add(court);
  // Net
  var net=new THREE.Mesh(new THREE.BoxGeometry(12,1.2,0.1),new THREE.MeshPhongMaterial({color:0x00f5ff,transparent:true,opacity:0.6}));
  net.position.y=0.7;sc.add(net);
  // Lines
  var lineMat=new THREE.MeshBasicMaterial({color:0x4488ff});
  [[0,0.12,0,12,0.05,20],[0,0.12,0,0.1,0.05,20],[0,0.12,0,12,0.05,0.1]].forEach(function(l){
    var lm=new THREE.Mesh(new THREE.BoxGeometry(l[0]||12,l[1],l[2]||0.1),lineMat);
    lm.position.set(0,l[1]/2,0);sc.add(lm);
  });
  // Paddles
  var playerPaddle=new THREE.Mesh(new THREE.BoxGeometry(2.5,0.4,0.4),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244,shininess:200}));
  playerPaddle.position.set(0,0.5,8);playerPaddle.castShadow=true;sc.add(playerPaddle);
  sc.add(mkLight('point',0x00f5ff,1.5,6,0,1,8));
  var aiPaddle=new THREE.Mesh(new THREE.BoxGeometry(2.5,0.4,0.4),new THREE.MeshPhongMaterial({color:0xff006e,emissive:0x330011,shininess:200}));
  aiPaddle.position.set(0,0.5,-8);sc.add(aiPaddle);
  // Ball
  var ball=new THREE.Mesh(new THREE.SphereGeometry(0.3,10,10),new THREE.MeshPhongMaterial({color:0xffbe0b,emissive:0xff8800,emissiveIntensity:0.6,shininess:200}));
  ball.position.set(0,1,0);sc.add(ball);
  var bl6=new THREE.PointLight(0xffbe0b,2,4);ball.add(bl6);
  var bvx=0.08,bvy=0.05,bvz=0.22;
  var pScore=0;var aiScore=0;var frame=0;var swing=0;
  var keys={};var mouseX=0;
  cv.addEventListener('mousemove',function(e){var r=cv.getBoundingClientRect();mouseX=((e.clientX-r.left)/r.width-.5)*10;});
  document.addEventListener('keydown',function tnk(e){
    if(currentGame!=='g6_tennis')return document.removeEventListener('keydown',tnk);
    keys[e.key]=true;
    if(e.key===' '){swing=10;e.preventDefault();}
  });
  document.addEventListener('keyup',function tnku(e){delete keys[e.key];});
  setScore('YOU:0 | AI:0');
  addMsg('MOUSE to position paddle ¬∑ SPACE to swing ¬∑ Rally for points!');
  var stop=g3Loop(function(){
    frame++;swing=Math.max(0,swing-1);
    playerPaddle.position.x+=(mouseX-playerPaddle.position.x)*0.12;
    playerPaddle.position.x=Math.max(-5,Math.min(5,playerPaddle.position.x));
    playerPaddle.rotation.z=swing>0?-0.4:0;
    // AI
    aiPaddle.position.x+=(ball.position.x-aiPaddle.position.x)*0.06;
    aiPaddle.position.x=Math.max(-5,Math.min(5,aiPaddle.position.x));
    ball.position.x+=bvx;ball.position.y+=bvy;ball.position.z+=bvz;
    ball.rotation.x+=0.1;ball.rotation.z+=0.08;
    bvy-=0.004;
    if(ball.position.y<0.3){ball.position.y=0.3;bvy=Math.abs(bvy)*0.7;}
    if(Math.abs(ball.position.x)>5.5){bvx*=-1;}
    // Player hit
    if(ball.position.z>7.5&&ball.position.z<8.5&&Math.abs(ball.position.x-playerPaddle.position.x)<1.5&&ball.position.y<1.5){
      bvz=-Math.abs(bvz)*1.05;bvy=0.12;bvx+=(ball.position.x-playerPaddle.position.x)*0.04;
      if(swing>0){bvz*=1.2;bvx*=1.3;}
    }
    // AI hit
    if(ball.position.z<-7.5&&ball.position.z>-8.5&&Math.abs(ball.position.x-aiPaddle.position.x)<1.5&&ball.position.y<1.5){
      bvz=Math.abs(bvz);bvy=0.12;bvx+=(ball.position.x-aiPaddle.position.x)*0.03;
    }
    if(ball.position.z>11){aiScore++;ball.position.set(0,1,0);bvz=-0.22;bvx=(Math.random()-0.5)*0.1;bvy=0.06;setScore('YOU:'+pScore+' | AI:'+aiScore);}
    if(ball.position.z<-11){pScore++;ball.position.set(0,1,0);bvz=0.22;bvx=(Math.random()-0.5)*0.1;bvy=0.06;setScore('YOU:'+pScore+' | AI:'+aiScore);}
    if(pScore>=7){addMsg('YOU WIN! Score:'+pScore+'-'+aiScore);stop();}
    if(aiScore>=7){addMsg('AI WINS! Score:'+pScore+'-'+aiScore);stop();}
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Tennis,60);});
}

// ‚îÄ‚îÄ G6-13: ZERO-G ESCAPE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Escape(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv,true);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x020208);
  var cam=new THREE.PerspectiveCamera(70,580/420,.1,80);
  sc.add(mkLight('ambient',0x222244,1.5));
  sc.add(mkLight('point',0x4466ff,2,40,0,10,0));
  // Station corridors
  var wallMat=new THREE.MeshPhongMaterial({color:0x223344,emissive:0x111122});
  var floorMat=new THREE.MeshPhongMaterial({color:0x112233,emissive:0x050510});
  function addRoom(x,z,w,d){
    var floor=new THREE.Mesh(new THREE.BoxGeometry(w,0.2,d),floorMat);
    floor.position.set(x,0,z);floor.receiveShadow=true;sc.add(floor);
    var ceil=new THREE.Mesh(new THREE.BoxGeometry(w,0.2,d),wallMat);
    ceil.position.set(x,3,z);sc.add(ceil);
    [[x-w/2,1.5,z,0.2,3,d],[x+w/2,1.5,z,0.2,3,d],[x,1.5,z-d/2,w,3,0.2],[x,1.5,z+d/2,w,3,0.2]].forEach(function(wl){
      var wm=new THREE.Mesh(new THREE.BoxGeometry(wl[3],wl[4],wl[5]),wallMat);
      wm.position.set(wl[0],wl[1],wl[2]);wm.castShadow=true;sc.add(wm);
    });
  }
  addRoom(0,0,12,12);addRoom(8,8,6,6);addRoom(-8,8,6,6);addRoom(0,-8,8,6);
  // Crates
  var crates=[];
  var CPOS=[{x:2,z:2},{x:-3,z:-2},{x:5,z:-3},{x:-2,z:4},{x:7,z:6}];
  CPOS.forEach(function(cp){
    var cm=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshPhongMaterial({color:0x996633,emissive:0x331100}));
    cm.position.set(cp.x,0.5,cp.z);cm.castShadow=true;sc.add(cm);
    crates.push({m:cm,vx:0,vz:0});
  });
  // Switches
  var switches=[];var activated=0;
  [[3,-4,0x00f5ff],[-3,-4,0xff006e],[10,9,0xffbe0b],[-10,9,0x06d6a0]].forEach(function(sw,i){
    var sm=new THREE.Mesh(new THREE.BoxGeometry(0.6,0.6,0.6),new THREE.MeshPhongMaterial({color:sw[2],emissive:sw[2],emissiveIntensity:0.3}));
    sm.position.set(sw[0],0.3,sw[1]);sc.add(sm);
    sc.add(mkLight('point',sw[2],1.5,4,sw[0],1,sw[1]));
    switches.push({m:sm,active:false,col:sw[2]});
  });
  // Exit
  var exit=new THREE.Mesh(new THREE.BoxGeometry(1.5,2.5,0.3),new THREE.MeshPhongMaterial({color:0xff4400,emissive:0xff2200,emissiveIntensity:0.8}));
  exit.position.set(0,-5.5,1.5);sc.add(exit);
  sc.add(mkLight('point',0xff4400,2,6,0,1.2,-4));
  // Player
  var player=new THREE.Group();
  var pbody=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,1.4,8),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244}));
  player.add(pbody);var pl7=new THREE.PointLight(0x00f5ff,1.5,4);player.add(pl7);
  player.position.set(0,0.7,0);sc.add(player);
  var pvx=0;var pvz=0;var score=0;var frame=0;var o2=100;var lastT=Date.now();
  var pushing=null;
  var keys={};
  document.addEventListener('keydown',function zgk(e){
    if(currentGame!=='g6_escape')return document.removeEventListener('keydown',zgk);
    keys[e.key]=true;e.preventDefault();
  });
  document.addEventListener('keyup',function zgku(e){delete keys[e.key];});
  setScore('O2:100% | SWITCHES:0/4');
  addMsg('WASD move ¬∑ Push crates into switches ¬∑ Reach the exit door!');
  var stop=g3Loop(function(){
    frame++;
    if(Date.now()-lastT>=1000){o2--;lastT=Date.now();if(o2<=0){addMsg('OUT OF O2!');stop();}setScore('O2:'+o2+'% | SW:'+activated+'/4');}
    var dx=0;var dz=0;
    if(keys['a']||keys['ArrowLeft'])dx=-0.1;
    if(keys['d']||keys['ArrowRight'])dx=0.1;
    if(keys['w']||keys['ArrowUp'])dz=-0.1;
    if(keys['s']||keys['ArrowDown'])dz=0.1;
    pvx=(pvx+dx)*0.8;pvz=(pvz+dz)*0.8;
    player.position.x=Math.max(-11,Math.min(11,player.position.x+pvx));
    player.position.z=Math.max(-11,Math.min(11,player.position.z+pvz));
    cam.position.set(player.position.x,12,player.position.z+10);
    cam.lookAt(player.position.x,0,player.position.z);
    // Push crates
    crates.forEach(function(c){
      var cx=player.position.x-c.m.position.x;var cz=player.position.z-c.m.position.z;
      if(Math.abs(cx)<1.2&&Math.abs(cz)<1.2){c.m.position.x-=cx*0.08;c.m.position.z-=cz*0.08;}
    });
    // Check switches
    switches.forEach(function(sw){
      if(sw.active)return;
      crates.forEach(function(c){
        var cx=c.m.position.x-sw.m.position.x;var cz=c.m.position.z-sw.m.position.z;
        if(Math.abs(cx)<0.9&&Math.abs(cz)<0.9){sw.active=true;activated++;sw.m.material.emissiveIntensity=1;setScore('O2:'+o2+'% | SW:'+activated+'/4');addMsg('Switch '+activated+' activated!');}
      });
    });
    // Check exit
    if(activated>=4){
      exit.material.emissiveIntensity=1;
      var ex=player.position.x-exit.position.x;var ez=player.position.z-exit.position.z;
      if(Math.abs(ex)<1.5&&Math.abs(ez)<1.5){addMsg('ESCAPED! O2 remaining:'+o2+'%  Score:'+(o2*50));stop();}
    }
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Escape,60);});
}

// ‚îÄ‚îÄ G6-14: VOLCANO DEFENSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Volcano(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x100500);
  sc.fog=new THREE.Fog(0x100500,30,100);
  var cam=new THREE.PerspectiveCamera(70,580/420,.1,120);
  cam.position.set(0,20,30);cam.lookAt(0,0,0);
  sc.add(mkLight('ambient',0x331100,1.5));
  sc.add(mkLight('point',0xff4400,3,40,0,15,0));
  // Ground
  var ground=new THREE.Mesh(new THREE.PlaneGeometry(80,80),new THREE.MeshPhongMaterial({color:0x1a0800}));
  ground.rotation.x=-Math.PI/2;sc.add(ground);
  // Volcano
  var volcano=new THREE.Mesh(new THREE.ConeGeometry(8,14,12),new THREE.MeshPhongMaterial({color:0x331100,emissive:0x110500}));
  volcano.position.y=7;sc.add(volcano);
  var lavaPool=new THREE.Mesh(new THREE.CylinderGeometry(2.5,2.5,1,16),new THREE.MeshPhongMaterial({color:0xff4400,emissive:0xff8800,emissiveIntensity:0.8}));
  lavaPool.position.y=14.5;sc.add(lavaPool);
  sc.add(mkLight('point',0xff6600,4,15,0,15,0));
  // Village houses
  var houses=[];var HPOS=[{x:-18,z:15},{x:-14,z:18},{x:-10,z:20},{x:10,z:20},{x:14,z:18},{x:18,z:15},{x:-20,z:10},{x:20,z:10}];
  HPOS.forEach(function(hp){
    var hg=new THREE.Group();
    var hwall=new THREE.Mesh(new THREE.BoxGeometry(2.5,2,2.5),new THREE.MeshPhongMaterial({color:0xcc8833}));
    hg.add(hwall);
    var hroof=new THREE.Mesh(new THREE.ConeGeometry(1.8,2,4),new THREE.MeshPhongMaterial({color:0x883311}));
    hroof.position.y=2;hg.add(hroof);
    hg.position.set(hp.x,1,hp.z);sc.add(hg);
    houses.push({g:hg,hp2:3,alive:true});
  });
  // Player cannon
  var cannon=new THREE.Group();
  var cbase=new THREE.Mesh(new THREE.CylinderGeometry(0.8,1,1,8),new THREE.MeshPhongMaterial({color:0x334455}));
  cannon.add(cbase);
  var cbarrel=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.3,2.5,8),new THREE.MeshPhongMaterial({color:0x223344}));
  cbarrel.position.set(0,1.5,0);cannon.add(cbarrel);
  cannon.position.set(0,0.5,22);sc.add(cannon);
  sc.add(mkLight('point',0x00f5ff,2,8,0,2,22));
  // Boulders
  var boulders=[];var shots=[];var score=0;var lives=8;var frame=0;var cool=0;
  function spawnBoulder(){
    var bm=new THREE.Mesh(new THREE.SphereGeometry(0.6+Math.random()*0.4,8,8),new THREE.MeshPhongMaterial({color:0x553311,emissive:0xff4400,emissiveIntensity:0.4}));
    var angle=(Math.random()-0.5)*1.2;
    bm.position.set(Math.sin(angle)*2,14.5,Math.cos(angle)*2);
    var targetHouse=houses.filter(function(h){return h.alive;})[Math.floor(Math.random()*houses.filter(function(h){return h.alive;}).length)];
    var tx=targetHouse?targetHouse.g.position.x:((Math.random()-0.5)*30);
    var tz=targetHouse?targetHouse.g.position.z:20;
    var dist=Math.sqrt(Math.pow(tx-bm.position.x,2)+Math.pow(tz-bm.position.z,2));
    var spd=0.08+Math.random()*0.04;
    sc.add(bm);boulders.push({m:bm,vx:(tx-bm.position.x)/dist*spd,vy:0.05,vz:(tz-bm.position.z)/dist*spd,tx:tx,tz:tz});
  }
  for(var i=0;i<3;i++)spawnBoulder();
  var mouseX2=0;
  cv.addEventListener('mousemove',function(e){var r2=cv.getBoundingClientRect();mouseX2=((e.clientX-r2.left)/r2.width-.5)*30;});
  cv.addEventListener('click',function(){
    if(cool>0)return;cool=15;
    var s=new THREE.Mesh(new THREE.SphereGeometry(0.25,8,8),new THREE.MeshBasicMaterial({color:0x00f5ff}));
    s.position.copy(cannon.position);s.position.y+=2;
    sc.add(s);
    var ang=(cannon.position.x/30)*0.8;
    shots.push({m:s,vx:Math.sin(ang)*0.6,vy:0.5,vz:-0.9,life:80});
  });
  document.addEventListener('keydown',function vlk(e){
    if(currentGame!=='g6_volcano')return document.removeEventListener('keydown',vlk);
    if(e.key===' '&&cool<=0){cool=15;var s2=new THREE.Mesh(new THREE.SphereGeometry(0.25,8,8),new THREE.MeshBasicMaterial({color:0x00f5ff}));s2.position.copy(cannon.position);s2.position.y+=2;sc.add(s2);var ang2=(cannon.position.x/30)*0.8;shots.push({m:s2,vx:Math.sin(ang2)*0.6,vy:0.5,vz:-0.9,life:80});e.preventDefault();}
  });
  setScore('LIVES:'+lives+' | SCORE:0 | HOUSES:'+houses.length);
  addMsg('MOUSE aim ¬∑ CLICK or SPACE fire ¬∑ Shoot boulders before they hit the village!');
  var stop=g3Loop(function(){
    frame++;cool--;
    cannon.position.x+=(mouseX2-cannon.position.x)*0.1;
    cannon.position.x=Math.max(-14,Math.min(14,cannon.position.x));
    lavaPool.rotation.y+=0.03;
    for(var i=boulders.length-1;i>=0;i--){
      boulders[i].m.position.x+=boulders[i].vx;
      boulders[i].m.position.y+=boulders[i].vy;
      boulders[i].m.position.z+=boulders[i].vz;
      boulders[i].vy-=0.003;boulders[i].m.rotation.x+=0.05;boulders[i].m.rotation.z+=0.07;
      if(boulders[i].m.position.y<1){
        var bx=boulders[i].m.position.x;var bz=boulders[i].m.position.z;
        sc.remove(boulders[i].m);boulders.splice(i,1);
        var hitHouse=null;
        houses.forEach(function(h){if(h.alive&&Math.abs(h.g.position.x-bx)<3&&Math.abs(h.g.position.z-bz)<3)hitHouse=h;});
        if(hitHouse){hitHouse.hp2--;if(hitHouse.hp2<=0){hitHouse.alive=false;sc.remove(hitHouse.g);lives--;setScore('LIVES:'+Math.max(0,lives)+' | SCORE:'+score);if(lives<=0){addMsg('VILLAGE DESTROYED! Score:'+score);stop();return;}}}
        setTimeout(spawnBoulder,1500);continue;
      }
    }
    for(var i=shots.length-1;i>=0;i--){
      shots[i].m.position.x+=shots[i].vx;shots[i].m.position.y+=shots[i].vy;shots[i].m.position.z+=shots[i].vz;
      shots[i].vy-=0.012;shots[i].life--;
      var hit=false;
      for(var j=boulders.length-1;j>=0;j--){
        var dx=shots[i].m.position.x-boulders[j].m.position.x;var dy=shots[i].m.position.y-boulders[j].m.position.y;var dz=shots[i].m.position.z-boulders[j].m.position.z;
        if(Math.sqrt(dx*dx+dy*dy+dz*dz)<1.2){
          sc.remove(boulders[j].m);boulders.splice(j,1);sc.remove(shots[i].m);shots.splice(i,1);
          score+=50;setScore('LIVES:'+lives+' | SCORE:'+score);hit=true;
          setTimeout(spawnBoulder,1000);break;
        }
      }
      if(!hit&&shots[i]&&shots[i].life<=0){sc.remove(shots[i].m);shots.splice(i,1);}
    }
    if(frame%200===0)spawnBoulder();
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Volcano,60);});
}

// ‚îÄ‚îÄ G6-15: NEON SPEEDWAY (Kart Racing) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function g6Speedway(){
  var cv=g3Canvas(580,420),rr=g3Renderer(cv);
  var sc=new THREE.Scene();sc.background=new THREE.Color(0x000008);
  sc.fog=new THREE.Fog(0x000008,30,100);
  var cam=new THREE.PerspectiveCamera(80,580/420,.1,150);
  sc.add(mkLight('ambient',0x111133,1.5));
  sc.add(mkLight('point',0x4466ff,2,60,0,20,0));
  // Track - oval shape via segments
  var trackMat=new THREE.MeshPhongMaterial({color:0x111122,emissive:0x050510});
  var trackWidth=8;
  var trackPoints=[];var SEGS=32;
  for(var i=0;i<SEGS;i++){
    var a=i/SEGS*Math.PI*2;
    trackPoints.push(new THREE.Vector3(Math.cos(a)*25,0,Math.sin(a)*18));
  }
  // Build track as a series of boxes
  for(var i=0;i<SEGS;i++){
    var p1=trackPoints[i];var p2=trackPoints[(i+1)%SEGS];
    var seg=new THREE.Mesh(new THREE.BoxGeometry(trackWidth,0.2,p1.distanceTo(p2)+0.2),trackMat);
    var mx=(p1.x+p2.x)/2;var mz=(p1.z+p2.z)/2;
    seg.position.set(mx,0,mz);seg.lookAt(new THREE.Vector3(p2.x,0,p2.z));seg.receiveShadow=true;sc.add(seg);
    // Track lights
    if(i%4===0){var tl2=new THREE.PointLight(0x0044ff,0.8,12);tl2.position.set(mx,2,mz);sc.add(tl2);}
  }
  // Track barriers
  for(var i=0;i<SEGS;i++){
    var a=i/SEGS*Math.PI*2;
    var inn=new THREE.Mesh(new THREE.BoxGeometry(0.4,1,2),new THREE.MeshPhongMaterial({color:0xff006e,emissive:0x330011}));
    inn.position.set(Math.cos(a)*19,0.5,Math.sin(a)*13);sc.add(inn);
    var out=new THREE.Mesh(new THREE.BoxGeometry(0.4,1,2),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244}));
    out.position.set(Math.cos(a)*31,0.5,Math.sin(a)*23);sc.add(out);
  }
  // Player kart
  var kart=new THREE.Group();
  var kbody=new THREE.Mesh(new THREE.BoxGeometry(1.4,0.5,2),new THREE.MeshPhongMaterial({color:0x00f5ff,emissive:0x002244,shininess:200}));
  kart.add(kbody);
  var kcabin=new THREE.Mesh(new THREE.BoxGeometry(1,0.7,1),new THREE.MeshPhongMaterial({color:0x005577}));
  kcabin.position.y=0.6;kart.add(kcabin);
  [[0.8,0,0.8],[0.8,0,-0.8],[-0.8,0,0.8],[-0.8,0,-0.8]].forEach(function(wp){
    var w=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,0.2,8),new THREE.MeshPhongMaterial({color:0x333333}));
    w.rotation.z=Math.PI/2;w.position.set(wp[0],-0.15,wp[1]||wp[2]);kart.add(w);
  });
  var klight=new THREE.PointLight(0x00f5ff,2,6);kart.add(klight);
  kart.position.set(25,0.4,0);sc.add(kart);
  // AI karts
  var aiKarts=[];var AICOLS=[0xff006e,0xffbe0b,0x06d6a0];
  for(var i=0;i<3;i++){
    var akg=new THREE.Group();
    var akb=new THREE.Mesh(new THREE.BoxGeometry(1.4,0.5,2),new THREE.MeshPhongMaterial({color:AICOLS[i],emissive:0x111111}));
    akg.add(akb);
    var akc=new THREE.Mesh(new THREE.BoxGeometry(1,0.7,1),new THREE.MeshPhongMaterial({color:AICOLS[i]}));
    akc.position.y=0.6;akg.add(akc);
    var startA=i/3*Math.PI*2+0.3;
    akg.position.set(Math.cos(startA)*25,0.4,Math.sin(startA)*18);sc.add(akg);
    aiKarts.push({g:akg,t:i/3+0.01,spd:0.0018+Math.random()*0.0006,lap:0});
  }
  var kartT=0;var kartSpd=0;var steer=0;var lap=0;var frame=0;var score=0;var bestLap=Infinity;var lastLapT=Date.now();
  var keys={};
  document.addEventListener('keydown',function spk(e){
    if(currentGame!=='g6_speedway')return document.removeEventListener('keydown',spk);
    keys[e.key]=true;e.preventDefault();
  });
  document.addEventListener('keyup',function spku(e){delete keys[e.key];});
  setScore('LAP:0 | POS:1/4 | SCORE:0');
  addMsg('W accelerate ¬∑ S brake ¬∑ A/D steer ¬∑ Complete laps to score!');
  var stop=g3Loop(function(){
    frame++;
    if(keys['w']||keys['ArrowUp'])kartSpd=Math.min(0.025,kartSpd+0.001);
    else if(keys['s']||keys['ArrowDown'])kartSpd=Math.max(0,kartSpd-0.002);
    else kartSpd=Math.max(0,kartSpd-0.0005);
    if(keys['a']||keys['ArrowLeft'])steer=Math.max(-0.05,steer-0.004);
    else if(keys['d']||keys['ArrowRight'])steer=Math.min(0.05,steer+0.004);
    else steer*=0.85;
    kart.rotation.y-=steer*kartSpd*20;
    kartT+=kartSpd;
    var tarA=kartT*Math.PI*2;
    kart.position.x=Math.cos(tarA)*25;kart.position.z=Math.sin(tarA)*18;
    kart.rotation.y=-tarA-Math.PI/2;
    var prevLap=Math.floor((kartT-kartSpd)*1);var curLap=Math.floor(kartT*1);
    if(curLap>prevLap){lap++;var lapTime=(Date.now()-lastLapT)/1000;lastLapT=Date.now();bestLap=Math.min(bestLap,lapTime);score+=Math.round(1000/lapTime);setScore('LAP:'+lap+' | BEST:'+bestLap.toFixed(1)+'s | SCORE:'+score);addMsg('Lap '+lap+' in '+lapTime.toFixed(2)+'s');}
    aiKarts.forEach(function(ak){ak.t+=ak.spd;var a2=ak.t*Math.PI*2;ak.g.position.x=Math.cos(a2)*25;ak.g.position.z=Math.sin(a2)*18;ak.g.rotation.y=-a2-Math.PI/2;});
    var pos=1+aiKarts.filter(function(ak){return ak.t>kartT;}).length;
    cam.position.set(kart.position.x+Math.sin(kart.rotation.y)*-12,6,kart.position.z+Math.cos(kart.rotation.y)*-12);
    cam.lookAt(kart.position.x,0,kart.position.z);
    if(lap>=5){addMsg('RACE COMPLETE! Score:'+score+' | Best lap:'+bestLap.toFixed(2)+'s');stop();}
    rr.render(sc,cam);
  });
  gameCleanup=function(){stop();rr.dispose();};
  addRestartBtn(function(){gameCleanup();setTimeout(g6Speedway,60);});
}


</script>
</body>
</html>
